<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorická kalkulačka</title>
    <!-- Odkaz na externí CSS soubor -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>

<body data-app-id="{{ app_id }}" data-supabase-url="{{ supabase_url }}" data-supabase-key="{{ supabase_key }}">
    <div class="container">

        <script>
            // Debug funkce - DEFINOVAT NA ZAČÁTKU
            let debugVisible = false;
            const debugLogs = [];

            function debugLog(message) {
                console.log(message);
                debugLogs.push(message);

                const debugDiv = document.getElementById('debugConsole');
                if (debugDiv && debugVisible) {
                    debugDiv.innerHTML += message + '<br>';
                    debugDiv.scrollTop = debugDiv.scrollHeight;
                }
            }

            // Přidejte debug logy do inicializace
            debugLog("Aplikace se spouští...");
        </script>

        <!-- Do záhlaví přidejte -->
        <div id="userMenu" style="position: absolute; top: 10px; right: 60px; z-index: 11; display: none;">
            <button id="logoutBtn" style="padding: 5px 10px; font-size: 12px;">Odhlásit se</button>
        </div>

        <!-- Indikátor načítání -->
        <div id="globalLoading"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
            <div style="text-align: center;">
                <div style="margin-bottom: 10px;">Načítání aplikace...</div>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <button id="manualInitButton"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
            Obnovit aplikaci
        </button>

        <!-- Nový wrapper pro statické záhlaví -->
        <div class="sticky-header-wrapper">
            <div class="header-controls">

                <!-- Přidejte toto tlačítko -->
                <button id="loginMenuBtn" style="margin-left: 10px; padding: 5px 10px; display: none;">
                    Přihlásit se
                </button>
            </div>

            <div id="userIdDisplay"></div> <!-- Přesunuto sem -->
            <h1>Kalorická kalkulačka</h1>

            <!-- Připojený profil v levém horním rohu -->
            <div id="currentProfileDisplay" style="display: none;">
                <div class="profile-display-clickable">
                    <!-- Přidejte email nad název profilu -->
                    <div class="profile-email" id="currentProfileEmail"></div>
                    <div class="profile-info">
                        <img src="{{ url_for('static', filename='icon/profil.png') }}" alt="Profil"
                            class="profile-icon">
                        <span id="currentProfileName">Název profilu</span>
                    </div>
                </div>
            </div>

            <!-- Ikonka ozubeného kolečka pro nastavení (PNG obrázek) -->
            <img id="settingsIcon" src="{{ url_for('static', filename='icon/nastaveni.png') }}" alt="Nastavení"
                class="settings-icon">

            <!-- Kontejner pro zarovnání tlačítka "Recepty" a vyhledávání -->
            <div class="search-and-recipes-container">
                <div class="main-controls">
                    <button id="recipesButton" disabled>Recepty</button>
                    <!-- Přidáme tlačítko pro skenování čárových kódů -->
                    <button id="barcodeButton" style="margin-left: 10px;">
                        📷 Skenovat kód
                    </button>
                </div>

                <form id="searchForm">
                    <input type="text" id="query" name="query"
                        placeholder="Zadejte název potraviny (např. jablko, kuře)">
                    <button type="submit">Vyhledat</button>
                </form>
            </div>

            <div id="loading">Vyhledávám...</div>
            <div id="error-message" class="error"></div>
        </div>

        <div id="results">
            <!-- Zde se budou zobrazovat výsledky -->
        </div>
    </div>

    <!-- Přihlašovací modální okno -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Přihlášení / Registrace</h3>
            <div id="loginError" class="error" style="display: none;"></div>
            <div id="loginSuccess" class="success" style="display: none; color: green;"></div>

            <input type="email" id="loginEmail" placeholder="E-mail" required>
            <input type="password" id="loginPassword" placeholder="Heslo" required>

            <div class="modal-action-buttons">
                <button id="loginBtn">Přihlásit se</button>
                <button id="registerBtn">Registrovat</button>
                <button id="continueAnonymouslyBtn" style="background-color: #6c757d;">Pokračovat anonymně</button>
            </div>

            <!-- Přidejte informaci o emailové verifikaci -->
            <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                Po registraci je potřeba potvrdit email. Zkontrolujte si spam složku.
            </div>
        </div>
    </div>

    <!-- Modální okno pro výběr profilu -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeProfileModal">&times;</span>
            <h3>Správa profilů</h3>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px; text-align: center;">
                Vyberte si profil pro ukládání receptů a nastavení
            </p>
            <div id="profileList">
                <!-- Seznam profilů se načte zde -->
            </div>
            <div class="modal-action-buttons">
                <button id="createNewProfileBtn">Vytvořit nový profil</button>
            </div>
        </div>
    </div>

    <!-- Modální okno pro vytvoření nového profilu -->
    <div id="createProfileModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeCreateProfileModal">&times;</span>
            <h3>Vytvořit nový profil</h3>
            <input type="text" id="newProfileName" placeholder="Jméno profilu">
            <div class="create-profile-buttons">
                <button id="confirmCreateProfile">Vytvořit</button>
                <button id="cancelCreateProfile">Zrušit</button>

            </div>
        </div>
    </div>

    <!-- Modální okno pro detaily receptu -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content modal-recipe-content"> <!-- Přidat třídu -->
            <span class="close-button">&times;</span> <!-- Křížek ZŮSTÁVÁ zde -->

            <div class="modal-recipe-scroll-container"> <!-- Nový kontejner pro scroll -->
                <div id="modalDetailsContent" class="modal-details modal-recipe-container">
                    <!-- Fixní hlavička receptu -->
                    <div class="modal-recipe-header">
                        <img id="modalHeaderImage" src="" alt="" class="modal-header-image">
                        <div class="modal-header-text">
                            <div id="modalHeaderName" class="modal-header-name">Název receptu</div>
                            <div class="energy-display-group">
                                <div id="totalKcalDisplay" class="energy-header">0 kcal</div>
                                <div id="totalKjDisplay" class="energy-sub-header">0 kJ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hlavní obsah s scrollováním -->
                    <div class="modal-scrollable-container">
                        <div id="nutrientDetailsSection"></div>
                        <h3 class="ingredients-title">Složení receptu:</h3>
                        <div id="recipeIngredientsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nové modální okno pro vytvoření nového receptu -->
    <div id="createRecipeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeCreateRecipeModal">&times;</span>
            <h3>Vytvořit nový recept</h3>
            <input type="text" id="newRecipeNameInput" placeholder="Název receptu">
            <div class="create-recipe-buttons"> <!-- Nový kontejner pro tlačítka -->
                <button id="confirmCreateRecipeButton">Vytvořit a přidat</button>
                <button id="cancelCreateRecipeButton">Zrušit</button>
            </div>
        </div>
    </div>

    <!-- Nové modální okno pro výběr existujícího receptu -->
    <div id="selectRecipeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeSelectRecipeModal">&times;</span>
            <h3>Moje recepty</h3>
            <!-- Nový element pro zobrazení počtu receptů -->
            <div id="recipeCountDisplay" class="recipe-count-display"></div>
            <ul id="existingRecipesList">
                <!-- Recepty se načtou zde -->
            </ul>
            <div class="recipe-list-actions">
                <!-- Tlačítko "Přidat nový recept" je nyní skryto nebo odstraněno -->
                <!-- Tlačítko "Zavřít" je odstraněno -->
            </div>
        </div>
    </div>

    <!-- Nové modální okno pro vlastní upozornění -->
    <div id="customNotificationModal" class="modal-overlay">
        <div class="modal-content">
            <p id="customNotificationMessage"></p>
            <div class="notification-controls">
                <div id="dynamicNotificationToggleContainer" class="notification-toggle-container">
                    <!-- Dynamic toggle will be inserted here by JS -->
                </div>
                <!-- Tlačítka pro potvrzení/zrušení se budou dynamicky vkládat zde -->
            </div>
        </div>
    </div>

    <!-- Nové modální okno pro nastavení -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModal">&times;</span>
            <!-- Přidáno: Informace o profilu a uživateli - STEJNÉ JAKO NA HLAVNÍ STRÁNCE -->
            <div id="settingsProfileInfo" class="settings-profile-info"
                style="display: none; justify-content: center; margin-bottom: 20px;">
                <div class="profile-display-clickable" style="margin: 0 auto;">
                    <div class="profile-email" id="settingsProfileEmail"></div>
                    <div class="profile-info">
                        <img src="{{ url_for('static', filename='icon/profil.png') }}" alt="Profil"
                            class="profile-icon">
                        <span id="settingsProfileName">Název profilu</span>
                    </div>
                </div>
            </div>

            <h3>Nastavení</h3>

            <!-- Sekce přihlášení -->
            <div class="setting-item">
                <span class="setting-label">Přihlášení</span>
                <button id="switchAccountBtn" style="padding: 5px 10px; font-size: 12px;">
                    Přepnout účet
                </button>
            </div>

            <!-- Sekce dialogová okna - rozbalovací -->
            <div class="setting-section">
                <div class="setting-section-header">
                    <span class="setting-label">Dialogová okna</span>
                    <span class="setting-section-arrow">▼</span>
                </div>
                <div class="setting-section-content">
                    <div class="setting-item">
                        <span class="setting-label">Potvrzení smazání receptu</span>
                        <label class="toggle-switch" style="margin-left: -20px; transform: scale(0.9);">
                            <input type="checkbox" id="confirmDeleteRecipeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Potvrzení smazání položky</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmDeleteRecipeItemToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Potvrzení uložení změn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmSaveChangesToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Oznámení vytvoření receptu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeCreationToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Oznámení přidání potraviny</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmFoodAdditionToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Oznámení úspěšného smazání</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeDeletionSuccessToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Oznámení chyby smazání</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeDeletionErrorToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Oznámení úspěšného uložení změn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeSaveSuccessToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nové modální okno pro skenování čárových kódů -->
    <div id="barcodeModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 90%; height: 70%;">
            <span class="close-button" id="closeBarcodeModal">&times;</span>
            <h3>Skenovat čárový kód</h3>
            <div id="barcodeScannerContainer"
                style="width: 100%; height: 80%; position: relative; display: flex; justify-content: center; align-items: center; background-color: #f0f0f0; border-radius: 8px;">
                <div id="barcodeUnsupportedMessage" style="text-align: center; padding: 20px;">
                    <p style="font-size: 18px; margin-bottom: 15px;">🔒 Skenování čárových kódů není v tomto prohlížeči
                        dostupné</p>
                    <p style="margin-bottom: 10px;">Pro skenování kódů fotoaparátem:</p>
                    <ul style="text-align: left; margin-bottom: 15px;">
                        <li>Použijte HTTPS připojení (zabezpečené)</li>
                        <li>Povolte přístup ke kameře v prohlížeči</li>
                        <li>Zkuste moderní prohlížeč (Chrome, Firefox, Edge)</li>
                    </ul>
                    <p>Můžete také zadat kód ručně:</p>
                    <input type="text" id="manualBarcodeInput" placeholder="Zadejte čárový kód"
                        style="padding: 10px; width: 200px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                    <button id="submitManualBarcode"
                        style="padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Vyhledat</button>
                </div>
                <video id="barcodeVideo"
                    style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; display: none;"></video>
                <canvas id="barcodeCanvas" style="display: none;"></canvas>
                <div id="barcodeOverlay"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 30%; border: 2px solid #4CAF50; border-radius: 8px; pointer-events: none; display: none;">
                </div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <button id="toggleCameraButton" style="margin: 0 5px; display: none;">Přepnout kameru</button>
                <button id="toggleFlashButton" style="margin: 0 5px; display: none;">Blesk</button>
            </div>
            <div id="barcodeStatus" style="text-align: center; margin-top: 10px; color: #666;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.58.0/dist/umd/supabase.min.js"></script>

    <script type="module">

        // Globální proměnné
        let supabaseClient;
        let currentUser = null;
        let currentProfileId = null;
        let isAppInitialized = false;
        let isLoadingProfiles = false;
        let isProfileModalShowing = false;
        let isUpdatingProfileDisplay = false;

        // Inicializace globálních proměnných
        window.currentUser = null;
        window.userProfiles = [];
        window.isLoadingProfiles = false;
        window.isProfileModalShowing = false;
        window.isAppInitialized = false;
        window.appInitialized = false;
        window.isCreatingProfile = false;

        function debugLog(message) {
            console.log(message);
            debugLogs.push(message);
        }

        console.log("🔍 Kontrola globálních proměnných...");
        console.log("🔍 window.supabaseClient:", typeof window.supabaseClient);
        console.log("🔍 window.currentUser:", typeof window.currentUser);
        console.log("🔍 window.userProfiles:", typeof window.userProfiles);

        // Vynulovat pokud existují problémy
        window.supabaseClient = null;
        window.currentUser = null;
        window.userProfiles = [];
        window.isLoadingProfiles = false;
        window.isProfileModalShowing = false;
        window.isAppInitialized = false;
        window.appInitialized = false;
        window.isProfileModalShowing = false;

        console.log("✅ Globální proměnné inicializovány");

        // Přímá inicializace Supabase (přidejte na začátek)
        console.log("🚀 RYCHLÁ INICIALIZACE SUPABASE");
        try {
            if (typeof supabase !== 'undefined') {
                const { createClient } = supabase;
                const supabaseUrl = 'https://temswelhomcndkifxbwl.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlbXN3ZWxob21jbmRraWZ4YndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NDE3MzAsImV4cCI6MjA3NDMxNzczMH0.-f21p7Y9fOP5NGvk7f3z4ekckQDOGVNJfZ5Q9dHboyc';

                window.supabaseClient = createClient(supabaseUrl, supabaseKey);
                console.log("✅ Rychlá inicializace - window.supabaseClient:", !!window.supabaseClient);
            } else {
                console.error("❌ Supabase SDK není dostupné");
            }
        } catch (error) {
            console.error("❌ Chyba rychlé inicializace:", error);
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Zajistit, že všechny modaly jsou skryté
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                if (modal.id !== 'loginModal') { // Přihlašovací modal může být viditelný
                    modal.style.display = 'none';
                }
            });
        });

        // Event listener pro přepnutí účtu
        document.getElementById('switchAccountBtn').addEventListener('click', async function () {
            await logoutUser();
            showLoginModal();
        });

        // Funkce pro rozbalování sekcí v nastavení - SIMPLIFIED
        function initializeSettingsSections() {
            console.log("🔄 Inicializuji rozbalovací sekce nastavení...");

            const sectionHeaders = document.querySelectorAll('.setting-section-header');
            console.log("🔍 Nalezeno sekcí:", sectionHeaders.length);

            sectionHeaders.forEach((header, index) => {
                console.log(`🎯 Sekce ${index + 1}:`, header);

                // Odstranit existující event listenery
                header.replaceWith(header.cloneNode(true));
                const newHeader = document.querySelectorAll('.setting-section-header')[index];

                newHeader.addEventListener('click', function (e) {
                    e.stopPropagation();
                    console.log("🎯 Kliknuto na sekci nastavení");

                    const content = this.nextElementSibling;
                    const arrow = this.querySelector('.setting-section-arrow');

                    console.log("📦 Obsah sekce:", content);
                    console.log("🎯 Šipka:", arrow);

                    if (content && content.classList.contains('setting-section-content')) {
                        // Přepnout stav
                        const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';

                        if (isOpen) {
                            // Zavřít
                            content.style.maxHeight = "0";
                            content.style.opacity = "0";
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        } else {
                            // Otevřít
                            content.style.maxHeight = content.scrollHeight + "px";
                            content.style.opacity = "1";
                            if (arrow) arrow.style.transform = 'rotate(180deg)';
                        }

                        console.log("✅ Stav sekce změněn:", isOpen ? "zavřeno" : "otevřeno");
                    }
                });

                // Inicializovat zavřený stav
                const content = newHeader.nextElementSibling;
                const arrow = newHeader.querySelector('.setting-section-arrow');

                if (content && content.classList.contains('setting-section-content')) {
                    content.style.maxHeight = "0";
                    content.style.opacity = "0";
                    content.style.transition = 'max-height 0.3s ease, opacity 0.3s ease';
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                }
            });
        }

        // Inicializace při načtení DOM
        document.addEventListener('DOMContentLoaded', function () {
            console.log("✅ DOM načten - inicializuji sekce nastavení");
            setTimeout(initializeSettingsSections, 500);
        });

        // Inicializace při otevření modálního okna nastavení
        document.addEventListener('click', function (e) {
            if (e.target.id === 'settingsIcon' || e.target.closest('#settingsIcon')) {
                console.log("🎯 Otevřeno nastavení - inicializuji sekce");
                setTimeout(initializeSettingsSections, 300);
            }
        });

        // Inicializace při otevření modálního okna nastavení
        document.getElementById('settingsIcon').addEventListener('click', function () {
            console.log("🎯 Otevřeno nastavení - načítám aktuální nastavení");

            // Načíst aktuální nastavení
            loadUserSettings();

            // Inicializovat rozbalovací sekce
            setTimeout(initializeSettingsSections, 100);

            // Aktualizovat informace o profilu
            updateSettingsProfileInfo();
        });

        // Funkce pro zobrazení přihlašovacího modalu
        function showLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                console.log("🔄 Zobrazuji přihlašovací modal");
                loginModal.style.display = 'flex';

                // Resetovat inputy
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
            } else {
                console.error("❌ Přihlašovací modal nebyl nalezen!");
            }
        }

        // Funkce pro skrytí přihlašovacího modalu
        function hideLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        }

        // Funkce pro zobrazení success zprávy
        function showLoginSuccess(message) {
            const successDiv = document.getElementById('loginSuccess');
            const errorDiv = document.getElementById('loginError');

            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }

        // Registrace uživatele
        async function registerUser(email, password) {
            try {
                console.log("🔄 Registruji uživatele:", email);

                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        emailRedirectTo: window.location.origin + '/auth/callback'
                    }
                });

                if (error) {
                    console.error("❌ Chyba registrace:", error);
                    throw error;
                }

                if (data.user) {
                    console.log("✅ Uživatel zaregistrován:", data.user.id);

                    let message = "Registrace úspěšná! ";
                    if (data.user.identities && data.user.identities.length === 0) {
                        message += "Účet již existuje. Přihlaste se.";
                        showLoginSuccess(message);
                    } else if (!data.user.email_confirmed_at) {
                        message += "Prosím zkontrolujte email a potvrďte registraci.";
                        showLoginSuccess(message);
                    } else {
                        // Pokud je email již potvrzený, přihlásit a zobrazit profily
                        message += "Nyní si vytvořte první profil.";
                        showLoginSuccess(message);

                        // Automaticky přihlásit a zobrazit výběr profilů
                        window.currentUser = data.user;
                        hideLoginModal();
                        window.showCustomNotification("Vítejte! Vytvořte si první profil.", 'success');
                        await continueWithUser(data.user);
                    }

                    return data.user;
                }

            } catch (error) {
                console.error("❌ Chyba při registraci:", error);
                throw error;
            }
        }

        // Přihlášení uživatele
        async function loginUser(email, password) {
            try {
                console.log("🔄 Přihlašuji uživatele:", email);

                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    console.error("❌ Chyba přihlášení:", error);
                    throw error;
                }

                if (data.user) {
                    console.log("✅ Uživatel přihlášen:", data.user.id);
                    window.currentUser = data.user;
                    hideLoginModal();

                    // Zobrazit custom notifikaci
                    window.showCustomNotification(`Vítejte zpět, ${email}!`, 'success');

                    await continueWithUser(data.user); // Použije novou logiku
                    return data.user;
                }

            } catch (error) {
                console.error("❌ Chyba při přihlášení:", error);
                throw error;
            }
        }

        // Pokračování anonymně
        async function continueAnonymously() {
            try {
                console.log("🔄 Pokračuji anonymně...");

                // ŽÁDNÉ lokální profily pro anonymní uživatele
                window.showCustomNotification("Pro plné funkce aplikace se prosím přihlaste.", 'info');
                showLoginModal(); // Nabídnout přihlášení

            } catch (error) {
                console.error("❌ Chyba při anonymním přihlášení:", error);
                window.showCustomNotification("Pro plné funkce aplikace se prosím přihlaste.", 'info');
                showLoginModal();
            }
        }

        // Odhlášení uživatele
        async function logoutUser() {
            try {
                const { error } = await window.supabaseClient.auth.signOut();
                if (error) {
                    console.error("❌ Chyba při odhlašování:", error);
                } else {
                    console.log("✅ Uživatel odhlášen");
                    // Resetovat aplikaci
                    window.currentUser = null;
                    window.userProfiles = [];
                    window.currentProfileId = null;
                    localStorage.clear();
                    location.reload();
                }
            } catch (error) {
                console.error("❌ Chyba při odhlašování:", error);
            }
        }

        // Event listener pro odhlášení
        document.getElementById('logoutBtn').addEventListener('click', logoutUser);

        // Funkce pro zobrazení/skrytí user menu
        function updateUserMenu() {
            const userMenu = document.getElementById('userMenu');
            if (window.currentUser && !window.currentUser.is_anonymous) {
                userMenu.style.display = 'block';
            } else {
                userMenu.style.display = 'none';
            }
        }

        // Funkce pro aktualizaci informací o profilu v nastavení
        function updateSettingsProfileInfo() {
            const profileInfo = document.getElementById('settingsProfileInfo');
            const profileEmail = document.getElementById('settingsProfileEmail');
            const profileName = document.getElementById('settingsProfileName');

            if (window.currentUser && window.currentUser.email && window.currentProfileId) {
                // Zobrazit sekci pouze pokud je uživatel přihlášen a má vybraný profil
                profileInfo.style.display = 'flex';

                profileEmail.textContent = window.currentUser.email;
                profileEmail.style.display = 'block';

                if (window.userProfiles) {
                    const profile = window.userProfiles.find(p => p.id === window.currentProfileId);
                    if (profile) {
                        profileName.textContent = profile.name;
                    } else {
                        profileName.textContent = 'Nevybrán profil';
                    }
                }
            } else {
                // Skrýt sekci pokud není přihlášen
                profileInfo.style.display = 'none';
            }
        }

        // Přidání klikatelnosti - OPRAVENÁ VERZE
        document.addEventListener('click', function (e) {
            const profileElement = e.target.closest('#settingsProfileInfo .profile-display-clickable');
            if (profileElement) {
                console.log("🎯 Kliknuto na profil v nastavení");

                // Nejdříve sbalit všechny sekce
                collapseAllSettingsSections();

                // Pak zavřít modální okno nastavení
                setTimeout(() => {
                    const settingsModal = document.getElementById('settingsModal');
                    if (settingsModal) {
                        settingsModal.style.display = 'none';
                        console.log("✅ Modální okno nastavení zavřeno");
                    }

                    // Nakonec otevřít modální okno profilů
                    window.showProfileModal();
                }, 150); // Větší zpoždění pro plynulou animaci
            }
        });

        // Volání funkce při otevření nastavení
        document.getElementById('settingsIcon').addEventListener('click', function () {
            setTimeout(updateSettingsProfileInfo, 100);
        });

        // Také aktualizujte při změně profilu
        window.selectProfile = async function (profileId) {
            try {
                console.log("🎯 selectProfile volána:", profileId);

                // KONTROLA EXISTENCE PROFILU
                const profileExists = window.userProfiles && window.userProfiles.some(p => p.id === profileId);
                if (!profileExists) {
                    console.warn("⚠️ Profil neexistuje v userProfiles, načítám profily znovu...");
                    await window.loadUserProfiles();

                    const profileExistsAfterReload = window.userProfiles && window.userProfiles.some(p => p.id === profileId);
                    if (!profileExistsAfterReload) {
                        console.error("❌ Profil stále neexistuje po načtení:", profileId);
                        return;
                    }
                }

                window.currentProfileId = profileId;
                console.log("✅ Aktuální profil nastaven:", profileId);

                // Načtení a zobrazení názvu profilu
                console.log("🔄 Načítám a zobrazuji aktuální profil...");
                await window.loadAndDisplayCurrentProfile();

                // Načtení nastavení pro vybraný profil
                console.log("🔍 Načítám nastavení pro vybraný profil...");
                await loadUserSettings();

                // Aktualizace nastavení
                console.log("🔄 Aktualizuji informace o profilu v nastavení...");
                updateSettingsProfileInfo();

                console.log("✅ Profil úspěšně vybrán a nastaven jako aktivní");

            } catch (error) {
                console.error("❌ Chyba při výběru profilu:", error);
            }
        };

        // Event listenery pro přepínače - přidejte debugování
        document.addEventListener('DOMContentLoaded', function () {
            // Přidejte tyto console.log do každého event listeneru
            const toggles = [
                'confirmRecipeCreationToggle',
                'confirmFoodAdditionToggle',
                'confirmDeleteRecipeToggle',
                'confirmDeleteRecipeItemToggle',
                'confirmSaveChangesToggle',
                'confirmRecipeSaveSuccessToggle',
                'confirmRecipeDeletionSuccessToggle',
                'confirmRecipeDeletionErrorToggle'
            ];

            toggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', function () {
                        const settingKey = toggleId.replace('Toggle', '');
                        userSettings[settingKey] = this.checked;
                        console.log(`🎯 Přepínač ${toggleId} změněn na:`, this.checked);
                        console.log(`💾 Ukládám ${settingKey}:`, this.checked);
                        saveUserSettings();
                    });
                }
            });
        });

        // Hlavní inicializační funkce - UPRAVENÁ
        async function initializeApplication() {
            console.log("🔍 Před inicializací - window.supabaseClient:", !!window.supabaseClient);
            console.log("🎯 initializeApplication volána");

            try {
                // 1. Inicializace Supabase
                console.log("🔄 Krok 1: Inicializace Supabase...");
                const supabaseInitialized = await window.initializeSupabase();

                console.log("🔍 Po inicializací - window.supabaseClient:", !!window.supabaseClient);

                if (!supabaseInitialized) {
                    console.log("⚠️ Supabase inicializace selhala - pokračuji v lokálním režimu");
                }

                // 2. Kontrola existující session
                console.log("🔄 Krok 2: Kontrola session...");
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();

                if (session && session.user) {
                    console.log("✅ Session nalezena, user:", session.user.id, "email:", session.user.email);

                    // ROZHODNUTÍ: Pokud uživatel má email, pokračujeme, jinak zobrazíme přihlášení
                    if (session.user.email) {
                        console.log("✅ Uživatel má email - pokračujeme");
                        window.currentUser = session.user;
                        await continueWithUser(session.user);
                    } else {
                        console.log("ℹ️ Uživatel je anonymní - zobrazuji přihlašovací modal");
                        window.currentUser = session.user; // Uložíme anonymního uživatele prozatím
                        showLoginModal();
                    }
                } else {
                    // 3. Pokud není session, zobraz přihlašovací modal
                    console.log("ℹ️ Žádná session - zobrazuji přihlašovací modal");
                    showLoginModal();
                }

            } catch (error) {
                console.error("❌ Chyba při inicializaci:", error);
                showLoginModal();
            }
        }

        // Event listener pro přihlašovací tlačítko v headeru
        document.getElementById('loginMenuBtn').addEventListener('click', function () {
            showLoginModal();
        });

        // Funkce pro sbalení všech rozbalených sekcí - VYLEPŠENÁ
        function collapseAllSettingsSections() {
            console.log("🔄 Sbalení všech rozbalených sekcí...");

            const sectionHeaders = document.querySelectorAll('.setting-section-header');
            let foundOpen = false;

            sectionHeaders.forEach(header => {
                const content = header.nextElementSibling;
                const arrow = header.querySelector('.setting-section-arrow');

                if (content && content.classList.contains('setting-section-content')) {
                    // Sbalit pouze pokud je sekce otevřená
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
                    if (isOpen) {
                        content.style.maxHeight = "0";
                        content.style.opacity = "0";
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                        header.classList.remove('active');
                        foundOpen = true;
                        console.log("✅ Sekce sbalena");
                    }
                }
            });

            // Pokud jsme něco sbalili, vrátit true
            return foundOpen;
        }

        // Upravte všechny zavírací funkce pro modální okna
        function setupModalCloseHandlers() {
            console.log("🎯 Nastavování zavíracích handlerů...");

            // Zavírání modálního okna nastavení křížkem
            document.getElementById('closeSettingsModal').addEventListener('click', function () {
                collapseAllSettingsSections();
                setTimeout(() => {
                    document.getElementById('settingsModal').style.display = 'none';
                }, 100);
            });

            // Zavírání modálního okna nastavení kliknutím mimo - OPRAVENÉ
            document.getElementById('settingsModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    const hadOpenSections = collapseAllSettingsSections();

                    // Pokud byly otevřené sekce, počkáme na animaci, jinak zavřeme hned
                    const delay = hadOpenSections ? 150 : 0;

                    setTimeout(() => {
                        this.style.display = 'none';
                    }, delay);
                }
            });

            // Zavírání modálního okna profilů
            document.getElementById('closeProfileModal').addEventListener('click', function () {
                // Pro jistotu sbalit i zde (pokud by byly nějaké sekce)
                collapseAllSettingsSections();
                document.getElementById('profileModal').style.display = 'none';
            });

            // Zavírání modálního okna vytvoření profilu
            document.getElementById('closeCreateProfileModal').addEventListener('click', function () {
                collapseAllSettingsSections();
                document.getElementById('createProfileModal').style.display = 'none';
            });

            // Zavírání modálního okna receptů
            document.getElementById('closeSelectRecipeModal').addEventListener('click', function () {
                collapseAllSettingsSections();
                document.getElementById('selectRecipeModal').style.display = 'none';
            });

            // Zavírání modálního okna vytvoření receptu
            document.getElementById('closeCreateRecipeModal').addEventListener('click', function () {
                collapseAllSettingsSections();
                document.getElementById('createRecipeModal').style.display = 'none';
            });
        }

        // Inicializace při načtení DOM
        document.addEventListener('DOMContentLoaded', function () {
            setupModalCloseHandlers();
        });

        // Také přidejte sbalení při přepnutí účtu
        document.getElementById('switchAccountBtn').addEventListener('click', async function () {
            collapseAllSettingsSections();
            await logoutUser();
            showLoginModal();
        });

        // Funkce pro aktualizaci zobrazení přihlašovacího tlačítka
        function updateLoginButton() {
            const loginBtn = document.getElementById('loginMenuBtn');
            if (window.currentUser && window.currentUser.email) {
                // Uživatel je přihlášen s emailem - skrýt tlačítko
                loginBtn.style.display = 'none';
                loginBtn.textContent = `Přihlášen: ${window.currentUser.email}`;
            } else {
                // Uživatel je anonymní nebo není přihlášen - zobrazit tlačítko
                loginBtn.style.display = 'block';
                loginBtn.textContent = 'Přihlásit se';
            }
        }

        // Funkce pro pokračování s přihlášeným uživatelem - OPRAVENÁ
        async function continueWithUser(user) {
            window.currentUser = user;
            console.log("👤 Pokračuji s uživatelem:", user.id, "email:", user.email);

            // Aktualizovat přihlašovací tlačítko
            updateLoginButton();

            // Načtení profilů
            await window.loadUserProfiles();

            console.log("📊 Počet profilů pro uživatele:", window.userProfiles.length);

            // ROZHODNUTÍ O ZOBRAZENÍ PROFILŮ - OPRAVENÉ
            if (window.userProfiles.length === 0) {
                console.log("ℹ️ Žádné profily - zobrazuji vytvoření prvního profilu");
                window.showCreateProfileModal();
            } else if (window.userProfiles.length === 1) {
                console.log("ℹ️ Pouze jeden profil - automaticky vybírám");
                const singleProfile = window.userProfiles[0];
                console.log("🎯 Automaticky vybírám profil:", singleProfile.id, singleProfile.name);

                // VOLAT selectProfile PRO AKTIVACI PROFILU
                await window.selectProfile(singleProfile.id);

                window.showCustomNotification(`Profil "${singleProfile.name}" byl automaticky vybrán`, 'info');
            } else {
                console.log("ℹ️ Více profilů - zobrazuji výběr");
                // Krátké zpoždění pro lepší UX
                setTimeout(() => {
                    window.showProfileModal();
                }, 500);
            }

            window.isAppInitialized = true;

            // Povolit funkce aplikace
            const recipesButton = document.getElementById('recipesButton');
            if (recipesButton) {
                recipesButton.disabled = false;
                console.log("✅ Tlačítko Recepty povoleno");
            }
        }

        // Inicializace Supabase - zajistěte globální dostupnost
        window.initializeSupabase = async function () {
            try {
                const bodyElement = document.body;
                const supabaseUrl = bodyElement.dataset.supabaseUrl;
                const supabaseKey = bodyElement.dataset.supabaseKey;

                console.log("🔗 Inicializace Supabase...");
                console.log("📡 URL:", supabaseUrl);
                console.log("🔑 Key dostupná:", !!supabaseKey);

                if (!supabaseUrl || !supabaseKey) {
                    console.error("❌ Chybí Supabase konfigurace");
                    return false;
                }

                if (typeof supabase === 'undefined') {
                    console.error("❌ Supabase SDK není načteno");
                    return false;
                }

                // VYTVOŘIT GLOBÁLNÍ SUPABASE CLIENT
                const { createClient } = supabase;
                window.supabaseClient = createClient(supabaseUrl, supabaseKey, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                    }
                });

                console.log("✅ Supabase klient vytvořen:", !!window.supabaseClient);
                console.log("🔍 Auth klient:", !!window.supabaseClient.auth);

                // Test připojení - jednodušší test
                console.log("🔄 Testuji připojení...");
                const { data, error } = await window.supabaseClient
                    .from('profiles')
                    .select('count')
                    .limit(1);

                if (error) {
                    console.error("❌ Test připojení selhal:", error);
                    // Pokračujeme i při chybě - může to být kvůli RLS
                    console.log("ℹ️ Pokračuji s lokálním režimem");
                    return true;
                }

                console.log("✅ Supabase klient inicializován a připojen");
                console.log("🔍 window.supabaseClient:", !!window.supabaseClient);
                return true;

            } catch (error) {
                console.error("❌ Chyba při inicializaci Supabase:", error);
                console.log("ℹ️ Pokračuji s lokálním režimem");
                return true; // Vracíme true, aby aplikace mohla pokračovat
            }
        };

        // Kontrola autentizace
        async function checkAuth() {
            console.log("🎯 checkAuth volána");

            if (!window.supabaseClient) {
                console.error("❌ Supabase klient není inicializován");
                return createLocalUser();
            }

            try {
                console.log("🔍 Kontroluji session...");

                // Kontrola, zda je auth dostupný
                if (!window.supabaseClient.auth) {
                    console.log("ℹ️ Auth není dostupné - používám lokálního uživatele");
                    return createLocalUser();
                }

                const { data: { session }, error } = await window.supabaseClient.auth.getSession();

                if (error) {
                    console.error("❌ Chyba při kontrole session:", error);
                    return await attemptAnonymousSignIn();
                }

                if (session && session.user) {
                    console.log("✅ Session nalezena, user:", session.user.id);
                    window.currentUser = session.user;
                    return session.user;
                } else {
                    console.log("ℹ️ Žádná session - zkouším anonymní přihlášení");
                    return await attemptAnonymousSignIn();
                }
            } catch (error) {
                console.error("❌ Neočekávaná chyba při autentizaci:", error);
                return createLocalUser();
            }
        }

        // Pokus o anonymní přihlášení
        async function attemptAnonymousSignIn() {
            try {
                console.log("🔄 Pokus o anonymní přihlášení...");

                // Kontrola, zda je auth dostupný
                if (!window.supabaseClient || !window.supabaseClient.auth) {
                    console.log("ℹ️ Auth není dostupné - používám lokálního uživatele");
                    return createLocalUser();
                }

                const { data, error } = await window.supabaseClient.auth.signInAnonymously();

                if (error) {
                    console.error("❌ Anonymní přihlášení selhalo:", error);
                    return createLocalUser();
                }

                if (data && data.user) {
                    console.log("✅ Anonymní uživatel přihlášen:", data.user.id);
                    window.currentUser = data.user;
                    return data.user;
                }

                throw new Error("Neplatná odpověď od Supabase");

            } catch (error) {
                console.error("❌ Chyba při anonymním přihlášení:", error);
                return createLocalUser();
            }
        }

        // Vytvoření lokálního uživatele
        function createLocalUser() {
            console.log("🔄 Vytvářím lokálního uživatele...");

            // Generujeme UUID formát místo "local-user-"
            const generateUUID = () => {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            };

            window.currentUser = {
                id: generateUUID(), // UUID formát
                email: null,
                is_anonymous: true,
                is_local: true
            };
            console.log("✅ Lokální uživatel vytvořen:", window.currentUser.id);
            return window.currentUser;
        }

        async function createNewProfile(profileName) {
            if (window.isCreatingProfile) {
                console.log("⚠️ Vytváření profilu již probíhá - přeskočeno");
                return null;
            }

            window.isCreatingProfile = true;

            console.log("🎯 ===== CREATE NEW PROFILE START =====");
            console.log("📝 Jméno profilu:", profileName);

            if (!profileName || profileName.trim() === '') {
                console.error("❌ Název profilu je prázdný");
                window.showCustomNotification("Prosím, zadejte název profilu.", 'error');
                window.isCreatingProfile = false;
                return null;
            }

            try {
                const trimmedName = profileName.trim();
                let newProfileId = null;
                let newProfileData = null;

                // POUZE SUPABASE
                if (window.supabaseClient && window.currentUser && !window.currentUser.is_local) {
                    console.log("🔄 Ukládám profil do Supabase...");

                    const profileData = {
                        name: trimmedName,
                        user_id: window.currentUser.id,
                        created_at: new Date().toISOString()
                    };

                    console.log("📦 Data pro insert:", profileData);

                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .insert(profileData)
                        .select()
                        .single();

                    if (error) {
                        console.error("❌ Chyba při ukládání do Supabase:", error);
                        throw error;
                    } else {
                        console.log("✅ ÚSPĚCH: Profil uložen do Supabase!");
                        newProfileId = data.id;
                        newProfileData = data; // Uložit celá data

                        // PŘIDAT PROFIL DO LOKÁLNÍHO POLE - OPRAVA
                        if (!window.userProfiles) window.userProfiles = [];
                        window.userProfiles.push(data);
                        console.log("✅ Profil přidán do userProfiles, nový počet:", window.userProfiles.length);

                        // Inicializace nastavení pro nový profil
                        try {
                            await initializeSettingsForNewProfile(newProfileId);
                        } catch (settingsError) {
                            console.log("⚠️ Nastavení se nepodařilo inicializovat, ale profil byl vytvořen");
                        }
                    }
                } else {
                    console.error("❌ Nelze vytvořit profil - není připojení nebo anonymní uživatel");
                    throw new Error("Pro vytvoření profilu se musíte přihlásit a mít internetové připojení");
                }

                console.log("✅ Profil úspěšně vytvořen:", newProfileId);

                // AUTOMATICKÉ NASTAVENÍ JAKO AKTIVNÍ PROFIL
                console.log("🎯 Nastavuji nový profil jako aktivní:", newProfileId);
                await window.selectProfile(newProfileId);

                window.showCustomNotification(`Profil "${trimmedName}" byl úspěšně vytvořen a nastaven jako aktivní!`, 'success');
                return newProfileId;

            } catch (error) {
                console.error("❌ Chyba při vytváření profilu:", error);
                window.showCustomNotification("Chyba při vytváření profilu: " + error.message, 'error');
                return null;
            } finally {
                window.isCreatingProfile = false;
            }
        }

        // NOVÁ FUNKCE: Inicializace nastavení pro nový profil - VŠE TRUE
        async function initializeSettingsForNewProfile(profileId) {
            console.log("🎯 Inicializace nastavení pro nový profil:", profileId);

            // Výchozí nastavení - VŠECHNA DIALOGOVÁ OKNA ZAPNUTÁ
            const defaultSettings = {
                confirmRecipeCreation: true,
                confirmFoodAddition: true,
                confirmDeleteRecipe: true,
                confirmDeleteRecipeItem: true,
                confirmSaveChanges: true,
                confirmRecipeSaveSuccess: true,
                confirmRecipeDeletionSuccess: true,
                confirmRecipeDeletionError: true
            };

            // POUZE SUPABASE
            if (window.supabaseClient && window.currentUser && !window.currentUser.is_local) {
                try {
                    console.log("💾 Ukládám výchozí nastavení do sloupce profiles...");

                    // UKLÁDÁME NASTAVENÍ PŘÍMO DO TABULKY PROFILES
                    const { error } = await window.supabaseClient
                        .from('profiles')
                        .update({
                            settings: defaultSettings,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', profileId);

                    if (error) {
                        console.error("❌ Chyba při ukládání nastavení:", error);
                        console.log("⚠️ Nastavení se nepodařilo uložit, ale profil byl vytvořen");
                    } else {
                        console.log("✅ Výchozí nastavení uloženo do profiles");
                    }
                } catch (error) {
                    console.error("❌ Chyba při inicializaci nastavení:", error);
                    console.log("⚠️ Chyba inicializace nastavení, ale profil byl vytvořen");
                }
            }

            // Aktualizace globální proměnné
            userSettings = defaultSettings;
            console.log("✅ Globální userSettings aktualizováno na:", userSettings);

            return true;
        }

        // Vylepšená loadUserProfiles pro produkci
        window.loadUserProfiles = async function () {
            console.log("🎯 loadUserProfiles volána - POUZE ONLINE");

            if (window.isLoadingProfiles) {
                console.log("⚠️ Načítání již probíhá - přeskočeno");
                return;
            }

            window.isLoadingProfiles = true;

            try {
                if (!window.currentUser) {
                    console.error("❌ loadUserProfiles: currentUser je undefined");
                    window.userProfiles = [];
                    return;
                }

                console.log("👤 CurrentUser:", window.currentUser);
                console.log("🔗 SupabaseClient:", !!window.supabaseClient);

                // POUZE SUPABASE - žádné localStorage fallbacky
                if (window.supabaseClient && !window.currentUser.is_local) {
                    try {
                        console.log("🔍 Načítám data z Supabase...");
                        console.log("📊 User ID pro query:", window.currentUser.id);

                        const { data, error } = await window.supabaseClient
                            .from('profiles')
                            .select('*')
                            .eq('user_id', window.currentUser.id)
                            .order('created_at', { ascending: true });

                        console.log("📦 Supabase odpověď:", { data, error });

                        if (error) {
                            console.error("❌ Chyba Supabase:", error);
                            throw error; // Žádný fallback
                        } else if (data) {
                            console.log("✅ Data z Supabase:", data);
                            window.userProfiles = data;
                        }
                    } catch (dbError) {
                        console.error("❌ Chyba při načítání z Supabase:", dbError);
                        throw dbError; // Propagovat chybu výše
                    }
                } else {
                    console.error("❌ Nelze načíst profily - anonymní uživatel nebo chybí Supabase");
                    window.userProfiles = [];
                }

            } catch (error) {
                console.error("❌ Neočekávaná chyba:", error);
                window.userProfiles = [];
                throw error;
            } finally {
                window.isLoadingProfiles = false;
                console.log("🎯 loadUserProfiles dokončena");
                console.log("📊 Celkem profilů:", window.userProfiles.length);
            }
        };

        // Synchronizace lokálních dat s Supabase (volitelné)
        async function syncLocalDataWithSupabase() {
            if (!supabaseClient || currentUser.is_anonymous) {
                return;
            }

            try {
                // Synchronizace profilů
                const localProfiles = userProfiles.filter(p => p.is_local);
                for (const profile of localProfiles) {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .insert({
                            name: profile.name,
                            user_id: currentUser.id
                        })
                        .select()
                        .single();

                    if (!error) {
                        // Aktualizovat ID profilu
                        profile.id = data.id;
                        profile.is_local = false;
                        debugLog("✅ Profil synchronizován: " + profile.name);
                    }
                }

                // Uložit aktualizované profily
                localStorage.setItem(`userProfiles_${currentUser.id}`, JSON.stringify(userProfiles));

            } catch (error) {
                debugLog("❌ Chyba při synchronizaci: " + error.message);
            }
        }

        // Přidejte další časté chyby čtení

        let currentSearchXHR = null;
        let currentSearchController = null;
        let currentReader = null;
        let isSearchInterrupted = false;
        let app, db, auth, userId;
        let isAuthReady = false;
        let userSettings = {
            confirmRecipeCreation: true, // Default value
            confirmFoodAddition: true, // Default value
            confirmDeleteRecipe: true, // New default value for delete confirmation
            confirmDeleteRecipeItem: true, // New setting for deleting recipe items
            confirmSaveChanges: true, // Re-added
            confirmRecipeSaveSuccess: true, // Re-added
            confirmRecipeDeletionSuccess: true, // New setting for success message
            confirmRecipeDeletionError: true // New setting for error message
        };

        // Declare currentFoodItemData in global scope
        let currentFoodItemData = null; // To store data of the food item being processed
        let currentEditingRecipeId = null; // Store the ID of the recipe being edited
        let currentEditingIngredientIndex = null; // Store the index of the ingredient being edited
        const placeholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}"; // Add this line

        // Globální proměnné pro správu profilů
        let userProfiles = [];
        let isCreatingProfile = false;

        // Funkce pro otevření modálního okna profilu
        function openProfileModalFromDisplay() {
            if (isAppInitialized && userId) {
                showProfileModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('detailsModal');
            modal.style.display = 'none';
            modal.classList.remove('modal-recipe-open'); // Vždy odstranit při zavření
        }

        // Načtení a zobrazení aktuálního profilu
        window.loadAndDisplayCurrentProfile = async function () {
            console.log("🔄 loadAndDisplayCurrentProfile volána, currentProfileId:", window.currentProfileId);

            if (!window.currentProfileId) {
                console.log("ℹ️ Žádný aktuální profil - skrývám zobrazení");
                window.hideCurrentProfileDisplay();
                return;
            }

            try {
                const profile = window.userProfiles.find(p => p.id === window.currentProfileId);
                if (profile) {
                    console.log("✅ Nalezen profil:", profile.name);
                    window.updateCurrentProfileDisplay(profile.name);

                    // Načíst nastavení pro aktuální profil
                    console.log("🔍 Načítám nastavení pro aktuální profil...");
                    await loadUserSettings();
                } else {
                    console.error("❌ Profil nebyl nalezen v userProfiles:", window.currentProfileId);
                    window.hideCurrentProfileDisplay();
                }
            } catch (error) {
                console.error("❌ Chyba při načítání profilu:", error);
                window.hideCurrentProfileDisplay();
            }
        };

        function checkInitialization() {
            if (!isAppInitialized || !db || !userId || !currentProfileId) {
                window.showCustomNotification("Prosím, počkejte, než se aplikace plně inicializuje.", 'info');
                return false;
            }
            return true;
        }

        function showGlobalLoading() {
            document.getElementById('globalLoading').style.display = 'block';
        }

        function hideGlobalLoading() {
            document.getElementById('globalLoading').style.display = 'none';
        }

        // Uložení přihlašovacích údajů do localStorage
        function saveLoginSession(user) {
            localStorage.setItem('userData', JSON.stringify({
                uid: user.uid,
                email: user.email,
                lastLogin: new Date().toISOString()
            }));
        }

        // Kontrola existující relace
        function checkExistingSession() {
            const userData = localStorage.getItem('userData');
            if (userData) {
                return JSON.parse(userData);
            }
            return null;
        }

        // Funkce pro zobrazení modálního okna pro vytvoření nového profilu
        window.showCreateProfileModal = function () {
            console.log("🎯 showCreateProfileModal volána");

            const createProfileModal = document.getElementById('createProfileModal');
            const newProfileNameInput = document.getElementById('newProfileName');

            if (newProfileNameInput) {
                newProfileNameInput.addEventListener('keypress', function (event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log("🎯 Enter stisknut v inputu - spouštím vytváření");
                        document.getElementById('confirmCreateProfile').click();
                    }
                });
            }

            if (!createProfileModal) {
                console.error("❌ createProfileModal element not found!");
                return;
            }

            // Zkontrolujte, zda modální okno již je zobrazeno
            if (createProfileModal.style.display === 'flex') {
                console.log("ℹ️ Create profile modal already shown");
                return;
            }

            // Resetovat vstupní pole
            if (newProfileNameInput) {
                newProfileNameInput.value = '';
            }

            // Zobrazit modální okno
            createProfileModal.style.display = 'flex';
            console.log("✅ Create profile modal zobrazen");

            // Focus na vstupní pole
            setTimeout(() => {
                if (newProfileNameInput) {
                    newProfileNameInput.focus();
                    console.log("🎯 Focus na input field");
                }
            }, 100);
        };

        // Validace inputu
        document.getElementById('newProfileName').addEventListener('input', function (e) {
            const confirmBtn = document.getElementById('confirmCreateProfile');
            confirmBtn.disabled = e.target.value.trim().length === 0;
        });

        // Funkce pro zavření modalu profilů - UPRAVTE TUTO FUNKCI
        function closeProfileModal() {
            console.log("🎯 Zavírám profile modal");
            const profileModal = document.getElementById('profileModal');
            if (profileModal) {
                profileModal.style.display = 'none';
            }
            window.isProfileModalShowing = false;
            console.log("🔍 Nastaveno isProfileModalShowing na:", window.isProfileModalShowing);

            // ODSTRANIT event listenery pro zavírání, aby se nepřidávaly duplicitně
            const closeBtn = document.getElementById('closeProfileModal');
            if (closeBtn) {
                closeBtn.replaceWith(closeBtn.cloneNode(true));
            }
        }

        // Přidejte tuto funkci pro sledování změn modalu
        function initializeModalCloseHandlers() {
            const profileModal = document.getElementById('profileModal');
            if (!profileModal) return;

            // Sledovat změny ve visibility modalu
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.attributeName === 'style') {
                        const displayStyle = profileModal.style.display;
                        if (displayStyle === 'none' && window.isProfileModalShowing) {
                            console.log("🔍 Modal byl skryt jiným způsobem - opravuji stav");
                            window.isProfileModalShowing = false;
                        }
                    }
                });
            });

            observer.observe(profileModal, {
                attributes: true,
                attributeFilter: ['style']
            });
        }

        // Voláme při načtení stránky
        document.addEventListener('DOMContentLoaded', function () {
            initializeModalCloseHandlers();
        });

        // Funkce pro zobrazení modálního okna s profily
        window.showProfileModal = async function () {
            console.log("🎯 showProfileModal volána - aktuální počet profilů:", window.userProfiles ? window.userProfiles.length : 0);

            // Zabránit vícenásobnému zobrazení
            if (window.isProfileModalShowing) {
                console.log("⚠️ Modal již je zobrazen - přeskočeno");
                return;
            }

            const profileModal = document.getElementById('profileModal');
            if (!profileModal) {
                console.error("❌ Profile modal element not found!");
                return;
            }

            window.isProfileModalShowing = true;
            console.log("🔍 Nastaveno isProfileModalShowing na:", window.isProfileModalShowing);

            try {
                console.log("🔄 Příprava modálního okna...");

                // ZOBRAZIT MODAL OKAMŽITĚ - před načtením dat
                profileModal.style.display = 'flex';

                // Načtení existujících profilů (pro jistotu)
                await window.loadUserProfiles();

                // Vytvoření seznamu profilů
                const profileList = document.getElementById('profileList');
                if (profileList) {
                    profileList.innerHTML = '';

                    if (!window.userProfiles || window.userProfiles.length === 0) {
                        // Žádné profily - zobrazit speciální zprávu
                        profileList.innerHTML = `
                    <div class="no-profiles">
                        <div class="no-profiles-icon">👤</div>
                        <div class="no-profiles-title">Žádné profily</div>
                        <div class="no-profiles-text">Vytvořte si první profil pro ukládání receptů a nastavení</div>
                        <button id="createFirstProfileBtn" class="create-first-profile-btn">
                            Vytvořit první profil
                        </button>
                    </div>
                `;

                        // Event listener pro vytvoření prvního profilu
                        document.getElementById('createFirstProfileBtn').addEventListener('click', function () {
                            console.log("🎯 Kliknuto na vytvoření prvního profilu");
                            closeProfileModal();
                            window.showCreateProfileModal();
                        });

                    } else {
                        console.log("📊 Zobrazuji profily:", window.userProfiles.length);

                        // Přidat informaci o aktuálním uživateli
                        const userInfo = document.createElement('div');
                        userInfo.className = 'user-info-header';
                        userInfo.innerHTML = `
                    <div class="user-email">${window.currentUser?.email || 'Anonymní uživatel'}</div>
                    <div class="profile-count">Dostupné profily: ${window.userProfiles.length}</div>
                    <div class="profile-instruction">Klikněte na profil pro výběr</div>
                `;
                        profileList.appendChild(userInfo);

                        window.userProfiles.forEach(profile => {
                            const profileItem = document.createElement('div');
                            profileItem.classList.add('profile-item');
                            if (profile.id === window.currentProfileId) {
                                profileItem.classList.add('active');
                            }

                            profileItem.innerHTML = `
                                <div class="profile-name-container">
                                    <span class="profile-name">${profile.name}</span>
                                    ${profile.id === window.currentProfileId ? '<span class="current-profile-badge">Aktivní</span>' : ''}
                                </div>
                                <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat" class="profile-delete" data-profile-id="${profile.id}">
                            `;

                            profileItem.addEventListener('click', (e) => {
                                if (!e.target.classList.contains('profile-delete')) {
                                    console.log("🎯 Vybrán profil:", profile.name);
                                    window.selectProfile(profile.id);
                                    closeProfileModal(); // ZAVŘÍT MODAL PO VÝBĚRU
                                }
                            });

                            // Event listener pro smazání
                            const deleteBtn = profileItem.querySelector('.profile-delete');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    e.preventDefault();

                                    const profileId = e.target.dataset.profileId;
                                    const profile = window.userProfiles.find(p => p.id === profileId);

                                    if (profileId && profile) {
                                        await window.deleteProfile(profileId);
                                        // NENÍ POTŘEBA VOLAT showProfileModal() - už se volá v refreshProfileDisplayAfterDelete()
                                    }
                                });
                            }

                            profileList.appendChild(profileItem);
                        });
                    }
                }

                // PŘIDAT JEDNOU event listener pro zavření křížkem
                const closeProfileModalBtn = document.getElementById('closeProfileModal');
                if (closeProfileModalBtn) {
                    closeProfileModalBtn.onclick = closeProfileModal; // Použijte onclick místo addEventListener
                }

                // PŘIDAT JEDNOU event listener pro zavření kliknutím mimo
                profileModal.onclick = function (event) {
                    if (event.target === profileModal) {
                        console.log("🎯 Kliknuto mimo modal - zavírám");
                        closeProfileModal();
                    }
                };

                console.log("✅ Profile modal kompletně připraven");

            } catch (error) {
                console.error("❌ Error showing profile modal:", error);
                window.isProfileModalShowing = false;
            }
        };

        // Zobrazení aktuálního profilu s emailem - UPRAVENO
        window.updateCurrentProfileDisplay = function (profileName) {
            const profileDisplay = document.getElementById('currentProfileDisplay');
            const profileNameSpan = document.getElementById('currentProfileName');
            const profileEmailSpan = document.getElementById('currentProfileEmail');

            if (profileDisplay && profileNameSpan && profileEmailSpan) {
                profileNameSpan.textContent = profileName;

                // Zobrazit email pokud je uživatel přihlášený
                if (window.currentUser && window.currentUser.email) {
                    profileEmailSpan.textContent = window.currentUser.email;
                    profileEmailSpan.style.display = 'block';
                } else {
                    profileEmailSpan.style.display = 'none';
                }

                // SKRYTÍ původního zobrazení - přidáno
                profileDisplay.style.display = 'none';
                console.log("✅ Původní zobrazení profilu skryto");

                // Aktualizace nastavení - přidáno
                updateSettingsProfileInfo();
            }
        };

        function attachProfileClickListener() {
            const profileDisplay = document.getElementById('currentProfileDisplay');
            if (profileDisplay) {
                console.log("🎯 Přidávám click listener k profilu");

                // Odstranit všechny existující event listenery
                profileDisplay.replaceWith(profileDisplay.cloneNode(true));
                const newProfileDisplay = document.getElementById('currentProfileDisplay');

                newProfileDisplay.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("🎯 Kliknuto na profil v headeru");
                    console.log("🔍 Stav isProfileModalShowing:", window.isProfileModalShowing);
                    window.showProfileModal();
                });
            }
        }

        // Skrytí zobrazení profilu
        window.hideCurrentProfileDisplay = function () {
            const profileDisplay = document.getElementById('currentProfileDisplay');
            if (profileDisplay) {
                profileDisplay.style.display = 'none';
            }
        };

        // Načtení dat profilu
        async function loadProfileData() {
            if (!currentProfileId) return;
            debugLog("🔄 Načítám data profilu: " + currentProfileId);

            // Zde můžete načíst nastavení, recepty, etc.
            await loadUserSettings();
            await loadUserRecipes();
        }

        // Funkce pro smazání profilu - OPRAVENÁ
        window.deleteProfile = async function (profileId) {
            const profileToDelete = window.userProfiles.find(p => p.id === profileId);
            if (!profileToDelete) {
                console.error("❌ Profil k smazání nebyl nalezen:", profileId);
                return;
            }

            if (!confirm(`Opravdu chcete smazat profil "${profileToDelete.name}"? Všechna data budou nenávratně ztracena.`)) {
                return;
            }

            console.log("🗑️ Mazání profilu:", profileId, "název:", profileToDelete.name);

            try {
                // SMĚZÁNÍ Z SUPABASE
                if (window.supabaseClient && !profileId.startsWith('local-')) {
                    try {
                        console.log("🔄 Mažu z Supabase...");
                        const { error } = await window.supabaseClient
                            .from('profiles')
                            .delete()
                            .eq('id', profileId);

                        if (error) {
                            console.error("❌ Chyba při mazání z Supabase:", error);
                            throw error;
                        }
                        console.log("✅ Profil smazán z Supabase");
                    } catch (dbError) {
                        console.error("❌ Selhalo mazání z Supabase:", dbError);
                        throw dbError;
                    }
                }

                // ODEBRÁNÍ Z POLE userProfiles
                window.userProfiles = window.userProfiles.filter(profile => profile.id !== profileId);
                console.log("✅ Profil odebrán z userProfiles");

                // Feedback pro uživatele
                window.showCustomNotification(`Profil "${profileToDelete.name}" byl úspěšně smazán`, 'success');

                // OKAMŽITÉ OBNOVENÍ ZOBRAZENÍ PROFILŮ - OPRAVENÉ
                await refreshProfileDisplayAfterDelete(profileId);

            } catch (error) {
                console.error("Chyba při mazání profilu:", error);
                window.showCustomNotification("Chyba při mazání profilu: " + error.message, 'error');
            }
        };

        // NOVÁ FUNKCE: Obnovení zobrazení profilů po smazání - OPRAVENÁ
        async function refreshProfileDisplayAfterDelete(deletedProfileId) {
            console.log("🔄 Obnovuji zobrazení profilů po smazání...");

            // 1. Znovu načíst profily z databáze pro aktuálnost
            await window.loadUserProfiles();
            console.log("✅ Profily znovu načteny, zbývá:", window.userProfiles.length);

            // 2. Zkontrolovat a upravit aktuální profil
            if (window.currentProfileId === deletedProfileId) {
                console.log("ℹ️ Aktuální profil byl smazán, hledám náhradní...");

                if (window.userProfiles.length > 0) {
                    window.currentProfileId = window.userProfiles[0].id;
                    console.log("✅ Nový aktuální profil:", window.currentProfileId);

                    // Načíst nastavení pro nový profil
                    await loadUserSettings();
                    await window.loadAndDisplayCurrentProfile();

                    window.showCustomNotification(`Aktivní profil změněn na "${window.userProfiles[0].name}"`, 'info');
                } else {
                    window.currentProfileId = null;
                    window.hideCurrentProfileDisplay();
                    console.log("ℹ️ Žádné profily nezůstaly");
                    window.showCustomNotification("Všechny profily byly smazány. Vytvořte si nový profil.", 'info');
                }
            }

            // 3. Znovu zobrazit modální okno s aktuálním seznamem - POUZE POKUD JE OTEVŘENÉ
            const profileModal = document.getElementById('profileModal');
            if (profileModal && profileModal.style.display === 'flex') {
                console.log("🔄 Znovu zobrazuji modální okno profilů...");
                // Zavřít a znovu otevřít pro kompletní obnovení
                profileModal.style.display = 'none';
                window.isProfileModalShowing = false;

                setTimeout(async () => {
                    await window.showProfileModal();
                }, 100);
            }

            console.log("✅ Zobrazení profilů obnoveno");
        }

        // NOVÁ FUNKCE: Obnovení zobrazení profilů
        async function refreshProfileDisplay() {
            console.log("🔄 Obnovuji zobrazení profilů...");

            // Znovu načíst profily z databáze pro aktuálnost
            await window.loadUserProfiles();

            // Znovu zobrazit modální okno s aktuálním seznamem
            await window.showProfileModal();

            console.log("✅ Zobrazení profilů obnoveno");
        }

        // Funkce pro aktualizaci UI podle nastavení
        function updateSettingsUI() {
            // Aktualizace přepínačů v nastavení
            const confirmRecipeCreationToggle = document.getElementById('confirmRecipeCreationToggle');
            const confirmFoodAdditionToggle = document.getElementById('confirmFoodAdditionToggle');
            const confirmDeleteRecipeToggle = document.getElementById('confirmDeleteRecipeToggle');
            const confirmDeleteRecipeItemToggle = document.getElementById('confirmDeleteRecipeItemToggle');
            const confirmSaveChangesToggle = document.getElementById('confirmSaveChangesToggle');
            const confirmRecipeSaveSuccessToggle = document.getElementById('confirmRecipeSaveSuccessToggle');
            const confirmRecipeDeletionSuccessToggle = document.getElementById('confirmRecipeDeletionSuccessToggle');
            const confirmRecipeDeletionErrorToggle = document.getElementById('confirmRecipeDeletionErrorToggle');

            if (confirmRecipeCreationToggle) confirmRecipeCreationToggle.checked = userSettings.confirmRecipeCreation;
            if (confirmFoodAdditionToggle) confirmFoodAdditionToggle.checked = userSettings.confirmFoodAddition;
            if (confirmDeleteRecipeToggle) confirmDeleteRecipeToggle.checked = userSettings.confirmDeleteRecipe;
            if (confirmDeleteRecipeItemToggle) confirmDeleteRecipeItemToggle.checked = userSettings.confirmDeleteRecipeItem;
            if (confirmSaveChangesToggle) confirmSaveChangesToggle.checked = userSettings.confirmSaveChanges;
            if (confirmRecipeSaveSuccessToggle) confirmRecipeSaveSuccessToggle.checked = userSettings.confirmRecipeSaveSuccess;
            if (confirmRecipeDeletionSuccessToggle) confirmRecipeDeletionSuccessToggle.checked = userSettings.confirmRecipeDeletionSuccess;
            if (confirmRecipeDeletionErrorToggle) confirmRecipeDeletionErrorToggle.checked = userSettings.confirmRecipeDeletionError;
        }

        // Funkce pro bezpečné přidání event listeneru
        function addEventListenerOnce(elementId, eventType, callback) {
            const element = document.getElementById(elementId);
            if (!element) return;

            // Odstranění existujících listenerů
            element.removeEventListener(eventType, callback);

            // Přidání nového listeneru
            element.addEventListener(eventType, callback);
        }

        // Použití:
        addEventListenerOnce('confirmCreateProfile', 'click', async () => {
            const profileName = document.getElementById('newProfileName').value.trim();
            if (profileName) {
                const newProfileId = await createNewProfile(profileName);
                if (newProfileId) {
                    await selectProfile(newProfileId);
                    document.getElementById('createProfileModal').style.display = 'none';
                }
            }
        });


        async function loadUserSettings() {
            console.log("🔄 loadUserSettings START - currentProfileId:", window.currentProfileId);

            if (!window.currentUser || !window.currentProfileId) {
                console.error("User ID or Profile ID not initialized.");
                return;
            }

            try {
                // POUZE SUPABASE
                if (window.supabaseClient && !window.currentUser.is_local) {
                    console.log("🔍 Načítám nastavení z profiles pro profileId:", window.currentProfileId);

                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .select('settings')
                        .eq('id', window.currentProfileId)
                        .single();

                    console.log("📦 Odpověď z Supabase:", { data, error });

                    if (error) {
                        console.error("❌ Chyba při načítání nastavení:", error);
                        // Pokud nastavení neexistuje, použijte výchozí hodnoty
                        console.log("ℹ️ Používám výchozí nastavení (vše true)");
                        userSettings = {
                            confirmRecipeCreation: true,
                            confirmFoodAddition: true,
                            confirmDeleteRecipe: true,
                            confirmDeleteRecipeItem: true,
                            confirmSaveChanges: true,
                            confirmRecipeSaveSuccess: true,
                            confirmRecipeDeletionSuccess: true,
                            confirmRecipeDeletionError: true
                        };
                    } else if (data && data.settings) {
                        userSettings = data.settings;
                        console.log("✅ Nastavení načteno z profiles:", userSettings);
                    } else {
                        // Pokud settings sloupec existuje, ale je null nebo prázdný
                        console.log("ℹ️ Settings sloupec je prázdný, používám výchozí nastavení (vše true)");
                        userSettings = {
                            confirmRecipeCreation: true,
                            confirmFoodAddition: true,
                            confirmDeleteRecipe: true,
                            confirmDeleteRecipeItem: true,
                            confirmSaveChanges: true,
                            confirmRecipeSaveSuccess: true,
                            confirmRecipeDeletionSuccess: true,
                            confirmRecipeDeletionError: true
                        };
                    }
                } else {
                    console.log("ℹ️ Anonymní uživatel nebo chybí Supabase, používám výchozí nastavení (vše true)");
                    userSettings = {
                        confirmRecipeCreation: true,
                        confirmFoodAddition: true,
                        confirmDeleteRecipe: true,
                        confirmDeleteRecipeItem: true,
                        confirmSaveChanges: true,
                        confirmRecipeSaveSuccess: true,
                        confirmRecipeDeletionSuccess: true,
                        confirmRecipeDeletionError: true
                    };
                }

                console.log("🎯 FINÁLNÍ userSettings:", userSettings);
                updateSettingsUI();

            } catch (error) {
                console.error("Chyba při načítání nastavení:", error);
                userSettings = {
                    confirmRecipeCreation: true,
                    confirmFoodAddition: true,
                    confirmDeleteRecipe: true,
                    confirmDeleteRecipeItem: true,
                    confirmSaveChanges: true,
                    confirmRecipeSaveSuccess: true,
                    confirmRecipeDeletionSuccess: true,
                    confirmRecipeDeletionError: true
                };
                updateSettingsUI();
            }

            console.log("✅ loadUserSettings COMPLETE");
        }

        // Debounce funkce pro omezení četnosti volání
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Aplikujte debounce na event listener
        const debouncedCreateProfile = debounce(async () => {
            const profileName = document.getElementById('newProfileName').value.trim();
            if (profileName) {
                const newProfileId = await createNewProfile(profileName);
                if (newProfileId) {
                    await selectProfile(newProfileId);
                    document.getElementById('createProfileModal').style.display = 'none';
                }
            }
        }, 1000); // 1 sekunda debounce

        // Event listener pro zavření modálního okna profilu
        document.getElementById('closeProfileModal').addEventListener('click', function () {
            document.getElementById('profileModal').style.display = 'none';
        });

        // Zavření kliknutím mimo okno
        window.addEventListener('click', function (event) {
            if (event.target === document.getElementById('profileModal')) {
                document.getElementById('profileModal').style.display = 'none';
            }
        });

        // Event listenery pro správu profilů
        document.getElementById('createNewProfileBtn').addEventListener('click', () => {
            document.getElementById('profileModal').style.display = 'none';
            window.showCreateProfileModal();
        });

        document.getElementById('confirmCreateProfile').addEventListener('click', async () => {
            const profileName = document.getElementById('newProfileName').value.trim();

            if (!profileName) {
                window.showCustomNotification("Prosím, zadejte název profilu.", 'info');
                return;
            }

            // Disable tlačítka během vytváření
            const createButton = document.getElementById('confirmCreateProfile');
            const originalText = createButton.textContent;
            createButton.disabled = true;
            createButton.textContent = "Vytváření...";

            try {
                const newProfileId = await createNewProfile(profileName);
                if (newProfileId) {
                    await selectProfile(newProfileId);
                    document.getElementById('createProfileModal').style.display = 'none';
                }
            } catch (error) {
                console.error("Error creating profile:", error);
            } finally {
                // Re-enable tlačítka
                createButton.disabled = false;
                createButton.textContent = originalText;
            }
        });

        document.getElementById('cancelCreateProfile').addEventListener('click', () => {
            document.getElementById('createProfileModal').style.display = 'none';
            showProfileModal();
        });

        document.getElementById('closeCreateProfileModal').addEventListener('click', () => {
            document.getElementById('createProfileModal').style.display = 'none';
            showProfileModal();
        });

        // PŘIDEJTE TUTO FUNKCI - musí být v globálním scope
        function searchByBarcode(barcode) {
            console.log('Vyhledávám podle čárového kódu:', barcode);

            // Nastavíme hodnotu do vyhledávacího pole
            const searchInput = document.getElementById('query');
            if (searchInput) {
                searchInput.value = barcode;
            }

            // Spustíme vyhledávání
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                // Vytvoříme a odešleme submit event
                const submitEvent = new Event('submit', {
                    bubbles: true,
                    cancelable: true
                });
                searchForm.dispatchEvent(submitEvent);
            } else {
                console.error('Search form element not found');
            }
        }


        // --- Helper functions (Moved to global scope) ---
        function parseValueAndUnit(valueString) {
            if (typeof valueString !== 'string' && typeof valueString !== 'number') {
                return { number: NaN, unit: '' };
            }
            if (typeof valueString === 'number') {
                return { number: valueString, unit: '' };
            }

            const cleanedString = String(valueString).replace(/[\s\u00A0]/g, '').replace(',', '.');
            const match = cleanedString.match(/(\d+\.?\d*)\s*(.*)/);

            if (match) {
                const number = parseFloat(match[1]);
                const unit = match[2] || '';
                return { number, unit };
            }
            return { number: NaN, unit: '' };
        }

        function formatNumberForDisplay(number, unit = '', isEnergyValue = false) {
            if (typeof number !== 'number' || isNaN(number) || number === null || number === undefined) {
                return '-';
            }

            let formattedNumber;
            if (isEnergyValue) {
                // For energy values (kcal, kJ), round to 1 decimal place
                formattedNumber = parseFloat(number.toFixed(1));
            } else {
                // For other nutrients, keep 2 decimal places as before
                formattedNumber = parseFloat(number.toFixed(2));
            }

            // Use toLocaleString for proper locale-specific formatting (e.g., comma as decimal separator)
            return `${formattedNumber.toLocaleString('cs-CZ')}${unit ? ` ${unit}` : ''}`;
        }

        function createNutrientRow(label, originalValueString, rdiString = null, dotColor = null, type = 'other', currentFactor = 1, addSeparator = false, fontWeight = 'bold', fontSize = null) {
            const { number: originalNumericValue, unit: displayUnit } = parseValueAndUnit(originalValueString);

            let calculatedValueDisplay;
            if (isNaN(originalNumericValue)) {
                calculatedValueDisplay = '-';
            } else {
                calculatedValueDisplay = formatNumberForDisplay(originalNumericValue * currentFactor, displayUnit, false);
            }

            let dot = dotColor ? `<span class="dot ${dotColor}"></span>` : '';
            let labelClass = 'nutrient-label';
            let valueClass = 'nutrient-value';

            let labelStyle = `font-weight: ${fontWeight};`;
            let valueStyle = `font-weight: ${fontWeight};`;
            let separatorHtml = '';

            if (fontSize) {
                labelStyle += `font-size: ${fontSize};`;
                valueStyle += `font-size: ${fontSize};`;
            }

            if (dotColor) {
                let colorHex = '';
                switch (dotColor) {
                    case 'red': colorHex = '#f44336'; break;
                    case 'blue': colorHex = '#2196f3'; break;
                    case 'orange': colorHex = '#ff9800'; break;
                    case 'green': colorHex = '#4caf50'; break;
                    default: colorHex = '';
                }
                if (colorHex) {
                    labelStyle += `color: ${colorHex};`;
                    valueStyle += `color: ${colorHex};`;
                }
            }

            if (type === 'main') {
                labelClass += ' main';
                valueClass += ' main-value';
            } else if (type === 'nested') {
                labelClass = 'nutrient-sub-label';
                valueClass = 'nutrient-sub-value';
            }

            if (addSeparator) {
                separatorHtml = `<div class="nutrient-line-separator"></div>`;
            }

            let rdiHtml = '';

            return `
                ${separatorHtml}
                <div class="nutrient-row">
                    <div class="${labelClass}" style="${labelStyle}">${dot}${label}</div>
                    <div class="${valueClass}" style="${valueStyle}">${calculatedValueDisplay}</div>
                </div>
                ${rdiHtml}
            `;
        }

        function renderAllNutrientDetails(details, factor = 1) {
            if (!details || typeof details !== 'object') {
                console.error("Neplatná nutriční data");
                return;
            }

            // Upravte formátování čísel:
            const formatValue = (value) => {
                if (value === "N/A") return "-";
                const num = parseFloat(value);
                return isNaN(num) ? value : num.toLocaleString('cs-CZ');
            };

            // Upravte výpočet faktorů:
            const applyFactor = (value) => {
                if (value === "N/A") return "-";
                const num = parseFloat(value);
                return isNaN(num) ? value : (num * factor).toFixed(1);
            };
            console.log("renderAllNutrientDetails called with details:", details, "factor:", factor);
            const nutrientDetailsSection = document.getElementById('nutrientDetailsSection');
            if (!nutrientDetailsSection) {
                console.error("Element 'nutrientDetailsSection' not found. Cannot render nutrients.");
                return;
            }
            nutrientDetailsSection.innerHTML = '';

            const totalKcalDisplay = document.getElementById('totalKcalDisplay');
            const totalKjDisplay = document.getElementById('totalKjDisplay');

            if (totalKcalDisplay) {
                const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(details.total_kcal);
                totalKcalDisplay.textContent = formatNumberForDisplay(kcalNum * factor, kcalUnit, true);
            }
            if (totalKjDisplay) {
                const { number: kjNum, unit: kjUnit } = parseValueAndUnit(details.total_kj);
                totalKjDisplay.textContent = `Také ${formatNumberForDisplay(kjNum * factor, kjUnit, true)} • Energetická hodnota`;
            }

            let nutrientsHtmlContent = '';

            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('Bílkoviny', details.protein, null, 'red', 'main', factor, true);
            nutrientsHtmlContent += createNutrientRow('Sacharidy', details.carbs, null, 'blue', 'main', factor, true);
            nutrientsHtmlContent += createNutrientRow('Cukry', details.sugar, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Tuky', details.fat, null, 'orange', 'main', factor, true);
            nutrientsHtmlContent += createNutrientRow('Nasycené mastné kyseliny', details.saturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Trans mastné kyseliny', details.trans_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Mononenasycené', details.monounsaturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Polynenasycené', details.polyunsaturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Cholesterol', details.cholesterol, null, null, 'nested', factor, false);
            nutrientsHtmlContent += `</div>`;
            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('Vláknina', details.fiber, null, 'green', 'main', factor, true);
            nutrientsHtmlContent += `</div>`;
            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('Sůl', details.salt, null, null, 'main', factor, true, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('Vápník', details.calcium, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('Sodík', details.sodium, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('Voda', details.water, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('PHE', details.phe, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += `</div>`;

            nutrientDetailsSection.innerHTML = nutrientsHtmlContent;
            console.log("Nutrients rendered.");
        }

        // Detekce mobilního zařízení
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        async function initializeWithTimeout() {
            const initializationTimeout = setTimeout(() => {
                console.log("⚠️ Initialization timeout - showing profile modal anyway");
                showProfileModal();
                hideGlobalLoading();
            }, 10000); // 10 sekund timeout

            await initializeFirebase();
            clearTimeout(initializationTimeout);
        }

        // Funkce pro uložení nastavení uživatele
        async function saveUserSettings() {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId || window.currentUser.is_local) {
                console.warn("Nelze uložit nastavení - není připojení nebo anonymní uživatel");
                return;
            }

            try {
                console.log("💾 Ukládám nastavení do profiles pro profileId:", window.currentProfileId);
                console.log("📦 Data k uložení:", userSettings);

                const { error } = await window.supabaseClient
                    .from('profiles')
                    .update({
                        settings: userSettings,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', window.currentProfileId);

                if (error) {
                    console.error("❌ Chyba při ukládání nastavení:", error);
                } else {
                    console.log("✅ Nastavení úspěšně uloženo do profiles");

                    // OVĚŘENÍ - načtěte znovu nastavení pro kontrolu
                    setTimeout(async () => {
                        console.log("🔍 Ověřuji uložení - načítám nastavení znovu...");
                        const { data: verifyData } = await window.supabaseClient
                            .from('profiles')
                            .select('settings')
                            .eq('id', window.currentProfileId)
                            .single();
                        console.log("✅ Ověřovací data:", verifyData);
                    }, 1000);
                }
            } catch (error) {
                console.error("Error saving user settings:", error);
            }
        }

        // --- Custom Notification Modal Elements (moved to global scope) ---
        const customNotificationModal = document.getElementById('customNotificationModal');
        const customNotificationMessage = document.getElementById('customNotificationMessage');
        const dynamicNotificationToggleContainer = document.getElementById('dynamicNotificationToggleContainer');
        // We'll dynamically create/manage the OK/Cancel buttons within showCustomNotification


        // Pokud neexistují, vytvořte fallback
        if (!customNotificationModal) {
            console.error("❌ customNotificationModal element not found");
        }

        if (!customNotificationMessage) {
            console.error("❌ customNotificationMessage element not found");
        }

        if (!dynamicNotificationToggleContainer) {
            console.error("❌ dynamicNotificationToggleContainer element not found");
        }

        // Function to show custom notification (moved to global scope)
        window.showCustomNotification = function (message, notificationType, confirmCallback = null, showConfirmButtons = false) {
            let currentSettingKey;
            let showToggleInNotification = true; // Flag to decide if the toggle should appear in the notification dialog itself

            // Determine which setting controls this notification's visibility
            if (notificationType === 'recipeCreation') {
                currentSettingKey = 'confirmRecipeCreation';
            } else if (notificationType === 'foodAddition') {
                currentSettingKey = 'confirmFoodAddition';
            } else if (notificationType === 'confirmDeleteRecipe') {
                currentSettingKey = 'confirmDeleteRecipe';
            } else if (notificationType === 'confirmDeleteRecipeItem') { // NEW
                currentSettingKey = 'confirmDeleteRecipeItem';
            } else if (notificationType === 'confirmSaveChanges') { // NEW
                currentSettingKey = 'confirmSaveChanges';
            } else if (notificationType === 'recipeSaveSuccess') { // NEW
                currentSettingKey = 'confirmRecipeSaveSuccess';
            } else if (notificationType === 'recipeDeletionSuccess') {
                currentSettingKey = 'confirmRecipeDeletionSuccess'; // New setting
            } else if (notificationType === 'recipeDeletionError') {
                currentSettingKey = 'confirmRecipeDeletionError'; // New setting
            } else {
                // For unknown types, no specific setting, just show the message without a toggle
                showToggleInNotification = false;
            }

            // --- Core Logic: Decide whether to show the modal or execute callback directly ---
            // If there's a specific setting for this notification type, and it's OFF, and it's NOT a confirmation dialog
            // (meaning it's an informational message that the user chose to hide), then skip showing the modal).
            if (currentSettingKey && !userSettings[currentSettingKey] && !showConfirmButtons) {
                console.log(`Notifikace typu '${notificationType}' je vypnuta v nastavení. Provedení akce přímo (pokud je callback).`);
                if (confirmCallback) {
                    confirmCallback(); // This would be for cases where a "success" message might trigger a reload, etc.
                }
                return; // Do not show the modal
            }

            // If it's a confirmation dialog and the setting is OFF, execute callback directly.
            // This handles the "skip confirmation" case.
            if ((currentSettingKey === 'confirmDeleteRecipe' || currentSettingKey === 'confirmDeleteRecipeItem' || currentSettingKey === 'confirmSaveChanges') && !userSettings[currentSettingKey] && showConfirmButtons) { // MODIFIED
                console.log(`Potvrzení je vypnuto. Provedení akce přímo.`);
                if (confirmCallback) {
                    confirmCallback();
                }
                return;
            }

            customNotificationMessage.innerHTML = message;
            customNotificationModal.style.display = 'flex';

            dynamicNotificationToggleContainer.innerHTML = ''; // Clear previous content
            const notificationControls = customNotificationModal.querySelector('.notification-controls');
            notificationControls.innerHTML = ''; // Clear existing buttons

            // Add toggle if applicable and if it's supposed to be shown in the notification dialog
            if (showToggleInNotification && currentSettingKey) {
                const toggleLabelWrapper = document.createElement('label');
                // Apply specific classes for notification toggles
                toggleLabelWrapper.classList.add('toggle-switch', 'notification-toggle-switch');

                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.checked = userSettings[currentSettingKey];
                toggleInput.id = `dynamicToggle-${notificationType}`;

                const sliderSpan = document.createElement('span');
                sliderSpan.classList.add('slider');

                toggleLabelWrapper.appendChild(toggleInput);
                toggleLabelWrapper.appendChild(sliderSpan);

                const labelElement = document.createElement('span');
                // Apply specific classes for notification labels
                labelElement.classList.add('toggle-label', 'notification-toggle-label');
                labelElement.textContent = 'Zobrazovat tento dialog';

                // Always put toggle first for all notifications now
                dynamicNotificationToggleContainer.appendChild(toggleLabelWrapper); // Toggle first
                dynamicNotificationToggleContainer.appendChild(labelElement); // Then label

                toggleInput.addEventListener('change', () => {
                    userSettings[currentSettingKey] = toggleInput.checked;
                    saveUserSettings();
                    // Update the main settings modal toggle if it exists and matches
                    const settingsToggle = document.getElementById(`${currentSettingKey}Toggle`);
                    if (settingsToggle) {
                        settingsToggle.checked = toggleInput.checked;
                    }
                    console.log(`Nastavení '${currentSettingKey}' změněno na: ${toggleInput.checked}`);
                });
            }

            // Create a wrapper for buttons to ensure consistent flex behavior
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.gap = '10px'; // Space between buttons
            buttonsContainer.style.alignItems = 'flex-end'; // Align buttons to their own bottom

            if (showConfirmButtons) {
                const noButton = document.createElement('button');
                noButton.textContent = 'Ne';
                noButton.classList.add('notification-button');
                noButton.style.backgroundColor = '#f44336';
                noButton.onmouseover = () => noButton.style.backgroundColor = '#d32f2f';
                noButton.onmouseout = () => noButton.style.backgroundColor = '#f44336';
                noButton.onclick = () => {
                    customNotificationModal.style.display = 'none';
                };
                buttonsContainer.appendChild(noButton);

                const yesButton = document.createElement('button');
                yesButton.textContent = 'Ano';
                yesButton.classList.add('notification-button');
                yesButton.style.backgroundColor = '#4CAF50';
                yesButton.onmouseover = () => yesButton.style.backgroundColor = '#45a049';
                yesButton.onmouseout = () => yesButton.style.backgroundColor = '#4CAF50';
                yesButton.onclick = () => {
                    customNotificationModal.style.display = 'none';
                    if (confirmCallback) {
                        confirmCallback();
                    }
                };
                buttonsContainer.appendChild(yesButton);

            } else {
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.classList.add('notification-button');
                okButton.style.backgroundColor = '#4CAF50';
                okButton.onclick = () => { customNotificationModal.style.display = 'none'; };
                buttonsContainer.appendChild(okButton);
            }

            // Append elements to notificationControls
            if (dynamicNotificationToggleContainer.children.length > 0) {
                notificationControls.appendChild(dynamicNotificationToggleContainer);
            }
            notificationControls.appendChild(buttonsContainer);

            // Apply consistent styles to notificationControls
            notificationControls.style.display = 'flex';
            notificationControls.style.justifyContent = 'space-between'; // Push toggle left, buttons right
            notificationControls.style.alignItems = 'flex-end'; // Align both to the bottom
            notificationControls.style.flexWrap = 'nowrap';
            notificationControls.style.gap = '10px';
            notificationControls.style.paddingTop = '15px';
            notificationControls.style.borderTop = '1px solid #eee'; // Corrected line
        };

        // --- Firestore Functions (moved to global scope) ---
        async function createNewRecipe(recipeName, foodItem) {
            if (!db || !userId || !currentProfileId) {
                console.error("Není inicializováno: db nebo currentProfileId");
                return;
            }
            try {
                const recipesColRef = collection(db, `artifacts/${appId}/profiles/${currentProfileId}/recipes`);
                const newRecipeDoc = await addDoc(recipesColRef, {
                    name: recipeName,
                    createdBy: userId, // Uložíme ID uživatele, který recept vytvořil
                    ingredients: foodItem ? [foodItem] : [], // Add the initial food item if provided
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                console.log("Nový recept vytvořen pod ID:", newRecipeDoc.id);
                // Updated message with bold formatting
                window.showCustomNotification(`Recept "<strong>${recipeName}</strong>" byl vytvořen a byla do něj vložena položka "<strong>${foodItem.foodName}</strong>"!`, 'recipeCreation');
                return newRecipeDoc.id;
            } catch (error) {
                console.error("Error creating new recipe:", error);
                window.showCustomNotification("Chyba při vytváření nového receptu: " + error.message, 'recipeCreation');
                return null;
            }
        }

        async function addFoodItemToExistingRecipe(recipeId, foodItem) {
            console.log("addFoodItemToExistingRecipe called with:", {
                recipeId,
                userId,
                currentProfileId,
                appId
            });

            if (!db || !userId || !currentProfileId || !appId) {
                console.error("Není inicializováno: db, userId nebo currentProfileId");
                return;
            }
            if (!recipeId) {
                console.error("Recipe ID is missing");
                window.showCustomNotification("Chyba: ID receptu chybí.", 'error');
                return;
            }
            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/profiles/${currentProfileId}/recipes`, recipeId);
                const recipeSnap = await getDoc(recipeDocRef);

                if (recipeSnap.exists()) {
                    const currentIngredients = recipeSnap.data().ingredients || [];
                    const updatedIngredients = [...currentIngredients, foodItem];
                    await updateDoc(recipeDocRef, {
                        ingredients: updatedIngredients,
                        updatedAt: serverTimestamp()
                    });
                    console.log(`Food item added to recipe ${recipeId}`);
                    // Updated message with bold formatting
                    window.showCustomNotification(`Položka "<strong>${foodItem.foodName}</strong>" byla přidána do receptu "<strong>${recipeSnap.data().name}</strong>"!`, 'foodAddition');
                } else {
                    console.error("Recipe not found:", recipeId);
                    window.showCustomNotification("Vybraný recept nebyl nalezen.", 'foodAddition');
                }
            } catch (error) {
                console.error("Error adding food item to recipe:", error);
                window.showCustomNotification("Chyba při přidávání položky do receptu: " + error.message, 'foodAddition');
            }
        }

        async function updateFoodItemInRecipe(recipeId, ingredientIndex, updatedFoodItem) {
            if (!db || !userId || !currentProfileId) {
                console.error("Firestore, User ID or Profile ID not initialized.");
                return;
            }

            // Declare recipeDocRef at the top of the function
            const recipeDocRef = doc(db, `artifacts/${appId}/profiles/${currentProfileId}/recipes`, recipeId);

            const executeUpdate = async () => { // Wrap the core update logic in a function
                try {
                    const recipeSnap = await getDoc(recipeDocRef);

                    if (recipeSnap.exists()) {
                        const currentIngredients = recipeSnap.data().ingredients || [];
                        if (ingredientIndex >= 0 && ingredientIndex < currentIngredients.length) {
                            currentIngredients[ingredientIndex] = updatedFoodItem;
                            await updateDoc(recipeDocRef, {
                                ingredients: currentIngredients,
                                updatedAt: serverTimestamp()
                            });
                            console.log(`Food item at index ${ingredientIndex} updated in recipe ${recipeId}`);

                            // Close the details modal (editing view)
                            detailsModal.style.display = 'none';

                            // Fetch the updated recipe name from the current snap or refetch if needed
                            const updatedRecipeName = recipeSnap.data().name;
                            await showRecipeDetailsModal(recipeId, updatedRecipeName); // Reload recipe details

                            // Show success notification after successful update and reload
                            window.showCustomNotification(`Položka "<strong>${updatedFoodItem.foodName}</strong>" v receptu byla úspěšně aktualizována.`, 'recipeSaveSuccess');

                        } else {
                            console.error("Ingredient index out of bounds:", ingredientIndex);
                            window.showCustomNotification("Chyba: Index položky mimo rozsah.", 'recipeDeletionError'); // Reusing error type
                        }
                    } else {
                        console.error("Recipe not found:", recipeId);
                        window.showCustomNotification("Vybraný recept nebyl nalezen.", 'recipeDeletionError'); // Reusing error type
                    }
                } catch (error) {
                    console.error("Error updating food item in recipe:", error);
                    window.showCustomNotification("Chyba při aktualizaci položky v receptu: " + error.message, 'recipeDeletionError'); // Reusing error type
                }
            };

            // Call the confirmation dialog
            window.showCustomNotification(`Opravdu chcete uložit změny pro položku "<strong>${updatedFoodItem.foodName}</strong>"?`, 'confirmSaveChanges', executeUpdate, true);
        }

        async function deleteRecipe(recipeId, recipeName) {
            if (!db || !userId || !currentProfileId) {
                console.error("Firestore, User ID or Profile ID not initialized.");
                return;
            }
            // Add a confirmation step before deleting
            // The third argument is a callback for 'confirm' action, and the fourth indicates if it's a confirmation type
            window.showCustomNotification(`Opravdu chcete odstranit recept "<strong>${recipeName}</strong>"?`, 'confirmDeleteRecipe', async () => {
                try {
                    const recipeDocRef = doc(db, `artifacts/${appId}/profiles/${currentProfileId}/recipes`, recipeId);
                    await deleteDoc(recipeDocRef);
                    console.log(`Recipe ${recipeId} deleted.`);
                    window.showCustomNotification(`Recept "<strong>${recipeName}</strong>" byl úspěšně smazán.`, 'recipeDeletionSuccess');
                    loadUserRecipes(); // Reload the list after deletion
                } catch (error) {
                    console.error("Error deleting recipe:", error);
                    window.showCustomNotification(`Chyba při odstraňování receptu "<strong>${recipeName}</strong>": ${error.message}`, 'recipeDeletionError');
                }
            }, true); // Pass true to indicate this notification needs a confirm button
        }

        // NEW: Function to delete a food item from a recipe
        async function deleteFoodItemFromRecipe(recipeId, ingredientIndex, ingredientName, recipeName) {
            if (!db || !userId || !currentProfileId) {
                console.error("Firestore, User ID or Profile ID not initialized.");
                return;
            }
            window.showCustomNotification(`Opravdu chcete odstranit položku "<strong>${ingredientName}</strong>" z receptu "<strong>${recipeName}</strong>"?`, 'confirmDeleteRecipeItem', async () => {
                try {
                    const recipeDocRef = doc(db, `artifacts/${appId}/profiles/${currentProfileId}/recipes/${recipeId}`);
                    const recipeSnap = await getDoc(recipeDocRef);

                    if (recipeSnap.exists()) {
                        const currentIngredients = recipeSnap.data().ingredients || [];
                        if (ingredientIndex >= 0 && ingredientIndex < currentIngredients.length) {
                            currentIngredients.splice(ingredientIndex, 1); // Remove the ingredient
                            await updateDoc(recipeDocRef, {
                                ingredients: currentIngredients,
                                updatedAt: serverTimestamp()
                            });
                            console.log(`Ingredient at index ${ingredientIndex} deleted from recipe ${recipeId}.`);
                            window.showCustomNotification(`Položka "<strong>${ingredientName}</strong>" byla úspěšně smazána z receptu "<strong>${recipeName}</strong>".`, 'recipeDeletionSuccess');
                            // Reload the recipe details modal to reflect the change
                            await showRecipeDetailsModal(recipeId, recipeName);
                        } else {
                            console.error("Ingredient index out of bounds:", ingredientIndex);
                            window.showCustomNotification("Chyba: Index položky mimo rozsah.", 'recipeDeletionError');
                        }
                    } else {
                        console.error("Recipe not found:", recipeId);
                        window.showCustomNotification("Vybraný recept nebyl nalezen.", 'recipeDeletionError');
                    }
                } catch (error) {
                    console.error("Error deleting food item from recipe:", error);
                    window.showCustomNotification(`Chyba při odstraňování položky "<strong>${ingredientName}</strong>": ${error.message}`, 'recipeDeletionError');
                }
            }, true); // Pass true to indicate this notification needs a confirm button
        }

        // New function to show recipe details modal
        async function showRecipeDetailsModal(recipeId, recipeName) {
            console.log("showRecipeDetailsModal called for recipe ID:", recipeId, "name:", recipeName);
            modalDetailsContent.classList.add('modal-recipe-container');
            document.getElementById('modalDetailsContent').classList.add('modal-recipe-container');
            document.getElementById('detailsModal').classList.add('modal-recipe-open');
            detailsModal.style.display = 'flex';
            modalDetailsContent.innerHTML = `<p class="loading-details">Načítám detaily receptu "${recipeName}"...</p>`;
            if (!db || !userId || !currentProfileId) {
                modalDetailsContent.innerHTML = `<p class="error-details">Chyba: Aplikace se nenačetla správně. Nelze načíst recept.</p>`;
                return;
            }

            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/profiles/${currentProfileId}/recipes`, recipeId);
                const recipeSnap = await getDoc(recipeDocRef);

                if (!recipeSnap.exists()) {
                    modalDetailsContent.innerHTML = `<p class="error-details">Recept "${recipeName}" nebyl nalezen.</p>`;
                    return;
                }

                const recipeData = recipeSnap.data();
                const imageUrl = recipeData.imageUrl || "{{ url_for('static', filename='icon/recepty.png') }}";
                const ingredients = recipeData.ingredients || [];

                // Agregace nutrientů
                const aggregatedNutrients = {
                    total_kcal: 0, total_kj: 0, protein: 0, carbs: 0, sugar: 0, fat: 0,
                    saturated_fat: 0, trans_fat: 0, monounsaturated_fat: 0, polyunsaturated_fat: 0,
                    cholesterol: 0, fiber: 0, salt: 0, calcium: 0, sodium: 0, water: 0, phe: 0
                };

                ingredients.forEach(ingredient => {
                    if (ingredient.nutritionalDetails && typeof ingredient.nutritionalDetails === 'object') {
                        const amount = parseFloat(ingredient.amount) || 0;
                        let baseAmount = amount;
                        if (ingredient.unit === 'kg' || ingredient.unit === 'l') baseAmount *= 1000;
                        const factor = baseAmount / 100;

                        for (const key in aggregatedNutrients) {
                            if (ingredient.nutritionalDetails[key] && ingredient.nutritionalDetails[key] !== "N/A") {
                                const { number: valNum } = parseValueAndUnit(ingredient.nutritionalDetails[key]);
                                if (!isNaN(valNum)) aggregatedNutrients[key] += valNum * factor;
                            }
                        }
                    }
                });

                const totalKj = aggregatedNutrients.total_kj || (aggregatedNutrients.total_kcal * 4.184);
                const formattedAggregatedNutrients = {};
                for (const key in aggregatedNutrients) {
                    let unit = '';
                    if (key.includes('kcal')) unit = 'kcal';
                    else if (key.includes('kj')) unit = 'kJ';
                    else if (['protein', 'carbs', 'sugar', 'fat', 'saturated_fat', 'trans_fat',
                        'monounsaturated_fat', 'polyunsaturated_fat', 'fiber', 'salt', 'water', 'phe'].includes(key)) unit = 'g';
                    else if (['cholesterol', 'calcium', 'sodium'].includes(key)) unit = 'mg';

                    formattedAggregatedNutrients[key] = formatNumberForDisplay(aggregatedNutrients[key], unit, key.includes('kcal') || key.includes('kj'));
                }

                let recipeDetailsHtml = `
            <div class="modal-recipe-header">
                <img
                    id="modalHeaderImage"
                    src="${imageUrl}"
                    alt="${recipeName}"
                    class="modal-header-image"
                    onerror="this.onerror=null;this.src='{{ url_for('static', filename='icon/recepty.png') }}'"
                />
                <div class="modal-header-text">
                    <div id="modalHeaderName" class="modal-header-name">${recipeName}</div>
                    <div class="energy-display-group">
                        <div id="totalKcalDisplay" class="energy-header">${formattedAggregatedNutrients.total_kcal}</div>
                        <div id="totalKjDisplay" class="energy-sub-header">${formatNumberForDisplay(totalKj, 'kJ', true)}</div>
                    </div>
                </div>
            </div>

            <div class="modal-scrollable-container">
                <div id="nutrientDetailsSection"></div>
                <h3 class="ingredients-title">Složení receptu:</h3>
                <div id="recipeIngredientsList"></div>
            </div>
        `;

                modalDetailsContent.innerHTML = recipeDetailsHtml;


                // Render nutrientů
                renderAllNutrientDetails(formattedAggregatedNutrients);

                // Render ingrediencí
                const ingredientsListEl = document.getElementById('recipeIngredientsList');
                if (ingredients.length === 0) {
                    ingredientsListEl.innerHTML = '<p style="text-align: center; color: #888;">Tento recept neobsahuje žádné potraviny.</p>';
                } else {
                    ingredients.forEach((ingredient, index) => {
                        const ingredientItemDiv = document.createElement('div');
                        ingredientItemDiv.classList.add('food-item', 'food-item-potravina');
                        const ingPlaceholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}";
                        let displayImageUrl = ingredient.imageUrl || ingPlaceholderImage;
                        const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(ingredient.kcal);
                        const formattedIngredientKcal = formatNumberForDisplay(kcalNum, kcalUnit, true);

                        ingredientItemDiv.innerHTML = `
                            <div class="image-wrapper" style="display: flex; flex-direction: column; align-items: center;">
                                <img src="${displayImageUrl}" alt="${ingredient.foodName}" onerror="this.onerror=null;this.src='${ingPlaceholderImage}'" />
                                <div class="recipe-icons" style="margin-top: 5px;">
                                    <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Upravit" class="recipe-icon edit-icon" data-recipe-id="${recipeId}" data-ingredient-index="${index}" />
                                    <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Odstranit" class="recipe-icon delete-icon" data-recipe-id="${recipeId}" data-ingredient-index="${index}" />
                                </div>
                            </div>
                            <div class="food-details">
                                <h3>${ingredient.foodName}</h3>
                                <div class="calories-and-type-row">
                                    <div class="calories-and-type-row">
                                        <span class="amount-display">Množství:  ${ingredient.amount} ${ingredient.unit}</span>
                                        <span class="calories-display">Kalorie: ${formattedIngredientKcal}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        ingredientsListEl.appendChild(ingredientItemDiv);

                        // Edit ikonka
                        const editIcon = ingredientItemDiv.querySelector('.edit-icon');
                        if (editIcon) {
                            editIcon.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                currentEditingRecipeId = e.target.dataset.recipeId;
                                currentEditingIngredientIndex = parseInt(e.target.dataset.ingredientIndex);
                                const ingredientToEdit = ingredients[currentEditingIngredientIndex];
                                if (ingredientToEdit) {
                                    await showDetailsModal(
                                        ingredientToEdit.slug,
                                        ingredientToEdit.foodName,
                                        ingredientToEdit.imageUrl,
                                        ingredientToEdit.kcal,
                                        ingredientToEdit.foodType,
                                        true,
                                        ingredientToEdit.amount,
                                        ingredientToEdit.unit,
                                        ingredientToEdit.nutritionalDetails
                                    );
                                } else {
                                    console.error("Ingredient not found at index:", currentEditingIngredientIndex);
                                    window.showCustomNotification("Chyba: Položka receptu k úpravě nebyla nalezena.", 'info');
                                }
                            });
                        }

                        // Delete ikonka
                        const deleteIcon = ingredientItemDiv.querySelector('.delete-icon');
                        if (deleteIcon) {
                            deleteIcon.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const currentRecipeId = e.target.dataset.recipeId;
                                const ingredientIndex = parseInt(e.target.dataset.ingredientIndex);
                                const ingredientName = ingredient.foodName;
                                deleteFoodItemFromRecipe(currentRecipeId, ingredientIndex, ingredientName, recipeName);
                            });
                        }
                    });
                }

                // Dynamická velikost názvu v hlavičce
                const modalHeaderImage = document.getElementById('modalHeaderImage');
                const modalHeaderName = document.getElementById('modalHeaderName');
                if (modalHeaderImage && modalHeaderName) {
                    const imageHeight = modalHeaderImage.offsetHeight;
                    let currentFontSize = imageHeight * 0.25;
                    modalHeaderName.style.fontSize = `${currentFontSize}px`;

                    while ((modalHeaderName.scrollWidth > modalHeaderName.clientWidth || modalHeaderName.scrollHeight > modalHeaderName.clientHeight) && currentFontSize > 10) {
                        currentFontSize -= 0.5;
                        modalHeaderName.style.fontSize = `${currentFontSize}px`;
                    }
                }

            } catch (error) {
                console.error("Error loading recipe details:", error);
                modalDetailsContent.innerHTML = `<p class="error-details">Došlo k chybě při načítání detailů receptu: ${error.message}</p>`;
            }
        }

        // --- Barcode Scanner Functions ---
        let barcodeModal = null;
        let barcodeVideo = null;
        let barcodeCanvas = null;
        let barcodeOverlay = null;
        let barcodeStatus = null;
        let stream = null;
        let currentDeviceId = null;
        let facingMode = 'environment';
        let flashEnabled = false;
        let scanInterval = null;
        let quaggaInitialized = false;

        function debugCameraStream() {
            if (barcodeVideo && barcodeVideo.srcObject) {
                console.log('Video dimensions:', barcodeVideo.videoWidth, 'x', barcodeVideo.videoHeight);
                console.log('Video ready state:', barcodeVideo.readyState);
                console.log('Stream active:', barcodeVideo.srcObject.active);

                const tracks = barcodeVideo.srcObject.getVideoTracks();
                if (tracks.length > 0) {
                    console.log('Track settings:', tracks[0].getSettings());
                }
            }
        }

        // Přidejte tuto funkci pro lepší error handling
        function handleFetchError(error, context) {
            console.error(`❌ Fetch error in ${context}:`, error);

            if (error.name === 'TypeError') {
                return 'Chyba připojení k serveru. Zkontrolujte síťové připojení.';
            } else if (error.name === 'AbortError') {
                return 'Požadavek byl přerušen.';
            } else {
                return `Neočekávaná chyba: ${error.message}`;
            }
        }

        // Inicializace skeneru čárových kódů
        function initBarcodeScanner() {
            barcodeModal = document.getElementById('barcodeModal');
            barcodeVideo = document.getElementById('barcodeVideo');
            barcodeCanvas = document.getElementById('barcodeCanvas');
            barcodeOverlay = document.getElementById('barcodeOverlay');
            barcodeStatus = document.getElementById('barcodeStatus');

            // Event listenery pro modální okno skeneru
            document.getElementById('closeBarcodeModal').addEventListener('click', closeBarcodeScanner);
            document.getElementById('toggleCameraButton').addEventListener('click', toggleCamera);
            document.getElementById('toggleFlashButton').addEventListener('click', toggleFlash);
            document.getElementById('submitManualBarcode').addEventListener('click', submitManualBarcode);

            // Event listener pro tlačítko skeneru
            document.getElementById('barcodeButton').addEventListener('click', openBarcodeScanner);

        }

        // Inicializace QuaggaJS
        function initQuagga() {
            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: barcodeVideo,
                            constraints: {
                                width: 1280,
                                height: 720,
                                facingMode: facingMode,
                                aspectRatio: { min: 1, max: 2 }
                            },
                        },
                        decoder: {
                            readers: ["ean_reader", "ean_8_reader"], // Primárně EAN
                            multiple: false,
                            // Specifická konfigurace pro EAN
                            resolution: 800, // Zvyšte rozlišení pro lepší detekci
                            patchSize: "x-large", // Větší oblast pro detekci
                        },
                        locator: {
                            patchSize: "large",
                            halfSample: true,
                            // Konfigurace pro lepší detekci EAN-13
                            debug: {
                                showCanvas: false,
                                showPatches: false,
                                showFoundPatches: false,
                                showSkeleton: false
                            }
                        },
                        preprocessor: {
                            // Zvýší kontrast pro lepší čitelnost
                            contrast: {
                                min: 32,
                                max: 220
                            },
                            // Zvýší ostrost
                            sharpen: {
                                flat: 1.0,
                                jagged: 2.0
                            }
                        },
                        frequency: 5,
                        numOfWorkers: 2,
                        debug: false // Vypnout debug pro lepší výkon
                    }, function (err) {
                        if (err) {
                            console.error("Chyba při inicializaci Quagga:", err);
                            barcodeStatus.textContent = 'Nepodařilo se inicializovat skener';
                            barcodeStatus.style.color = 'red';
                            return;
                        }

                        quaggaInitialized = true;
                        console.log("Quagga inicializována");

                        Quagga.onDetected(function (result) {
                            console.log('Quagga result:', result);

                            if (result && result.codeResult && result.codeResult.code) {
                                console.log('Detekován kód:', result.codeResult.code,
                                    'typ:', result.codeResult.format,
                                    'confidence:', result.codeResult.confidence);

                                // Přidejte více debug info
                                if (result.codeResult.decoded) {
                                    console.log('Decoded info:', result.codeResult.decoded);
                                }

                                // Filtr podle confidence pokud je dostupná
                                if (result.codeResult.confidence !== undefined &&
                                    result.codeResult.confidence < 0.3) {
                                    console.log('Příliš nízká confidence, ignoruji:', result.codeResult.confidence);
                                    return;
                                }

                                handleBarcodeDetected(result.codeResult.code, result);
                            }
                        });
                    });
                } catch (error) {
                    console.error('Výjimka při inicializaci Quaggy:', error);
                }
            }
        }

        // Fallback funkce pro canvas detection
        function startCanvasFallback() {
            barcodeStatus.textContent = 'Používám základní detekci...';
            barcodeStatus.style.color = 'orange';

            scanInterval = setInterval(async () => {
                if (barcodeVideo.readyState === barcodeVideo.HAVE_ENOUGH_DATA) {
                    try {
                        const barcodes = await detectBarcodesWithCanvas();
                        if (barcodes.length > 0) {
                            handleBarcodeDetected(barcodes[0]);
                        }
                    } catch (error) {
                        console.error('Chyba při detekci čárového kódu:', error);
                    }
                }
            }, 1000);
        }

        // Odeslání ručně zadaného čárového kódu
        function submitManualBarcode() {
            const manualBarcodeInput = document.getElementById('manualBarcodeInput');
            const barcode = manualBarcodeInput.value.trim();

            if (barcode) {
                closeBarcodeScanner();
                searchByBarcode(barcode);
            } else {
                barcodeStatus.textContent = 'Prosím, zadejte čárový kód';
                barcodeStatus.style.color = 'red';
            }
        }

        // Otevření skeneru čárových kódů
        async function openBarcodeScanner() {
            console.log('Otevírám skener...');
            barcodeModal.style.display = 'flex';
            barcodeStatus.textContent = 'Inicializace...';
            barcodeStatus.innerHTML = `
    <div style="margin-bottom: 10px; font-weight: bold;">🔍 Skenování čárového kódu</div>
    <div style="font-size: 14px; color: #666; line-height: 1.4;">
        • Namiřte kód do zeleného rámečku<br>
        • Zaostření proběhne automaticky<br>
        • Pro ukončení klikněte mimo okno
    </div>
`;

            if (isMobileDevice()) {
                barcodeStatus.innerHTML = `
    <div style="font-weight: bold; margin-bottom: 10px;">Namiřte na čárový kód</div>
    <div style="font-size: 12px; color: #666;">
      • Zaostření proběhne automaticky<br>
      • Držte zařízení stabilně<br>
      • Zkontrolujte osvětlení
    </div>
  `;
            } else {
                barcodeStatus.innerHTML = `
    <div style="font-weight: bold; margin-bottom: 10px;">Namiřte na čárový kód</div>
    <div style="font-size: 12px; color: #666;">
      • Ujistěte se, že kód je v dobrém osvětlení<br>
      • Držte kód rovně před kamerou<br>
      • Přibližte/oddalte podle potřeby
    </div>
  `;
            }

            // Inicializujeme Quaggu až při otevření modálního okna
            if (!quaggaInitialized) {
                initQuagga();
            }

            // Zkontrolujeme, zda je API dostupné
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                barcodeStatus.textContent = 'Kamera není v tomto prohlížeči dostupná';
                barcodeStatus.style.color = 'red';
                return;
            }

            try {
                await startCamera();
                debugCameraStream();
                barcodeStatus.textContent = 'Namiřte na čárový kód';

                // POČKÁME, NEŽ SE VIDEO NAČTE
                await new Promise(resolve => setTimeout(resolve, 500));

                startBarcodeScanning();
            } catch (error) {
                console.error('Chyba při inicializaci kamery:', error);
                barcodeStatus.textContent = 'Chyba: ' + error.message;
                barcodeStatus.style.color = 'red';

                // POKUS O OBNOVU QUAGGY
                if (quaggaInitialized) {
                    try {
                        Quagga.stop();
                        // Počkáme a zkusíme znovu
                        setTimeout(() => {
                            if (barcodeModal.style.display === 'flex') {
                                startBarcodeScanning();
                            }
                        }, 1000);
                    } catch (e) {
                        console.error('Nelze obnovit Quaggu:', e);
                    }
                }
            }
        }

        function restartQuagga() {
            console.log('Restartuji Quaggu...');

            if (typeof Quagga !== 'undefined') {
                try {
                    // Zastavíme současnou instanci
                    if (quaggaInitialized) {
                        Quagga.stop();
                        Quagga.offDetected();
                        Quagga.offProcessed();
                    }

                    // Resetujeme stav
                    quaggaInitialized = false;
                    lastDetectedBarcode = null;

                    // Počkáme chvíli
                    setTimeout(() => {
                        initQuagga();
                        console.log('Quagga restartována');
                    }, 500);

                } catch (error) {
                    console.error('Chyba při restartu Quaggy:', error);
                }
            }
        }

        // Spuštění kamery
        async function startCamera() {
            // Zastavíme existující stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                    frameRate: { ideal: 60 }, // vyšší fps pro plynulejší video
                    facingMode: facingMode,
                }
            };

            // Pokud máme uložené deviceId, použijeme ho
            if (currentDeviceId) {
                constraints.video.deviceId = { exact: currentDeviceId };
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                barcodeVideo.srcObject = stream;
                barcodeVideo.style.display = 'block';
                document.getElementById('barcodeUnsupportedMessage').style.display = 'none';
                document.getElementById('toggleCameraButton').style.display = 'inline-block';
                document.getElementById('toggleFlashButton').style.display = 'inline-block';
                barcodeOverlay.style.display = 'block';

                // Explicitně nastavte velikost videa pro Quagga
                barcodeVideo.width = 640;
                barcodeVideo.height = 480;

                // Uložíme deviceId pro příště
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    currentDeviceId = videoTrack.getSettings().deviceId;
                }

                // Čekáme na načtení videa
                return new Promise((resolve) => {
                    barcodeVideo.onloadedmetadata = () => {
                        barcodeVideo.play().then(() => {
                            console.log('Video started playing');
                            resolve();
                        }).catch(error => {
                            console.error('Error playing video:', error);
                            resolve();
                        });
                    };

                    // Fallback timeout
                    setTimeout(() => resolve(), 1000);
                });
            } catch (error) {
                console.error('Chyba při přístupu ke kameře:', error);
                document.getElementById('barcodeUnsupportedMessage').style.display = 'block';
                barcodeVideo.style.display = 'none';
                document.getElementById('toggleCameraButton').style.display = 'none';
                document.getElementById('toggleFlashButton').style.display = 'none';
                barcodeOverlay.style.display = 'none';

                barcodeStatus.textContent = 'Použijte ruční zadání kódu';
                throw error;
            }
        }

        // Spuštění skenování čárových kódů
        function startBarcodeScanning() {
            console.log('Spouštím skenování...');

            // Zastavíme existující interval
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }

            // Nastavíme časový limit pro skenování (20 sekund)
            if (detectionTimeout) {
                clearTimeout(detectionTimeout);
            }
            detectionTimeout = setTimeout(() => {
                console.log('Časový limit skenování vypršel');
                barcodeStatus.textContent = 'Časový limit vypršel - zkuste to znovu';
                barcodeStatus.style.color = 'orange';
                restartQuagga();
            }, 20000);

            // ZKONTROLUJEME, zda je Quagga připravena a video funguje
            if (quaggaInitialized && barcodeVideo && barcodeVideo.srcObject) {
                try {
                    Quagga.start();
                    barcodeStatus.textContent = 'Skenování spuštěno - namiřte na čárový kód';
                    console.log('Quagga úspěšně restartována');
                } catch (error) {
                    console.error('Chyba při startu Quaggy:', error);
                    // Fallback na canvas
                    startCanvasFallback();
                }
            } else {
                console.log('Quagga není inicializována nebo video nefunguje, používám fallback');
                // Fallback: použijeme intervalové kontrolování pomocí canvasu
                startCanvasFallback();
            }
        }


        // Detekce čárových kódů pomocí canvasu (fallback)
        function detectBarcodesWithCanvas() {
            return new Promise((resolve) => {
                if (!barcodeVideo.videoWidth || !barcodeVideo.videoHeight) {
                    resolve([]);
                    return;
                }

                const context = barcodeCanvas.getContext('2d');
                const width = barcodeVideo.videoWidth;
                const height = barcodeVideo.videoHeight;

                // Nastavíme velikost canvasu
                barcodeCanvas.width = width;
                barcodeCanvas.height = height;

                // Nakreslíme aktuální snímek videa na canvas
                context.drawImage(barcodeVideo, 0, 0, width, height);

                try {
                    // Zjednodušená detekce - v reálné aplikaci byste použili knihovnu
                    const imageData = context.getImageData(0, 0, width, height);
                    const detectedBarcodes = detectSimpleBarcodes(imageData);
                    resolve(detectedBarcodes);
                } catch (error) {
                    console.error('Chyba při detekci:', error);
                    resolve([]);
                }
            });
        }

        // Jednoduchá detekce čárových kódů (vylepšená)
        function detectSimpleBarcodes(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const barcodes = [];

            // Projedeme pouze středovou oblast (30% výšky)
            const startY = Math.floor(height * 0.35);
            const endY = Math.floor(height * 0.65);

            for (let y = startY; y <= endY; y += Math.floor(height * 0.05)) {
                let inBar = false;
                let barStart = 0;
                let bars = [];
                let barCount = 0;

                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];

                    const brightness = (r + g + b) / 3;
                    const isDark = brightness < 80; // Přísnější threshold

                    if (isDark && !inBar) {
                        inBar = true;
                        barStart = x;
                        barCount++;
                    } else if (!isDark && inBar) {
                        inBar = false;
                        const barWidth = x - barStart;

                        // Filtrujeme příliš široké/úzké pruhy
                        if (barWidth > 2 && barWidth < 50) {
                            bars.push({ start: barStart, end: x, width: barWidth });
                        }
                    }
                }

                // EAN kód má obvykle 30-60 pruhů
                if (bars.length > 25 && bars.length < 65) {
                    console.log('Nalezen potenciální čárový kód s', bars.length, 'pruhy');

                    // Zkusíme extrahovat numerickou hodnotu
                    const numericPattern = extractNumericPattern(bars);
                    if (numericPattern && numericPattern.length >= 8) {
                        barcodes.push(numericPattern);
                        break; // Našli jsme platný kód, přestaneme hledat
                    }
                }
            }

            return barcodes;
        }

        function extractNumericPattern(bars) {
            // Jednoduchá heuristika - v reálné aplikaci by bylo potřeba proper dekódování
            const widths = bars.map(bar => bar.width);
            const avgWidth = widths.reduce((a, b) => a + b, 0) / widths.length;

            // Binární reprezentace podle šířky pruhů
            let binary = '';
            for (const bar of bars) {
                binary += bar.width > avgWidth ? '1' : '0';
            }

            // Zkusíme najít něco, co vypadá jako EAN (13 nebo 8 číslic)
            if (binary.length >= 95) { // EAN-13 má cca 95 modulů
                return 'PRAVDĚPODOBNY_EAN_13';
            } else if (binary.length >= 67) { // EAN-8 má cca 67 modulů
                return 'PRAVDĚPODOBNY_EAN_8';
            }

            return null;
        }



        // Přidejte tuto funkci do svého kódu (nejlépe nad handleBarcodeDetected)
        function isValidEAN(barcode) {
            // Kontrola délky EAN (8 nebo 13 číslic)
            if (!/^\d{8}$|^\d{13}$/.test(barcode)) {
                return false;
            }

            // Kontrola checksumu pomocí existující funkce validateEANChecksum
            return validateEANChecksum(barcode);
        }

        let lastDetectedBarcode = null;
        let detectionTimeout = null;

        // Zpracování nalezeného čárového kódu
        function handleBarcodeDetected(barcode, quaggaResult) {
            if (lastDetectedBarcode === barcode) {
                console.log('Ignoruji opakovanou detekci stejného kódu:', barcode);
                return;
            }

            console.log('Nalezen čárový kód:', barcode);
            console.log('Raw pattern:', quaggaResult.pattern);
            console.log('Pattern length:', quaggaResult.pattern.length);
            console.log('Bounding box:', quaggaResult.box);
            // Upravte handleBarcodeDetected - přidejte před validací:
            if (commonMisreads[barcode]) {
                console.log('Opravuji častou chybu detekce:', barcode, '→', commonMisreads[barcode]);
                barcode = commonMisreads[barcode];
            }

            // Validace formátu a checksumu
            const isValid = isValidEAN(barcode);
            //const patternAnalysis = analyzePattern(result.pattern);
            //console.log('Pattern analysis:', patternAnalysis);

            if (!isValid) {
                console.log('Neplatný formát nebo checksum kódu:', barcode);
                barcodeStatus.textContent = `Neplatný kód: ${barcode}`;
                barcodeStatus.style.color = 'orange';
                return;
            }

            // Pokud vše projde, uložíme a zpracujeme kód
            lastDetectedBarcode = barcode;
            barcodeStatus.textContent = `Nalezen kód: ${barcode}`;
            barcodeStatus.style.color = '#4CAF50';

            // Vizuální feedback
            barcodeOverlay.classList.add('barcode-found');

            // Zastavíme skenování
            if (quaggaInitialized) {
                Quagga.stop();
            }

            // Po krátké prodlevě zavřeme skener a vyhledáme
            setTimeout(() => {
                closeBarcodeScanner();
                searchByBarcode(barcode);
            }, 1000);

            // Odstraníme animaci po dokončení
            setTimeout(() => {
                barcodeOverlay.classList.remove('barcode-found');
            }, 1500);

            // Přidejte do handleBarcodeDetected
            if (barcode === '12526048' && expectedCode === '8595229926818') {
                console.log('Opravuji detekovaný kód na správný');
                barcode = '8595229926818'; // MANUÁLNÍ OPRAVA
            }


            if (commonMisreads[barcode]) {
                console.log('Opravuji častou chybu detekce:', barcode, '→', commonMisreads[barcode]);
                barcode = commonMisreads[barcode];
            }

            if (!isValidEAN && !isValidUPC) {
                console.log('Ignoruji neplatný formát kódu:', barcode);
                return;
            }

            // DODATEČNÁ KONTROLA - EAN checksum validation
            if (!validateEANChecksum(barcode)) {
                console.log('Neplatný checksum pro kód:', barcode);
                return;
            }

            // Vizuální feedback
            barcodeOverlay.classList.add('barcode-found');
            barcodeStatus.textContent = `Nalezen kód: ${barcode}`;
            barcodeStatus.style.color = '#4CAF50';

            // Zastavíme skenování
            if (quaggaInitialized) {
                Quagga.stop();
            }

        }

        // PŘIDEJTE VALIDAČNÍ FUNKCI PRO EAN
        function validateEANChecksum(barcode) {
            if (barcode.length !== 8 && barcode.length !== 13) {
                console.log('Neplatná délka kódu:', barcode.length);
                return false;
            }

            const digits = barcode.split('').map(Number);
            const checksumDigit = digits.pop();

            let sum = 0;

            if (barcode.length === 8) {
                console.log('Detekován EAN-8 kód, aplikuji automatickou korekci');

                // Zkuste najít mapping
                if (commonMisreads && commonMisreads[barcode]) {
                    barcode = commonMisreads[barcode];
                    console.log('Opraveno pomocí commonMisreads:', barcode);
                } else {
                    // Fallback: zkuste generickou opravu
                    const corrected = attemptEAN8toEAN13Correction(barcode);
                    if (corrected) {
                        barcode = corrected;
                        console.log('Automaticky opraveno EAN-8 na EAN-13:', barcode);
                    }
                }
            }

            function attemptEAN8toEAN13Correction(ean8) {
                // Jednoduchá heuristika pro opravu EAN-8 na EAN-13
                // Toto je příklad - upravte podle vašich potřeb
                if (ean8.startsWith('84')) {
                    return '859' + ean8.substring(2); // Přidání prefixu 859
                }
                return null;
            }

            const calculatedChecksum = (10 - (sum % 10)) % 10;
            const isValid = calculatedChecksum === checksumDigit;

            if (!isValid) {
                console.log('Checksum neplatný:', {
                    kód: barcode,
                    očekávaný: checksumDigit,
                    vypočtený: calculatedChecksum,
                    suma: sum
                });
            }

            return isValid;
        }

        // Přepnutí kamery (přední/zadní)
        async function toggleCamera() {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            barcodeStatus.textContent = 'Přepínám kameru...';

            try {
                await startCamera();
                barcodeStatus.textContent = 'Namiřte na čárový kód';

                // Restart Quagga s novou kamerou
                if (quaggaInitialized) {
                    Quagga.stop();
                    initQuagga();
                    startBarcodeScanning();
                }
            } catch (error) {
                console.error('Chyba při přepínání kamery:', error);
                barcodeStatus.textContent = 'Chyba: ' + error.message;
                barcodeStatus.style.color = 'red';
            }
        }

        // Přepnutí blesku (pokud je dostupný)
        async function toggleFlash() {
            if (!stream) return;

            const videoTrack = stream.getVideoTracks()[0];
            if (!videoTrack) return;

            try {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    await videoTrack.applyConstraints({
                        advanced: [{ torch: !flashEnabled }]
                    });
                    flashEnabled = !flashEnabled;
                    document.getElementById('toggleFlashButton').textContent =
                        flashEnabled ? 'Vypnout blesk' : 'Blesk';
                } else {
                    barcodeStatus.textContent = 'Blesk není dostupný';
                    barcodeStatus.style.color = 'orange';
                    setTimeout(() => {
                        if (barcodeModal.style.display === 'flex') {
                            barcodeStatus.textContent = 'Namiřte na čárový kód';
                            barcodeStatus.style.color = '#666';
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('Chyba při ovládání blesku:', error);
            }
        }

        // Zavření skeneru čárových kódů
        function closeBarcodeScanner() {
            console.log('Zavírám skener...');

            // Zastavíme časový limit
            if (detectionTimeout) {
                clearTimeout(detectionTimeout);
                detectionTimeout = null;
            }

            // Zastavíme stream videa
            if (stream) {
                try {
                    stream.getTracks().forEach(track => {
                        track.stop();
                        console.log('Zastaven track:', track.kind);
                    });
                    stream = null;
                } catch (error) {
                    console.error('Chyba při zastavování streamu:', error);
                }
            }

            // Zastavíme video
            if (barcodeVideo) {
                barcodeVideo.srcObject = null;
            }

            // RESTARTUJEME QUAGGU PRO PŘÍŠTÍ POUŽITÍ
            restartQuagga();

            // Skryjeme modální okno
            barcodeModal.style.display = 'none';

            // Obnovíme výchozí zobrazení
            document.getElementById('barcodeUnsupportedMessage').style.display = 'block';
            barcodeVideo.style.display = 'none';
            document.getElementById('toggleCameraButton').style.display = 'none';
            document.getElementById('toggleFlashButton').style.display = 'none';
            barcodeOverlay.style.display = 'none';

            console.log('Skener úspěšně uzavřen');
        }
        // Najděte existující zavírací kód pro detailsModal a upravte ho
        const detailsModal = document.getElementById('detailsModal');
        if (detailsModal) {
            const closeButton = detailsModal.querySelector('.close-button');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    collapseAllSettingsSections();
                    detailsModal.style.display = 'none';
                    currentEditingRecipeId = null;
                    currentEditingIngredientIndex = null;
                });
            }

            // Upravte také kliknutí mimo modal
            detailsModal.addEventListener('click', (event) => {
                if (event.target === detailsModal) {
                    collapseAllSettingsSections();
                    detailsModal.style.display = 'none';
                    currentEditingRecipeId = null;
                    currentEditingIngredientIndex = null;
                }
            });
        }
        const closeButton = detailsModal.querySelector('.close-button');

        // --- Logika vyhledávání potravin ---
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', async function (event) {
                console.log('Search form submit event fired.');
                event.preventDefault();

                const query = document.getElementById('query').value;
                const resultsDiv = document.getElementById('results');
                const loadingDiv = document.getElementById('loading');
                const errorDiv = document.getElementById('error-message');

                resultsDiv.innerHTML = '';
                errorDiv.innerHTML = '';
                loadingDiv.style.display = 'block';

                // Resetujeme stav přerušení
                isSearchInterrupted = false;

                // Zrušíme předchozí vyhledávání, pokud existuje
                if (currentSearchController) {
                    currentSearchController.abort();
                }

                // Vytvoříme nový AbortController pro aktuální vyhledávání
                currentSearchController = new AbortController();

                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `query=${encodeURIComponent(query)}`,
                        signal: currentSearchController.signal // Připojíme signal pro možnost přerušení
                    });

                    if (!response.ok) {
                        loadingDiv.style.display = 'none';
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            errorData = { error: await response.text() };
                        }
                        errorDiv.textContent = `Chyba: ${errorData.error || response.statusText}`;
                        return;
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';

                    while (true) {
                        // Kontrola přerušení před dalším čtením
                        if (isSearchInterrupted) {
                            console.log('Vyhledávání bylo přerušeno uživatelem');
                            reader.cancel();
                            break;
                        }

                        const { done, value } = await reader.read();
                        if (done) {
                            break;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            try {
                                const item = JSON.parse(line);
                                if (item.error) {
                                    errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                                    loadingDiv.style.display = 'none';
                                    return;
                                }
                                appendFoodItem(item);
                            } catch (e) {
                                console.error('Chyba při parsování JSON řádku:', e, 'Řádek:', line);
                            }
                        }
                    }
                    if (buffer.trim() !== '' && !isSearchInterrupted) {
                        try {
                            const item = JSON.parse(buffer);
                            if (item.error) {
                                errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                            } else {
                                appendFoodItem(item);
                            }
                        } catch (e) {
                            console.error('Chyba při parsování zbytku JSON bufferu:', e, 'Buffer:', buffer);
                        }
                    }

                    loadingDiv.style.display = 'none';
                    if (resultsDiv.innerHTML === '' && !isSearchInterrupted) {
                        resultsDiv.innerHTML = '<p>Nic nenalezeno.</p>';
                    }

                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('Vyhledávání bylo přerušeno uživatelem');
                    } else {
                        console.error('Došlo k chybě:', error);
                        loadingDiv.style.display = 'none';
                        if (!isSearchInterrupted) {
                            errorDiv.textContent = 'Došlo k chybě při komunikaci se serverem.';
                        }
                    }
                }
            });
        } else {
            console.error('Search form element with ID "searchForm" not found.');
        }

        function appendFoodItem(item) {
            // Filter out recipes - only show 'potravina'
            if (item.food_type !== 'potravina') {
                return;
            }

            const resultsDiv = document.getElementById('results');
            const foodItemDiv = document.createElement('div');
            foodItemDiv.classList.add('food-item', 'food-item-potravina');

            // Keep class for styling if needed, even if only 'potravina' is shown
            if (item.food_type === 'potravina') {
                foodItemDiv.classList.add('food-item-potravina');
            }

            if (item.slug) {
                foodItemDiv.dataset.slug = item.slug;
                foodItemDiv.dataset.foodType = item.food_type;

                // Upravený click listener pro přerušení vyhledávání
                foodItemDiv.addEventListener('click', () => {
                    // Přerušíme aktuální vyhledávání
                    isSearchInterrupted = true;
                    if (currentSearchController) {
                        currentSearchController.abort();
                    }
                    // Skryjeme loading indicator
                    document.getElementById('loading').style.display = 'none';
                    // Zobrazíme detaily
                    showDetailsModal(item.slug, item.name, item.image_url, item.calories, item.food_type);
                });
            }

            let imageHtml = '';
            // Updated placeholder image path
            const placeholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}";

            if (item.image_url) {
                imageHtml = `<img src="${item.image_url}" alt="${item.name}" onerror="this.onerror=null;this.src='${placeholderImage}'" />`;
            } else {
                imageHtml = `<img src="${placeholderImage}" alt="Bez obrázku" />`;
            }

            // Parse and reformat item.calories to ensure 1 decimal place
            const { number: caloriesNum, unit: caloriesUnit } = parseValueAndUnit(item.calories);
            const formattedCalories = formatNumberForDisplay(caloriesNum, caloriesUnit, true); // Pass true for isEnergyValue

            // Změněná struktura pro umístění kalorií pod obrázek a labelu vedle názvu
            let itemContent = `
                <div class="image-wrapper">
                    ${imageHtml}
                </div>
                <div class="food-details">
                    <h3>${item.name}</h3>
                    <div class="calories-and-type-row">
                        <p class="calories-display">Kalorie: ${formattedCalories}</p>
                        <!-- Removed foodTypeLabelHtml -->
                    </div>
                </div>
            `;
            foodItemDiv.innerHTML = itemContent;
            resultsDiv.appendChild(foodItemDiv);


            // --- Logika modálního okna pro detaily potravin ---

            const modalDetailsContent = document.getElementById('modalDetailsContent');

            // References to new modals
            const createRecipeModal = document.getElementById('createRecipeModal');
            const newRecipeNameInput = document.getElementById('newRecipeNameInput');
            const confirmCreateRecipeButton = document.getElementById('confirmCreateRecipeButton');
            const cancelCreateRecipeButton = document.getElementById('cancelCreateRecipeButton');

            const selectRecipeModal = document.getElementById('selectRecipeModal');
            const existingRecipesList = document.getElementById('existingRecipesList');
            // const cancelSelectRecipeButton = document.getElementById('cancelSelectRecipeButton'); // Removed
            // const addNewRecipeButton = document.getElementById('addNewRecipeButton'); // Removed

            // References to settings modal elements
            const settingsIcon = document.getElementById('settingsIcon');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModalButton = document.getElementById('closeSettingsModal');
            const confirmRecipeCreationToggle = document.getElementById('confirmRecipeCreationToggle'); // New toggle
            const confirmFoodAdditionToggle = document.getElementById('confirmFoodAdditionToggle'); // New toggle
            const confirmDeleteRecipeToggle = document.getElementById('confirmDeleteRecipeToggle'); // New toggle for delete confirmation
            const confirmDeleteRecipeItemToggle = document.getElementById('confirmDeleteRecipeItemToggle'); // NEW toggle
            const confirmSaveChangesToggle = document.getElementById('confirmSaveChangesToggle'); // NEW
            const confirmRecipeSaveSuccessToggle = document.getElementById('confirmRecipeSaveSuccessToggle'); // NEW

            // currentFoodItemData is now in global scope
            // let currentFoodItemData = null; // To store data of the food item being processed

            // Event listener for the toggle switch in the settings modal for recipe creation
            if (confirmRecipeCreationToggle) {
                confirmRecipeCreationToggle.addEventListener('change', () => {
                    userSettings.confirmRecipeCreation = confirmRecipeCreationToggle.checked;
                    saveUserSettings(); // Save to Firestore
                    console.log("Potvrzení vytvoření receptu povoleno:", userSettings.confirmRecipeCreation);
                });
            }

            // Event listener for the toggle switch in the settings modal for food addition
            if (confirmFoodAdditionToggle) {
                confirmFoodAdditionToggle.addEventListener('change', () => {
                    userSettings.confirmFoodAddition = confirmFoodAdditionToggle.checked;
                    saveUserSettings(); // Save to Firestore
                    console.log("Potvrzení přidání potraviny povoleno:", userSettings.confirmFoodAddition);
                });
            }

            // Event listener for the toggle switch in the settings modal for delete confirmation
            if (confirmDeleteRecipeToggle) {
                confirmDeleteRecipeToggle.addEventListener('change', () => {
                    userSettings.confirmDeleteRecipe = confirmDeleteRecipeToggle.checked;
                    saveUserSettings(); // Save to Firestore
                    console.log("Potvrzení smazání receptu povoleno:", userSettings.confirmDeleteRecipe);
                });
            }

            // NEW: Event listener for the toggle switch in the settings modal for recipe item deletion
            if (confirmDeleteRecipeItemToggle) {
                confirmDeleteRecipeItemToggle.addEventListener('change', () => {
                    userSettings.confirmDeleteRecipeItem = confirmDeleteRecipeItemToggle.checked;
                    saveUserSettings(); // Save to Firestore
                    console.log("Potvrzení smazání položky povoleno:", userSettings.confirmDeleteRecipeItem);
                });
            }

            // NEW: Event listener for the toggle switch in the settings modal for save changes confirmation
            if (confirmSaveChangesToggle) {
                confirmSaveChangesToggle.addEventListener('change', () => {
                    userSettings.confirmSaveChanges = confirmSaveChangesToggle.checked;
                    saveUserSettings(); // Save to Firestore
                    console.log("Potvrzení uložení změn povoleno:", userSettings.confirmSaveChanges);
                });
            }

            // NEW: Event listener for the toggle switch in the settings modal for successful save notification
            if (confirmRecipeSaveSuccessToggle) {
                confirmRecipeSaveSuccessToggle.addEventListener('change', () => {
                    userSettings.confirmRecipeSaveSuccess = confirmRecipeSaveSuccessToggle.checked;
                    saveUserSettings(); // Save to Firestore
                    console.log("Oznámení úspěšného uložení změn povoleno:", userSettings.confirmRecipeSaveSuccess);
                });
            }

            // New toggle for successful recipe deletion notification
            const confirmRecipeDeletionSuccessToggle = document.getElementById('confirmRecipeDeletionSuccessToggle');
            if (confirmRecipeDeletionSuccessToggle) {
                confirmRecipeDeletionSuccessToggle.addEventListener('change', () => {
                    userSettings.confirmRecipeDeletionSuccess = confirmRecipeDeletionSuccessToggle.checked;
                    saveUserSettings();
                    console.log("Potvrzení úspěšného smazání povoleno:", userSettings.confirmRecipeDeletionSuccess);
                });
            }

            // New toggle for recipe deletion error notification
            const confirmRecipeDeletionErrorToggle = document.getElementById('confirmRecipeDeletionErrorToggle');
            if (confirmRecipeDeletionErrorToggle) {
                confirmRecipeDeletionErrorToggle.addEventListener('change', () => {
                    userSettings.confirmRecipeDeletionError = confirmRecipeDeletionErrorToggle.checked;
                    saveUserSettings();
                    console.log("Potvrzení chyby smazání povoleno:", userSettings.confirmRecipeDeletionError);
                });
            }

            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    detailsModal.style.display = 'none';
                    // Reset current editing context when closing the modal
                    currentEditingRecipeId = null;
                    currentEditingIngredientIndex = null;
                });
            }

            window.addEventListener('click', (event) => {
                if (event.target == detailsModal) {
                    detailsModal.style.display = 'none';
                    // Reset current editing context when closing the modal
                    currentEditingRecipeId = null;
                    currentEditingIngredientIndex = null;
                }
                if (event.target == settingsModal) { // Close settings modal if clicked outside
                    settingsModal.style.display = 'none';
                }
                // Close custom notification modal if clicked outside, unless it's a confirmation type
                if (event.target == customNotificationModal && customNotificationModal.style.display === 'flex') {
                    // If it's a confirmation, don't close on outside click.
                    // This requires a way to know if it's a confirmation.
                    // For now, let's assume all custom notifications can be closed by outside click.
                    // A more robust solution would be to add a data attribute to the modal when it's a confirmation.
                    customNotificationModal.style.display = 'none';
                }
                // Close selectRecipeModal if clicked outside
                if (event.target == selectRecipeModal) {
                    selectRecipeModal.style.display = 'none';
                }
                // Close barcodeModal if clicked outside
                if (event.target == barcodeModal) {
                    closeBarcodeScanner();
                }
            });

            // Close new modals
            document.getElementById('closeCreateRecipeModal').addEventListener('click', () => {
                createRecipeModal.style.display = 'none';
            });

            // Event listener for confirming new recipe creation
            if (confirmCreateRecipeButton) { // Add check for existence
                confirmCreateRecipeButton.onclick = async () => {
                    const recipeName = newRecipeNameInput.value.trim();
                    if (recipeName) {
                        await createNewRecipe(recipeName, currentFoodItemData);
                        createRecipeModal.style.display = 'none';
                    } else {
                        window.showCustomNotification("Prosím, zadejte název receptu.", 'validationError');
                    }
                };
            }

            // Event listener for canceling new recipe creation
            if (cancelCreateRecipeButton) { // Add check for existence
                cancelCreateRecipeButton.addEventListener('click', () => {
                    createRecipeModal.style.display = 'none';
                });
            }

            document.getElementById('closeSelectRecipeModal').addEventListener('click', () => {
                selectRecipeModal.style.display = 'none';
            });

            // Settings icon click listener
            if (settingsIcon) {
                settingsIcon.addEventListener('click', () => {
                    settingsModal.style.display = 'flex';
                });
            }

            // Close settings modal button
            if (closeSettingsModalButton) {
                closeSettingsModalButton.addEventListener('click', () => {
                    settingsModal.style.display = 'none';
                });
            }

        }; // End of DOMContentLoaded

        async function showDetailsModal(slug, name, imageUrl, initialCaloriesString, foodType, isEditingRecipeIngredient = false, initialAmount = 100, initialUnit = 'g', originalNutritionalDetails = null) {
            console.log("showDetailsModal called for slug:", slug, "name:", name, "foodType:", foodType, "isEditingRecipeIngredient:", isEditingRecipeIngredient);
            modalDetailsContent.classList.remove('modal-recipe-container');
            document.getElementById('modalDetailsContent').classList.remove('modal-recipe-container');
            document.getElementById('detailsModal').classList.remove('modal-recipe-open');
            detailsModal.style.display = 'flex';
            modalDetailsContent.innerHTML = `<p class="loading-details">Načítám detaily pro ${name}...</p>`;

            try {
                let details;
                if (isEditingRecipeIngredient && originalNutritionalDetails) {
                    details = originalNutritionalDetails;
                    console.log("Using provided nutritional details for editing:", details);
                } else {
                    console.log("🔍 Volám /get_details endpoint...");
                    const response = await fetch('/get_details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            slug: slug,
                            food_type: foodType
                        })
                    });

                    console.log("📊 Response status:", response.status);
                    console.log("📊 Response ok:", response.ok);

                    if (!response.ok) {
                        let errorMessage = `Chyba při načítání detailů (Status: ${response.status}).`;
                        let rawResponseText = await response.text();
                        console.error("❌ Raw server response (not OK):", rawResponseText);

                        // Zkuste parsovat jako JSON, pokud to selže, použijte raw text
                        try {
                            const errorData = JSON.parse(rawResponseText);
                            if (errorData && errorData.error) {
                                errorMessage = `Chyba ze serveru: ${errorData.error}`;
                            }
                        } catch (jsonParseError) {
                            console.error("❌ Nepodařilo se parsovat odpověď serveru jako JSON:", jsonParseError);
                            errorMessage = `Chyba při komunikaci se serverem: ${response.statusText || 'Neznámá chyba'}. Odpověď: ${rawResponseText.substring(0, 100)}...`;
                        }
                        modalDetailsContent.innerHTML = `<p class="error-details">${errorMessage}</p>`;
                        return;
                    }

                    // Pokud response je OK, zkuste parsovat jako JSON
                    try {
                        details = await response.json();
                        console.log("✅ Received details JSON:", details);
                    } catch (jsonError) {
                        console.error("❌ Error parsing JSON response:", jsonError);
                        modalDetailsContent.innerHTML = `<p class="error-details">Chyba při zpracování odpovědi ze serveru.</p>`;
                        return;
                    }
                }

                let originalDetailsData = details;

                if (details.error) {
                    modalDetailsContent.innerHTML = `<p class="error-details">Chyba ze serveru: ${details.error}</p>`;
                } else {
                    // Updated placeholder image path
                    const placeholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}";
                    let displayImageUrl = imageUrl || placeholderImage;

                    const { unit: initialUnitForTypeDetection } = parseValueAndUnit(initialCaloriesString);
                    const isLiquidFood = initialUnitForTypeDetection.toLowerCase().includes('ml');

                    let actionButtonsHtml = '';
                    if (isEditingRecipeIngredient) {
                        actionButtonsHtml = `
                            <div class="modal-action-buttons">
                                <button id="saveChangesButton" style="background-color: #28a745;">Uložit změny</button>
                                <button id="discardChangesButton" style="background-color: #dc3545;">Zahodit změny</button>
                            </div>
                        `;
                    } else {
                        actionButtonsHtml = `
                            <div class="modal-action-buttons">
                                <button id="addToRecipeButton">Přidat do receptu</button>
                                <button id="createAndAddRecipeButton">Vytvořit recept a přidat</button>
                            </div>
                        `;
                    }

                    let detailsHtml = `
                        <div class="modal-header-content">
                            <img id="modalHeaderImage" src="${displayImageUrl}" alt="${name}" class="modal-header-image" onerror="this.onerror=null;this.src='${placeholderImage}'" />
                            <div id="modalHeaderName" class="modal-header-name">${name}</div>
                        </div>
                        ${actionButtonsHtml}
                        <div class="interactive-section">
                            <div class="amount-controls">
                                <input type="number" id="amountInput" value="${initialAmount}" min="0" step="1" class="amount-input">
                                <select id="unitSelect" class="unit-select">
                                    <!-- Options will be dynamically added here -->
                                </select>
                            </div>
                            <div class="energy-display-group">
                                <div id="totalKcalDisplay" class="energy-header"></div>
                                <div id="totalKjDisplay" class="energy-sub-header"></div>
                            </div>
                        </div>
                        <div id="nutrientDetailsSection">
                            <!-- Nutrients will be rendered here by renderAllNutrientDetails -->
                        </div>
                        ${details.source_url ? `<p style="text-align: center; margin-top: 20px;"><a href="${details.source_url}" target="_blank">Zobrazit na KalorickéTabulky.cz</a></p>` : ''}
                    `;
                    modalDetailsContent.innerHTML = detailsHtml;

                    // Re-get references to elements after innerHTML is set
                    const amountInput = document.getElementById('amountInput');
                    const unitSelect = document.getElementById('unitSelect');
                    const addToRecipeButton = document.getElementById('addToRecipeButton'); // May be null
                    const createAndAddRecipeButton = document.getElementById('createAndAddRecipeButton'); // May be null
                    const saveChangesButton = document.getElementById('saveChangesButton'); // May be null
                    const discardChangesButton = document.getElementById('discardChangesButton'); // May be null

                    unitSelect.innerHTML = '';
                    if (isLiquidFood) {
                        unitSelect.add(new Option('ml', 'ml'));
                        unitSelect.add(new Option('l', 'l'));
                        unitSelect.value = initialUnit;
                    } else {
                        unitSelect.add(new Option('g', 'g'));
                        unitSelect.add(new Option('kg', 'kg'));
                        unitSelect.value = initialUnit;
                    }

                    const updateDisplay = () => {
                        const currentAmount = parseFloat(amountInput.value) || 0;
                        const selectedUnit = unitSelect.value;
                        let baseAmount = currentAmount;

                        if (selectedUnit === 'kg') {
                            baseAmount = currentAmount * 1000;
                        } else if (selectedUnit === 'l') {
                            baseAmount = currentAmount * 1000;
                        }

                        let factor = baseAmount / 100;

                        renderAllNutrientDetails(originalDetailsData, factor);

                        // Update currentFoodItemData with the latest calculated values for saving/adding
                        currentFoodItemData = {
                            foodName: name,
                            slug: slug,
                            imageUrl: displayImageUrl,
                            foodType: foodType,
                            amount: currentAmount,
                            unit: selectedUnit,
                            kcal: document.getElementById('totalKcalDisplay').textContent, // Store the calculated kcal
                            nutritionalDetails: originalDetailsData // Store the full nutritional details
                        };
                    };

                    amountInput.addEventListener('input', updateDisplay);
                    unitSelect.addEventListener('change', updateDisplay);

                    updateDisplay(); // Initial display update

                    // Event listeners for buttons
                    if (addToRecipeButton) {
                        addToRecipeButton.addEventListener('click', async (e) => {
                            e.stopPropagation();

                            if (!checkInitialization()) {
                                return;
                            }

                            console.log('Přidat do receptu clicked for:', name);
                            await loadUserRecipes(true);
                            detailsModal.style.display = 'none';
                            selectRecipeModal.style.display = 'flex';
                        });
                    }

                    if (createAndAddRecipeButton) {
                        createAndAddRecipeButton.addEventListener('click', (e) => {
                            e.stopPropagation();

                            if (!checkInitialization()) {
                                return;
                            }

                            console.log('Vytvořit recept a přidat clicked for:', name);
                            detailsModal.style.display = 'none';
                            createRecipeModal.style.display = 'flex';
                            newRecipeNameInput.value = '';
                            newRecipeNameInput.focus();
                        });
                    }

                    if (saveChangesButton) {
                        saveChangesButton.addEventListener('click', async () => {
                            if (currentEditingRecipeId && currentEditingIngredientIndex !== null) {
                                await updateFoodItemInRecipe(currentEditingRecipeId, currentEditingIngredientIndex, currentFoodItemData);
                                // The modal closing and recipe details reloading is now handled within updateFoodItemInRecipe's success callback
                            } else {
                                window.showCustomNotification("Chyba: Nelze uložit změny. Chybí kontext úpravy.", 'info');
                            }
                        });
                    }

                    if (discardChangesButton) {
                        discardChangesButton.addEventListener('click', async () => {
                            detailsModal.style.display = 'none';
                            // Optionally, reload the original recipe details if needed
                            if (currentEditingRecipeId) {
                                const recipeDocRef = doc(db, `artifacts/${appId}/profiles/${currentProfileId}/recipes`, currentEditingRecipeId);
                                const recipeSnap = await getDoc(recipeDocRef);
                                if (recipeSnap.exists()) {
                                    await showRecipeDetailsModal(currentEditingRecipeId, recipeSnap.data().name);
                                }
                            }
                            // Reset current editing context
                            currentEditingRecipeId = null;
                            currentEditingIngredientIndex = null;
                        });
                    }

                    const modalHeaderImage = document.getElementById('modalHeaderImage');
                    const modalHeaderName = document.getElementById('modalHeaderName');

                    if (modalHeaderImage && modalHeaderName) {
                        const imageHeight = modalHeaderImage.offsetHeight;
                        let currentFontSize = imageHeight * 0.25;
                        modalHeaderName.style.fontSize = `${currentFontSize}px`;

                        while ((modalHeaderName.scrollWidth > modalHeaderName.clientWidth || modalHeaderName.scrollHeight > modalHeaderName.clientHeight) && currentFontSize > 10) {
                            currentFontSize -= 0.5;
                            modalHeaderName.style.fontSize = `${currentFontSize}px`;
                        }
                    }
                }

            } catch (error) {
                console.error('Chyba při získávání detailů:', error);
                modalDetailsContent.innerHTML = `<p class="error-details">Došlo k chybě při komunikaci se serverem pro detaily.</p>`;
            }
        }

        // --- Logika pro tlačítko "Recepty" a modální okno s možnostmi receptů ---
        const recipesButton = document.getElementById('recipesButton');

        // Modified recipesButton listener
        if (recipesButton) {
            recipesButton.addEventListener('click', async () => {
                try {
                    await waitForInitialization();
                    await loadUserRecipes();
                    selectRecipeModal.style.display = 'flex';
                } catch (error) {
                    window.showCustomNotification("Aplikace není připravena. Zkuste to prosím znovu.", 'error');
                }
            });
        }

        // Na konec souboru přidejte/upravte
        console.log("✅ Script načten, čekám na DOM...");

        // =============================================
        // INICIALIZACE EVENT LISTENERŮ
        // =============================================

        // Jediná inicializace při načtení DOM
        document.addEventListener('DOMContentLoaded', async function () {

            console.log("✅ DOM načten, spouštím aplikaci...");

            // Kontrola, zda již nebyla inicializována
            if (window.appInitialized) {
                console.log("⚠️ Aplikace již byla inicializována - přeskočeno");
                return;
            }

            window.appInitialized = true;
            await initializeApplication();

            // Přihlášení
            document.getElementById('loginBtn').addEventListener('click', async function () {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                if (!email || !password) {
                    errorDiv.textContent = "Vyplňte email a heslo";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    await loginUser(email, password);
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            // Registrace
            document.getElementById('registerBtn').addEventListener('click', async function () {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                if (!email || !password) {
                    errorDiv.textContent = "Vyplňte email a heslo";
                    errorDiv.style.display = 'block';
                    return;
                }

                if (password.length < 6) {
                    errorDiv.textContent = "Heslo musí mít alespoň 6 znaků";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    await registerUser(email, password);
                    errorDiv.style.display = 'none';
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            // Pokračovat anonymně
            document.getElementById('continueAnonymouslyBtn').addEventListener('click', function () {
                continueAnonymously();
            });

            // Enter v inputech
            document.getElementById('loginEmail').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginPassword').focus();
                }
            });

            document.getElementById('loginPassword').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginBtn').click();
                }
            });

            console.log("✅ DOM načten, inicializuji event listenery...");

            // Přidat event listener i při načtení stránky (pro případ, že profil je již zobrazen)
            setTimeout(() => {
                attachProfileClickListener();
            }, 1000);

            // Event listener pro vytvoření profilu
            const confirmCreateProfileBtn = document.getElementById('confirmCreateProfile');
            if (confirmCreateProfileBtn) {
                console.log("✅ Nalezeno tlačítko confirmCreateProfile");

                // Odstranění všech existujících listenerů
                confirmCreateProfileBtn.replaceWith(confirmCreateProfileBtn.cloneNode(true));

                // Znovu najít tlačítko po clone
                const newConfirmCreateProfileBtn = document.getElementById('confirmCreateProfile');

                document.getElementById('confirmCreateProfile').addEventListener('click', async function (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();

                    console.log("🎯 Kliknuto na vytvoření profilu");

                    if (this.disabled) {
                        console.log("⚠️ Tlačítko již je disabled - přeskočeno");
                        return;
                    }

                    const profileNameInput = document.getElementById('newProfileName');
                    if (profileNameInput) {
                        const profileName = profileNameInput.value.trim();
                        console.log("📝 Jméno profilu:", profileName);

                        if (!profileName) {
                            window.showCustomNotification("Prosím, zadejte název profilu.", 'info');
                            return;
                        }

                        // Disable tlačítka během vytváření
                        this.disabled = true;
                        const originalText = this.textContent;
                        this.textContent = "Vytváření...";

                        try {
                            const newProfileId = await createNewProfile(profileName);
                            console.log("🆔 Nové ID profilu:", newProfileId);

                            if (newProfileId) {
                                // Zavřít modální okno vytvoření profilu
                                const createProfileModal = document.getElementById('createProfileModal');
                                if (createProfileModal) {
                                    createProfileModal.style.display = 'none';
                                    console.log("✅ Modální okno vytvoření profilu zavřeno");
                                }

                                // NENÍ POTŘEBA VOLAT selectProfile() - už se volá v createNewProfile()
                            }
                        } catch (error) {
                            console.error("❌ Chyba při vytváření profilu:", error);
                        } finally {
                            // Re-enable tlačítka pouze pokud stále existuje
                            if (this && this.parentNode) {
                                this.disabled = false;
                                this.textContent = originalText;
                            }
                        }
                    }
                });
            } else {
                console.error("❌ Tlačítko confirmCreateProfile nebylo nalezeno!");
            }

            // Event listener pro kliknutí na profil
            document.addEventListener('DOMContentLoaded', function () {
                const profileDisplay = document.getElementById('currentProfileDisplay');

                if (profileDisplay) {
                    // Odstranit předchozí event listenery
                    profileDisplay.replaceWith(profileDisplay.cloneNode(true));

                    // Přidat nový event listener
                    document.getElementById('currentProfileDisplay').addEventListener('click', function (e) {
                        e.stopPropagation();
                        console.log("🎯 Kliknuto na profil v headeru");
                        console.log("🔍 Stav isProfileModalShowing před otevřením:", window.isProfileModalShowing);
                        window.showProfileModal();
                    });
                }
            });

            // Reference na modální okna a jejich ovládací prvky
            const closeButton = detailsModal ? detailsModal.querySelector('.close-button') : null;
            const createRecipeModal = document.getElementById('createRecipeModal');
            const selectRecipeModal = document.getElementById('selectRecipeModal');
            const settingsModal = document.getElementById('settingsModal');
            const barcodeModal = document.getElementById('barcodeModal');

            // Event listener pro zavírací tlačítko detailního modalu
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    detailsModal.style.display = 'none';
                    currentEditingRecipeId = null;
                    currentEditingIngredientIndex = null;
                });
            }

            // Event listener pro zavírání kliknutím mimo modální okno
            window.addEventListener('click', (event) => {
                if (event.target == detailsModal) {
                    detailsModal.style.display = 'none';
                    currentEditingRecipeId = null;
                    currentEditingIngredientIndex = null;
                }
                if (event.target == settingsModal) {
                    settingsModal.style.display = 'none';
                }
                if (event.target == selectRecipeModal) {
                    selectRecipeModal.style.display = 'none';
                }
                if (event.target == barcodeModal) {
                    closeBarcodeScanner();
                }
            });

            const createNewProfileBtn = document.getElementById('createNewProfileBtn');
            if (createNewProfileBtn) {
                createNewProfileBtn.addEventListener('click', () => {
                    document.getElementById('profileModal').style.display = 'none';
                    window.showCreateProfileModal();
                });
            }

            const confirmCreateProfile = document.getElementById('confirmCreateProfile');
            if (confirmCreateProfile) {
                confirmCreateProfile.addEventListener('click', async () => {
                    const profileName = document.getElementById('newProfileName').value.trim();
                    if (profileName) {
                        const newProfileId = await createNewProfile(profileName);
                        if (newProfileId) {
                            await selectProfile(newProfileId);
                            document.getElementById('createProfileModal').style.display = 'none';
                        }
                    }
                });
            }

            const cancelCreateProfile = document.getElementById('cancelCreateProfile');
            if (cancelCreateProfile) {
                cancelCreateProfile.addEventListener('click', () => {
                    document.getElementById('createProfileModal').style.display = 'none';
                    showProfileModal();
                });
            }

            const closeCreateProfileModal = document.getElementById('closeCreateProfileModal');
            if (closeCreateProfileModal) {
                closeCreateProfileModal.addEventListener('click', () => {
                    document.getElementById('createProfileModal').style.display = 'none';
                    showProfileModal();
                });
            }

            // Event listener pro nastavovací ikonku
            const settingsIcon = document.getElementById('settingsIcon');
            if (settingsIcon) {
                settingsIcon.addEventListener('click', () => {
                    settingsModal.style.display = 'flex';
                });
            }

            // Event listener pro tlačítko zavření nastavení
            const closeSettingsModalButton = document.getElementById('closeSettingsModal');
            if (closeSettingsModalButton) {
                closeSettingsModalButton.addEventListener('click', () => {
                    settingsModal.style.display = 'none';
                });
            }

            // Event listener pro tlačítko zavření výběru receptu
            const closeSelectRecipeModal = document.getElementById('closeSelectRecipeModal');
            if (closeSelectRecipeModal) {
                closeSelectRecipeModal.addEventListener('click', () => {
                    selectRecipeModal.style.display = 'none';
                });
            }

            // Event listener pro tlačítko zavření vytváření receptu
            document.getElementById('closeCreateRecipeModal').addEventListener('click', () => {
                createRecipeModal.style.display = 'none';
            });

            console.log("Modální okna inicializována");
        });

    </script>

    <!-- Load QuaggaJS for barcode scanning -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</body>

</html>