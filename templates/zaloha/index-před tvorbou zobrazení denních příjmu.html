<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorick√° kalkulaƒçka</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>

<body data-app-id="{{ app_id }}" data-supabase-url="{{ supabase_url }}" data-supabase-key="{{ supabase_key }}">
    <div class="container">
        <div id="userMenu" style="position: absolute; top: 10px; right: 60px; z-index: 11; display: none;">
            <button id="logoutBtn" style="padding: 5px 10px; font-size: 12px;">Odhl√°sit se</button>
        </div>

        <div id="globalLoading"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
            <div style="text-align: center;">
                <div style="margin-bottom: 10px;">Naƒç√≠t√°n√≠ aplikace...</div>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <button id="manualInitButton"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
            Obnovit aplikaci
        </button>

        <div class="sticky-header-wrapper">
            <div class="header-controls">
                <button id="loginMenuBtn" style="margin-left: 10px; padding: 5px 10px; display: none;">
                    P≈ôihl√°sit se
                </button>
            </div>

            <div id="userIdDisplay"></div>
            <h1>Kalorick√° kalkulaƒçka</h1>

            <div id="currentProfileDisplay" style="display: none;" class="profile-button-container">
                <div class="profile-display-clickable">
                    <div class="profile-email" id="currentProfileEmail"></div>
                    <div class="profile-info">
                        <img src="{{ url_for('static', filename='icon/profil.png') }}" alt="Profil"
                            class="profile-icon">
                        <span id="currentProfileName">N√°zev profilu</span>
                    </div>
                </div>
            </div>

            <img id="settingsIcon" src="{{ url_for('static', filename='icon/nastaveni.png') }}" alt="Nastaven√≠"
                class="settings-icon">

            <div class="search-and-recipes-container">
                <div class="main-controls">
                    <button id="recipesButton" disabled>Recepty</button>
                    <button id="barcodeButton" style="margin-left: 10px;">üì∑ Skenovat k√≥d</button>
                </div>

                <form id="searchForm">
                    <input type="text" id="query" name="query"
                        placeholder="Zadejte n√°zev potraviny (nap≈ô. jablko, ku≈ôe)">
                    <button type="submit">Vyhledat</button>
                </form>
            </div>

            <div id="loading">Vyhled√°v√°m...</div>
            <div id="error-message" class="error"></div>
        </div>

        <div id="results"></div>
    </div>

    <div id="personalCardModal" class="modal-overlay">
        <div class="modal-content personal-card-modal">
            <span class="close-button" id="closePersonalCardModal">&times;</span>

            <!-- HLAVIƒåKA - BEZ MODR√âHO POZAD√ç -->
            <div class="personal-card-header" style="background: none; color: #000; padding: 20px 30px 0 30px;">
                <h2 style="color: #000;">üßò Osobn√≠ karta</h2>
                <p class="personal-card-subtitle" style="color: #000; opacity: 0.8;">Nastavte si sv√© c√≠le a z√≠skejte
                    personalizovan√° doporuƒçen√≠</p>
            </div>

            <!-- OBSAH -->
            <div class="personal-card-content">

                <!-- LEV√ù SLOUPEC - Z√ÅKLADN√ç √öDAJE A MAKRO≈ΩIVINY -->
                <div class="personal-card-column">
                    <!-- Z√ÅKLADN√ç √öDAJE -->
                    <div class="personal-card-section">
                        <h3>üìä Z√°kladn√≠ √∫daje</h3>

                        <div class="form-row">
                            <div class="form-group gender-group">
                                <label for="gender">Pohlav√≠</label>
                                <select id="gender" class="form-input" required>
                                    <option value="" disabled selected>‚ôÇ/‚ôÄ</option>
                                    <option value="male">‚ôÇ Mu≈æ</option>
                                    <option value="female">‚ôÄ ≈Ωena</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="age">Vƒõk</label>
                                <input type="number" id="age" class="form-input" placeholder="30" min="15" max="100">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="height">V√Ω≈°ka (cm)</label>
                                <input type="number" id="height" class="form-input" placeholder="175" min="100"
                                    max="250">
                            </div>
                            <div class="form-group weight-group">
                                <label for="weight">Aktu√°ln√≠ hmotnost (kg)</label>
                                <input type="number" id="weight" class="form-input" placeholder="75" min="30" max="300"
                                    step="0.1">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group body-fat-group">
                                <label for="bodyFat">Podko≈æn√≠ tuk (%)</label>
                                <input type="number" id="bodyFat" class="form-input" placeholder="20" min="5" max="60"
                                    step="0.1">
                            </div>
                            <div class="form-group activity-level-group">
                                <label for="activityLevel">Denn√≠ pohybov√° aktivita</label>
                                <select id="activityLevel" class="form-input">
                                    <option value="" disabled selected>Vyberte aktivitu</option>
                                    <option value="1.2">Sedav√Ω (minimum pohybu)</option>
                                    <option value="1.375">Lehce aktivn√≠ (1-3x t√Ωdnƒõ)</option>
                                    <option value="1.55">St≈ôednƒõ aktivn√≠ (3-5x t√Ωdnƒõ)</option>
                                    <option value="1.725">Velmi aktivn√≠ (6-7x t√Ωdnƒõ)</option>
                                    <option value="1.9">Extr√©mnƒõ aktivn√≠ (fyzick√° pr√°ce + tr√©nink)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SAMOSTATN√â MAKRO≈ΩIVINY -->
                    <div class="personal-card-section macros-section">
                        <h3>üí™ Makro≈æiviny</h3>
                        <div class="macros-subtitle">Doporuƒçen√° denn√≠ d√°vka</div>
                        <div class="macros-grid-2rows">
                            <div class="macro-row">
                                <div class="macro-item protein">
                                    <div class="macro-icon">ü•©</div>
                                    <div class="macro-info">
                                        <div class="macro-label">B√≠lkoviny</div>
                                        <div class="macro-value" id="proteinResult">- g</div>
                                    </div>
                                </div>
                                <div class="macro-item carbs">
                                    <div class="macro-icon">üçö</div>
                                    <div class="macro-info">
                                        <div class="macro-label">Sacharidy</div>
                                        <div class="macro-value" id="carbsResult">- g</div>
                                    </div>
                                </div>
                            </div>
                            <div class="macro-row">
                                <div class="macro-item fats">
                                    <div class="macro-icon">ü•ë</div>
                                    <div class="macro-info">
                                        <div class="macro-label">Tuky</div>
                                        <div class="macro-value" id="fatsResult">- g</div>
                                    </div>
                                </div>
                                <div class="macro-item fiber">
                                    <div class="macro-icon">üåæ</div>
                                    <div class="macro-info">
                                        <div class="macro-label">Vl√°knina</div>
                                        <div class="macro-value" id="fiberResult">- g</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRAV√ù SLOUPEC - C√çLE A V√ùSLEDKY -->
                <div class="personal-card-column">

                    <!-- C√çL A INTENZITA S C√çLOVOU HMOTNOST√ç -->
                    <div class="personal-card-section">
                        <h3>üéØ C√≠l</h3>

                        <div class="form-group">
                            <label for="goal">C√≠l</label>
                            <select id="goal" class="form-input">
                                <option value="" disabled selected>Vyberte c√≠l</option>
                                <option value="loss">Redukce hmotnosti</option>
                                <option value="maintain">Udr≈æen√≠ hmotnosti</option>
                                <option value="gain">Nab√≠r√°n√≠ hmotnosti</option>
                            </select>
                        </div>

                        <!-- SKRYT√Å INTENZITA - V≈ΩDY "light" -->
                        <input type="hidden" id="intensity" value="light">

                        <!-- P≈òESUNUTO: C√≠lov√° hmotnost S VƒöT≈†√çM ROZESTUPEM -->
                        <div class="form-group" style="margin-top: 25px;">
                            <label for="targetWeight">C√≠lov√° hmotnost (kg)</label>
                            <input type="number" id="targetWeight" class="form-input" placeholder="70" min="30"
                                max="300" step="0.1">
                        </div>
                    </div>

                    <!-- V√ùSLEDKY -->
                    <div class="personal-card-section results-section">
                        <h3>üìà V√Ωsledky</h3>
                        <div class="results-grid-single-line">
                            <div class="result-item-single">
                                <div class="result-label">Baz√°ln√≠ metabolismus</div>
                                <div class="result-value" id="bmrResult">- kcal</div>
                            </div>
                            <div class="result-item-single">
                                <div class="result-label">Denn√≠ v√Ωdej (TDEE)</div>
                                <div class="result-value" id="tdeeResult">- kcal</div>
                            </div>
                            <div class="result-item-single highlight">
                                <div class="result-label">Doporuƒçen√Ω p≈ô√≠jem</div>
                                <div class="result-value" id="targetCaloriesResult">- kcal</div>
                            </div>
                            <div class="result-item-single">
                                <div class="result-label">Rozd√≠l hmotnosti</div>
                                <div class="result-value" id="weightDiffResult">- kg</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PATIƒåKA S TLAƒå√çTKY -->
            <div class="personal-card-footer">
                <button id="calculatePersonalCard" class="btn-primary">Spoƒç√≠tat</button>
                <button id="savePersonalCard" class="btn-primary" disabled>Ulo≈æit data</button>
            </div>
        </div>
    </div>

    <!-- Mod√°ln√≠ okna -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <h3>P≈ôihl√°≈°en√≠ / Registrace</h3>
            <div id="loginError" class="error" style="display: none;"></div>
            <div id="loginSuccess" class="success" style="display: none; color: green;"></div>

            <input type="email" id="loginEmail" placeholder="E-mail" required>
            <input type="password" id="loginPassword" placeholder="Heslo" required>

            <div class="registration-info"
                style="font-size: 12px; color: #666; margin-bottom: 15px; text-align: center;">
                Pro registraci pou≈æijte pros√≠m existuj√≠c√≠ emailovou adresu.
            </div>

            <div class="modal-action-buttons">
                <button id="loginBtn">P≈ôihl√°sit se</button>
                <button id="registerBtn" class="btn-primary">Registrovat</button>
            </div>

            <!-- P≈òID√ÅNO: text-align: center pro zarovn√°n√≠ na st≈ôed -->
            <div class="email-verification-info" style="text-align: center;">
                Po registraci je pot≈ôeba potvrdit email. Zkontrolujte si spam slo≈æku.
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeProfileModal">&times;</span>
            <h3>Spr√°va profil≈Ø</h3>
            <p class="profile-instruction-text">Vyberte si profil pro ukl√°d√°n√≠ recept≈Ø a nastaven√≠</p>
            <div id="profileList"></div>
            <div class="modal-action-buttons">
                <button id="createNewProfileBtn" class="btn-primary">Vytvo≈ôit nov√Ω profil</button>
            </div>
        </div>
    </div>

    <div id="createProfileModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeCreateProfileModal">&times;</span>
            <h3>Vytvo≈ôit nov√Ω profil</h3>
            <input type="text" id="newProfileName" placeholder="Jm√©no profilu">
            <div class="create-profile-buttons">
                <button id="confirmCreateProfile" class="btn-primary">Vytvo≈ôit</button>
                <button id="cancelCreateProfile" class="btn-secondary">Zru≈°it</button>
            </div>
        </div>
    </div>

    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content modal-recipe-content">
            <span class="close-button">&times;</span>
            <div class="modal-recipe-scroll-container">
                <div id="modalDetailsContent" class="modal-details modal-recipe-container">
                    <div class="modal-recipe-header">
                        <img id="modalHeaderImage" src="" alt="" class="modal-header-image">
                        <div class="modal-header-text">
                            <div id="modalHeaderName" class="modal-header-name">N√°zev receptu</div>
                            <div class="energy-display-group">
                                <div id="totalKcalDisplay" class="energy-header">0 kcal</div>
                                <div id="totalKjDisplay" class="energy-sub-header">0 kJ</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-scrollable-container">
                        <div id="nutrientDetailsSection"></div>
                        <h3 class="ingredients-title">Slo≈æen√≠ receptu:</h3>
                        <div id="recipeIngredientsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="createRecipeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeCreateRecipeModal">&times;</span>
            <h3>Vytvo≈ôit nov√Ω recept</h3>
            <input type="text" id="newRecipeNameInput" placeholder="N√°zev receptu">
            <div class="create-recipe-buttons">
                <button id="confirmCreateRecipeButton" class="btn-primary">Vytvo≈ôit a p≈ôidat</button>
                <button id="cancelCreateRecipeButton" class="btn-secondary">Zru≈°it</button>
            </div>
        </div>
    </div>

    <div id="selectRecipeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeSelectRecipeModal">&times;</span>
            <h3>Moje recepty</h3>
            <div id="recipeCountDisplay" class="recipe-count-display"></div>
            <div class="recipes-list-container">
                <ul id="existingRecipesList"></ul>
            </div>
            <div class="recipe-list-actions"></div>
        </div>
    </div>

    <div id="customNotificationModal" class="modal-overlay">
        <div class="modal-content">
            <p id="customNotificationMessage"></p>
            <div class="notification-controls">
                <div id="dynamicNotificationToggleContainer" class="notification-toggle-container"></div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModal">&times;</span>
            <div id="settingsProfileInfo" class="settings-profile-info" style="display: none;">
                <div class="profile-display-clickable">
                    <div class="profile-email" id="settingsProfileEmail"></div>
                    <div class="profile-info">
                        <img src="{{ url_for('static', filename='icon/profil.png') }}" alt="Profil"
                            class="profile-icon">
                        <span id="settingsProfileName">N√°zev profilu</span>
                    </div>
                </div>
            </div>

            <h3>Nastaven√≠</h3>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <div style="display: flex; flex-direction: column; flex: 1;">
                    <span class="setting-label">Osobn√≠ karta a c√≠le</span>
                    <button id="personalCardButton" class="btn-small"
                        style="background-color: #6f42c1; margin-top: 5px;">
                        Otev≈ô√≠t osobn√≠ kartu
                    </button>
                </div>
                <div style="display: flex; flex-direction: column; flex: 1;">
                    <span class="setting-label">P≈ôihl√°≈°en√≠</span>
                    <button id="switchAccountBtn" class="btn-small" style="margin-top: 5px;">P≈ôepnout √∫ƒçet</button>
                </div>
            </div>

            <div class="setting-section">
                <div class="setting-section-header">
                    <span class="setting-label">Dialogov√° okna</span>
                    <span class="setting-section-arrow">‚ñº</span>
                </div>
                <div class="setting-section-content">
                    <div class="setting-item">
                        <span class="setting-label">Potvrzen√≠ smaz√°n√≠ receptu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmDeleteRecipeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Potvrzen√≠ smaz√°n√≠ profilu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmDeleteProfileToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Potvrzen√≠ smaz√°n√≠ polo≈æky</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmDeleteRecipeItemToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Potvrzen√≠ ulo≈æen√≠ zmƒõn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmSaveChangesToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ vytvo≈ôen√≠ receptu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeCreationToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ vytvo≈ôen√≠ profilu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmProfileCreationToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ zmƒõny profilu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmProfileSwitchToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ automatick√©ho v√Ωbƒõru profilu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmProfileAutoSelectToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ p≈ôid√°n√≠ potraviny</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmFoodAdditionToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ √∫spƒõ≈°n√©ho smaz√°n√≠</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeDeletionSuccessToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ chyby smaz√°n√≠</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeDeletionErrorToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ √∫spƒõ≈°n√©ho ulo≈æen√≠ zmƒõn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeSaveSuccessToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="barcodeModal" class="modal-overlay">
        <div class="modal-content barcode-modal">
            <span class="close-button" id="closeBarcodeModal">&times;</span>
            <h3>Skenovat ƒç√°rov√Ω k√≥d</h3>
            <div id="barcodeScannerContainer" class="barcode-scanner-container">
                <div id="barcodeUnsupportedMessage" class="barcode-unsupported-message">
                    <p>üîí Skenov√°n√≠ ƒç√°rov√Ωch k√≥d≈Ø nen√≠ v tomto prohl√≠≈æeƒçi dostupn√©</p>
                    <p>Pro skenov√°n√≠ k√≥d≈Ø fotoapar√°tem:</p>
                    <ul>
                        <li>Pou≈æijte HTTPS p≈ôipojen√≠ (zabezpeƒçen√©)</li>
                        <li>Povolte p≈ô√≠stup ke kame≈ôe v prohl√≠≈æeƒçi</li>
                        <li>Zkuste modern√≠ prohl√≠≈æeƒç (Chrome, Firefox, Edge)</li>
                    </ul>
                    <p>M≈Ø≈æete tak√© zadat k√≥d ruƒçnƒõ:</p>
                    <input type="text" id="manualBarcodeInput" placeholder="Zadejte ƒç√°rov√Ω k√≥d">
                    <button id="submitManualBarcode" class="btn-primary">Vyhledat</button>
                </div>
                <video id="barcodeVideo"></video>
                <canvas id="barcodeCanvas"></canvas>
                <div id="barcodeOverlay"></div>
            </div>
            <div class="barcode-controls">
                <button id="toggleCameraButton" class="btn-small">P≈ôepnout kameru</button>
                <button id="toggleFlashButton" class="btn-small">Blesk</button>
            </div>
            <div id="barcodeStatus"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.58.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

    <script type="module">
        // =============================================
        // GLOB√ÅLN√ç PROMƒöNN√â A KONFIGURACE
        // =============================================
        let supabaseClient;
        let currentUser = null;
        let currentProfileId = null;
        let isAppInitialized = false;
        let isLoadingProfiles = false;
        let isProfileModalShowing = false;
        let isUpdatingProfileDisplay = false;
        let isEditingRecipeItem = false;
        let editingRecipeContext = null;
        let currentFoodItemData = null;
        let currentEditingRecipeId = null;
        let currentEditingIngredientIndex = null;
        let userProfiles = [];
        let isCreatingProfile = false;
        let personalCardData = null;

        // Nastaven√≠ u≈æivatele
        let userSettings = {
            confirmRecipeCreation: true,
            confirmFoodAddition: true,
            confirmDeleteRecipe: true,
            confirmDeleteRecipeItem: true,
            confirmSaveChanges: true,
            confirmRecipeSaveSuccess: true,
            confirmRecipeDeletionSuccess: true,
            confirmRecipeDeletionError: true
        };

        // Promƒõnn√© pro vyhled√°v√°n√≠
        let currentSearchController = null;
        let isSearchInterrupted = false;
        const placeholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}";

        // Promƒõnn√© pro skenov√°n√≠ ƒç√°rov√Ωch k√≥d≈Ø
        let barcodeStream = null;
        let barcodeFacingMode = 'environment';
        let barcodeFlashEnabled = false;
        let barcodeScanInterval = null;
        let quaggaInitialized = false;
        let lastDetectedBarcode = null;
        let barcodeDetectionTimeout = null;

        // Inicializace glob√°ln√≠ch promƒõnn√Ωch
        window.supabaseClient = null;
        window.currentUser = null;
        window.currentProfileId = null;
        window.userProfiles = [];
        window.isAppInitialized = false;
        window.isLoadingProfiles = false;
        window.isProfileModalShowing = false;

        // =============================================
        // Z√ÅKLADN√ç UTILITY FUNKCE
        // =============================================
        function showPersonalCardModal() {
            const modal = document.getElementById('personalCardModal');
            modal.style.display = 'flex';
            loadPersonalCardData();
        }

        function closePersonalCardModal() {
            const modal = document.getElementById('personalCardModal');
            modal.style.display = 'none';
        }

        // Event listener pro kliknut√≠ mimo modal
        document.getElementById('personalCardModal').addEventListener('click', function (event) {
            if (event.target === this) {
                closePersonalCardModal();
            }
        });

        // Hlavn√≠ v√Ωpoƒçetn√≠ funkce
        function calculatePersonalCard() {
            // Naƒçten√≠ hodnot z formul√°≈ôe
            const formData = getFormData();

            // Validace
            if (!validateFormData(formData)) {
                return;
            }

            // V√Ωpoƒçty
            const calculations = performCalculations(formData);

            // Zobrazen√≠ v√Ωsledk≈Ø
            displayResults(calculations);

            // Ulo≈æen√≠ kompletn√≠ch dat pro pozdƒõj≈°√≠ ulo≈æen√≠
            personalCardData = {
                formData: formData,
                calculations: calculations,
                timestamp: new Date().toISOString()
            };

            // Povolen√≠ tlaƒç√≠tka Ulo≈æit
            document.getElementById('savePersonalCard').disabled = false;

            console.log("üìä Vypoƒç√≠tan√° data:", personalCardData);
        }

        // Naƒçten√≠ dat z formul√°≈ôe
        function getFormData() {
            return {
                gender: document.getElementById('gender').value,
                age: parseInt(document.getElementById('age').value) || 0,
                height: parseInt(document.getElementById('height').value) || 0,
                weight: parseFloat(document.getElementById('weight').value) || 0,
                bodyFat: parseFloat(document.getElementById('bodyFat').value) || 0,
                targetWeight: parseFloat(document.getElementById('targetWeight').value) || 0,
                activityLevel: parseFloat(document.getElementById('activityLevel').value) || 0,
                goal: document.getElementById('goal').value,
                intensity: 'light' // V≈ΩDY POU≈Ω√çV√ÅME LEHKO√ö INTENZITU
            };
        }

        // Validace formul√°≈ôe
        function validateFormData(data) {
            const errors = [];

            if (!data.gender) errors.push('Vyberte pohlav√≠');
            if (!data.age || data.age < 15 || data.age > 100) errors.push('Vƒõk mus√≠ b√Ωt mezi 15 a 100 lety');
            if (!data.height || data.height < 100 || data.height > 250) errors.push('V√Ω≈°ka mus√≠ b√Ωt mezi 100 a 250 cm');
            if (!data.weight || data.weight < 30 || data.weight > 300) errors.push('Hmotnost mus√≠ b√Ωt mezi 30 a 300 kg');
            if (!data.bodyFat || data.bodyFat < 5 || data.bodyFat > 60) errors.push('Podko≈æn√≠ tuk mus√≠ b√Ωt mezi 5% a 60%');
            if (!data.targetWeight || data.targetWeight < 30 || data.targetWeight > 300) errors.push('C√≠lov√° hmotnost mus√≠ b√Ωt mezi 30 a 300 kg');
            if (!data.activityLevel) errors.push('Vyberte √∫rove≈à aktivity');
            if (!data.goal) errors.push('Vyberte c√≠l');
            // ODSTRA≈áTE validaci intenzity - ji≈æ nen√≠ pot≈ôeba
            // if (data.goal !== 'maintain' && !data.intensity) errors.push('Vyberte intenzitu');

            // Validace c√≠lov√© hmotnosti z≈Øst√°v√°
            if (data.goal === 'loss' && data.targetWeight >= data.weight) {
                errors.push('C√≠lov√° hmotnost mus√≠ b√Ωt ni≈æ≈°√≠ ne≈æ aktu√°ln√≠ pro redukci');
            }
            if (data.goal === 'gain' && data.targetWeight <= data.weight) {
                errors.push('C√≠lov√° hmotnost mus√≠ b√Ωt vy≈°≈°√≠ ne≈æ aktu√°ln√≠ pro nab√≠r√°n√≠');
            }

            if (errors.length > 0) {
                window.showCustomNotification('Opravte pros√≠m:<br>' + errors.join('<br>'), 'error');
                return false;
            }

            return true;
        }

        // Hlavn√≠ v√Ωpoƒçetn√≠ funkce - Katch-McArdle
        function performCalculations(data) {
            console.log("üî¢ Spou≈°t√≠m v√Ωpoƒçty s daty:", data);

            // 1. V√Ωpoƒçet Lean Body Mass
            const leanBodyMass = data.weight * (1 - data.bodyFat / 100);
            console.log("üí™ Lean Body Mass:", leanBodyMass);

            // 2. BMR - Katch-McArdle vzorec
            const bmr = 370 + (21.6 * leanBodyMass);
            console.log("üî• BMR:", bmr);

            // 3. TDEE - Total Daily Energy Expenditure
            const tdee = bmr * data.activityLevel;
            console.log("‚ö° TDEE:", tdee);

            // 4. C√≠lov√Ω kalorick√Ω p≈ô√≠jem (s nov√Ωmi procenty)
            const targetCalories = calculateTargetCalories(tdee, data.goal, data.intensity);

            // 5. Makro≈æiviny
            const macros = calculateMacros(targetCalories, data.goal, data.weight);

            // 6. Rozd√≠l hmotnosti
            const weightDiff = data.targetWeight - data.weight;

            const results = {
                bmr: Math.round(bmr),
                tdee: Math.round(tdee),
                targetCalories: Math.round(targetCalories),
                weightDiff: Math.round(weightDiff * 10) / 10,
                macros: macros,
                leanBodyMass: Math.round(leanBodyMass * 10) / 10
            };

            console.log("üéØ Koneƒçn√© v√Ωsledky:", results);
            return results;
        }

        // V√Ωpoƒçet c√≠lov√©ho kalorick√©ho p≈ô√≠jmu
        function calculateTargetCalories(tdee, goal, intensity) {
            console.log("üßÆ V√Ωpoƒçet kalorick√©ho p≈ô√≠jmu:", { tdee, goal, intensity });

            const adjustments = {
                loss: {
                    light: -0.12,   // -12% z TDEE
                    moderate: -0.20, // -20% z TDEE
                    hard: -0.30     // -30% z TDEE
                },
                maintain: {
                    light: 0,
                    moderate: 0,
                    hard: 0
                },
                gain: {
                    light: 0.10,    // +10% z TDEE
                    moderate: 0.125, // +12.5% z TDEE
                    hard: 0.15      // +15% z TDEE
                }
            };

            const adjustmentPercentage = adjustments[goal][intensity] || 0;
            const adjustment = tdee * adjustmentPercentage;
            const targetCalories = tdee + adjustment;

            console.log("üìä V√Ωsledek v√Ωpoƒçtu:", {
                adjustmentPercentage: (adjustmentPercentage * 100) + '%',
                adjustment: Math.round(adjustment),
                targetCalories: Math.round(targetCalories)
            });

            return targetCalories;
        }

        // V√Ωpoƒçet makro≈æivin
        function calculateMacros(calories, goal, weight) {
            // B√≠lkoviny (g) - podle c√≠le
            let proteinPerKg;
            switch (goal) {
                case 'loss': proteinPerKg = 2.2; break;    // V√≠ce protein≈Ø p≈ôi redukci
                case 'gain': proteinPerKg = 2.0; break;    // St≈ôedn√≠ mno≈æstv√≠ p≈ôi nab√≠r√°n√≠
                default: proteinPerKg = 1.6;               // Standard p≈ôi udr≈æov√°n√≠
            }
            const protein = Math.round(weight * proteinPerKg);
            const proteinCalories = protein * 4;

            // Tuky (g) - 25% z kalori√≠
            const fatCalories = calories * 0.25;
            const fat = Math.round(fatCalories / 9);

            // Sacharidy (g) - zbytek kalori√≠
            const carbCalories = calories - proteinCalories - fatCalories;
            const carbs = Math.round(carbCalories / 4);

            // Vl√°knina (g) - 25-35g
            const fiber = weight > 80 ? 35 : 25;

            return {
                protein: protein,
                carbs: carbs,
                fat: fat,
                fiber: fiber,
                proteinCalories: proteinCalories,
                fatCalories: fatCalories,
                carbCalories: carbCalories
            };
        }

        //Zobrazen√≠ v√Ωsledk≈Ø
        function displayResults(results) {
            // Z√°kladn√≠ v√Ωsledky s jednotkami na stejn√©m ≈ô√°dku
            document.getElementById('bmrResult').textContent = `${results.bmr} kcal`;
            document.getElementById('tdeeResult').textContent = `${results.tdee} kcal`;
            document.getElementById('targetCaloriesResult').textContent = `${results.targetCalories} kcal`;

            // Rozd√≠l hmotnosti
            const weightDiffElement = document.getElementById('weightDiffResult');
            if (results.weightDiff > 0) {
                weightDiffElement.textContent = `+${results.weightDiff} kg`;
                weightDiffElement.style.color = '#28a745';
            } else if (results.weightDiff < 0) {
                weightDiffElement.textContent = `${results.weightDiff} kg`;
                weightDiffElement.style.color = '#dc3545';
            } else {
                weightDiffElement.textContent = `${results.weightDiff} kg`;
                weightDiffElement.style.color = '#6c757d';
            }

            // Makro≈æiviny s jednotkami
            document.getElementById('proteinResult').textContent = `${results.macros.protein} g`;
            document.getElementById('carbsResult').textContent = `${results.macros.carbs} g`;
            document.getElementById('fatsResult').textContent = `${results.macros.fat} g`;
            document.getElementById('fiberResult').textContent = `${results.macros.fiber} g`;
        }

        // Ukl√°d√°n√≠ a naƒç√≠t√°n√≠ dat
        async function savePersonalCardData() {
            if (!personalCardData) {
                window.showCustomNotification("Nejd≈ô√≠ve spoƒç√≠tejte data pomoc√≠ tlaƒç√≠tka 'Spoƒç√≠tat'", 'error');
                return;
            }

            try {
                // Ulo≈æen√≠ do Supabase vƒçetnƒõ vypoƒç√≠tan√Ωch hodnot
                await saveToSupabase(personalCardData);
            } catch (error) {
                console.error("Chyba p≈ôi ukl√°d√°n√≠:", error);
            }
        }

        async function saveToSupabase(data) {
            try {
                const { error } = await window.supabaseClient
                    .from('personal_cards')
                    .upsert({
                        user_id: window.currentUser.id,
                        profile_id: window.currentProfileId,
                        form_data: data.formData,       // P≈Øvodn√≠ data z formul√°≈ôe
                        calculations: data.calculations, // Vypoƒç√≠tan√© hodnoty
                        timestamp: data.timestamp,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,profile_id'
                    });

                if (error) throw error;

                window.showCustomNotification('Osobn√≠ data byla √∫spƒõ≈°nƒõ ulo≈æena!', 'success');
                console.log("üíæ Ulo≈æena kompletn√≠ data:", data);
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ osobn√≠ch dat:', error);
                window.showCustomNotification('Chyba p≈ôi ukl√°d√°n√≠ dat: ' + error.message, 'error');
            }
        }


        async function loadPersonalCardData() {
            if (!window.currentProfileId) {
                console.log("‚ùå Nelze naƒç√≠st data - nen√≠ vybr√°n profil");
                return;
            }

            const saveButton = document.getElementById('savePersonalCard');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Naƒç√≠t√°m...';
            saveButton.disabled = true;

            try {
                const loadedData = await loadFromSupabase();

                if (loadedData && loadedData.formData) {
                    console.log("‚úÖ Data naƒçtena z DB");
                    fillFormWithData(loadedData);
                    saveButton.textContent = 'Data naƒçtena';

                    setTimeout(() => {
                        saveButton.textContent = originalText;
                    }, 2000);
                } else {
                    console.log("‚ÑπÔ∏è ≈Ω√°dn√° data k naƒçten√≠");
                    saveButton.textContent = originalText;
                    saveButton.disabled = true;
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat:", error);
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            }
        }

        async function loadFromSupabase() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('personal_cards')
                    .select('*')
                    .eq('profile_id', window.currentProfileId)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                if (data) {
                    console.log("üì• Naƒçtena kompletn√≠ data:", data);
                    // Vr√°t√≠me strukturovan√° data
                    return {
                        formData: data.form_data,
                        calculations: data.calculations,
                        timestamp: data.timestamp
                    };
                }
                return null;
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ osobn√≠ch dat:', error);
                return null;
            }
        }



        function fillFormWithData(loadedData) {
            if (!loadedData) return;

            const { formData, calculations } = loadedData;

            console.log("üîÑ Pln√≠m formul√°≈ô daty:", formData);

            // Napln√≠me formul√°≈ô
            if (formData.gender) document.getElementById('gender').value = formData.gender;
            if (formData.age) document.getElementById('age').value = formData.age;
            if (formData.height) document.getElementById('height').value = formData.height;
            if (formData.weight) document.getElementById('weight').value = formData.weight;
            if (formData.bodyFat) document.getElementById('bodyFat').value = formData.bodyFat;
            if (formData.targetWeight) document.getElementById('targetWeight').value = formData.targetWeight;
            if (formData.activityLevel) document.getElementById('activityLevel').value = formData.activityLevel;
            if (formData.goal) {
                document.getElementById('goal').value = formData.goal;
            }
            // INTENZITA SE JI≈Ω NENAƒå√çT√Å - V≈ΩDY "light"

            // Pokud m√°me vypoƒç√≠tan√© hodnoty, zobraz√≠me je
            if (calculations) {
                console.log("üìä Zobrazuji vypoƒç√≠tan√© hodnoty:", calculations);
                displayResults(calculations);

                personalCardData = loadedData;
                document.getElementById('savePersonalCard').disabled = false;
            }

            console.log("‚úÖ Formul√°≈ô naplnƒõn daty");
        }

        function debugLog(message) {
            console.log(message);
        }

        function parseValueAndUnit(valueString) {
            if (valueString === null || valueString === undefined) {
                return { number: NaN, unit: '' };
            }
            if (typeof valueString !== 'string' && typeof valueString !== 'number') {
                return { number: NaN, unit: '' };
            }
            if (typeof valueString === 'number') {
                return { number: valueString, unit: '' };
            }

            const cleanedString = String(valueString).replace(/[\s\u00A0]/g, '').replace(',', '.');
            const match = cleanedString.match(/(\d+\.?\d*)\s*(.*)/);

            if (match) {
                const number = parseFloat(match[1]);
                const unit = match[2] || '';
                return { number, unit };
            }
            return { number: NaN, unit: '' };
        }

        function formatNumberForDisplay(number, unit = '', isEnergyValue = false) {
            if (typeof number !== 'number' || isNaN(number) || number === null || number === undefined) {
                return '-';
            }

            let formattedNumber;
            if (isEnergyValue) {
                formattedNumber = parseFloat(number.toFixed(1));
            } else {
                formattedNumber = parseFloat(number.toFixed(2));
            }

            return `${formattedNumber.toLocaleString('cs-CZ')}${unit ? ` ${unit}` : ''}`;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // =============================================
        // INICIALIZACE APLIKACE
        // =============================================
        window.initializeSupabase = async function () {
            try {
                const bodyElement = document.body;
                const supabaseUrl = bodyElement.dataset.supabaseUrl;
                const supabaseKey = bodyElement.dataset.supabaseKey;

                if (!supabaseUrl || !supabaseKey) {
                    console.error("‚ùå Chyb√≠ Supabase konfigurace");
                    return false;
                }

                if (typeof supabase === 'undefined') {
                    console.error("‚ùå Supabase SDK nen√≠ naƒçteno");
                    return false;
                }

                const { createClient } = supabase;
                window.supabaseClient = createClient(supabaseUrl, supabaseKey, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                    }
                });

                console.log("‚úÖ Supabase klient vytvo≈ôen");
                return true;
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi inicializaci Supabase:", error);
                return false;
            }
        };

        async function initializeApplication() {
            console.log("üéØ initializeApplication vol√°na");

            try {
                const supabaseInitialized = await window.initializeSupabase();
                if (!supabaseInitialized) {
                    console.log("‚ö†Ô∏è Supabase inicializace selhala - pokraƒçuji v lok√°ln√≠m re≈æimu");
                }

                // D≈ÆLE≈ΩIT√â: Inicializujeme userSettings hned na zaƒç√°tku
                window.userSettings = getDefaultSettings();
                console.log("üéØ Inicializov√°no userSettings na zaƒç√°tku aplikace:", window.userSettings);

                const { data: { session } } = await window.supabaseClient.auth.getSession();

                if (session && session.user) {
                    console.log("‚úÖ Session nalezena, user:", session.user.id);
                    if (session.user.email) {
                        window.currentUser = session.user;
                        await continueWithUser(session.user);
                    } else {
                        window.currentUser = session.user;
                        showLoginModal();
                    }
                } else {
                    showLoginModal();
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi inicializaci:", error);
                showLoginModal();
            }
        }

        // =============================================
        // AUTENTIZACE A SPR√ÅVA U≈ΩIVATEL≈Æ
        // =============================================
        function showLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                // Nejprve skryjeme v≈°echna ostatn√≠ mod√°ln√≠ okna
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.style.display = 'none';
                });

                // Pak zobraz√≠me p≈ôihla≈°ovac√≠ okno
                loginModal.style.display = 'flex';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('loginSuccess').style.display = 'none';
            }
        }

        function hideLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        }

        async function loginUser(email, password) {
            try {
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                if (data.user) {
                    window.currentUser = data.user;
                    hideLoginModal();

                    // POZOR: Pou≈æijte setTimeout aby se notifikace nezobrazovala bƒõhem p≈ôechodu
                    setTimeout(() => {
                        try {
                            window.showCustomNotification(`V√≠tejte zpƒõt, ${email}!`, 'success');
                        } catch (notificationError) {
                            console.log("‚úÖ P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©, notifikace selhala:", notificationError);
                        }
                    }, 1000);

                    await continueWithUser(data.user);
                    return data.user;
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi p≈ôihl√°≈°en√≠:", error);
                const errorDiv = document.getElementById('loginError');
                if (errorDiv) {
                    errorDiv.textContent = `Chyba p≈ôi p≈ôihl√°≈°en√≠: ${error.message}`;
                    errorDiv.style.display = 'block';
                }
                throw error;
            }
        }

        async function registerUser(email, password) {
            try {
                const emailTrimmed = email.trim().toLowerCase();

                if (!isValidEmail(emailTrimmed)) {
                    throw new Error("Neplatn√Ω form√°t emailov√© adresy");
                }

                if (password.length < 6) {
                    throw new Error("Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø");
                }

                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: emailTrimmed,
                    password,
                    options: {
                        emailRedirectTo: window.location.origin + '/auth/callback'
                    }
                });

                if (error) {
                    // Specifick√° chyba pro neplatn√©/testovac√≠ emaily
                    if (error.message.includes('invalid') || error.message.includes('Invalid')) {
                        throw new Error("Emailov√° adresa nebyla p≈ôijata. Pou≈æijte pros√≠m platn√Ω existuj√≠c√≠ email (nap≈ô. v√°≈° skuteƒçn√Ω email).");
                    } else if (error.message.includes('already') || error.message.includes('exists')) {
                        throw new Error("√öƒçet s t√≠mto emailem ji≈æ existuje. P≈ôihlaste se nebo pou≈æijte jin√Ω email.");
                    } else {
                        throw error;
                    }
                }

                if (data.user) {
                    let message = "Registrace √∫spƒõ≈°n√°! ";
                    if (data.user.identities && data.user.identities.length === 0) {
                        message += "√öƒçet ji≈æ existuje. P≈ôihlaste se.";
                    } else if (!data.user.email_confirmed_at) {
                        message += "Pros√≠m zkontrolujte email a potvrƒète registraci (zkontrolujte i spam slo≈æku).";
                    } else {
                        message += "Nyn√≠ si vytvo≈ôte prvn√≠ profil.";
                        window.currentUser = data.user;
                        hideLoginModal();
                        window.showCustomNotification("V√≠tejte! Vytvo≈ôte si prvn√≠ profil.", 'success');
                        await continueWithUser(data.user);
                    }

                    document.getElementById('loginSuccess').textContent = message;
                    document.getElementById('loginSuccess').style.display = 'block';
                    return data.user;
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi registraci:", error);
                throw error;
            }
        }

        // P≈òID√ÅNO: Pomocn√° funkce pro validaci emailu
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        async function logoutUser() {
            try {
                const { error } = await window.supabaseClient.auth.signOut();
                if (error) {
                    console.error("‚ùå Chyba p≈ôi odhla≈°ov√°n√≠:", error);
                } else {
                    window.currentUser = null;
                    window.userProfiles = [];
                    window.currentProfileId = null;
                    localStorage.clear();
                    location.reload();
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi odhla≈°ov√°n√≠:", error);
            }
        }

        async function continueWithUser(user) {
            window.currentUser = user;
            updateLoginButton();

            // Inicializujeme userSettings p≈ôed naƒçten√≠m profil≈Ø
            window.userSettings = getDefaultSettings();
            console.log("üéØ Inicializov√°no userSettings p≈ôi spu≈°tƒõn√≠:", window.userSettings);

            await window.loadUserProfiles();

            if (window.userProfiles.length === 0) {
                window.showCreateProfileModal();
            } else if (window.userProfiles.length === 1) {
                const singleProfile = window.userProfiles[0];
                await window.selectProfile(singleProfile.id);

                // ZOBRAZ√çME OZN√ÅMEN√ç O AUTOMATICK√âM V√ùBƒöRU PROFILU
                window.showCustomNotification(
                    `Profil "<strong>${singleProfile.name}</strong>" byl automaticky nastaven jako aktivn√≠`,
                    'profileAutoSelect'
                );
            } else {
                setTimeout(() => {
                    window.showProfileModal();
                }, 500);
            }

            window.isAppInitialized = true;
            const recipesButton = document.getElementById('recipesButton');
            if (recipesButton) {
                recipesButton.disabled = false;
            }

            setTimeout(() => {
                fixRecipesWithNullIngredients();
            }, 2000);
        }

        function updateLoginButton() {
            const loginBtn = document.getElementById('loginMenuBtn');
            if (window.currentUser && window.currentUser.email) {
                loginBtn.style.display = 'none';
                loginBtn.textContent = `P≈ôihl√°≈°en: ${window.currentUser.email}`;
            } else {
                loginBtn.style.display = 'block';
                loginBtn.textContent = 'P≈ôihl√°sit se';
            }
        }

        // =============================================
        // SPR√ÅVA PROFIL≈Æ
        // =============================================
        window.loadUserProfiles = async function () {
            if (window.isLoadingProfiles) return;
            window.isLoadingProfiles = true;

            try {
                if (!window.currentUser) {
                    window.userProfiles = [];
                    return;
                }

                // ODEB√çR√ÅME podm√≠nku !window.currentUser.is_local - byla v≈ædy true
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('user_id', window.currentUser.id)
                        .order('created_at', { ascending: true });

                    if (error) throw error;
                    window.userProfiles = data || [];
                } else {
                    window.userProfiles = [];
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profil≈Ø:", error);
                window.userProfiles = [];
            } finally {
                window.isLoadingProfiles = false;
            }
        };

        window.showProfileModal = async function () {
            if (window.isProfileModalShowing) {
                console.log("‚ÑπÔ∏è Profil modal ji≈æ je otev≈ôen - refreshuji data");
                // Refreshneme data i kdy≈æ je modal ji≈æ otev≈ôen√Ω
                await refreshProfileModalContent();
                return;
            }

            const profileModal = document.getElementById('profileModal');
            if (!profileModal) return;

            window.isProfileModalShowing = true;
            profileModal.style.display = 'flex';
            profileModal.style.zIndex = '1000';
            console.log("‚úÖ Profil modal otev≈ôen");

            await refreshProfileModalContent();
        };

        // D≈ÆLE≈ΩIT√â: P≈ôidejte pomocnou funkci pro refresh obsahu modalu
        async function refreshProfileModalContent() {
            try {
                await window.loadUserProfiles();
                const profileList = document.getElementById('profileList');
                if (profileList) {
                    profileList.innerHTML = '';

                    if (!window.userProfiles || window.userProfiles.length === 0) {
                        profileList.innerHTML = `
                    <div class="no-profiles">
                        <div class="no-profiles-icon">üë§</div>
                        <div class="no-profiles-title">≈Ω√°dn√© profily</div>
                        <div class="no-profiles-text">Vytvo≈ôte si prvn√≠ profil pro ukl√°d√°n√≠ recept≈Ø a nastaven√≠</div>
                        <button id="createFirstProfileBtn" class="create-first-profile-btn">
                            Vytvo≈ôit prvn√≠ profil
                        </button>
                    </div>
                `;

                        document.getElementById('createFirstProfileBtn').addEventListener('click', function () {
                            closeProfileModal();
                            window.showCreateProfileModal();
                        });
                    } else {
                        const userInfo = document.createElement('div');
                        userInfo.className = 'user-info-header';
                        userInfo.innerHTML = `
                    <div class="user-email">${window.currentUser?.email || 'Anonymn√≠ u≈æivatel'}</div>
                    <div class="profile-count">Dostupn√© profily: ${window.userProfiles.length}</div>
                    <div class="profile-instruction">Kliknƒõte na profil pro v√Ωbƒõr</div>
                `;
                        profileList.appendChild(userInfo);

                        window.userProfiles.forEach(profile => {
                            const profileItem = document.createElement('div');
                            profileItem.classList.add('profile-item');
                            if (profile.id === window.currentProfileId) {
                                profileItem.classList.add('active');
                            }

                            profileItem.innerHTML = `
                        <div class="profile-name-container">
                            <span class="profile-name">${profile.name}</span>
                            ${profile.id === window.currentProfileId ? '<span class="current-profile-badge">Aktivn√≠</span>' : ''}
                        </div>
                        <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat" class="profile-delete" data-profile-id="${profile.id}">
                    `;

                            profileItem.addEventListener('click', (e) => {
                                if (!e.target.classList.contains('profile-delete')) {
                                    console.log("üë§ Vybr√°n profil:", profile.name);
                                    closeProfileModal();
                                    window.selectProfile(profile.id);
                                }
                            });

                            const deleteBtn = profileItem.querySelector('.profile-delete');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    const profileId = e.target.dataset.profileId;
                                    const profile = window.userProfiles.find(p => p.id === profileId);
                                    if (profileId && profile) {
                                        await window.deleteProfile(profileId);
                                    }
                                });
                            }

                            profileList.appendChild(profileItem);
                        });
                    }
                }
            } catch (error) {
                console.error("‚ùå Error refreshing profile modal:", error);
            }
        }

        function closeProfileModal() {
            const profileModal = document.getElementById('profileModal');
            if (profileModal) {
                profileModal.style.display = 'none';
            }
            window.isProfileModalShowing = false;
            console.log("üî¥ Profil modal zav≈ôen");
        }

        window.showCreateProfileModal = function () {
            const createProfileModal = document.getElementById('createProfileModal');
            const newProfileNameInput = document.getElementById('newProfileName');

            if (createProfileModal) {
                window.isProfileModalShowing = true;

                createProfileModal.style.display = 'flex';
                if (newProfileNameInput) {
                    newProfileNameInput.value = '';
                    setTimeout(() => newProfileNameInput.focus(), 100);
                }
            }
        };

        async function createNewProfile(profileName) {
            if (window.isCreatingProfile) return null;
            window.isCreatingProfile = true;

            try {
                // EMERGENCY FIX: Zajist√≠me, ≈æe userSettings existuje
                if (!window.userSettings) {
                    window.userSettings = getDefaultSettings();
                    console.log("üö® EMERGENCY - userSettings bylo null, inicializov√°no:", window.userSettings);
                }

                const trimmedName = profileName.trim();
                if (!trimmedName) {
                    window.showCustomNotification("Pros√≠m, zadejte n√°zev profilu.", 'error');
                    return null;
                }

                let newProfileId = null;

                if (window.supabaseClient && window.currentUser) {
                    const profileData = {
                        name: trimmedName,
                        user_id: window.currentUser.id,
                        created_at: new Date().toISOString(),
                        settings: getDefaultSettings() // D≈ÆLE≈ΩIT√â: P≈ôid√°me nastaven√≠ p≈ô√≠mo p≈ôi vytvo≈ôen√≠
                    };

                    console.log("üìù Vytv√°≈ô√≠m profil s nastaven√≠m:", profileData.settings);

                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .insert(profileData)
                        .select()
                        .single();

                    if (error) throw error;

                    newProfileId = data.id;

                    // Naƒçteme znovu profily z datab√°ze
                    await window.loadUserProfiles();

                    // P≈ôid√°me nov√Ω profil do lok√°ln√≠ho seznamu
                    if (!window.userProfiles) window.userProfiles = [];
                    window.userProfiles = window.userProfiles.filter(p => p.id !== data.id);
                    window.userProfiles.push(data);

                    console.log("‚úÖ Profil vytvo≈ôen, nastaven√≠:", data.settings);
                } else {
                    throw new Error("Pro vytvo≈ôen√≠ profilu se mus√≠te p≈ôihl√°sit");
                }

                // Zav≈ôeme createProfile modal
                document.getElementById('createProfileModal').style.display = 'none';

                // Vybereme nov√Ω profil
                await window.selectProfile(newProfileId);

                // Zav≈ôeme i profil modal pokud je otev≈ôen√Ω
                closeProfileModal();

                // Zobraz√≠me notifikaci (pokud je povolen√°)
                window.showCustomNotification(`Profil "<strong>${trimmedName}</strong>" byl √∫spƒõ≈°nƒõ vytvo≈ôen!`, 'profileCreation');
                return newProfileId;

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi vytv√°≈ôen√≠ profilu:", error);
                window.showCustomNotification("Chyba p≈ôi vytv√°≈ôen√≠ profilu: " + error.message, 'error');
                return null;
            } finally {
                window.isCreatingProfile = false;
            }
        }

        window.selectProfile = async function (profileId) {
            try {
                const profileExists = window.userProfiles && window.userProfiles.some(p => p.id === profileId);
                if (!profileExists) {
                    await window.loadUserProfiles();
                }

                const oldProfileId = window.currentProfileId;
                window.currentProfileId = profileId;

                await loadUserSettings();
                await window.loadAndDisplayCurrentProfile();
                updateSettingsProfileInfo();

                // OZN√ÅMEN√ç P≈òI RUƒåN√ç ZMƒöNƒö PROFILU (voliteln√©)
                if (oldProfileId && oldProfileId !== profileId) {
                    const newProfile = window.userProfiles.find(p => p.id === profileId);
                    if (newProfile) {
                        window.showCustomNotification(
                            `Profil byl zmƒõnƒõn na "<strong>${newProfile.name}</strong>"`,
                            'profileSwitch'
                        );
                    }
                }

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi v√Ωbƒõru profilu:", error);
            }
        };

        window.deleteProfile = async function (profileId) {
            const profileToDelete = window.userProfiles.find(p => p.id === profileId);
            if (!profileToDelete) return;

            window.showCustomNotification(
                `Opravdu chcete smazat profil "<strong>${profileToDelete.name}</strong>"?<br><small style="color: #dc3545; font-weight: bold;">Smaz√°n√≠m profilu p≈ôijdete o v≈°echna data vƒçetnƒõ recept≈Ø a nastaven√≠!</small>`,
                'confirmDeleteProfile',
                async () => {
                    try {
                        if (window.supabaseClient && !profileId.startsWith('local-')) {
                            const { error } = await window.supabaseClient
                                .from('profiles')
                                .delete()
                                .eq('id', profileId);

                            if (error) throw error;
                        }

                        window.userProfiles = window.userProfiles.filter(profile => profile.id !== profileId);

                        // NEJD≈ò√çV PROVEDEME OBNOVU PROFILU A NASTAVEN√ç
                        const profileChangeInfo = await refreshProfileDisplayAfterDelete(profileId);

                        // V≈ΩDY OBNOV√çME SEZNAM PROFIL≈Æ V MODALU
                        await refreshProfileModal();

                        // PAK ZOBRAZ√çME SLOUƒåENOU NOTIFIKACI
                        let notificationMessage = `Profil "<strong>${profileToDelete.name}</strong>" byl √∫spƒõ≈°nƒõ smaz√°n`;

                        if (profileChangeInfo && profileChangeInfo.newProfile) {
                            notificationMessage += `<br>Aktivn√≠ profil byl nastaven na "<strong>${profileChangeInfo.newProfile.name}</strong>"`;
                        } else if (profileChangeInfo && profileChangeInfo.noProfiles) {
                            notificationMessage += `<br>V≈°echny profily byly smaz√°ny. Vytvo≈ôte si nov√Ω profil.`;
                        }

                        window.showCustomNotification(notificationMessage, 'recipeDeletionSuccess');

                    } catch (error) {
                        console.error("Chyba p≈ôi maz√°n√≠ profilu:", error);
                        window.showCustomNotification(
                            `Chyba p≈ôi maz√°n√≠ profilu "<strong>${profileToDelete.name}</strong>": ${error.message}`,
                            'recipeDeletionError'
                        );
                    }
                },
                true
            );
        };

        // P≈òIDEJTE POMOCNOU FUNKCI PRO REFRESH MODALU
        async function refreshProfileModal() {
            const profileModal = document.getElementById('profileModal');
            if (profileModal && profileModal.style.display === 'flex') {
                // Zav≈ôeme a znovu otev≈ôeme modal pro refresh dat
                profileModal.style.display = 'none';
                window.isProfileModalShowing = false;

                // Po kr√°tk√© chv√≠li znovu otev≈ôeme s aktu√°ln√≠mi daty
                setTimeout(async () => {
                    await window.showProfileModal();
                }, 100);
            } else {
                // Pokud modal nen√≠ otev≈ôen√Ω, otev≈ôeme ho
                await window.showProfileModal();
            }
        }

        async function refreshProfileDisplayAfterDelete(deletedProfileId) {
            await window.loadUserProfiles();

            let result = {};

            if (window.currentProfileId === deletedProfileId) {
                if (window.userProfiles.length > 0) {
                    const newProfile = window.userProfiles[0];
                    window.currentProfileId = newProfile.id;
                    await loadUserSettings();
                    await window.loadAndDisplayCurrentProfile();
                    result.newProfile = newProfile;
                } else {
                    window.currentProfileId = null;
                    window.hideCurrentProfileDisplay();
                    result.noProfiles = true;
                }
            }

            return result;
        }

        // =============================================
        // ZOBRAZEN√ç PROFILU A NASTAVEN√ç
        // =============================================
        window.loadAndDisplayCurrentProfile = async function () {
            if (!window.currentProfileId) {
                window.hideCurrentProfileDisplay();
                return;
            }

            try {
                // D≈ÆLE≈ΩIT√â: Naƒçteme aktu√°ln√≠ seznam profil≈Ø
                await window.loadUserProfiles();

                const profile = window.userProfiles.find(p => p.id === window.currentProfileId);
                if (profile) {
                    window.updateCurrentProfileDisplay(profile.name);
                    await loadUserSettings();
                } else {
                    console.error("‚ùå Aktu√°ln√≠ profil nenalezen v seznamu:", window.currentProfileId);
                    window.hideCurrentProfileDisplay();
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profilu:", error);
                window.hideCurrentProfileDisplay();
            }
        };

        window.updateCurrentProfileDisplay = function (profileName) {
            const profileDisplay = document.getElementById('currentProfileDisplay');
            const profileNameSpan = document.getElementById('currentProfileName');
            const profileEmailSpan = document.getElementById('currentProfileEmail');

            if (profileDisplay && profileNameSpan && profileEmailSpan) {
                profileNameSpan.textContent = profileName;
                if (window.currentUser && window.currentUser.email) {
                    profileEmailSpan.textContent = window.currentUser.email;
                    profileEmailSpan.style.display = 'block';
                } else {
                    profileEmailSpan.style.display = 'none';
                }
                profileDisplay.style.display = 'none';
                updateSettingsProfileInfo();
            }
        };

        window.hideCurrentProfileDisplay = function () {
            const profileDisplay = document.getElementById('currentProfileDisplay');
            if (profileDisplay) {
                profileDisplay.style.display = 'none';
            }
        };

        function updateSettingsProfileInfo() {
            const profileInfo = document.getElementById('settingsProfileInfo');
            const profileEmail = document.getElementById('settingsProfileEmail');
            const profileName = document.getElementById('settingsProfileName');

            if (window.currentUser && window.currentUser.email && window.currentProfileId) {
                profileInfo.style.display = 'flex';
                profileEmail.textContent = window.currentUser.email;
                profileEmail.style.display = 'block';

                if (window.userProfiles) {
                    const profile = window.userProfiles.find(p => p.id === window.currentProfileId);
                    if (profile) {
                        profileName.textContent = profile.name;
                    } else {
                        profileName.textContent = 'Nevybr√°n profil';
                    }
                }

                // D≈ÆLE≈ΩIT√â: Ujistƒõte se, ≈æe je element klikateln√Ω
                profileInfo.style.pointerEvents = 'auto';
                profileInfo.style.cursor = 'pointer';
            } else {
                profileInfo.style.display = 'none';
            }
        }

        // =============================================
        // NASTAVEN√ç U≈ΩIVATELE
        // =============================================
        async function loadUserSettings() {
            if (!window.currentUser || !window.currentProfileId) return;

            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .select('settings')
                        .eq('id', window.currentProfileId)
                        .single();

                    if (!error && data && data.settings) {
                        console.log("‚öôÔ∏è Naƒçtena nastaven√≠ z DB:", data.settings);
                        userSettings = data.settings;
                    } else {
                        console.log("‚öôÔ∏è Pou≈æ√≠v√°m defaultn√≠ nastaven√≠");
                        userSettings = getDefaultSettings();
                    }
                } else {
                    console.log("‚öôÔ∏è Pou≈æ√≠v√°m defaultn√≠ nastaven√≠ (bez Supabase)");
                    userSettings = getDefaultSettings();
                }
                updateSettingsUI();
            } catch (error) {
                console.error("Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠:", error);
                userSettings = getDefaultSettings();
                updateSettingsUI();
            }
        }

        function getDefaultSettings() {
            return {
                confirmRecipeCreation: true,
                confirmProfileCreation: true,
                confirmProfileSwitch: true,
                confirmProfileAutoSelect: true,
                confirmFoodAddition: true,
                confirmDeleteRecipe: true,
                confirmDeleteProfile: true,
                confirmDeleteRecipeItem: true,
                confirmSaveChanges: true,
                confirmRecipeSaveSuccess: true,
                confirmRecipeDeletionSuccess: true,
                confirmRecipeDeletionError: true
            };
        }

        async function saveUserSettings() {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId || window.currentUser.is_local) {
                return;
            }

            try {
                const { error } = await window.supabaseClient
                    .from('profiles')
                    .update({
                        settings: userSettings,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', window.currentProfileId);

                if (error) {
                    console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠:", error);
                }
            } catch (error) {
                console.error("Error saving user settings:", error);
            }
        }

        function updateSettingsUI() {
            const toggleIds = [
                'confirmRecipeCreationToggle',
                'confirmProfileCreationToggle',
                'confirmProfileSwitchToggle',
                'confirmProfileAutoSelectToggle',
                'confirmFoodAdditionToggle',
                'confirmDeleteRecipeToggle',
                'confirmDeleteProfileToggle',
                'confirmDeleteRecipeItemToggle',
                'confirmSaveChangesToggle',
                'confirmRecipeSaveSuccessToggle',
                'confirmRecipeDeletionSuccessToggle',
                'confirmRecipeDeletionErrorToggle'
            ];

            toggleIds.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    const settingKey = toggleId.replace('Toggle', '');
                    toggle.checked = userSettings[settingKey];
                }
            });
        }

        async function initializeSettingsForNewProfile(profileId) {
            const defaultSettings = getDefaultSettings();

            if (window.supabaseClient && window.currentUser) {
                try {
                    const { error } = await window.supabaseClient
                        .from('profiles')
                        .update({
                            settings: defaultSettings, // ULO≈Ω√çME DEFAULTN√ç NASTAVEN√ç
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', profileId);

                    if (error) {
                        console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠ pro nov√Ω profil:", error);
                    } else {
                        console.log("‚úÖ Nastaven√≠ pro nov√Ω profil ulo≈æeno:", defaultSettings);
                    }
                } catch (error) {
                    console.error("‚ùå Chyba p≈ôi inicializaci nastaven√≠:", error);
                }
            }

            // D≈ÆLE≈ΩIT√â: Nastav√≠me lok√°ln√≠ kopii nastaven√≠
            userSettings = defaultSettings;
            return true;
        }

        // Pomocn√° funkce pro bezpeƒçn√© nastaven√≠ HTML
        function setSafeHTML(element, html) {
            if (!element) return;

            // Jednoduch√° sanitizace - povol√≠me pouze bezpeƒçn√© tagy
            const safeHTML = html
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Odstranit scripty
                .replace(/on\w+="[^"]*"/g, '') // Odstranit event handlery
                .replace(/javascript:/gi, '') // Odstranit javascript: URL
                .replace(/<strong>(.*?)<\/strong>/g, '<strong>$1</strong>') // Povolit strong
                .replace(/<em>(.*?)<\/em>/g, '<em>$1</em>') // Povolit em
                .replace(/<b>(.*?)<\/b>/g, '<b>$1</b>') // Povolit b
                .replace(/<i>(.*?)<\/i>/g, '<i>$1</i>'); // Povolit i

            element.innerHTML = safeHTML;
        }

        // =============================================
        // NOTIFIKACE
        // =============================================
        window.showCustomNotification = function (message, notificationType, confirmCallback = null, showConfirmButtons = false) {
            try {
                const customNotificationModal = document.getElementById('customNotificationModal');
                const customNotificationMessage = document.getElementById('customNotificationMessage');

                if (!customNotificationModal || !customNotificationMessage) {
                    console.error("‚ùå Notification modal elements not found");
                    if (confirmCallback) confirmCallback();
                    return;
                }

                const settingMap = {
                    'recipeCreation': 'confirmRecipeCreation',
                    'foodAddition': 'confirmFoodAddition',
                    'profileSwitch': 'confirmProfileSwitch',
                    'profileAutoSelect': 'confirmProfileAutoSelect',
                    'confirmDeleteRecipe': 'confirmDeleteRecipe',
                    'confirmDeleteProfile': 'confirmDeleteProfile',
                    'confirmDeleteRecipeItem': 'confirmDeleteRecipeItem',
                    'confirmSaveChanges': 'confirmSaveChanges',
                    'recipeSaveSuccess': 'confirmRecipeSaveSuccess',
                    'recipeDeletionSuccess': 'confirmRecipeDeletionSuccess',
                    'recipeDeletionError': 'confirmRecipeDeletionError',
                    'profileCreation': 'confirmProfileCreation' // NOV√Å POLO≈ΩKA
                };

                const currentSettingKey = settingMap[notificationType];
                const showToggleInNotification = !!currentSettingKey;

                // D≈ÆLE≈ΩIT√Å OPRAVA: Pro v≈°echny typy notifikac√≠ - pokud je nastaven√≠ vypnuto a nejde o confirm tlaƒç√≠tka
                if (currentSettingKey && !userSettings[currentSettingKey] && !showConfirmButtons) {
                    console.log("üîï Notifikace vypnuta v nastaven√≠, p≈ôeskoƒçeno:", notificationType);
                    if (confirmCallback) confirmCallback();
                    return;
                }

                // D≈ÆLE≈ΩIT√Å OPRAVA: Pro confirm dialogy s tlaƒç√≠tky - pokud je nastaven√≠ vypnuto, rovnou potvrd√≠me
                if (currentSettingKey && !userSettings[currentSettingKey] && showConfirmButtons) {
                    console.log("üîï Confirm dialog vypnut v nastaven√≠, automatick√© potvrzen√≠:", notificationType);
                    if (confirmCallback) confirmCallback();
                    return;
                }

                const dynamicNotificationToggleContainer = document.getElementById('dynamicNotificationToggleContainer');
                const notificationControls = customNotificationModal.querySelector('.notification-controls');

                // Nastaven√≠ zpr√°vy
                if (customNotificationMessage) {
                    customNotificationMessage.innerHTML = message;
                }

                customNotificationModal.style.display = 'flex';

                // Vyƒçi≈°tƒõn√≠ container≈Ø
                if (dynamicNotificationToggleContainer) {
                    dynamicNotificationToggleContainer.innerHTML = '';
                }

                if (notificationControls) {
                    notificationControls.innerHTML = '';

                    // Vytvo≈ôen√≠ kontainer≈Ø pro layout
                    const toggleContainer = document.createElement('div');
                    toggleContainer.className = 'notification-toggle-container';

                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'notification-buttons-container';

                    // P≈ôep√≠naƒç "Zobrazovat tento dialog" - VLEVO
                    if (showToggleInNotification && currentSettingKey) {
                        const toggleLabelWrapper = document.createElement('label');
                        toggleLabelWrapper.classList.add('toggle-switch', 'notification-toggle-switch');

                        const toggleInput = document.createElement('input');
                        toggleInput.type = 'checkbox';
                        toggleInput.checked = userSettings[currentSettingKey]; // Zapnuto podle nastaven√≠
                        toggleInput.id = `dynamicToggle-${notificationType}`;

                        const sliderSpan = document.createElement('span');
                        sliderSpan.classList.add('slider');

                        toggleLabelWrapper.appendChild(toggleInput);
                        toggleLabelWrapper.appendChild(sliderSpan);

                        const labelElement = document.createElement('span');
                        labelElement.classList.add('toggle-label');
                        labelElement.textContent = 'Zobrazovat tento dialog';

                        toggleContainer.appendChild(toggleLabelWrapper);
                        toggleContainer.appendChild(labelElement);

                        toggleInput.addEventListener('change', () => {
                            userSettings[currentSettingKey] = toggleInput.checked;
                            saveUserSettings();
                            const settingsToggle = document.getElementById(`${currentSettingKey}Toggle`);
                            if (settingsToggle) {
                                settingsToggle.checked = toggleInput.checked;
                            }
                        });
                    }

                    // Tlaƒç√≠tka - VPRAVO
                    if (showConfirmButtons) {
                        const noButton = document.createElement('button');
                        noButton.textContent = 'Ne';
                        noButton.classList.add('notification-button', 'no-button');
                        noButton.onclick = () => {
                            customNotificationModal.style.display = 'none';
                        };

                        const yesButton = document.createElement('button');
                        yesButton.textContent = 'Ano';
                        yesButton.classList.add('notification-button', 'yes-button');
                        yesButton.onclick = () => {
                            customNotificationModal.style.display = 'none';
                            if (confirmCallback) confirmCallback();
                        };

                        buttonsContainer.appendChild(noButton);
                        buttonsContainer.appendChild(yesButton);
                    } else {
                        const okButton = document.createElement('button');
                        okButton.textContent = 'OK';
                        okButton.classList.add('notification-button', 'ok-button');
                        okButton.onclick = () => {
                            customNotificationModal.style.display = 'none';
                        };
                        buttonsContainer.appendChild(okButton);
                    }

                    // P≈ôid√°n√≠ container≈Ø do controls
                    notificationControls.appendChild(toggleContainer);
                    notificationControls.appendChild(buttonsContainer);
                }

            } catch (error) {
                console.error("‚ùå Chyba v showCustomNotification:", error);
                if (confirmCallback) confirmCallback();
            }
        };

        // =============================================
        // VYHLED√ÅV√ÅN√ç A ZOBRAZEN√ç V√ùSLEDK≈Æ
        // =============================================
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const query = document.getElementById('query').value;
                const resultsDiv = document.getElementById('results');
                const loadingDiv = document.getElementById('loading');
                const errorDiv = document.getElementById('error-message');

                resultsDiv.innerHTML = '';
                errorDiv.innerHTML = '';
                loadingDiv.style.display = 'block';
                isSearchInterrupted = false;

                if (currentSearchController) {
                    currentSearchController.abort();
                }

                currentSearchController = new AbortController();

                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `query=${encodeURIComponent(query)}`,
                        signal: currentSearchController.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';

                    while (true) {
                        if (isSearchInterrupted) {
                            reader.cancel();
                            break;
                        }

                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            try {
                                const item = JSON.parse(line);
                                if (item.error) {
                                    errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                                    loadingDiv.style.display = 'none';
                                    return;
                                }
                                appendFoodItem(item);
                            } catch (e) {
                                console.error('Chyba p≈ôi parsov√°n√≠ JSON ≈ô√°dku:', e, '≈ò√°dek:', line);
                            }
                        }
                    }

                    if (buffer.trim() !== '' && !isSearchInterrupted) {
                        try {
                            const item = JSON.parse(buffer);
                            if (!item.error) {
                                appendFoodItem(item);
                            }
                        } catch (e) {
                            console.error('Chyba p≈ôi parsov√°n√≠ zbytku JSON bufferu:', e, 'Buffer:', buffer);
                        }
                    }

                    loadingDiv.style.display = 'none';
                    if (resultsDiv.innerHTML === '' && !isSearchInterrupted) {
                        resultsDiv.innerHTML = '<p>Nic nenalezeno.</p>';
                    }

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Do≈°lo k chybƒõ:', error);
                        loadingDiv.style.display = 'none';
                        if (!isSearchInterrupted) {
                            errorDiv.textContent = 'Do≈°lo k chybƒõ p≈ôi komunikaci se serverem.';
                        }
                    }
                }
            });
        }

        function appendFoodItem(item) {
            if (item.food_type !== 'potravina') return;

            const resultsDiv = document.getElementById('results');
            const foodItemDiv = document.createElement('div');
            foodItemDiv.classList.add('food-item', 'food-item-potravina');

            let displayImageUrl = item.image_url || placeholderImage;
            let imageHtml = '';

            if (item.image_url) {
                imageHtml = `<img src="${item.image_url}" alt="${item.name}" onerror="this.onerror=null;this.src='${placeholderImage}'" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" />`;
            } else {
                imageHtml = `<img src="${placeholderImage}" alt="Bez obr√°zku" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" />`;
            }

            const { number: caloriesNum, unit: caloriesUnit } = parseValueAndUnit(item.calories);
            const formattedCalories = formatNumberForDisplay(caloriesNum, caloriesUnit, true);

            foodItemDiv.innerHTML = `
                <div class="image-wrapper">${imageHtml}</div>
                <div class="food-details">
                    <h3>${item.name}</h3>
                    <div class="calories-and-type-row">
                        <p class="calories-display">Kalorie: ${formattedCalories}</p>
                    </div>
                </div>
            `;

            if (item.slug) {
                const newFoodItemDiv = foodItemDiv.cloneNode(true);
                newFoodItemDiv.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    isSearchInterrupted = true;
                    if (currentSearchController) {
                        currentSearchController.abort();
                    }
                    document.getElementById('loading').style.display = 'none';
                    showDetailsModal(item.slug, item.name, item.image_url, item.calories, item.food_type);
                });
                resultsDiv.appendChild(newFoodItemDiv);
            } else {
                resultsDiv.appendChild(foodItemDiv);
            }
        }

        // =============================================
        // ZOBRAZEN√ç DETAIL≈Æ POTRAVIN
        // =============================================
        const modalDetailsContent = document.getElementById('modalDetailsContent');
        const detailsModal = document.getElementById('detailsModal');

        async function showDetailsModal(slug, name, imageUrl, initialCaloriesString, foodType, isEditingRecipeIngredient = false, initialAmount = 100, initialUnit = 'g', originalNutritionalDetails = null) {
            console.log("üîç Otev√≠r√°m detail modal - editace:", isEditingRecipeIngredient, "foodType:", foodType);
            if (window.isOpeningDetailsModal && !isEditingRecipeIngredient) {
                await new Promise(resolve => setTimeout(resolve, 300));
                if (window.isOpeningDetailsModal) return;
            }

            if (!isEditingRecipeIngredient) {
                window.isOpeningDetailsModal = true;
            }

            try {
                let displayImageUrl = imageUrl || placeholderImage;
                modalDetailsContent.classList.remove('modal-recipe-container');
                document.getElementById('modalDetailsContent').classList.remove('modal-recipe-container');
                document.getElementById('detailsModal').classList.remove('modal-recipe-open');
                detailsModal.style.display = 'flex';
                modalDetailsContent.innerHTML = `<p class="loading-details">Naƒç√≠t√°m detaily pro ${name}...</p>`;

                let details;
                if (isEditingRecipeIngredient && originalNutritionalDetails) {
                    details = originalNutritionalDetails;
                } else {
                    const response = await fetch('/get_details', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slug: slug, food_type: foodType })
                    });

                    if (!response.ok) {
                        let errorMessage = `Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø (Status: ${response.status}).`;
                        let rawResponseText = await response.text();
                        try {
                            const errorData = JSON.parse(rawResponseText);
                            if (errorData && errorData.error) {
                                errorMessage = `Chyba ze serveru: ${errorData.error}`;
                            }
                        } catch (jsonParseError) {
                            errorMessage = `Chyba p≈ôi komunikaci se serverem: ${response.statusText || 'Nezn√°m√° chyba'}. Odpovƒõƒè: ${rawResponseText.substring(0, 100)}...`;
                        }
                        modalDetailsContent.innerHTML = `<p class="error-details">${errorMessage}</p>`;
                        return;
                    }

                    details = await response.json();
                }

                if (details.error) {
                    modalDetailsContent.innerHTML = `<p class="error-details">Chyba ze serveru: ${details.error}</p>`;
                } else {
                    const { unit: initialUnitForTypeDetection } = parseValueAndUnit(initialCaloriesString);
                    const isLiquidFood = initialUnitForTypeDetection.toLowerCase().includes('ml');

                    let actionButtonsHtml = '';
                    if (isEditingRecipeIngredient) {
                        setTimeout(() => {
                            detailsModal.addEventListener('click', function handleEditClickOutside(event) {
                                if (event.target === detailsModal) {
                                    detailsModal.removeEventListener('click', handleEditClickOutside);
                                    closeDetailsModalAndRestoreRecipe();
                                }
                            });
                        }, 100);

                        actionButtonsHtml = `
                            <div class="modal-action-buttons">
                                <button id="discardChangesButton" style="background-color: #dc3545; min-width: 120px;">Zahodit zmƒõny</button>
                                <button id="saveChangesButton" style="background-color: #28a745;">Ulo≈æit zmƒõny</button>
                            </div>
                        `;
                    } else {
                        // D≈ÆLE≈ΩIT√â: Tato ƒç√°st mus√≠ z≈Østat pro norm√°ln√≠ zobrazen√≠ potraviny!
                        actionButtonsHtml = `
                            <div class="modal-action-buttons">
                                <button id="addToRecipeButton">P≈ôidat do receptu</button>
                                <button id="createAndAddRecipeButton" class="btn-primary">Vytvo≈ôit recept a p≈ôidat</button>
                            </div>
                        `;
                    }

                    modalDetailsContent.innerHTML = `
                        <div class="modal-header-content">
                            <img id="modalHeaderImage" src="${displayImageUrl}" alt="${name}" class="modal-header-image" onerror="this.onerror=null;this.src='${placeholderImage}'" />
                            <div id="modalHeaderName" class="modal-header-name">${name}</div>
                        </div>
                        ${actionButtonsHtml}
                        <div class="interactive-section">
                            <div class="amount-controls">
                                <input type="number" id="amountInput" value="${initialAmount}" min="0" step="1" class="amount-input">
                                <select id="unitSelect" class="unit-select"></select>
                            </div>
                            <div class="energy-display-group">
                                <div id="totalKcalDisplay" class="energy-header"></div>
                                <div id="totalKjDisplay" class="energy-sub-header"></div>
                            </div>
                        </div>
                        <div id="nutrientDetailsSection"></div>
                        ${details.source_url ? `<p style="text-align: center; margin-top: 20px;"><a href="${details.source_url}" target="_blank">Zobrazit na Kalorick√©Tabulky.cz</a></p>` : ''}
                    `;

                    const amountInput = document.getElementById('amountInput');
                    const unitSelect = document.getElementById('unitSelect');
                    const addToRecipeButton = document.getElementById('addToRecipeButton');
                    const createAndAddRecipeButton = document.getElementById('createAndAddRecipeButton');
                    const saveChangesButton = document.getElementById('saveChangesButton');
                    const discardChangesButton = document.getElementById('discardChangesButton');

                    unitSelect.innerHTML = '';
                    if (isLiquidFood) {
                        unitSelect.add(new Option('ml', 'ml'));
                        unitSelect.add(new Option('l', 'l'));
                        unitSelect.value = initialUnit;
                    } else {
                        unitSelect.add(new Option('g', 'g'));
                        unitSelect.add(new Option('kg', 'kg'));
                        unitSelect.value = initialUnit;
                    }

                    const updateDisplay = () => {
                        const currentAmount = parseFloat(amountInput.value) || 0;
                        const selectedUnit = unitSelect.value;
                        let baseAmount = currentAmount;

                        if (selectedUnit === 'kg' || selectedUnit === 'l') {
                            baseAmount = currentAmount * 1000;
                        }

                        let factor = baseAmount / 100;
                        renderAllNutrientDetails(details, factor);

                        currentFoodItemData = {
                            foodName: name,
                            slug: slug,
                            imageUrl: displayImageUrl,
                            foodType: foodType,
                            amount: currentAmount,
                            unit: selectedUnit,
                            kcal: document.getElementById('totalKcalDisplay').textContent,
                            nutritionalDetails: details
                        };

                        // D≈ÆLE≈ΩIT√â: Nastav√≠me glob√°ln√≠ promƒõnnou
                        window.currentFoodItemForRecipe = currentFoodItemData;
                        console.log("üîÑ Nastaven currentFoodItemForRecipe:", window.currentFoodItemForRecipe); // Debug log
                    };

                    amountInput.addEventListener('input', updateDisplay);
                    unitSelect.addEventListener('change', updateDisplay);
                    updateDisplay();

                    if (addToRecipeButton) {
                        addToRecipeButton.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            console.log("‚ûï Kliknuto na P≈ôidat do receptu");
                            if (!checkInitialization()) return;
                            window.currentFoodItemForRecipe = currentFoodItemData;
                            await loadUserRecipesForAdding();
                            detailsModal.style.display = 'none';
                            document.getElementById('selectRecipeModal').style.display = 'flex';
                        });
                    }

                    if (createAndAddRecipeButton) {
                        createAndAddRecipeButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log("üÜï Kliknuto na Vytvo≈ôit recept a p≈ôidat");
                            if (!checkInitialization()) return;
                            detailsModal.style.display = 'none';
                            document.getElementById('createRecipeModal').style.display = 'flex';
                            document.getElementById('newRecipeNameInput').value = '';
                            document.getElementById('newRecipeNameInput').focus();
                        });
                    }

                    if (saveChangesButton) {
                        saveChangesButton.addEventListener('click', async () => {
                            if (currentEditingRecipeId && currentEditingIngredientIndex !== null) {
                                console.log("üíæ Kliknuto na Ulo≈æit zmƒõny");

                                // OKAM≈ΩITƒö odstran√≠me event listener pro kliknut√≠ mimo
                                const existingHandler = detailsModal._editClickOutsideHandler;
                                if (existingHandler) {
                                    detailsModal.removeEventListener('click', existingHandler);
                                    detailsModal._editClickOutsideHandler = null;
                                }

                                // OKAM≈ΩITƒö zav≈ôeme modal
                                detailsModal.style.display = 'none';

                                // A zavol√°me update funkci
                                await updateFoodItemInRecipe(currentEditingRecipeId, currentEditingIngredientIndex, currentFoodItemData);
                            } else {
                                window.showCustomNotification("Chyba: Nelze ulo≈æit zmƒõny. Chyb√≠ kontext √∫pravy.", 'info');
                            }
                        });
                    }

                    if (discardChangesButton) {
                        discardChangesButton.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            console.log("üóëÔ∏è Kliknuto na Zahodit zmƒõny");

                            // OKAM≈ΩITƒö odstran√≠me event listener
                            const existingHandler = detailsModal._editClickOutsideHandler;
                            if (existingHandler) {
                                detailsModal.removeEventListener('click', existingHandler);
                                detailsModal._editClickOutsideHandler = null;
                            }

                            // Pou≈æijeme na≈°i hlavn√≠ funkci pro zav≈ôen√≠ a obnoven√≠
                            await closeDetailsModalAndRestoreRecipe();
                        });
                    }
                }
            } catch (error) {
                console.error("Chyba v showDetailsModal:", error);
                window.isOpeningDetailsModal = false;
            } finally {
                if (!isEditingRecipeIngredient) {
                    setTimeout(() => {
                        window.isOpeningDetailsModal = false;
                    }, 1000);
                }
            }
        }

        // =============================================
        // NUTRIENTY A ZOBRAZEN√ç
        // =============================================
        function createNutrientRow(label, originalValueString, rdiString = null, dotColor = null, type = 'other', currentFactor = 1, addSeparator = false, fontWeight = 'bold', fontSize = null) {
            const { number: originalNumericValue, unit: displayUnit } = parseValueAndUnit(originalValueString);
            let calculatedValueDisplay = isNaN(originalNumericValue) ? '-' : formatNumberForDisplay(originalNumericValue * currentFactor, displayUnit, false);
            let dot = dotColor ? `<span class="dot ${dotColor}"></span>` : '';
            let labelClass = 'nutrient-label';
            let valueClass = 'nutrient-value';

            let labelStyle = `font-weight: ${fontWeight};`;
            let valueStyle = `font-weight: ${fontWeight};`;
            let separatorHtml = '';

            if (fontSize) {
                labelStyle += `font-size: ${fontSize};`;
                valueStyle += `font-size: ${fontSize};`;
            }

            if (dotColor) {
                let colorHex = '';
                switch (dotColor) {
                    case 'red': colorHex = '#f44336'; break;
                    case 'blue': colorHex = '#2196f3'; break;
                    case 'orange': colorHex = '#ff9800'; break;
                    case 'green': colorHex = '#4caf50'; break;
                    default: colorHex = '';
                }
                if (colorHex) {
                    labelStyle += `color: ${colorHex};`;
                    valueStyle += `color: ${colorHex};`;
                }
            }

            if (type === 'main') {
                labelClass += ' main';
                valueClass += ' main-value';
            } else if (type === 'nested') {
                labelClass = 'nutrient-sub-label';
                valueClass = 'nutrient-sub-value';
            }

            if (addSeparator && label !== 'B√≠lkoviny') {
                separatorHtml = `<div class="nutrient-line-separator"></div>`;
            }

            return `
                ${separatorHtml}
                <div class="nutrient-row">
                    <div class="${labelClass}" style="${labelStyle}">${dot}${label}</div>
                    <div class="${valueClass}" style="${valueStyle}">${calculatedValueDisplay}</div>
                </div>
            `;
        }

        function renderAllNutrientDetails(details, factor = 1) {
            if (!details || typeof details !== 'object') {
                console.error("Neplatn√° nutriƒçn√≠ data");
                return;
            }

            const nutrientDetailsSection = document.getElementById('nutrientDetailsSection');
            if (!nutrientDetailsSection) return;

            nutrientDetailsSection.innerHTML = '';

            const totalKcalDisplay = document.getElementById('totalKcalDisplay');
            const totalKjDisplay = document.getElementById('totalKjDisplay');

            if (totalKcalDisplay) {
                const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(details.total_kcal);
                totalKcalDisplay.textContent = formatNumberForDisplay(kcalNum * factor, kcalUnit, true);
            }
            if (totalKjDisplay) {
                const { number: kjNum, unit: kjUnit } = parseValueAndUnit(details.total_kj);
                totalKjDisplay.textContent = `Tak√© ${formatNumberForDisplay(kjNum * factor, kjUnit, true)} ‚Ä¢ Energetick√° hodnota`;
            }

            let nutrientsHtmlContent = '';

            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('B√≠lkoviny', details.protein, null, 'red', 'main', factor, false);
            nutrientsHtmlContent += createNutrientRow('Sacharidy', details.carbs, null, 'blue', 'main', factor, true);
            nutrientsHtmlContent += createNutrientRow('Cukry', details.sugar, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Tuky', details.fat, null, 'orange', 'main', factor, true);
            nutrientsHtmlContent += createNutrientRow('Nasycen√© mastn√© kyseliny', details.saturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Trans mastn√© kyseliny', details.trans_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Mononenasycen√©', details.monounsaturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Polynenasycen√©', details.polyunsaturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Cholesterol', details.cholesterol, null, null, 'nested', factor, false);
            nutrientsHtmlContent += `</div>`;
            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('Vl√°knina', details.fiber, null, 'green', 'main', factor, true);
            nutrientsHtmlContent += `</div>`;
            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('S≈Øl', details.salt, null, null, 'main', factor, true, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('V√°pn√≠k', details.calcium, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('Sod√≠k', details.sodium, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('Voda', details.water, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('PHE', details.phe, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += `</div>`;

            nutrientDetailsSection.innerHTML = nutrientsHtmlContent;
        }

        // =============================================
        // RECEPTY - SPR√ÅVA A ZOBRAZEN√ç
        // =============================================
        async function createNewRecipe(recipeName, foodItem) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                window.showCustomNotification("Chyba: Aplikace nen√≠ spr√°vnƒõ inicializov√°na.", 'error');
                return null;
            }

            try {
                const completeFoodItem = foodItem ? {
                    ...foodItem,
                    imageUrl: foodItem.imageUrl || placeholderImage,
                    // D≈ÆLE≈ΩIT√â: Zajist√≠me, ≈æe v≈°echny pot≈ôebn√© pole jsou nastaveny
                    foodName: foodItem.foodName || 'Nezn√°m√° potravina',
                    slug: foodItem.slug || '',
                    foodType: foodItem.foodType || 'potravina',
                    amount: foodItem.amount || 100,
                    unit: foodItem.unit || 'g',
                    kcal: foodItem.kcal || '0 kcal',
                    nutritionalDetails: foodItem.nutritionalDetails || null
                } : null;

                const recipeData = {
                    name: recipeName,
                    user_id: window.currentUser.id,
                    profile_id: window.currentProfileId,
                    ingredients: completeFoodItem ? [completeFoodItem] : [], // D≈ÆLE≈ΩIT√â: P≈ôid√°me potravinu do ingredients
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                console.log("üìù Vytv√°≈ô√≠m recept s daty:", recipeData); // Debug log

                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .insert(recipeData)
                    .select()
                    .single();

                if (error) throw error;

                console.log("‚úÖ Recept vytvo≈ôen:", data); // Debug log

                // Resetujeme stav
                window.isOpeningDetailsModal = false;
                window.currentFoodItemForRecipe = null;

                document.getElementById('createRecipeModal').style.display = 'none';
                if (detailsModal.style.display === 'flex') {
                    detailsModal.style.display = 'none';
                }

                return data.id;
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi vytv√°≈ôen√≠ receptu:", error);
                window.showCustomNotification("Chyba p≈ôi vytv√°≈ôen√≠ receptu: " + error.message, 'error');
                window.isOpeningDetailsModal = false;
                return null;
            }
        }

        async function loadUserRecipes(showNotification = false) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            try {
                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('profile_id', window.currentProfileId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                displayRecipesInModal(data || []);
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø:", error);
            }
        }

        async function loadUserRecipesForAdding() {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            try {
                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('profile_id', window.currentProfileId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                displayRecipesInModal(data || [], true);
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø:", error);
            }
        }

        function displayRecipesInModal(recipes, isAddToRecipeMode = false) {
            const existingRecipesList = document.getElementById('existingRecipesList');
            const recipeCountDisplay = document.getElementById('recipeCountDisplay');

            if (!existingRecipesList) return;
            existingRecipesList.innerHTML = '';

            if (recipeCountDisplay) {
                recipeCountDisplay.style.display = 'none';
            }

            if (recipes.length === 0) {
                existingRecipesList.innerHTML = '<li style="text-align: center; color: #888; padding: 20px;">≈Ω√°dn√© recepty</li>';
                return;
            }

            const sortedRecipes = [...recipes].sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });

            sortedRecipes.forEach((recipe, index) => {
                const recipeItem = document.createElement('li');
                recipeItem.className = 'recipe-list-item';

                const totalCalories = calculateRecipeTotalCalories(recipe);
                const formattedCalories = formatNumberForDisplay(totalCalories, 'kcal', true);

                recipeItem.innerHTML = `
                    <div class="recipe-number-name-container">
                        <div class="recipe-number">${index + 1}.</div>
                        <div class="recipe-name">${recipe.name}</div>
                    </div>
                    <div class="recipe-calories">${formattedCalories}</div>
                    <div class="recipe-actions">
                        <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat" class="recipe-delete-icon" data-recipe-id="${recipe.id}" data-recipe-name="${recipe.name}">
                    </div>
                `;

                if (isAddToRecipeMode) {
                    recipeItem.addEventListener('click', (e) => {
                        if (e.target.classList.contains('recipe-delete-icon') || e.target.closest('.recipe-actions')) return;
                        addFoodItemToSelectedRecipe(recipe.id, recipe.name);
                    });
                } else {
                    recipeItem.addEventListener('click', (e) => {
                        if (e.target.classList.contains('recipe-delete-icon') || e.target.closest('.recipe-actions')) return;
                        document.getElementById('selectRecipeModal').style.display = 'none';
                        openRecipeDetail(recipe.id, recipe.name);
                    });
                }

                const deleteIcon = recipeItem.querySelector('.recipe-delete-icon');
                if (deleteIcon) {
                    deleteIcon.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const recipeId = e.target.dataset.recipeId;
                        const recipeName = e.target.dataset.recipeName;
                        await deleteRecipe(recipeId, recipeName);
                    });
                }

                existingRecipesList.appendChild(recipeItem);
            });

            setTimeout(() => {
                initializeRecipeListListeners();
            }, 100);
        }

        function calculateRecipeTotalCalories(recipe) {
            if (!recipe || !recipe.ingredients || !Array.isArray(recipe.ingredients)) return 0;

            let totalCalories = 0;
            recipe.ingredients.forEach((ingredient) => {
                if (!ingredient || !ingredient.foodName || !ingredient.kcal) return;
                const { number: kcalNum } = parseValueAndUnit(ingredient.kcal);
                if (!isNaN(kcalNum)) totalCalories += kcalNum;
            });

            return totalCalories;
        }

        async function fixRecipesWithNullIngredients() {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            try {
                const { data: recipes, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('profile_id', window.currentProfileId);

                if (error) return;

                let fixedCount = 0;
                for (const recipe of recipes) {
                    if (recipe.ingredients && Array.isArray(recipe.ingredients)) {
                        const originalLength = recipe.ingredients.length;
                        const cleanedIngredients = recipe.ingredients.filter(ing => ing !== null);

                        if (cleanedIngredients.length !== originalLength) {
                            const { error: updateError } = await window.supabaseClient
                                .from('recipes')
                                .update({
                                    ingredients: cleanedIngredients,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', recipe.id);

                            if (!updateError) fixedCount++;
                        }
                    }
                }

                if (fixedCount > 0) {
                    window.showCustomNotification(`Opraveno ${fixedCount} recept≈Ø s chybƒõj√≠c√≠mi ingrediencemi`, 'info');
                }
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi opravƒõ recept≈Ø:", error);
            }
        }

        async function addFoodItemToSelectedRecipe(recipeId, recipeName) {
            window.isAddingToRecipe = true;

            if (!window.currentFoodItemForRecipe) {
                window.showCustomNotification("Chyba: ≈Ω√°dn√° potravina k p≈ôid√°n√≠.", 'error');
                window.isAddingToRecipe = false;
                return;
            }

            try {
                await addFoodItemToExistingRecipe(recipeId, window.currentFoodItemForRecipe);
                document.getElementById('selectRecipeModal').style.display = 'none';
                if (detailsModal.style.display === 'flex') {
                    detailsModal.style.display = 'none';
                }
                window.isOpeningDetailsModal = false;
                window.currentFoodItemForRecipe = null;
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ potraviny do receptu:", error);
                window.showCustomNotification("Chyba p≈ôi p≈ôid√°v√°n√≠ do receptu: " + error.message, 'error');
            } finally {
                window.isAddingToRecipe = false;
                window.isOpeningDetailsModal = false;
            }
        }

        async function openRecipeDetail(recipeId, recipeName) {
            document.getElementById('selectRecipeModal').style.display = 'none';
            await showRecipeDetailsModal(recipeId, recipeName);
        }

        async function addFoodItemToExistingRecipe(recipeId, foodItem) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            try {
                const { data: recipeData, error: fetchError } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('id', recipeId)
                    .single();

                if (fetchError) throw fetchError;

                const completeFoodItem = {
                    ...foodItem,
                    imageUrl: foodItem.imageUrl || placeholderImage
                };

                const currentIngredients = recipeData.ingredients || [];
                const updatedIngredients = [...currentIngredients, completeFoodItem];

                const { error: updateError } = await window.supabaseClient
                    .from('recipes')
                    .update({
                        ingredients: updatedIngredients,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', recipeId);

                if (updateError) throw updateError;

                window.showCustomNotification(`Polo≈æka "<strong>${foodItem.foodName}</strong>" byla p≈ôid√°na do receptu "<strong>${recipeData.name}</strong>"!`, 'foodAddition');
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba:", error);
                window.showCustomNotification("Chyba p≈ôi p≈ôid√°v√°n√≠ do receptu: " + error.message, 'error');
            }
        }

        async function updateFoodItemInRecipe(recipeId, ingredientIndex, updatedFoodItem) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            const executeUpdate = async () => {
                try {
                    const { data: recipeData, error: fetchError } = await window.supabaseClient
                        .from('recipes')
                        .select('*')
                        .eq('id', recipeId)
                        .single();

                    if (fetchError) throw fetchError;

                    const currentIngredients = recipeData.ingredients || [];
                    if (ingredientIndex >= 0 && ingredientIndex < currentIngredients.length) {
                        currentIngredients[ingredientIndex] = updatedFoodItem;

                        const { error: updateError } = await window.supabaseClient
                            .from('recipes')
                            .update({
                                ingredients: currentIngredients,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', recipeId);

                        if (updateError) throw updateError;

                        // D≈ÆLE≈ΩIT√â: Pou≈æijeme spoleƒçnou funkci pro zav≈ôen√≠ a obnoven√≠
                        await closeDetailsModalAndRestoreRecipe();

                        // Zobraz√≠me notifikaci
                        window.showCustomNotification(`Polo≈æka "<strong>${updatedFoodItem.foodName}</strong>" v receptu byla √∫spƒõ≈°nƒõ aktualizov√°na.`, 'recipeSaveSuccess');
                    }
                } catch (error) {
                    console.error("Error updating food item in recipe:", error);
                    window.showCustomNotification("Chyba p≈ôi aktualizaci polo≈æky v receptu: " + error.message, 'recipeDeletionError');
                }
            };

            window.showCustomNotification(`Opravdu chcete ulo≈æit zmƒõny pro polo≈æku "<strong>${updatedFoodItem.foodName}</strong>"?`, 'confirmSaveChanges', executeUpdate, true);
        }

        async function deleteRecipe(recipeId, recipeName) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            window.showCustomNotification(`Opravdu chcete odstranit recept "<strong>${recipeName}</strong>"?`, 'confirmDeleteRecipe', async () => {
                try {
                    const { error } = await window.supabaseClient
                        .from('recipes')
                        .delete()
                        .eq('id', recipeId)
                        .eq('profile_id', window.currentProfileId);

                    if (error) throw error;
                    window.showCustomNotification(`Recept "<strong>${recipeName}</strong>" byl √∫spƒõ≈°nƒõ smaz√°n.`, 'recipeDeletionSuccess');
                    loadUserRecipes();
                } catch (error) {
                    console.error("Error deleting recipe:", error);
                    window.showCustomNotification(`Chyba p≈ôi odstra≈àov√°n√≠ receptu "<strong>${recipeName}</strong>": ${error.message}`, 'recipeDeletionError');
                }
            }, true);
        }

        async function deleteFoodItemFromRecipe(recipeId, ingredientIndex, ingredientName, recipeName) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            window.showCustomNotification(`Opravdu chcete odstranit polo≈æku "<strong>${ingredientName}</strong>" z receptu "<strong>${recipeName}</strong>"?`, 'confirmDeleteRecipeItem', async () => {
                try {
                    const { data: recipeData, error: fetchError } = await window.supabaseClient
                        .from('recipes')
                        .select('*')
                        .eq('id', recipeId)
                        .single();

                    if (fetchError) throw fetchError;

                    const currentIngredients = recipeData.ingredients || [];
                    if (ingredientIndex >= 0 && ingredientIndex < currentIngredients.length) {
                        currentIngredients.splice(ingredientIndex, 1);

                        const { error: updateError } = await window.supabaseClient
                            .from('recipes')
                            .update({
                                ingredients: currentIngredients,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', recipeId);

                        if (updateError) throw updateError;

                        window.showCustomNotification(`Polo≈æka "<strong>${ingredientName}</strong>" byla √∫spƒõ≈°nƒõ smaz√°na z receptu "<strong>${recipeName}</strong>".`, 'recipeDeletionSuccess');
                        await showRecipeDetailsModal(recipeId, recipeName);
                    }
                } catch (error) {
                    console.error("Error deleting food item from recipe:", error);
                    window.showCustomNotification(`Chyba p≈ôi odstra≈àov√°n√≠ polo≈æky "<strong>${ingredientName}</strong>": ${error.message}`, 'recipeDeletionError');
                }
            }, true);
        }

        async function showRecipeDetailsModal(recipeId, recipeName) {
            if (window.isAddingToRecipe) return;

            window.isOpeningDetailsModal = false;
            modalDetailsContent.classList.add('modal-recipe-container');
            document.getElementById('modalDetailsContent').classList.add('modal-recipe-container');
            document.getElementById('detailsModal').classList.add('modal-recipe-open');
            detailsModal.style.display = 'flex';
            modalDetailsContent.innerHTML = `<p class="loading-details">Naƒç√≠t√°m detaily receptu "${recipeName}"...</p>`;

            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                modalDetailsContent.innerHTML = `<p class="error-details">Chyba: Aplikace se nenaƒçetla spr√°vnƒõ. Nelze naƒç√≠st recept.</p>`;
                return;
            }

            try {
                const { data: recipeData, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('id', recipeId)
                    .single();

                if (error) throw error;
                if (!recipeData) {
                    modalDetailsContent.innerHTML = `<p class="error-details">Recept "${recipeName}" nebyl nalezen.</p>`;
                    return;
                }

                const imageUrl = recipeData.imageUrl || "{{ url_for('static', filename='icon/recepty.png') }}";
                const ingredients = recipeData.ingredients || [];

                const aggregatedNutrients = {
                    total_kcal: 0, total_kj: 0, protein: 0, carbs: 0, sugar: 0, fat: 0,
                    saturated_fat: 0, trans_fat: 0, monounsaturated_fat: 0, polyunsaturated_fat: 0,
                    cholesterol: 0, fiber: 0, salt: 0, calcium: 0, sodium: 0, water: 0, phe: 0
                };

                ingredients.forEach(ingredient => {
                    if (ingredient.nutritionalDetails && typeof ingredient.nutritionalDetails === 'object') {
                        const amount = parseFloat(ingredient.amount) || 0;
                        let baseAmount = amount;
                        if (ingredient.unit === 'kg' || ingredient.unit === 'l') baseAmount *= 1000;
                        const factor = baseAmount / 100;

                        for (const key in aggregatedNutrients) {
                            if (ingredient.nutritionalDetails[key] && ingredient.nutritionalDetails[key] !== "N/A") {
                                const { number: valNum } = parseValueAndUnit(ingredient.nutritionalDetails[key]);
                                if (!isNaN(valNum)) aggregatedNutrients[key] += valNum * factor;
                            }
                        }
                    }
                });

                const totalKj = aggregatedNutrients.total_kj || (aggregatedNutrients.total_kcal * 4.184);
                const formattedAggregatedNutrients = {};
                for (const key in aggregatedNutrients) {
                    let unit = '';
                    if (key.includes('kcal')) unit = 'kcal';
                    else if (key.includes('kj')) unit = 'kJ';
                    else if (['protein', 'carbs', 'sugar', 'fat', 'saturated_fat', 'trans_fat',
                        'monounsaturated_fat', 'polyunsaturated_fat', 'fiber', 'salt', 'water', 'phe'].includes(key)) unit = 'g';
                    else if (['cholesterol', 'calcium', 'sodium'].includes(key)) unit = 'mg';

                    formattedAggregatedNutrients[key] = formatNumberForDisplay(aggregatedNutrients[key], unit, key.includes('kcal') || key.includes('kj'));
                }

                modalDetailsContent.innerHTML = `
                    <div class="modal-recipe-header">
                        <img id="modalHeaderImage" src="${imageUrl}" alt="${recipeName}" class="modal-header-image" onerror="this.onerror=null;this.src='{{ url_for('static', filename='icon/recepty.png') }}'" />
                        <div class="modal-header-text">
                            <div id="modalHeaderName" class="modal-header-name">${recipeName}</div>
                            <div class="energy-display-group">
                                <div id="totalKcalDisplay" class="energy-header">${formattedAggregatedNutrients.total_kcal}</div>
                                <div id="totalKjDisplay" class="energy-sub-header">${formatNumberForDisplay(totalKj, 'kJ', true)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-scrollable-container">
                        <div id="nutrientDetailsSection"></div>
                        <h3 class="ingredients-title">Slo≈æen√≠ receptu:</h3>
                        <div id="recipeIngredientsList"></div>
                    </div>
                `;

                renderAllNutrientDetails(formattedAggregatedNutrients);
                const ingredientsListEl = document.getElementById('recipeIngredientsList');

                if (ingredients.length === 0) {
                    ingredientsListEl.innerHTML = '<p style="text-align: center; color: #888;">Tento recept neobsahuje ≈æ√°dn√© potraviny.</p>';
                } else {
                    ingredients.forEach((ingredient, index) => {
                        const ingredientItemDiv = document.createElement('div');
                        ingredientItemDiv.classList.add('food-item', 'food-item-potravina');

                        const ingPlaceholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}";
                        let displayImageUrl = ingredient.imageUrl || ingPlaceholderImage;

                        const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(ingredient.kcal);
                        const formattedIngredientKcal = formatNumberForDisplay(kcalNum, kcalUnit, true);

                        ingredientItemDiv.innerHTML = `
                            <div class="image-wrapper" style="display: flex; flex-direction: column; align-items: center;">
                                <img src="${displayImageUrl}" alt="${ingredient.foodName}" 
                                    onerror="this.onerror=null;this.src='${ingPlaceholderImage}'" 
                                    style="width: 55px; height: 55px; object-fit: cover; border-radius: 6px; padding-top: 8px;" />
                                <div class="recipe-icons" style="margin-top: 5px;">
                                    <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Upravit" class="recipe-icon edit-icon" data-recipe-id="${recipeId}" data-ingredient-index="${index}" />
                                    <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Odstranit" class="recipe-icon delete-icon" data-recipe-id="${recipeId}" data-ingredient-index="${index}" />
                                </div>
                            </div>
                            <div class="food-details">
                                <h3>${ingredient.foodName}</h3>
                                <div class="calories-and-type-row">
                                    <div class="calories-and-type-row">
                                        <span class="amount-display">Mno≈æstv√≠:  ${ingredient.amount} ${ingredient.unit}</span>
                                        <span class="calories-display">Kalorie: ${formattedIngredientKcal}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        ingredientsListEl.appendChild(ingredientItemDiv);

                        const editIcon = ingredientItemDiv.querySelector('.edit-icon');
                        if (editIcon) {
                            editIcon.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                currentEditingRecipeId = e.target.dataset.recipeId;
                                currentEditingIngredientIndex = parseInt(e.target.dataset.ingredientIndex);
                                isEditingRecipeItem = true;
                                editingRecipeContext = { recipeId: currentEditingRecipeId, recipeName: recipeName };

                                const ingredientToEdit = ingredients[currentEditingIngredientIndex];
                                if (ingredientToEdit) {
                                    await showDetailsModal(
                                        ingredientToEdit.slug,
                                        ingredientToEdit.foodName,
                                        ingredientToEdit.imageUrl,
                                        ingredientToEdit.kcal,
                                        ingredientToEdit.foodType,
                                        true,
                                        ingredientToEdit.amount,
                                        ingredientToEdit.unit,
                                        ingredientToEdit.nutritionalDetails
                                    );
                                }
                            });
                        }

                        const deleteIcon = ingredientItemDiv.querySelector('.delete-icon');
                        if (deleteIcon) {
                            deleteIcon.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const currentRecipeId = e.target.dataset.recipeId;
                                const ingredientIndex = parseInt(e.target.dataset.ingredientIndex);
                                const ingredientName = ingredient.foodName;
                                deleteFoodItemFromRecipe(currentRecipeId, ingredientIndex, ingredientName, recipeName);
                            });
                        }
                    });
                }
            } catch (error) {
                console.error("Error loading recipe details:", error);
                modalDetailsContent.innerHTML = `<p class="error-details">Do≈°lo k chybƒõ p≈ôi naƒç√≠t√°n√≠ detail≈Ø receptu: ${error.message}</p>`;
            }
        }

        // =============================================
        // SPR√ÅVA MODAL≈Æ
        // =============================================
        function initializeDetailsModalListeners() {
            const closeButton = detailsModal.querySelector('.close-button');
            if (closeButton) {
                const newCloseButton = closeButton.cloneNode(true);
                closeButton.parentNode.replaceChild(newCloseButton, closeButton);

                newCloseButton.addEventListener('click', function (e) {
                    e.stopPropagation();
                    console.log("‚ùå Kliknuto na zav√≠rac√≠ k≈ô√≠≈æek");
                    // V≈ΩDY pou≈æijeme closeDetailsModalAndRestoreRecipe - ta se postar√° o obnoven√≠ receptu pokud je to editace
                    closeDetailsModalAndRestoreRecipe();
                });
            }

            detailsModal.addEventListener('click', function (event) {
                if (event.target.classList.contains('close-button') || event.target.closest('.close-button')) return;

                if (event.target === detailsModal) {
                    console.log("‚ùå Kliknuto mimo modal");
                    if (isEditingRecipeItem) {
                        console.log("üìù Editace - speci√°ln√≠ zav√≠r√°n√≠");
                        // Pro editaci pou≈æijeme na≈°i speci√°ln√≠ funkci
                        closeDetailsModalAndRestoreRecipe();
                    } else {
                        // Pro norm√°ln√≠ zobrazen√≠ jednodu≈°e zav≈ôeme
                        detailsModal.style.display = 'none';
                        window.isOpeningDetailsModal = false;
                    }
                }
            });
        }

        async function closeDetailsModalAndRestoreRecipe() {
            if (window.closeDetailsModalCalled) return;
            window.closeDetailsModalCalled = true;

            console.log("üî¥ Zav√≠r√°m detailn√≠ modal - editace:", isEditingRecipeItem);

            // Ulo≈æ√≠me si kontext p≈ôed resetem
            const wasEditing = isEditingRecipeItem;
            const recipeIdToRestore = currentEditingRecipeId;
            const recipeNameToRestore = editingRecipeContext?.recipeName || "Recept";

            // OKAM≈ΩITƒö zav≈ôeme modal
            detailsModal.style.display = 'none';

            // OKAM≈ΩITƒö resetujeme stav
            isEditingRecipeItem = false;
            editingRecipeContext = null;
            currentEditingRecipeId = null;
            currentEditingIngredientIndex = null;

            // Odstran√≠me event listener
            const existingHandler = detailsModal._editClickOutsideHandler;
            if (existingHandler) {
                detailsModal.removeEventListener('click', existingHandler);
                detailsModal._editClickOutsideHandler = null;
            }

            // D≈ÆLE≈ΩIT√â: Pokud jsme byli v editaci, v≈ædy obnov√≠me recept
            if (wasEditing && recipeIdToRestore) {
                console.log("üîÑ Obnovuji recept po editaci:", recipeIdToRestore);
                try {
                    // Kr√°tk√© zpo≈ædƒõn√≠ pro zaji≈°tƒõn√≠ ƒçist√©ho p≈ôechodu
                    setTimeout(async () => {
                        await showRecipeDetailsModal(recipeIdToRestore, recipeNameToRestore);
                    }, 100);
                } catch (error) {
                    console.error("‚ùå Chyba p≈ôi zobrazov√°n√≠ detailu receptu:", error);
                }
            }

            setTimeout(() => {
                window.closeDetailsModalCalled = false;
            }, 300);
        }

        function initializeRecipeListListeners() {
            const recipeItems = document.querySelectorAll('.recipe-list-item');
            recipeItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    if (e.target.classList.contains('recipe-delete-icon') || e.target.closest('.recipe-actions')) return;
                    const recipeId = this.querySelector('.recipe-delete-icon')?.dataset.recipeId;
                    const recipeName = this.querySelector('.recipe-name').textContent;
                    document.getElementById('selectRecipeModal').style.display = 'none';
                    openRecipeDetail(recipeId, recipeName);
                });
            });
        }

        function initializeSettingsSections() {
            const sectionHeaders = document.querySelectorAll('.setting-section-header');
            sectionHeaders.forEach((header, index) => {
                header.replaceWith(header.cloneNode(true));
                const newHeader = document.querySelectorAll('.setting-section-header')[index];

                newHeader.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const content = this.nextElementSibling;
                    const arrow = this.querySelector('.setting-section-arrow');

                    if (content && content.classList.contains('setting-section-content')) {
                        const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';

                        if (isOpen) {
                            content.style.maxHeight = "0";
                            content.style.opacity = "0";
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            content.style.opacity = "1";
                            if (arrow) arrow.style.transform = 'rotate(180deg)';
                        }
                    }
                });

                const content = newHeader.nextElementSibling;
                const arrow = newHeader.querySelector('.setting-section-arrow');

                if (content && content.classList.contains('setting-section-content')) {
                    content.style.maxHeight = "0";
                    content.style.opacity = "0";
                    content.style.transition = 'max-height 0.3s ease, opacity 0.3s ease';
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                }
            });
        }

        function collapseAllSettingsSections() {
            const sectionHeaders = document.querySelectorAll('.setting-section-header');
            let foundOpen = false;

            sectionHeaders.forEach(header => {
                const content = header.nextElementSibling;
                const arrow = header.querySelector('.setting-section-arrow');

                if (content && content.classList.contains('setting-section-content')) {
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
                    if (isOpen) {
                        content.style.maxHeight = "0";
                        content.style.opacity = "0";
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                        header.classList.remove('active');
                        foundOpen = true;
                    }
                }
            });

            return foundOpen;
        }

        function setupModalCloseHandlers() {
            document.getElementById('profileModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    console.log("‚ùå Kliknuto mimo profil modal");
                    closeProfileModal();
                }
            });

            document.getElementById('closeSettingsModal').addEventListener('click', function () {
                collapseAllSettingsSections();
                setTimeout(() => {
                    document.getElementById('settingsModal').style.display = 'none';
                }, 100);
            });

            document.getElementById('settingsModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    const hadOpenSections = collapseAllSettingsSections();
                    const delay = hadOpenSections ? 150 : 0;
                    setTimeout(() => {
                        this.style.display = 'none';
                    }, delay);
                }
            });

            const modals = [
                'profileModal', 'createProfileModal', 'selectRecipeModal', 'createRecipeModal'
            ];

            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function (event) {
                        if (event.target === this) {
                            this.style.display = 'none';
                            if (modalId === 'profileModal') {
                                window.isProfileModalShowing = false;
                            }
                        }
                    });
                }
            });
        }

        // =============================================
        // VALIDACE A KONTROLY
        // =============================================
        function checkInitialization() {
            if (!window.isAppInitialized) {
                window.showCustomNotification("Pros√≠m, poƒçkejte, ne≈æ se aplikace plnƒõ inicializuje.", 'info');
                return false;
            }

            if (!window.currentUser) {
                window.showCustomNotification("Pro tuto akci se mus√≠te p≈ôihl√°sit.", 'info');
                return false;
            }

            if (!window.currentProfileId) {
                window.showCustomNotification("Pro tuto akci si mus√≠te vybrat profil.", 'info');
                return false;
            }

            if (!window.userProfiles || window.userProfiles.length === 0) {
                window.showCustomNotification("Pro tuto akci pot≈ôebujete m√≠t vytvo≈ôen√Ω profil.", 'info');
                return false;
            }

            if (!window.supabaseClient) {
                window.showCustomNotification("Chyba datab√°ze. Zkuste obnovit str√°nku.", 'error');
                return false;
            }

            return true;
        }

        // =============================================
        // SKENOV√ÅN√ç ƒå√ÅROV√ùCH K√ìD≈Æ
        // =============================================
        function initBarcodeScanner() {
            document.getElementById('barcodeButton').addEventListener('click', openBarcodeScanner);
            document.getElementById('closeBarcodeModal').addEventListener('click', closeBarcodeScanner);
            document.getElementById('toggleCameraButton').addEventListener('click', toggleCamera);
            document.getElementById('toggleFlashButton').addEventListener('click', toggleFlash);
            document.getElementById('submitManualBarcode').addEventListener('click', submitManualBarcode);
        }

        function initQuagga() {
            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.getElementById('barcodeVideo'),
                            constraints: {
                                width: 1280,
                                height: 720,
                                facingMode: barcodeFacingMode,
                                aspectRatio: { min: 1, max: 2 }
                            },
                        },
                        decoder: {
                            readers: ["ean_reader", "ean_8_reader"],
                            multiple: false,
                            resolution: 800,
                            patchSize: "x-large",
                        },
                        locator: {
                            patchSize: "large",
                            halfSample: true,
                            debug: {
                                showCanvas: false,
                                showPatches: false,
                                showFoundPatches: false,
                                showSkeleton: false
                            }
                        },
                        preprocessor: {
                            contrast: { min: 32, max: 220 },
                            sharpen: { flat: 1.0, jagged: 2.0 }
                        },
                        frequency: 5,
                        numOfWorkers: 2,
                        debug: false
                    }, function (err) {
                        if (err) {
                            console.error("Chyba p≈ôi inicializaci Quagga:", err);
                            document.getElementById('barcodeStatus').textContent = 'Nepoda≈ôilo se inicializovat skener';
                            document.getElementById('barcodeStatus').style.color = 'red';
                            return;
                        }

                        quaggaInitialized = true;
                        Quagga.onDetected(function (result) {
                            if (result && result.codeResult && result.codeResult.code) {
                                if (result.codeResult.confidence !== undefined && result.codeResult.confidence < 0.3) return;
                                handleBarcodeDetected(result.codeResult.code, result);
                            }
                        });
                    });
                } catch (error) {
                    console.error('V√Ωjimka p≈ôi inicializaci Quaggy:', error);
                }
            }
        }

        async function openBarcodeScanner() {
            const barcodeModal = document.getElementById('barcodeModal');
            const barcodeStatus = document.getElementById('barcodeStatus');

            barcodeModal.style.display = 'flex';
            barcodeStatus.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">üîç Skenov√°n√≠ ƒç√°rov√©ho k√≥du</div>
                <div style="font-size: 14px; color: #666; line-height: 1.4;">
                    ‚Ä¢ Nami≈ôte k√≥d do zelen√©ho r√°meƒçku<br>
                    ‚Ä¢ Zaost≈ôen√≠ probƒõhne automaticky<br>
                    ‚Ä¢ Pro ukonƒçen√≠ kliknƒõte mimo okno
                </div>
            `;

            if (!quaggaInitialized) {
                initQuagga();
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                barcodeStatus.textContent = 'Kamera nen√≠ v tomto prohl√≠≈æeƒçi dostupn√°';
                barcodeStatus.style.color = 'red';
                return;
            }

            try {
                await startCamera();
                barcodeStatus.textContent = 'Nami≈ôte na ƒç√°rov√Ω k√≥d';
                await new Promise(resolve => setTimeout(resolve, 500));
                startBarcodeScanning();
            } catch (error) {
                console.error('Chyba p≈ôi inicializaci kamery:', error);
                barcodeStatus.textContent = 'Chyba: ' + error.message;
                barcodeStatus.style.color = 'red';
            }
        }

        async function startCamera() {
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                    frameRate: { ideal: 60 },
                    facingMode: barcodeFacingMode,
                }
            };

            try {
                barcodeStream = await navigator.mediaDevices.getUserMedia(constraints);
                const barcodeVideo = document.getElementById('barcodeVideo');
                barcodeVideo.srcObject = barcodeStream;
                barcodeVideo.style.display = 'block';
                document.getElementById('barcodeUnsupportedMessage').style.display = 'none';
                document.getElementById('toggleCameraButton').style.display = 'inline-block';
                document.getElementById('toggleFlashButton').style.display = 'inline-block';
                document.getElementById('barcodeOverlay').style.display = 'block';

                barcodeVideo.width = 640;
                barcodeVideo.height = 480;

                return new Promise((resolve) => {
                    barcodeVideo.onloadedmetadata = () => {
                        barcodeVideo.play().then(resolve).catch(() => resolve());
                    };
                    setTimeout(() => resolve(), 1000);
                });
            } catch (error) {
                console.error('Chyba p≈ôi p≈ô√≠stupu ke kame≈ôe:', error);
                document.getElementById('barcodeUnsupportedMessage').style.display = 'block';
                document.getElementById('barcodeVideo').style.display = 'none';
                document.getElementById('toggleCameraButton').style.display = 'none';
                document.getElementById('toggleFlashButton').style.display = 'none';
                document.getElementById('barcodeOverlay').style.display = 'none';
                barcodeStatus.textContent = 'Pou≈æijte ruƒçn√≠ zad√°n√≠ k√≥du';
                throw error;
            }
        }

        function startBarcodeScanning() {
            if (barcodeScanInterval) {
                clearInterval(barcodeScanInterval);
                barcodeScanInterval = null;
            }

            if (barcodeDetectionTimeout) {
                clearTimeout(barcodeDetectionTimeout);
            }
            barcodeDetectionTimeout = setTimeout(() => {
                document.getElementById('barcodeStatus').textContent = 'ƒåasov√Ω limit vypr≈°el - zkuste to znovu';
                document.getElementById('barcodeStatus').style.color = 'orange';
                restartQuagga();
            }, 20000);

            if (quaggaInitialized && document.getElementById('barcodeVideo').srcObject) {
                try {
                    Quagga.start();
                    document.getElementById('barcodeStatus').textContent = 'Skenov√°n√≠ spu≈°tƒõno - nami≈ôte na ƒç√°rov√Ω k√≥d';
                } catch (error) {
                    console.error('Chyba p≈ôi startu Quaggy:', error);
                    startCanvasFallback();
                }
            } else {
                startCanvasFallback();
            }
        }

        function startCanvasFallback() {
            document.getElementById('barcodeStatus').textContent = 'Pou≈æ√≠v√°m z√°kladn√≠ detekci...';
            document.getElementById('barcodeStatus').style.color = 'orange';

            barcodeScanInterval = setInterval(async () => {
                const barcodeVideo = document.getElementById('barcodeVideo');
                if (barcodeVideo.readyState === barcodeVideo.HAVE_ENOUGH_DATA) {
                    try {
                        const barcodes = await detectBarcodesWithCanvas();
                        if (barcodes.length > 0) {
                            handleBarcodeDetected(barcodes[0]);
                        }
                    } catch (error) {
                        console.error('Chyba p≈ôi detekci ƒç√°rov√©ho k√≥du:', error);
                    }
                }
            }, 1000);
        }

        function detectBarcodesWithCanvas() {
            return new Promise((resolve) => {
                const barcodeVideo = document.getElementById('barcodeVideo');
                const barcodeCanvas = document.getElementById('barcodeCanvas');

                if (!barcodeVideo.videoWidth || !barcodeVideo.videoHeight) {
                    resolve([]);
                    return;
                }

                const context = barcodeCanvas.getContext('2d');
                const width = barcodeVideo.videoWidth;
                const height = barcodeVideo.videoHeight;

                barcodeCanvas.width = width;
                barcodeCanvas.height = height;
                context.drawImage(barcodeVideo, 0, 0, width, height);

                try {
                    const imageData = context.getImageData(0, 0, width, height);
                    const detectedBarcodes = detectSimpleBarcodes(imageData);
                    resolve(detectedBarcodes);
                } catch (error) {
                    console.error('Chyba p≈ôi detekci:', error);
                    resolve([]);
                }
            });
        }

        function detectSimpleBarcodes(imageData) {
            return []; // Zjednodu≈°en√° implementace
        }

        function handleBarcodeDetected(barcode, quaggaResult) {
            if (lastDetectedBarcode === barcode) return;

            console.log('Nalezen ƒç√°rov√Ω k√≥d:', barcode);
            const isValid = isValidEAN(barcode);

            if (!isValid) {
                document.getElementById('barcodeStatus').textContent = `Neplatn√Ω k√≥d: ${barcode}`;
                document.getElementById('barcodeStatus').style.color = 'orange';
                return;
            }

            lastDetectedBarcode = barcode;
            document.getElementById('barcodeStatus').textContent = `Nalezen k√≥d: ${barcode}`;
            document.getElementById('barcodeStatus').style.color = '#4CAF50';

            document.getElementById('barcodeOverlay').classList.add('barcode-found');

            if (quaggaInitialized) {
                Quagga.stop();
            }

            setTimeout(() => {
                closeBarcodeScanner();
                searchByBarcode(barcode);
            }, 1000);

            setTimeout(() => {
                document.getElementById('barcodeOverlay').classList.remove('barcode-found');
            }, 1500);
        }

        function isValidEAN(barcode) {
            if (!/^\d{8}$|^\d{13}$/.test(barcode)) return false;
            return validateEANChecksum(barcode);
        }

        function validateEANChecksum(barcode) {
            if (barcode.length !== 8 && barcode.length !== 13) return false;
            return true; // Zjednodu≈°en√° validace
        }

        function searchByBarcode(barcode) {
            const searchInput = document.getElementById('query');
            if (searchInput) searchInput.value = barcode;

            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                searchForm.dispatchEvent(submitEvent);
            }
        }

        async function toggleCamera() {
            barcodeFacingMode = barcodeFacingMode === 'environment' ? 'user' : 'environment';
            document.getElementById('barcodeStatus').textContent = 'P≈ôep√≠n√°m kameru...';

            try {
                await startCamera();
                document.getElementById('barcodeStatus').textContent = 'Nami≈ôte na ƒç√°rov√Ω k√≥d';

                if (quaggaInitialized) {
                    Quagga.stop();
                    initQuagga();
                    startBarcodeScanning();
                }
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôep√≠n√°n√≠ kamery:', error);
                document.getElementById('barcodeStatus').textContent = 'Chyba: ' + error.message;
                document.getElementById('barcodeStatus').style.color = 'red';
            }
        }

        async function toggleFlash() {
            if (!barcodeStream) return;
            const videoTrack = barcodeStream.getVideoTracks()[0];
            if (!videoTrack) return;

            try {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    await videoTrack.applyConstraints({
                        advanced: [{ torch: !barcodeFlashEnabled }]
                    });
                    barcodeFlashEnabled = !barcodeFlashEnabled;
                    document.getElementById('toggleFlashButton').textContent = barcodeFlashEnabled ? 'Vypnout blesk' : 'Blesk';
                }
            } catch (error) {
                console.error('Chyba p≈ôi ovl√°d√°n√≠ blesku:', error);
            }
        }

        function submitManualBarcode() {
            const manualBarcodeInput = document.getElementById('manualBarcodeInput');
            const barcode = manualBarcodeInput.value.trim();

            if (barcode) {
                closeBarcodeScanner();
                searchByBarcode(barcode);
            } else {
                document.getElementById('barcodeStatus').textContent = 'Pros√≠m, zadejte ƒç√°rov√Ω k√≥d';
                document.getElementById('barcodeStatus').style.color = 'red';
            }
        }

        function restartQuagga() {
            if (typeof Quagga !== 'undefined') {
                try {
                    if (quaggaInitialized) {
                        Quagga.stop();
                        Quagga.offDetected();
                        Quagga.offProcessed();
                    }

                    quaggaInitialized = false;
                    lastDetectedBarcode = null;

                    setTimeout(() => {
                        initQuagga();
                    }, 500);
                } catch (error) {
                    console.error('Chyba p≈ôi restartu Quaggy:', error);
                }
            }
        }

        function closeBarcodeScanner() {
            if (barcodeDetectionTimeout) {
                clearTimeout(barcodeDetectionTimeout);
                barcodeDetectionTimeout = null;
            }

            if (barcodeStream) {
                try {
                    barcodeStream.getTracks().forEach(track => track.stop());
                    barcodeStream = null;
                } catch (error) {
                    console.error('Chyba p≈ôi zastavov√°n√≠ streamu:', error);
                }
            }

            const barcodeVideo = document.getElementById('barcodeVideo');
            if (barcodeVideo) barcodeVideo.srcObject = null;

            restartQuagga();
            document.getElementById('barcodeModal').style.display = 'none';
            document.getElementById('barcodeUnsupportedMessage').style.display = 'block';
            document.getElementById('barcodeVideo').style.display = 'none';
            document.getElementById('toggleCameraButton').style.display = 'none';
            document.getElementById('toggleFlashButton').style.display = 'none';
            document.getElementById('barcodeOverlay').style.display = 'none';
        }

        document.getElementById('confirmCreateRecipeButton').addEventListener('click', async function () {
            const recipeName = document.getElementById('newRecipeNameInput').value.trim();
            if (!recipeName) {
                window.showCustomNotification("Pros√≠m, zadejte n√°zev receptu.", 'info');
                return;
            }

            try {
                // D≈ÆLE≈ΩIT√â: P≈ôed√°me currentFoodItemForRecipe do createNewRecipe
                const recipeId = await createNewRecipe(recipeName, window.currentFoodItemForRecipe);
                if (recipeId) {
                    document.getElementById('createRecipeModal').style.display = 'none';
                    // Zobraz√≠me potvrzen√≠
                    window.showCustomNotification(`Recept "${recipeName}" byl vytvo≈ôen a potravina byla p≈ôid√°na!`, 'recipeCreation');
                }
            } catch (error) {
                console.error("Chyba p≈ôi vytv√°≈ôen√≠ receptu:", error);
                window.showCustomNotification("Chyba p≈ôi vytv√°≈ôen√≠ receptu: " + error.message, 'error');
            }
        });

        // =============================================
        // INICIALIZACE APLIKACE
        // =============================================
        document.addEventListener('DOMContentLoaded', async function () {
            if (window.appInitialized) return;
            window.appInitialized = true;

            document.getElementById('personalCardButton').addEventListener('click', showPersonalCardModal);
            //document.getElementById('closePersonalCard').addEventListener('click', closePersonalCardModal);
            document.getElementById('calculatePersonalCard').addEventListener('click', calculatePersonalCard);
            document.getElementById('savePersonalCard').addEventListener('click', savePersonalCardData);

            // Event listener pro zmƒõnu c√≠le (zobraz√≠/skryje intenzitu)
            /*document.getElementById('goal').addEventListener('change', function () {
                const intensityGroup = document.getElementById('intensityGroup');
                if (this.value === 'maintain') {
                    intensityGroup.style.display = 'none';
                } else {
                    intensityGroup.style.display = 'block';
                }
            });*/

            // Event listener pro zmƒõnu c√≠le
            const goalSelect = document.getElementById('goal');
            if (goalSelect) {
                goalSelect.addEventListener('change', function () {
                    const intensityGroup = document.getElementById('intensityGroup');
                    const intensitySelect = document.getElementById('intensity');

                    if (intensityGroup && intensitySelect) {
                        if (this.value === 'maintain') {
                            // P≈ôi udr≈æen√≠: intenzita disabled a pr√°zdn√°
                            intensitySelect.disabled = true;
                            intensitySelect.value = "";
                            intensitySelect.style.backgroundColor = '#f8f9fa';
                            intensitySelect.style.color = '#6c757d';
                        } else if (this.value === 'loss' || this.value === 'gain') {
                            // P≈ôi redukci/nab√≠r√°n√≠: intenzita enabled a pr√°zdn√°
                            intensitySelect.disabled = false;
                            intensitySelect.value = ""; // PR√ÅZDN√â - ≈æ√°dn√° p≈ôedvolba
                            intensitySelect.style.backgroundColor = '';
                            intensitySelect.style.color = '';
                        } else {
                            // ≈Ω√°dn√Ω c√≠l vybr√°n: intenzita disabled a pr√°zdn√°
                            intensitySelect.disabled = true;
                            intensitySelect.value = "";
                            intensitySelect.style.backgroundColor = '#f8f9fa';
                            intensitySelect.style.color = '#6c757d';
                        }
                    }
                });

                // Inicializace - ≈æ√°dn√° p≈ôedvolba
                goalSelect.dispatchEvent(new Event('change'));
            }

            document.getElementById('closeSelectRecipeModal').addEventListener('click', function () {
                document.getElementById('selectRecipeModal').style.display = 'none';
            });

            document.getElementById('closeProfileModal').addEventListener('click', function (e) {
                e.stopPropagation();
                console.log("‚ùå Kliknuto na k≈ô√≠≈æek v profil modalu");
                closeProfileModal();
            });

            document.getElementById('settingsProfileInfo').addEventListener('click', function (e) {
                e.stopPropagation();
                console.log("üë§ Kliknuto na profil v nastaven√≠");

                // D≈ÆLE≈ΩIT√â: Nejprve sbal√≠me v≈°echny sekce v nastaven√≠
                const hadOpenSections = collapseAllSettingsSections();

                // Poƒçk√°me na animaci sbalen√≠
                const delay = hadOpenSections ? 150 : 0;

                setTimeout(() => {
                    // Zav≈ôeme nastaven√≠
                    document.getElementById('settingsModal').style.display = 'none';

                    // Pot√© otev≈ôeme spr√°vu profil≈Ø
                    setTimeout(() => {
                        window.showProfileModal();
                    }, 50);
                }, delay);
            });
            document.getElementById('closeCreateProfileModal').addEventListener('click', function () {
                document.getElementById('createProfileModal').style.display = 'none';
            });

            document.getElementById('cancelCreateProfile').addEventListener('click', function () {
                document.getElementById('createProfileModal').style.display = 'none';
                window.isProfileModalShowing = false;
            });

            document.getElementById('profileModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    console.log("‚ùå Kliknuto mimo profil modal");
                    closeProfileModal();
                }
            });

            document.getElementById('closeProfileModal').addEventListener('click', function (e) {
                e.stopPropagation();
                console.log("‚ùå Kliknuto na k≈ô√≠≈æek v profil modalu");
                closeProfileModal();
            });

            initializeDetailsModalListeners();
            setupModalCloseHandlers();
            initBarcodeScanner();

            await initializeApplication();

            // Event listenery pro p≈ôihl√°≈°en√≠
            document.getElementById('loginBtn').addEventListener('click', async function () {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                if (!email || !password) {
                    errorDiv.textContent = "Vypl≈àte email a heslo";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    await loginUser(email, password);
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            document.getElementById('registerBtn').addEventListener('click', async function () {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                if (!email || !password) {
                    errorDiv.textContent = "Vypl≈àte email a heslo";
                    errorDiv.style.display = 'block';
                    return;
                }

                if (password.length < 6) {
                    errorDiv.textContent = "Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    await registerUser(email, password);
                    errorDiv.style.display = 'none';
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            // Event listenery pro profily
            document.getElementById('confirmCreateProfile').addEventListener('click', async function (event) {
                event.preventDefault();
                event.stopPropagation();

                if (this.disabled) return;

                const profileNameInput = document.getElementById('newProfileName');
                if (profileNameInput) {
                    const profileName = profileNameInput.value.trim();
                    if (!profileName) {
                        window.showCustomNotification("Pros√≠m, zadejte n√°zev profilu.", 'info');
                        return;
                    }

                    this.disabled = true;
                    const originalText = this.textContent;
                    this.textContent = "Vytv√°≈ôen√≠...";

                    try {
                        const newProfileId = await createNewProfile(profileName);
                        if (newProfileId) {
                            document.getElementById('createProfileModal').style.display = 'none';
                        }
                    } catch (error) {
                        console.error("‚ùå Chyba p≈ôi vytv√°≈ôen√≠ profilu:", error);
                    } finally {
                        if (this && this.parentNode) {
                            this.disabled = false;
                            this.textContent = originalText;
                        }
                    }
                }
            });

            document.getElementById('createNewProfileBtn').addEventListener('click', () => {
                document.getElementById('profileModal').style.display = 'none';
                window.showCreateProfileModal();
            });

            // Event listenery pro recepty
            document.getElementById('recipesButton').addEventListener('click', async () => {
                if (!checkInitialization()) return;
                try {
                    await loadUserRecipes();
                    document.getElementById('selectRecipeModal').style.display = 'flex';
                } catch (error) {
                    window.showCustomNotification("Chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø: " + error.message, 'error');
                }
            });

            // Event listenery pro nastaven√≠
            document.getElementById('settingsIcon').addEventListener('click', () => {
                document.getElementById('settingsModal').style.display = 'flex';
                setTimeout(initializeSettingsSections, 100);
                updateSettingsProfileInfo();
            });

            document.getElementById('switchAccountBtn').addEventListener('click', async function () {
                // Nejprve sbal√≠me v≈°echny otev≈ôen√© sekce v nastaven√≠
                const hadOpenSections = collapseAllSettingsSections();

                // Poƒçk√°me chv√≠li na animaci sbalen√≠ (pokud jsou nƒõjak√© sekce otev≈ôen√©)
                const delay = hadOpenSections ? 150 : 0;

                setTimeout(() => {
                    // Zav≈ôeme modal nastaven√≠
                    document.getElementById('settingsModal').style.display = 'none';

                    // Po dal≈°√≠ kr√°tk√© chv√≠li zobraz√≠me p≈ôihla≈°ovac√≠ okno
                    setTimeout(() => {
                        showLoginModal();
                    }, 50);
                }, delay);
            });

            // Event listenery pro p≈ôep√≠naƒçe nastaven√≠
            const toggleIds = [
                'confirmRecipeCreationToggle',
                'confirmProfileCreationToggle',
                'confirmProfileSwitchToggle',
                'confirmProfileAutoSelectToggle',
                'confirmFoodAdditionToggle',
                'confirmDeleteRecipeToggle',
                'confirmDeleteProfileToggle',
                'confirmDeleteRecipeItemToggle',
                'confirmSaveChangesToggle',
                'confirmRecipeSaveSuccessToggle',
                'confirmRecipeDeletionSuccessToggle',
                'confirmRecipeDeletionErrorToggle'
            ];

            toggleIds.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', function () {
                        const settingKey = toggleId.replace('Toggle', '');
                        userSettings[settingKey] = this.checked;
                        saveUserSettings();
                    });
                }
            });

            // Event listener pro kliknut√≠ na profil
            const profileDisplay = document.getElementById('currentProfileDisplay');
            if (profileDisplay) {
                profileDisplay.addEventListener('click', function (e) {
                    e.stopPropagation();
                    window.showProfileModal();
                });
            }

            console.log("‚úÖ Aplikace inicializov√°na");

            // P≈òID√ÅNO: Event listener pro k≈ô√≠≈æek osobn√≠ karty
            const closePersonalCardBtn = document.getElementById('closePersonalCardModal');
            if (closePersonalCardBtn) {
                closePersonalCardBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    closePersonalCardModal();
                });
            }
        });
    </script>
</body>

</html>