<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorick√° kalkulaƒçka</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kalorick√°Kalkulaƒçka">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4a90e2">

    <!-- Icons for iOS -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon/icon-192.png') }}">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icon/splash-screen.png') }}">

    <!-- Web App Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('{{ url_for("static", filename="sw.js") }}')
                    .then(function (registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function (error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</head>

<body data-app-id="{{ app_id }}" data-supabase-url="{{ supabase_url }}" data-supabase-key="{{ supabase_key }}">

    <!-- HLAVIƒåKA HLAVN√ç STR√ÅNKY -->
    <header id="mainFixedHeader" class="main-fixed-header">

        <div class="header-row top-row">

            <div id="profileIconHeader" class="profile-icon-header">
                <img src="{{ url_for('static', filename='icon/profil.png') }}" alt="Profil" class="profile-header-icon">
                <span id="currentProfileNameHeader" class="profile-name-header" style="display: none;">Profil</span>
            </div>

            <div class="header-button-group">
                <button id="recipesButton" class="btn-small recipes-btn">Recepty</button>
                <button id="searchModalButton" class="btn-small search-btn">Vyhledat</button>
            </div>

            <img id="settingsIcon" src="{{ url_for('static', filename='icon/nastaveni.png') }}" alt="Nastaven√≠"
                class="settings-icon">
        </div>

        <div class="daily-intake-header">
            <div class="date-selector">
                <button id="prevDayBtn" class="date-nav-btn">‚Üê</button>
                <div class="date-display">
                    <span id="currentDateDisplay" class="current-date"></span>
                    <button id="todayBtn" class="today-text-btn">dnes</button>
                </div>
                <button id="nextDayBtn" class="date-nav-btn">‚Üí</button>
            </div>
        </div>
    </header>

    <!-- HLAVN√ç KONTEJNER -->
    <div class="container">

        <!-- HLAVN√ç OBSAH - DENN√ç P≈ò√çJEM -->
        <div id="mainContent">
            <!-- DENN√ç P≈ò√çJEM SE ZDE ZOBRAZUJE JAKO HLAVN√ç OBSAH -->
        </div>
    </div>

    <!-- MOD√ÅLN√ç OKNO PRO ZMƒöNU PROFILU -->
    <div id="profileNameModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeProfileNameModal">&times;</span>

            <div class="current-profile-info">
                <div class="profile-email" id="profileNameModalEmail"></div>
                <div class="current-profile-name" id="currentProfileNameDisplay"></div>
            </div>

            <div class="nastaven√≠-tlacitek-profil"
                style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <div style="display: flex; flex-direction: column; flex: 1;">
                    <span class="setting-label">Osobn√≠ karta a c√≠le</span>
                    <button id="personalCardButton" class="btn-small"
                        style="background-color: #6f42c1; margin-top: 5px;">
                        Otev≈ô√≠t osobn√≠ kartu
                    </button>
                </div>
                <div style="display: flex; flex-direction: column; flex: 1;">
                    <span class="setting-label">P≈ôihl√°≈°en√≠</span>
                    <button id="switchAccountBtn" class="btn-small" style="margin-top: 5px;">P≈ôepnout √∫ƒçet</button>
                </div>
            </div>

            <div class="form-group" style="margin: 20px 0;">
                <label for="newProfileNameInput">Nov√© jm√©no profilu</label>
                <input type="text" id="newProfileNameInput" class="form-input" placeholder="Zadejte nov√Ω n√°zev">
            </div>

            <div class="modal-action-buttons">
                <!--<button id="cancelProfileNameBtn" class="btn-cancel">Zru≈°it</button>-->
                <button id="saveProfileNameBtn" class="btn-primary">Ulo≈æit zmƒõny</button>
            </div>
        </div>
    </div>

    <!-- MOD√ÅLN√ç OKNO PRO VYHLED√ÅV√ÅN√ç -->
    <div id="searchModal" class="modal-overlay">
        <div class="modal-content search-modal-content">
            <span class="close-button" id="closeSearchModal">&times;</span>
            <h3>Vyhledat potraviny</h3>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="barcodeButtonInModal" class="btn-primary" style="flex: 1;">
                    üì∑ Skenovat ƒç√°rov√Ω k√≥d
                </button>
            </div>

            <form id="searchModalForm">
                <input type="text" id="searchModalQuery" name="query"
                    placeholder="Zadejte n√°zev potraviny (nap≈ô. jablko, ku≈ôe)" autofocus>
                <button type="submit">Vyhledat</button>
            </form>

            <div id="searchModalLoading" style="display: none; text-align: center; padding: 20px;">
                Vyhled√°v√°m...
            </div>

            <div id="searchModalResults" class="search-results-container">
                <!-- V√Ωsledky vyhled√°v√°n√≠ se zobraz√≠ zde -->
            </div>

            <div id="searchModalError" class="error" style="display: none;"></div>
        </div>
    </div>

    <div id="personalCardModal" class="modal-overlay">
        <div class="modal-content personal-card-modal">
            <!-- HLAVIƒåKA - STATICK√Å -->
            <div class="personal-card-header">
                <span class="close-button" id="closePersonalCardModal">&times;</span>
                <h2 style="color: #000; margin: 0;">üßò Osobn√≠ karta</h2>
                <p class="personal-card-subtitle" style="color: #000; opacity: 0.8; margin: 5px 0 0 0;">Nastavte si sv√©
                    c√≠le a z√≠skejte personalizovan√° doporuƒçen√≠</p>
            </div>

            <!-- OBSAH - SCROLLOVATELN√ù S PATIƒåKOU -->
            <div class="personal-card-content-scrollable">

                <!-- Z√ÅKLADN√ç √öDAJE -->
                <div class="personal-card-section">
                    <h3>üìä Z√°kladn√≠ √∫daje</h3>

                    <div class="form-row">
                        <div class="form-group gender-group">
                            <label for="gender">Pohlav√≠</label>
                            <select id="gender" class="form-input" required>
                                <option value="" disabled selected>‚ôÇ/‚ôÄ</option>
                                <option value="male">‚ôÇ Mu≈æ</option>
                                <option value="female">‚ôÄ ≈Ωena</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="age">Vƒõk</label>
                            <input type="number" id="age" class="form-input" placeholder="30" min="15" max="100">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="height">V√Ω≈°ka (cm)</label>
                            <input type="number" id="height" class="form-input" placeholder="175" min="100" max="250">
                        </div>
                        <div class="form-group weight-group">
                            <label for="weight">Aktu√°ln√≠ hmotnost (kg)</label>
                            <input type="number" id="weight" class="form-input" placeholder="75" min="30" max="300"
                                step="0.1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group body-fat-group">
                            <label for="bodyFat">Podko≈æn√≠ tuk (%)</label>
                            <input type="number" id="bodyFat" class="form-input" placeholder="20" min="5" max="60"
                                step="0.1">
                        </div>
                        <div class="form-group activity-level-group">
                            <label for="activityLevel">Denn√≠ pohybov√° aktivita</label>
                            <select id="activityLevel" class="form-input">
                                <option value="" disabled selected>Vyberte aktivitu</option>
                                <option value="1.2">Sedav√Ω (minimum pohybu)</option>
                                <option value="1.375">Lehce aktivn√≠ (1-3x t√Ωdnƒõ)</option>
                                <option value="1.55">St≈ôednƒõ aktivn√≠ (3-5x t√Ωdnƒõ)</option>
                                <option value="1.725">Velmi aktivn√≠ (6-7x t√Ωdnƒõ)</option>
                                <option value="1.9">Extr√©mnƒõ aktivn√≠ (fyzick√° pr√°ce + tr√©nink)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- C√çL -->
                <div class="personal-card-section">
                    <h3>üéØ C√≠l</h3>

                    <div class="form-group">
                        <label for="goal">C√≠l</label>
                        <select id="goal" class="form-input">
                            <option value="" disabled selected>Vyberte c√≠l</option>
                            <option value="loss">Redukce hmotnosti</option>
                            <option value="maintain">Udr≈æen√≠ hmotnosti</option>
                            <option value="gain">Nab√≠r√°n√≠ hmotnosti</option>
                        </select>
                    </div>

                    <!-- SKRYT√Å INTENZITA - V≈ΩDY "light" -->
                    <input type="hidden" id="intensity" value="light">

                    <!-- C√çLOV√Å HMOTNOST -->
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="targetWeight">C√≠lov√° hmotnost (kg)</label>
                        <input type="number" id="targetWeight" class="form-input" placeholder="70" min="30" max="300"
                            step="0.1">
                    </div>
                </div>

                <!-- TLAƒå√çTKO PRO V√ùPOƒåET -->
                <div class="personal-card-footer">
                    <button id="calculatePersonalCard" class="btn-primary">Vypoƒç√≠tat</button>
                </div>

                <!-- V√ùSLEDKY -->
                <div class="personal-card-section results-section">
                    <h3>üìà V√Ωsledky</h3>
                    <div class="results-grid-single-line">
                        <div class="result-item-single">
                            <div class="result-label">Baz√°ln√≠ metabolismus</div>
                            <div class="result-value" id="bmrResult">- kcal</div>
                        </div>
                        <div class="result-item-single">
                            <div class="result-label">Denn√≠ v√Ωdej (TDEE)</div>
                            <div class="result-value" id="tdeeResult">- kcal</div>
                        </div>
                        <div class="result-item-single highlight">
                            <div class="result-label">Doporuƒçen√Ω p≈ô√≠jem</div>
                            <div class="result-value" id="targetCaloriesResult">- kcal</div>
                        </div>
                        <div class="result-item-single">
                            <div class="result-label">Rozd√≠l hmotnosti</div>
                            <div class="result-value" id="weightDiffResult">- kg</div>
                        </div>
                    </div>
                </div>

                <!-- MAKRO≈ΩIVINY -->
                <div class="personal-card-section macros-section">
                    <h3>üí™ Makro≈æiviny</h3>
                    <div class="macros-subtitle">Doporuƒçen√° denn√≠ d√°vka</div>
                    <div class="macros-grid-2rows">
                        <div class="macro-row">
                            <div class="macro-item protein">
                                <div class="macro-icon">ü•©</div>
                                <div class="macro-info">
                                    <div class="macro-label">B√≠lkoviny</div>
                                    <div class="macro-value" id="proteinResult">- g</div>
                                </div>
                            </div>
                            <div class="macro-item carbs">
                                <div class="macro-icon">üçö</div>
                                <div class="macro-info">
                                    <div class="macro-label">Sacharidy</div>
                                    <div class="macro-value" id="carbsResult">- g</div>
                                </div>
                            </div>
                        </div>
                        <div class="macro-row">
                            <div class="macro-item fats">
                                <div class="macro-icon">ü•ë</div>
                                <div class="macro-info">
                                    <div class="macro-label">Tuky</div>
                                    <div class="macro-value" id="fatsResult">- g</div>
                                </div>
                            </div>
                            <div class="macro-item fiber">
                                <div class="macro-icon">üåæ</div>
                                <div class="macro-info">
                                    <div class="macro-label">Vl√°knina</div>
                                    <div class="macro-value" id="fiberResult">- g</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TLAƒå√çTKO PRO ULO≈ΩEN√ç -->
                <div class="personal-card-footer">
                    <!--<button id="calculatePersonalCard" class="btn-primary">Spoƒç√≠tat</button>-->
                    <button id="savePersonalCard" class="btn-primary" disabled>Ulo≈æit data</button>
                </div>
            </div>


        </div>
    </div>

    <!-- MOD√ÅLN√ç OKNO PRO V√ùBƒöR J√çDLA -->
    <div id="selectMealModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeSelectMealModal">&times;</span>
            <h3>P≈ôidat jako j√≠dlo</h3>

            <!-- V√ùBƒöR DATA -->
            <div class="date-selector"
                style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 20px 0;">
                <button id="prevMealDayBtn" class="date-nav-btn">‚Üê</button>
                <span id="selectedMealDate" class="current-date"
                    style="font-weight: 600; min-width: 200px; text-align: center;"></span>
                <button id="nextMealDayBtn" class="date-nav-btn">‚Üí</button>
            </div>

            <!-- SEZNAM J√çDEL -->
            <div class="meals-selection" style="display: flex; flex-direction: column; gap: 10px;">
                <button class="meal-type-btn" data-meal-type="breakfast">
                    <span style="font-size: 1.2em; margin-right: 10px;">üç≥</span>
                    Sn√≠danƒõ
                </button>
                <button class="meal-type-btn" data-meal-type="snack1">
                    <span style="font-size: 1.2em; margin-right: 10px;">ü•®</span>
                    Dopoledn√≠ svaƒçina
                </button>
                <button class="meal-type-btn" data-meal-type="lunch">
                    <span style="font-size: 1.2em; margin-right: 10px;">üç≤</span>
                    Obƒõd
                </button>
                <button class="meal-type-btn" data-meal-type="snack2">
                    <span style="font-size: 1.2em; margin-right: 10px;">üçé</span>
                    Odpoledn√≠ svaƒçina
                </button>
                <button class="meal-type-btn" data-meal-type="dinner">
                    <span style="font-size: 1.2em; margin-right: 10px;">üçΩÔ∏è</span>
                    Veƒçe≈ôe
                </button>
                <button class="meal-type-btn" data-meal-type="dinner2">
                    <span style="font-size: 1.2em; margin-right: 10px;">üåô</span>
                    Druh√° veƒçe≈ôe
                </button>
            </div>
        </div>
    </div>

    <!-- Mod√°ln√≠ okna -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <h3>P≈ôihl√°≈°en√≠ / Registrace</h3>
            <div id="loginError" class="error" style="display: none;"></div>
            <div id="loginSuccess" class="success" style="display: none; color: green;"></div>

            <input type="email" id="loginEmail" placeholder="E-mail" required>
            <input type="password" id="loginPassword" placeholder="Heslo" required>

            <div class="registration-info"
                style="font-size: 12px; color: #666; margin-bottom: 15px; text-align: center;">
                Pro registraci pou≈æijte pros√≠m existuj√≠c√≠ emailovou adresu.
            </div>

            <div class="modal-action-buttons">
                <button id="loginBtn">P≈ôihl√°sit se</button>
                <button id="registerBtn" class="btn-primary">Registrovat</button>
            </div>

            <!-- P≈òID√ÅNO: text-align: center pro zarovn√°n√≠ na st≈ôed -->
            <div class="email-verification-info" style="text-align: center;">
                Po registraci je pot≈ôeba potvrdit email. Zkontrolujte si spam slo≈æku.
            </div>
        </div>
    </div>

    <div id="createProfileModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeCreateProfileModal">&times;</span>
            <h3>Vytvo≈ôit nov√Ω profil</h3>
            <input type="text" id="newProfileName" placeholder="Jm√©no profilu">
            <div class="create-profile-buttons">
                <button id="confirmCreateProfile" class="btn-primary">Vytvo≈ôit</button>
                <button id="cancelCreateProfile" class="btn-secondary">Zru≈°it</button>
            </div>
        </div>
    </div>

    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content modal-recipe-content">
            <span class="close-button">&times;</span>
            <div class="modal-recipe-scroll-container">
                <div id="modalDetailsContent" class="modal-details modal-recipe-container">
                    <div class="modal-recipe-header">
                        <img id="modalHeaderImage" src="" alt="" class="modal-header-image">
                        <div class="modal-header-text">
                            <div id="modalHeaderName" class="modal-header-name">N√°zev receptu</div>
                            <div class="energy-display-group">
                                <div id="totalKcalDisplay" class="energy-header">0 kcal</div>
                                <div id="totalKjDisplay" class="energy-sub-header">0 kJ</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-scrollable-container">
                        <div id="nutrientDetailsSection"></div>
                        <h3 class="ingredients-title">Slo≈æen√≠ receptu:</h3>
                        <div id="recipeIngredientsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="createRecipeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeCreateRecipeModal">&times;</span>
            <h3>Vytvo≈ôit nov√Ω recept</h3>
            <input type="text" id="newRecipeNameInput" placeholder="N√°zev receptu">
            <div class="create-recipe-buttons">
                <button id="confirmCreateRecipeButton" class="btn-primary">Vytvo≈ôit a p≈ôidat</button>
                <button id="cancelCreateRecipeButton" class="btn-secondary">Zru≈°it</button>
            </div>
        </div>
    </div>

    <div id="selectRecipeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeSelectRecipeModal">&times;</span>
            <h3>Moje recepty</h3>
            <button id="addCustomRecipeBtn" class="btn-primary" style="padding: 8px 12px;">
                ‚ûï P≈ôidat vlastn√≠ recept
            </button>
            <div id="recipeCountDisplay" class="recipe-count-display"></div>
            <div class="recipes-list-container">
                <ul id="existingRecipesList"></ul>
            </div>
            <div class="recipe-list-actions"></div>
        </div>
    </div>

    <div id="customNotificationModal" class="modal-overlay">
        <div class="modal-content">
            <p id="customNotificationMessage"></p>
            <div class="notification-controls">
                <div id="dynamicNotificationToggleContainer" class="notification-toggle-container"></div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModal">&times;</span>
            <h2>Kalorick√° kalkulaƒçka</h2>
            <h3>Nastaven√≠</h3>

            <div class="setting-section">
                <div class="setting-section-header">
                    <span class="setting-label">Dialogov√° okna</span>
                    <span class="setting-section-arrow">‚ñº</span>
                </div>
                <div class="setting-section-content">
                    <div class="setting-item">
                        <span class="setting-label">Potvrzen√≠ smaz√°n√≠ receptu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmDeleteRecipeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Potvrzen√≠ smaz√°n√≠ polo≈æky receptu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmDeleteRecipeItemToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Potvrzen√≠ ulo≈æen√≠ zmƒõn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmSaveChangesToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ vytvo≈ôen√≠ receptu</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeCreationToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ p≈ôid√°n√≠ potraviny</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmFoodAdditionToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ √∫spƒõ≈°n√©ho smaz√°n√≠</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeDeletionSuccessToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ chyby smaz√°n√≠</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeDeletionErrorToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Ozn√°men√≠ √∫spƒõ≈°n√©ho ulo≈æen√≠ zmƒõn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="confirmRecipeSaveSuccessToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MOD√ÅLN√ç OKNO PRO VLASTN√ç RECEPT -->
    <div id="customRecipeModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeCustomRecipeModal">&times;</span>
            <h3>Vytvo≈ôit vlastn√≠ recept</h3>

            <!-- Z√ÅKLADN√ç INFORMACE -->
            <div class="basic-info-section">
                <div class="form-group">
                    <label for="customRecipeName">N√°zev receptu *</label>
                    <input type="text" id="customRecipeName" class="form-input" placeholder="Zadejte n√°zev" required>
                </div>

                <div class="basic-info-row">
                    <div class="form-group">
                        <label for="customRecipeCalories">Energie (kcal) *</label>
                        <input type="number" id="customRecipeCalories" class="form-input" placeholder="0" min="0"
                            required>
                    </div>

                    <div class="form-group">
                        <label for="customRecipePortions">Poƒçet porc√≠</label>
                        <select id="customRecipePortions" class="form-input">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- B√çLKOVINY -->
            <div class="nutrient-section-group">
                <div class="nutrient-group-header">B√≠lkoviny</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeProtein">Celkov√© (g)</label>
                        <input type="number" id="customRecipeProtein" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                    <div class="form-group" style="visibility: hidden;">
                        <label>Pr√°zdn√©</label>
                        <input type="text">
                    </div>
                </div>
            </div>

            <!-- SACHARIDY -->
            <div class="nutrient-section-group">
                <div class="nutrient-group-header">Sacharidy</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeCarbs">Celkov√© (g)</label>
                        <input type="number" id="customRecipeCarbs" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="customRecipeSugar">Cukry (g)</label>
                        <input type="number" id="customRecipeSugar" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                </div>
            </div>

            <!-- TUKY - KOMPAKTNƒöJ≈†√ç -->
            <div class="nutrient-section-group">
                <div class="nutrient-group-header">Tuky</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeFat">Celkov√© (g)</label>
                        <input type="number" id="customRecipeFat" class="form-input small-input" placeholder="0" min="0"
                            step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="customRecipeSaturatedFat">Nasycen√© (g)</label>
                        <input type="number" id="customRecipeSaturatedFat" class="form-input small-input"
                            placeholder="0" min="0" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeTransFat">Trans (g)</label>
                        <input type="number" id="customRecipeTransFat" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="customRecipeMonoFat">Mononenasycen√© (g)</label>
                        <input type="number" id="customRecipeMonoFat" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipePolyFat">Polynenasycen√© (g)</label>
                        <input type="number" id="customRecipePolyFat" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="customRecipeCholesterol">Cholesterol (mg)</label>
                        <input type="number" id="customRecipeCholesterol" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                </div>
            </div>

            <!-- DAL≈†√ç ≈ΩIVINY -->
            <div class="nutrient-section-group">
                <div class="nutrient-group-header">Dal≈°√≠ ≈æiviny</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeFiber">Vl√°knina (g)</label>
                        <input type="number" id="customRecipeFiber" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                </div>
            </div>

            <!-- MINER√ÅLY -->
            <div class="nutrient-section-group">
                <div class="nutrient-group-header">Miner√°ly</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeSalt">S≈Øl (g)</label>
                        <input type="number" id="customRecipeSalt" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="customRecipeCalcium">V√°pn√≠k (mg)</label>
                        <input type="number" id="customRecipeCalcium" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeSodium">Sod√≠k (mg)</label>
                        <input type="number" id="customRecipeSodium" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                </div>
            </div>

            <!-- OSTATN√ç -->
            <div class="nutrient-section-group">
                <div class="nutrient-group-header">Ostatn√≠</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customRecipeWater">Voda (g)</label>
                        <input type="number" id="customRecipeWater" class="form-input small-input" placeholder="0"
                            min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="customRecipePhe">PHE (mg)</label>
                        <input type="number" id="customRecipePhe" class="form-input small-input" placeholder="0" min="0"
                            step="0.1">
                    </div>
                </div>
            </div>

            <!-- TLAƒå√çTKO -->
            <div class="modal-action-buttons">
                <button id="saveCustomRecipeBtn" class="btn-primary">Ulo≈æit</button>
            </div>

            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                * Povinn√© pole
            </div>
        </div>
    </div>

    <!-- MOD√ÅLN√ç OKNO PRO SKENOV√ÅN√ç - NOV√Å VERZE -->
    <div id="barcodeModal" class="modal-overlay">
        <div class="modal-content barcode-modal">
            <span class="close-button" id="closeBarcodeModal">&times;</span>
            <h3>üì∑ Skenovat ƒç√°rov√Ω k√≥d</h3>

            <!-- KONTEJNER PRO KAMERU -->
            <div id="barcodeScannerContainer" class="barcode-scanner-container">
                <div class="barcode-placeholder">
                    <p>üîÑ P≈ôipravuji kameru...</p>
                </div>
            </div>

            <!-- OVL√ÅDAC√ç TLAƒå√çTKA -->
            <div class="barcode-controls">
                <button id="toggleCameraButton" class="btn-small">üîÑ Otoƒçit kameru</button>
                <button id="toggleFlashButton" class="btn-small" style="display:none;">‚ö° Blesk</button>
            </div>

            <!-- STAV SKENOV√ÅN√ç -->
            <div id="barcodeStatus" class="barcode-status">Kliknƒõte pro spu≈°tƒõn√≠ kamery</div>

            <!-- N√ÅHRADN√ç ≈òE≈†EN√ç -->
            <div class="barcode-fallback">
                <p><strong>Nefunguje skenov√°n√≠?</strong></p>
                <div class="manual-input-group">
                    <input type="text" id="manualBarcodeInput" placeholder="Zadejte ƒç√°rov√Ω k√≥d">
                    <button id="submitManualBarcode" class="btn-primary">Vyhledat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DENN√ç P≈ò√çJEM - HLAVN√ç SEKCE -->
    <div id="dailyIntakeSection" style="display: none;">

        <!-- CELKOV√ù P≈òEHLED S KRUHOV√ùMI GRAFY -->
        <div class="intake-overview">
            <div class="charts-grid-main">
                <div class="chart-container large-chart">
                    <div class="chart-title">Kalorie</div>
                    <div class="circular-chart" id="caloriesChart">
                        <svg viewBox="0 0 36 36" class="circular-chart-svg">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle" stroke-dasharray="0, 100"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18.5" y="17.5" class="percentage">0%</text>
                        </svg>
                    </div>
                    <div class="chart-details">
                        <div class="chart-value" id="caloriesValue">0 / 0 kcal</div>
                        <div class="chart-label" id="caloriesLabel">Zb√Ωv√° 0 kcal</div>
                    </div>
                </div>
            </div>

            <div class="charts-grid-macros">
                <div class="chart-container">
                    <div class="chart-title">B√≠lkoviny</div>
                    <div class="circular-chart" id="proteinChart">
                        <svg viewBox="0 0 36 36" class="circular-chart-svg">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle protein" stroke-dasharray="0, 100"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18" y="18" class="percentage">0%</text>
                        </svg>
                    </div>
                    <div class="chart-details">
                        <div class="chart-value" id="proteinValue">0 / 0 g</div>
                        <div class="chart-label" id="proteinLabel">Zb√Ωv√° 0 g</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Sacharidy</div>
                    <div class="circular-chart" id="carbsChart">
                        <svg viewBox="0 0 36 36" class="circular-chart-svg">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle carbs" stroke-dasharray="0, 100"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18" y="18" class="percentage">0%</text>
                        </svg>
                    </div>
                    <div class="chart-details">
                        <div class="chart-value" id="carbsValue">0 / 0 g</div>
                        <div class="chart-label" id="carbsLabel">Zb√Ωv√° 0 g</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Tuky</div>
                    <div class="circular-chart" id="fatsChart">
                        <svg viewBox="0 0 36 36" class="circular-chart-svg">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle fats" stroke-dasharray="0, 100"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18" y="18" class="percentage">0%</text>
                        </svg>
                    </div>
                    <div class="chart-details">
                        <div class="chart-value" id="fatsValue">0 / 0 g</div>
                        <div class="chart-label" id="fatsLabel">Zb√Ωv√° 0 g</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Vl√°knina</div>
                    <div class="circular-chart" id="fiberChart">
                        <svg viewBox="0 0 36 36" class="circular-chart-svg">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle fiber" stroke-dasharray="0, 100"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18" y="18" class="percentage">0%</text>
                        </svg>
                    </div>
                    <div class="chart-details">
                        <div class="chart-value" id="fiberValue">0 / 0 g</div>
                        <div class="chart-label" id="fiberLabel">Zb√Ωv√° 0 g</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEZNAM J√çDEL -->
        <div class="meals-section">
            <div class="meal-category" data-meal-type="breakfast">
                <div class="meal-header">
                    <h3>üç≥ Sn√≠danƒõ</h3>
                    <button class="add-meal-btn" data-meal-type="breakfast">+ P≈ôidat j√≠dlo</button>
                </div>
                <div class="meal-items" id="breakfastItems"></div>
            </div>

            <div class="meal-category" data-meal-type="snack1">
                <div class="meal-header">
                    <h3>ü•® Dopoledn√≠ svaƒçina</h3>
                    <button class="add-meal-btn" data-meal-type="snack1">+ P≈ôidat j√≠dlo</button>
                </div>
                <div class="meal-items" id="snack1Items"></div>
            </div>

            <div class="meal-category" data-meal-type="lunch">
                <div class="meal-header">
                    <h3>üç≤ Obƒõd</h3>
                    <button class="add-meal-btn" data-meal-type="lunch">+ P≈ôidat j√≠dlo</button>
                </div>
                <div class="meal-items" id="lunchItems"></div>
            </div>

            <div class="meal-category" data-meal-type="snack2">
                <div class="meal-header">
                    <h3>üçé Odpoledn√≠ svaƒçina</h3>
                    <button class="add-meal-btn" data-meal-type="snack2">+ P≈ôidat j√≠dlo</button>
                </div>
                <div class="meal-items" id="snack2Items"></div>
            </div>

            <div class="meal-category" data-meal-type="dinner">
                <div class="meal-header">
                    <h3>üçΩÔ∏è Veƒçe≈ôe</h3>
                    <button class="add-meal-btn" data-meal-type="dinner">+ P≈ôidat j√≠dlo</button>
                </div>
                <div class="meal-items" id="dinnerItems"></div>
            </div>

            <!-- DRUH√Å VEƒåE≈òE -->
            <div class="meal-category" data-meal-type="dinner2">
                <div class="meal-header">
                    <h3>üåô Druh√° veƒçe≈ôe</h3>
                    <button class="add-meal-btn" data-meal-type="dinner2">+ P≈ôidat j√≠dlo</button>
                </div>
                <div class="meal-items" id="dinner2Items"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.58.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

    <script type="module">
        // =============================================
        // GLOB√ÅLN√ç PROMƒöNN√â A KONFIGURACE
        // =============================================
        let supabaseClient;
        let currentUser = null;
        let currentProfileId = null;
        let isAppInitialized = false;
        let isLoadingProfiles = false;
        let isProfileModalShowing = false;
        let isUpdatingProfileDisplay = false;
        let isEditingRecipeItem = false;
        let editingRecipeContext = null;
        let currentFoodItemData = null;
        let currentEditingRecipeId = null;
        let currentEditingIngredientIndex = null;
        let userProfiles = [];
        let isCreatingProfile = false;
        let personalCardData = null;
        let selectedMealDate = new Date();
        let currentFoodItemForMeal = null;
        let personalCardOriginalData = null;
        let personalCardHasChanges = false;

        // Nastaven√≠ u≈æivatele
        let userSettings = {
            confirmRecipeCreation: true,
            confirmFoodAddition: true,
            confirmDeleteRecipe: true,
            confirmDeleteRecipeItem: true,
            confirmSaveChanges: true,
            confirmRecipeSaveSuccess: true,
            confirmRecipeDeletionSuccess: true,
            confirmRecipeDeletionError: true
        };

        // Promƒõnn√© pro vyhled√°v√°n√≠
        let currentSearchController = null;
        let isSearchInterrupted = false;
        const placeholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}";

        // Promƒõnn√© pro skenov√°n√≠ ƒç√°rov√Ωch k√≥d≈Ø
        /*let barcodeStream = null;
        let barcodeFacingMode = 'environment';
        let barcodeFlashEnabled = false;
        let barcodeScanInterval = null;
        let quaggaInitialized = false;
        let lastDetectedBarcode = null;
        let barcodeDetectionTimeout = null;
*/
        let barcodeStream = null;
        let barcodeScanningActive = false;
        let currentFacingMode = 'environment';
        let barcodeScannerActive = false;
        let barcodeDetectionInterval = null;

        // =============================================
        // DENN√ç P≈ò√çJEM - PROMƒöNN√â A KONFIGURACE
        // =============================================
        let currentDailyIntakeDate = new Date();
        let dailyIntakeGoals = null;
        let currentDailyIntakeData = null;

        // Mapov√°n√≠ typ≈Ø j√≠del na ƒçesk√© n√°zvy
        const mealTypeLabels = {
            breakfast: 'Sn√≠danƒõ',
            snack1: 'Dopoledn√≠ svaƒçina',
            lunch: 'Obƒõd',
            snack2: 'Odpoledn√≠ svaƒçina',
            dinner: 'Veƒçe≈ôe',
            dinner2: 'Druh√° veƒçe≈ôe'
        };

        // Mapov√°n√≠ typ≈Ø j√≠del na emoji
        const mealTypeEmojis = {
            breakfast: 'üç≥',
            snack1: 'ü•®',
            lunch: 'üç≤',
            snack2: 'üçé',
            dinner: 'üçΩÔ∏è',
            dinner2: 'üåô'
        };

        // Inicializace glob√°ln√≠ch promƒõnn√Ωch
        window.supabaseClient = null;
        window.currentUser = null;
        window.currentProfileId = null;
        window.userProfiles = [];
        window.isAppInitialized = false;
        window.isLoadingProfiles = false;
        window.isProfileModalShowing = false;

        // =============================================
        // Z√ÅKLADN√ç UTILITY FUNKCE
        // =============================================
        function showPersonalCardModal() {
            const modal = document.getElementById('personalCardModal');
            modal.style.display = 'flex';

            // Resetujeme stav zmƒõn p≈ôi otev≈ôen√≠ modalu
            personalCardHasChanges = false;
            loadPersonalCardData();

            // P≈ôid√°me event listenery pro zmƒõny
            setTimeout(() => {
                addPersonalCardChangeListeners();
            }, 100);
        }

        function closePersonalCardModal() {
            const modal = document.getElementById('personalCardModal');
            modal.style.display = 'none';
        }

        // Event listener pro kliknut√≠ mimo modal
        document.getElementById('personalCardModal').addEventListener('click', function (event) {
            if (event.target === this) {
                closePersonalCardModal();
            }
        });

        // Hlavn√≠ v√Ωpoƒçetn√≠ funkce
        function calculatePersonalCard() {
            // Naƒçten√≠ hodnot z formul√°≈ôe
            const formData = getFormData();

            // Validace
            if (!validateFormData(formData)) {
                return;
            }

            // V√Ωpoƒçty
            const calculations = performCalculations(formData);

            // Zobrazen√≠ v√Ωsledk≈Ø - D≈ÆLE≈ΩIT√â: zobrazit NOV√â v√Ωsledky
            displayResults(calculations);

            // Ulo≈æen√≠ kompletn√≠ch dat pro pozdƒõj≈°√≠ ulo≈æen√≠
            personalCardData = {
                formData: formData,
                calculations: calculations,  // NOV√â V√ùPOƒåTY
                timestamp: new Date().toISOString()
            };

            // Povolen√≠ tlaƒç√≠tka Ulo≈æit pouze pokud jsou zmƒõny
            checkPersonalCardChanges();

            console.log("üìä Vypoƒç√≠tan√° data:", personalCardData);
        }

        // Event listenery pro nov√° tlaƒç√≠tka
        document.getElementById('searchModalButton').addEventListener('click', openSearchModal);
        document.getElementById('closeSearchModal').addEventListener('click', closeSearchModal);

        // Funkce pro otev≈ôen√≠ vyhled√°vac√≠ho modalu
        function openSearchModal() {
            console.log("üîç Otev√≠r√°m vyhled√°vac√≠ modal");
            document.getElementById('searchModal').style.display = 'flex';
            document.getElementById('searchModalQuery').value = '';
            document.getElementById('searchModalQuery').focus();
            document.getElementById('searchModalResults').innerHTML = '';
            document.getElementById('searchModalError').style.display = 'none';
        }

        // Funkce pro zav≈ôen√≠ vyhled√°vac√≠ho modalu
        function closeSearchModal() {
            console.log("üî¥ Zav√≠r√°m vyhled√°vac√≠ modal");
            
            // ZRU≈†√çME PROB√çHAJ√çC√ç VYHLED√ÅV√ÅN√ç
            if (searchAbortController) {
                searchAbortController.abort();
                searchAbortController = null;
                console.log("üõë Vyhled√°v√°n√≠ zru≈°eno p≈ôi zav≈ôen√≠ modalu");
            }
            
            const modal = document.getElementById('searchModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Vyƒçist√≠me vstupn√≠ pole
            const searchInput = document.getElementById('searchModalQuery');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Vyƒçist√≠me v√Ωsledky
            const resultsDiv = document.getElementById('searchModalResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '';
            }
            
            // Skryjeme loading
            const loadingDiv = document.getElementById('searchModalLoading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
        }

        // Event listener pro vyhled√°vac√≠ form v modalu
        document.getElementById('searchModalForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const query = document.getElementById('searchModalQuery').value.trim();
            if (!query) return;

            await performSearch(query);
        });

        // Funkce pro kontrolu zmƒõn ve formul√°≈ôi
        function checkPersonalCardChanges() {
            if (!personalCardOriginalData) return false;

            const currentData = getFormData();

            // Porovn√°me aktu√°ln√≠ data s p≈Øvodn√≠mi
            const hasChanges =
                currentData.gender !== personalCardOriginalData.gender ||
                currentData.age !== personalCardOriginalData.age ||
                currentData.height !== personalCardOriginalData.height ||
                currentData.weight !== personalCardOriginalData.weight ||
                currentData.bodyFat !== personalCardOriginalData.bodyFat ||
                currentData.targetWeight !== personalCardOriginalData.targetWeight ||
                currentData.activityLevel !== personalCardOriginalData.activityLevel ||
                currentData.goal !== personalCardOriginalData.goal;

            personalCardHasChanges = hasChanges;
            updateSaveButtonState();
            return hasChanges;
        }

        // Funkce pro aktualizaci stavu tlaƒç√≠tka Ulo≈æit
        function updateSaveButtonState() {
            const saveButton = document.getElementById('savePersonalCard');
            if (!saveButton) return;

            if (personalCardHasChanges && personalCardData) {
                saveButton.disabled = false;
                saveButton.textContent = 'Ulo≈æit data';
                saveButton.style.backgroundColor = '#28a745';
            } else {
                saveButton.disabled = true;
                saveButton.textContent = 'Ulo≈æit data';
                saveButton.style.backgroundColor = '#6c757d';
            }
        }

        // Funkce pro zobrazen√≠ okna zmƒõny profilu
        function showProfileNameModal() {
            if (!window.currentProfileId || !window.userProfiles) {
                window.showCustomNotification("Nejprve vyberte profil", 'info');
                return;
            }

            const modal = document.getElementById('profileNameModal');
            const currentProfile = window.userProfiles.find(p => p.id === window.currentProfileId);

            if (!currentProfile) {
                window.showCustomNotification("Profil nenalezen", 'error');
                return;
            }

            // Napl≈à data
            document.getElementById('profileNameModalEmail').textContent = window.currentUser?.email || '';
            document.getElementById('currentProfileNameDisplay').textContent = currentProfile.name;
            document.getElementById('newProfileNameInput').value = currentProfile.name;

            modal.style.display = 'flex';
            document.getElementById('newProfileNameInput').focus();
        }

        // INICIALIZACE EVENT LISTENER≈Æ
        function initializeMealModalListeners() {
            console.log("üîß Inicializuji listeners pro meal modal...");

            // DEBUG: Kter√© elementy existuj√≠?
            console.log("üìã Dostupn√© elementy:");
            console.log("- addAsMealButton:", document.getElementById('addAsMealButton'));
            console.log("- selectMealModal:", document.getElementById('selectMealModal'));
            console.log("- closeSelectMealModal:", document.getElementById('closeSelectMealModal'));
            console.log("- meal-type-btn count:", document.querySelectorAll('.meal-type-btn').length);

            // ‚úÖ BEZPEƒåN√â KONTROLY EXISTENCE ELEMENT≈Æ
            const addAsMealButton = document.getElementById('addAsMealButton');
            const closeSelectMealModalBtn = document.getElementById('closeSelectMealModal');
            const prevMealDayBtn = document.getElementById('prevMealDayBtn');
            const nextMealDayBtn = document.getElementById('nextMealDayBtn');
            const selectMealModal = document.getElementById('selectMealModal');

            // Tlaƒç√≠tko "P≈ôidat jako j√≠dlo"
            if (addAsMealButton) {
                console.log("‚úÖ addAsMealButton nalezen, p≈ôid√°v√°m listener...");
                addAsMealButton.addEventListener('click', function () {
                    console.log("üéØ KLIKNUTO NA P≈òIDAT JAKO J√çDLO!");

                    if (!checkInitialization()) {
                        console.log("‚ùå Inicializace selhala");
                        return;
                    }

                    currentFoodItemForMeal = window.currentFoodItemForRecipe;
                    console.log("üì¶ currentFoodItemForMeal:", currentFoodItemForMeal);

                    if (!currentFoodItemForMeal) {
                        window.showCustomNotification("Nejd≈ô√≠ve vyberte potravinu", 'info');
                        return;
                    }

                    openSelectMealModal();
                });
            } else {
                console.log("‚ùå addAsMealButton NENALEZEN - probl√©m v HTML nebo naƒçasov√°n√≠");
            }

            // Zav√≠rac√≠ tlaƒç√≠tko
            if (closeSelectMealModalBtn) {
                closeSelectMealModalBtn.addEventListener('click', closeSelectMealModal);
                console.log("‚úÖ closeSelectMealModal inicializov√°n");
            }

            // Navigace datumu
            if (prevMealDayBtn) {
                prevMealDayBtn.addEventListener('click', () => navigateMealDay(-1));
            }
            if (nextMealDayBtn) {
                nextMealDayBtn.addEventListener('click', () => navigateMealDay(1));
            }

            // Tlaƒç√≠tka v√Ωbƒõru j√≠dla
            const mealTypeButtons = document.querySelectorAll('.meal-type-btn');
            if (mealTypeButtons.length > 0) {
                mealTypeButtons.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const mealType = this.dataset.mealType;
                        closeSelectMealModal(); // ZAV≈ò√çT HNED
                        addFoodToMeal(mealType);
                    });
                });
                console.log(`‚úÖ ${mealTypeButtons.length} mealTypeButtons inicializov√°no`);
            }

            // Kliknut√≠ mimo modal
            if (selectMealModal) {
                selectMealModal.addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeSelectMealModal();
                    }
                });
            }

            console.log("üéØ Inicializace meal modal listeners dokonƒçena");
        }

        // FUNKCE PRO OTEV≈òEN√ç MODALU
        function openSelectMealModal() {
            // ‚úÖ POU≈ΩIJ GLOB√ÅLN√ç PROMƒöNNOU
            const foodItem = window.currentFoodItemForRecipe;
            console.log("üçΩÔ∏è Otev√≠r√°m v√Ωbƒõr j√≠dla pro:", foodItem?.foodName);

            if (!foodItem) {
                window.showCustomNotification("Nejd≈ô√≠ve vyberte potravinu", 'info');
                return;
            }

            // ‚úÖ NASTAV PROMƒöNNOU
            currentFoodItemForMeal = foodItem;

            // Nastav aktu√°ln√≠ datum
            selectedMealDate = new Date();
            updateMealDateDisplay();

            // Zav≈ôi detailn√≠ modal a otev≈ôi v√Ωbƒõr j√≠dla
            document.getElementById('detailsModal').style.display = 'none';
            document.getElementById('selectMealModal').style.display = 'flex';
        }

        // FUNKCE PRO ZAV≈òEN√ç MODALU
        function closeSelectMealModal() {
            document.getElementById('selectMealModal').style.display = 'none';
            currentFoodItemForMeal = null;
        }

        // AKTUALIZACE ZOBRAZEN√ç DATA
        function updateMealDateDisplay() {
            const dateDisplay = document.getElementById('selectedMealDate');
            if (dateDisplay) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateDisplay.textContent = selectedMealDate.toLocaleDateString('cs-CZ', options);
            }
        }

        // NAVIGACE MEZI DNY
        function navigateMealDay(direction) {
            selectedMealDate.setDate(selectedMealDate.getDate() + direction);
            updateMealDateDisplay();
        }

        // HLAVN√ç FUNKCE PRO P≈òID√ÅN√ç DO J√çDLA - UPRAVEN√Å
        async function addFoodToMeal(mealType) {
            console.log("üçΩÔ∏è addFoodToMeal vol√°na s:", {
                mealType,
                currentFoodItemForMeal,
                hasFoodItem: !!currentFoodItemForMeal,
                isRecipe: currentFoodItemForMeal?.isRecipe
            });

            // ‚úÖ POU≈ΩIJ GLOB√ÅLN√ç PROMƒöNNOU POKUD LOC√ÅLN√ç CHYB√ç
            const foodItem = currentFoodItemForMeal || window.currentFoodItemForRecipe;

            if (!foodItem) {
                console.error("‚ùå ≈Ω√°dn√° potravina k p≈ôid√°n√≠:", {
                    currentFoodItemForMeal,
                    windowCurrentFoodItem: window.currentFoodItemForRecipe
                });
                window.showCustomNotification("Chyba: ≈Ω√°dn√° potravina k p≈ôid√°n√≠", 'error');
                return;
            }

            try {
                console.log(`‚ûï P≈ôid√°v√°m "${foodItem.foodName}" do ${mealTypeLabels[mealType]}`, {
                    isRecipe: foodItem.isRecipe,
                    hasIngredients: foodItem.ingredients?.length
                });

                // POU≈ΩIJEME STEJNOU FUNKCI JAKO PRO P≈òID√ÅV√ÅN√ç Z HLAVN√ç OBRAZOVKY
                await addFoodItemToDailyMeal(foodItem, mealType, selectedMealDate);

                // Zav≈ôeme modaly
                closeSelectMealModal();

                window.showCustomNotification(
                    `"${foodItem.foodName}" p≈ôid√°no do ${mealTypeLabels[mealType]}!`,
                    'success'
                );

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ do j√≠dla:", error);
                window.showCustomNotification("Chyba: " + error.message, 'error');
            }
        }

        // POMOCN√Å FUNKCE PRO P≈òID√ÅN√ç POTRAVINY DO DENN√çHO J√çDLA - OPRAVEN√Å
        async function addFoodItemToDailyMeal(foodItem, mealType, date) {
            console.log("üì¶ addFoodItemToDailyMeal - kontext:", {
                foodName: foodItem.foodName,
                isRecipe: foodItem.isRecipe,
                portions: foodItem.portions,
                usedOnePortionData: foodItem.usedOnePortionData
            });

            const dateString = formatDateForAPI(date);

            try {
                let dailyIntakeId = await getOrCreateDailyIntake(dateString);
                let mealId = await getOrCreateMeal(dailyIntakeId, mealType);

                if (foodItem.isRecipe && foodItem.ingredients && foodItem.ingredients.length > 0) {
                    const portions = foodItem.portions || 1;
                    const usedOnePortionData = foodItem.usedOnePortionData || false;

                    console.log("ü•ò P≈ôid√°v√°m recept do j√≠dla:", {
                        name: foodItem.foodName,
                        portions: portions,
                        usedOnePortionData: usedOnePortionData,
                        hasOverriddenNutrition: !!foodItem.overriddenNutrition
                    });

                    for (const ingredient of foodItem.ingredients) {
                        let nutritionalData = ingredient.nutritionalDetails || {};
                        let calories = parseFloat(ingredient.calories || nutritionalData.total_kcal || 0);

                        // D≈ÆLE≈ΩIT√â: Pokud recept m√° v√≠ce porc√≠ a pou≈æ√≠v√°me data pro jednu porci
                        if (foodItem.overriddenNutrition && usedOnePortionData) {
                            console.log("üî¢ Pou≈æ√≠v√°m p≈ôepoƒçten√° data z overriddenNutrition");
                            nutritionalData = foodItem.overriddenNutrition;
                            calories = parseFloat(foodItem.overriddenNutrition.total_kcal || 0);
                        }

                        const mealItemData = {
                            daily_meal_id: mealId,
                            food_name: ingredient.foodName || foodItem.foodName,
                            amount: ingredient.amount || 100,
                            unit: ingredient.unit || 'g',
                            calories: calories,
                            protein: parseFloat(nutritionalData.protein || 0),
                            carbs: parseFloat(nutritionalData.carbs || 0),
                            fat: parseFloat(nutritionalData.fat || 0),
                            fiber: parseFloat(nutritionalData.fiber || 0),
                            nutritional_data: nutritionalData,
                            recipe_id: foodItem.recipeId,
                            recipe_name: foodItem.foodName,
                            is_portion: true,
                            portions: portions, // ULO≈ΩIT poƒçet porc√≠
                            used_one_portion_data: usedOnePortionData, // ULO≈ΩIT zda se pou≈æila data pro jednu porci
                            original_portion_data: foodItem.overriddenNutrition // ULO≈ΩIT p≈Øvodn√≠ data pro jednu porci
                        };

                        console.log("üíæ UKL√ÅD√ÅM DO DATAB√ÅZE - mealItemData:", {
                            recipe_id: mealItemData.recipe_id,
                            recipe_name: mealItemData.recipe_name,
                            portions: mealItemData.portions,
                            used_one_portion_data: mealItemData.used_one_portion_data,
                            calories: mealItemData.calories
                        });

                        const { error } = await window.supabaseClient
                            .from('meal_items')
                            .insert(mealItemData);

                        if (error) {
                            console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ ingredience receptu:", error);
                            throw error;
                        }
                    }
                    console.log("‚úÖ Recept √∫spƒõ≈°nƒõ ulo≈æen s p≈ôepoƒçten√Ωmi daty");
                } else {
                    // P≈Øvodn√≠ k√≥d pro jednotliv√© potraviny
                    console.log("üíæ Ukl√°d√°m jednotlivou potravinu...");
                    const nutritionalData = foodItem.nutritionalDetails || {};

                    // PARSOV√ÅN√ç S parseValueAndUnit aby se neztr√°cela desetinn√° m√≠sta
                    const { number: caloriesNum } = parseValueAndUnit(foodItem.kcal || nutritionalData.total_kcal);
                    const { number: proteinNum } = parseValueAndUnit(nutritionalData.protein);
                    const { number: carbsNum } = parseValueAndUnit(nutritionalData.carbs);
                    const { number: fatNum } = parseValueAndUnit(nutritionalData.fat);
                    const { number: fiberNum } = parseValueAndUnit(nutritionalData.fiber);

                    const mealItemData = {
                        daily_meal_id: mealId,
                        food_name: foodItem.foodName || 'Nezn√°m√° potravina',
                        amount: foodItem.amount || 100,
                        unit: foodItem.unit || 'g',
                        calories: caloriesNum || 0,
                        protein: proteinNum || 0,
                        carbs: carbsNum || 0,
                        fat: fatNum || 0,
                        fiber: fiberNum || 0,
                        nutritional_data: nutritionalData,
                        recipe_id: null, // Jednotliv√° potravina
                        recipe_name: null // Jednotliv√° potravina
                    };

                    console.log("üíæ Ukl√°d√°m potravinu:", mealItemData);

                    const { error } = await window.supabaseClient
                        .from('meal_items')
                        .insert(mealItemData);

                    if (error) {
                        console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ meal_items:", error);
                        throw error;
                    }
                    console.log("‚úÖ Potravina √∫spƒõ≈°nƒõ ulo≈æena");
                }

                // Aktualizace zobrazen√≠
                if (isSameDay(date, currentDailyIntakeDate)) {
                    console.log("üîÑ Aktualizuji zobrazen√≠ denn√≠ho p≈ô√≠jmu...");
                    await loadDailyIntakeData(currentDailyIntakeDate);
                }

            } catch (error) {
                console.error("‚ùå Chyba v addFoodItemToDailyMeal:", error);
                throw error;
            }
        }

        // POMOCN√Å FUNKCE PRO POROVN√ÅN√ç DAT
        function isSameDay(date1, date2) {
            return date1.toDateString() === date2.toDateString();
        }


        // Funkce pro ulo≈æen√≠ zmƒõny n√°zvu profilu
        async function saveProfileName() {
            const newName = document.getElementById('newProfileNameInput').value.trim();

            if (!newName) {
                window.showCustomNotification("Zadejte n√°zev profilu", 'info');
                return;
            }

            if (!window.currentProfileId) {
                window.showCustomNotification("Nen√≠ vybr√°n profil", 'error');
                return;
            }

            try {
                const { error } = await window.supabaseClient
                    .from('profiles')
                    .update({
                        name: newName,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', window.currentProfileId);

                if (error) throw error;

                // Aktualizuj lok√°ln√≠ data
                const profileIndex = window.userProfiles.findIndex(p => p.id === window.currentProfileId);
                if (profileIndex !== -1) {
                    window.userProfiles[profileIndex].name = newName;
                }

                // Aktualizuj zobrazen√≠
                updateProfileHeaderDisplay();

                // Zav≈ôi modal
                document.getElementById('profileNameModal').style.display = 'none';

                window.showCustomNotification(`N√°zev profilu byl zmƒõnƒõn na "${newName}"`, 'success');

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi zmƒõnƒõ n√°zvu profilu:", error);
                window.showCustomNotification("Chyba p≈ôi zmƒõnƒõ n√°zvu: " + error.message, 'error');
            }
        }

        // Funkce pro aktualizaci zobrazen√≠ v hlaviƒçce
        function updateProfileHeaderDisplay() {
            const profileNameHeader = document.getElementById('currentProfileNameHeader');
            const profileIconHeader = document.getElementById('profileIconHeader');
            const currentProfile = window.userProfiles.find(p => p.id === window.currentProfileId);

            if (profileNameHeader && currentProfile) {
                profileNameHeader.textContent = currentProfile.name;

                // P≈òIDAT T≈ò√çDU PRO ZV√ùRAZNƒöN√ç
                if (profileIconHeader) {
                    profileIconHeader.classList.add('has-profile');
                }
            } else if (profileIconHeader) {
                // ODSTRANIT T≈ò√çDU POKUD NEN√ç PROFIL
                profileIconHeader.classList.remove('has-profile');
            }
        }

        // Event listenery
        document.getElementById('profileIconHeader')?.addEventListener('click', showProfileNameModal);
        document.getElementById('closeProfileNameModal')?.addEventListener('click', () => {
            document.getElementById('profileNameModal').style.display = 'none';
        });
        document.getElementById('saveProfileNameBtn')?.addEventListener('click', saveProfileName);
        document.getElementById('cancelProfileNameBtn')?.addEventListener('click', () => {
            document.getElementById('profileNameModal').style.display = 'none';
        });

        // Zav≈ôen√≠ modalu kliknut√≠m mimo
        document.getElementById('profileNameModal')?.addEventListener('click', function (event) {
            if (event.target === this) {
                this.style.display = 'none';
            }
        });

        // Funkce pro vyhled√°v√°n√≠
        // =====================================================
        // GLOB√ÅLN√ç PROMƒöNN√Å PRO KONTROLU ZRU≈†EN√ç VYHLED√ÅV√ÅN√ç
        // =====================================================
        let searchAbortController = null;

        async function performSearch(query) {
            const loadingDiv = document.getElementById('searchModalLoading');
            const resultsDiv = document.getElementById('searchModalResults');
            const errorDiv = document.getElementById('searchModalError');

            resultsDiv.innerHTML = '';
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';

            // VYTVO≈ò√çME NOV√ù ABORT CONTROLLER PRO TENTO SEARCH
            if (searchAbortController) {
                searchAbortController.abort(); // Zru≈°√≠me p≈ôedchoz√≠ hled√°n√≠
            }
            searchAbortController = new AbortController();

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `query=${encodeURIComponent(query)}`,
                    signal: searchAbortController.signal // P≈òID√ÅME SIGNAL PRO MO≈ΩNOST ZRU≈†EN√ç
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';

                while (true) {
                    // KONTROLA ZRU≈†EN√ç VYHLED√ÅV√ÅN√ç
                    if (searchAbortController.signal.aborted) {
                        console.log("üõë Vyhled√°v√°n√≠ p≈ôeru≈°eno u≈æivatelem");
                        reader.cancel(); // Zastav√≠me ƒçten√≠ streamu
                        break;
                    }

                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        try {
                            const item = JSON.parse(line);
                            if (item.error) {
                                errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                                errorDiv.style.display = 'block';
                                loadingDiv.style.display = 'none';
                                return;
                            }
                            appendSearchResult(item);
                        } catch (e) {
                            console.error('Chyba p≈ôi parsov√°n√≠ JSON ≈ô√°dku:', e);
                        }
                    }
                }

                loadingDiv.style.display = 'none';
                if (resultsDiv.innerHTML === '') {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #888;">Nic nenalezeno.</p>';
                }

            } catch (error) {
                // KONTROLA, ZDA BYLA CHYBA ZP≈ÆSOBENA ZRU≈†EN√çM
                if (error.name === 'AbortError') {
                    console.log("üõë Fetch byl zru≈°en");
                    loadingDiv.style.display = 'none';
                    return;
                }
                
                console.error('Do≈°lo k chybƒõ:', error);
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Do≈°lo k chybƒõ p≈ôi komunikaci se serverem.';
                errorDiv.style.display = 'block';
            }
        }

        // Funkce pro p≈ôid√°n√≠ v√Ωsledku vyhled√°v√°n√≠
        // NOV√Å FUNKCE appendSearchResult(item)
        function appendSearchResult(item) {
            const resultsDiv = document.getElementById('searchModalResults');

            // Pou≈æijeme hlavn√≠ kontejner pro recept (svƒõtle modr√© pozad√≠, zaoblen√Ω roh)
            const recipeGroupDiv = document.createElement('div');
            recipeGroupDiv.classList.add('recipe-group');

            // Vypoƒç√≠t√°me form√°tovan√© hodnoty
            const { number: caloriesNum, unit: caloriesUnit } = parseValueAndUnit(item.calories);
            const formattedCalories = formatNumberForDisplay(caloriesNum, caloriesUnit, true);

            // HTML struktura kombinuj√≠c√≠ RECIPE_HEADER a IMAGE
            const headerHtml = `
                <div class="recipe-header search-header-custom" data-food-id="${item.id || ''}" data-slug="${item.slug || ''}">
            
                    <div class="image-wrapper">
                        <img src="${item.image_url || placeholderImage}" alt="${item.name}" onerror="this.onerror=null;this.src='${placeholderImage}'">
                    </div>
            
                    <div class="food-item-info">
                        <div class="recipe-name-wrapper">
                            <div class="recipe-name">${item.name}</div>
                        </div>
                
                        <div class="recipe-summary-item-search">
                            <span class="total-calories">${formattedCalories}</span>
                            
                        </div>
                    </div>
            
                    <div class="food-item-actions">
                        </div>
                </div>
            `;

            recipeGroupDiv.innerHTML = headerHtml;

            const headerDiv = recipeGroupDiv.querySelector('.recipe-header');

            // --- EVENT LISTENER: P≈Øvodn√≠ chov√°n√≠ (kliknut√≠ = zobrazen√≠ detailu) ---

            if (item.slug && headerDiv) {
                // Nav√°≈æeme kliknut√≠ na celou hlaviƒçku, ale budeme muset zajistit, ≈æe se nespust√≠ na akƒçn√≠ch prvc√≠ch (pokud by se p≈ôidaly)
                headerDiv.addEventListener('click', function (e) {
                    // Kontrola, zda nebylo kliknuto na akƒçn√≠ prvek (nap≈ô. budouc√≠ tlaƒç√≠tko P≈ôidat)
                    if (!e.target.closest('.add-food-item-btn')) { // Tlaƒç√≠tko P≈ôidat jsme prozat√≠m zru≈°ili, ale kontrola je dobr√° pro budouc√≠ pou≈æit√≠
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // ‚ö° KL√çƒåOV√Å ZMƒöNA: OKAM≈ΩITƒö P≈òERU≈†√çME VYHLED√ÅV√ÅN√ç
                        if (searchAbortController) {
                            searchAbortController.abort();
                            console.log("üõë Vyhled√°v√°n√≠ p≈ôeru≈°eno - u≈æivatel klikl na v√Ωsledek");
                        }
                        
                        closeSearchModal();
                        showDetailsModal(item.slug, item.name, item.image_url, item.calories, item.food_type);
                    }
                });
            }

            resultsDiv.appendChild(recipeGroupDiv);
        }

        // Nov√° funkce pro zobrazen√≠ denn√≠ho p≈ô√≠jmu jako hlavn√≠ho obsahu
        function showDailyIntakeAsMainContent() {
            console.log("üìä Zobrazuji denn√≠ p≈ô√≠jem jako hlavn√≠ obsah");

            const mainContent = document.getElementById('mainContent');
            if (!mainContent) {
                console.error("‚ùå Hlavn√≠ obsah nenalezen");
                return;
            }

            // Vlo≈æ√≠me HTML denn√≠ho p≈ô√≠jmu do hlavn√≠ho obsahu
            mainContent.innerHTML = document.getElementById('dailyIntakeSection').innerHTML;

            // Inicializujeme denn√≠ p≈ô√≠jem
            if (!currentDailyIntakeData) {
                initializeDailyIntake();
            } else {
                updateDailyIntakeDisplay();
            }
        }

        // Naƒçten√≠ dat z formul√°≈ôe
        function getFormData() {
            return {
                gender: document.getElementById('gender').value,
                age: parseInt(document.getElementById('age').value) || 0,
                height: parseInt(document.getElementById('height').value) || 0,
                weight: parseFloat(document.getElementById('weight').value) || 0,
                bodyFat: parseFloat(document.getElementById('bodyFat').value) || 0,
                targetWeight: parseFloat(document.getElementById('targetWeight').value) || 0,
                activityLevel: parseFloat(document.getElementById('activityLevel').value) || 0,
                goal: document.getElementById('goal').value,
                intensity: 'light' // V≈ΩDY POU≈Ω√çV√ÅME LEHKO√ö INTENZITU
            };
        }

        // Validace formul√°≈ôe
        function validateFormData(data) {
            const errors = [];

            if (!data.gender) errors.push('Vyberte pohlav√≠');
            if (!data.age || data.age < 15 || data.age > 100) errors.push('Vƒõk mus√≠ b√Ωt mezi 15 a 100 lety');
            if (!data.height || data.height < 100 || data.height > 250) errors.push('V√Ω≈°ka mus√≠ b√Ωt mezi 100 a 250 cm');
            if (!data.weight || data.weight < 30 || data.weight > 300) errors.push('Hmotnost mus√≠ b√Ωt mezi 30 a 300 kg');
            if (!data.bodyFat || data.bodyFat < 5 || data.bodyFat > 60) errors.push('Podko≈æn√≠ tuk mus√≠ b√Ωt mezi 5% a 60%');
            if (!data.targetWeight || data.targetWeight < 30 || data.targetWeight > 300) errors.push('C√≠lov√° hmotnost mus√≠ b√Ωt mezi 30 a 300 kg');
            if (!data.activityLevel) errors.push('Vyberte √∫rove≈à aktivity');
            if (!data.goal) errors.push('Vyberte c√≠l');
            // ODSTRA≈áTE validaci intenzity - ji≈æ nen√≠ pot≈ôeba
            // if (data.goal !== 'maintain' && !data.intensity) errors.push('Vyberte intenzitu');

            // Validace c√≠lov√© hmotnosti z≈Øst√°v√°
            if (data.goal === 'loss' && data.targetWeight >= data.weight) {
                errors.push('C√≠lov√° hmotnost mus√≠ b√Ωt ni≈æ≈°√≠ ne≈æ aktu√°ln√≠ pro redukci');
            }
            if (data.goal === 'gain' && data.targetWeight <= data.weight) {
                errors.push('C√≠lov√° hmotnost mus√≠ b√Ωt vy≈°≈°√≠ ne≈æ aktu√°ln√≠ pro nab√≠r√°n√≠');
            }

            if (errors.length > 0) {
                window.showCustomNotification('Opravte pros√≠m:<br>' + errors.join('<br>'), 'error');
                return false;
            }

            return true;
        }

        // Hlavn√≠ v√Ωpoƒçetn√≠ funkce - Katch-McArdle
        function performCalculations(data) {
            console.log("üî¢ Spou≈°t√≠m v√Ωpoƒçty s daty:", data);

            // 1. V√Ωpoƒçet Lean Body Mass
            const leanBodyMass = data.weight * (1 - data.bodyFat / 100);
            console.log("üí™ Lean Body Mass:", leanBodyMass);

            // 2. BMR - Katch-McArdle vzorec
            const bmr = 370 + (21.6 * leanBodyMass);
            console.log("üî• BMR:", bmr);

            // 3. TDEE - Total Daily Energy Expenditure
            const tdee = bmr * data.activityLevel;
            console.log("‚ö° TDEE:", tdee);

            // 4. C√≠lov√Ω kalorick√Ω p≈ô√≠jem
            const targetCalories = calculateTargetCalories(tdee, data.goal, data.intensity);

            // 5. Makro≈æiviny - OPRAVA: p≈ôid√°me data jako parametr
            const macros = calculateMacros(targetCalories, data.goal, data.weight, data);

            // 6. Rozd√≠l hmotnosti
            const weightDiff = data.targetWeight - data.weight;

            const results = {
                bmr: Math.round(bmr),
                tdee: Math.round(tdee),
                targetCalories: Math.round(targetCalories),
                weightDiff: Math.round(weightDiff * 10) / 10,
                macros: macros,
                leanBodyMass: Math.round(leanBodyMass * 10) / 10
            };

            console.log("üéØ Koneƒçn√© v√Ωsledky:", results);
            return results;
        }

        // V√Ωpoƒçet c√≠lov√©ho kalorick√©ho p≈ô√≠jmu
        function calculateTargetCalories(tdee, goal, intensity) {
            console.log("üßÆ V√Ωpoƒçet kalorick√©ho p≈ô√≠jmu:", { tdee, goal, intensity });

            const adjustments = {
                loss: {
                    light: -0.12,   // -12% z TDEE
                    moderate: -0.20, // -20% z TDEE
                    hard: -0.30     // -30% z TDEE
                },
                maintain: {
                    light: 0,
                    moderate: 0,
                    hard: 0
                },
                gain: {
                    light: 0.10,    // +10% z TDEE
                    moderate: 0.125, // +12.5% z TDEE
                    hard: 0.15      // +15% z TDEE
                }
            };

            const adjustmentPercentage = adjustments[goal][intensity] || 0;
            const adjustment = tdee * adjustmentPercentage;
            const targetCalories = tdee + adjustment;

            console.log("üìä V√Ωsledek v√Ωpoƒçtu:", {
                adjustmentPercentage: (adjustmentPercentage * 100) + '%',
                adjustment: Math.round(adjustment),
                targetCalories: Math.round(targetCalories)
            });

            return targetCalories;
        }

        // FUNKCE PRO V√ùPOƒåET DOPORUƒåEN√â VL√ÅKNINY
        function calculateFiber(age, gender) {
            // Doporuƒçen√© denn√≠ d√°vky vl√°kniny podle vƒõku a pohlav√≠
            if (gender === 'male') {
                if (age < 50) return 38;  // Mu≈æi do 50 let: 38g
                else return 30;           // Mu≈æi nad 50 let: 30g
            } else {
                if (age < 50) return 25;  // ≈Ωeny do 50 let: 25g  
                else return 21;           // ≈Ωeny nad 50 let: 21g
            }
        }

        // V√Ωpoƒçet makro≈æivin
        function calculateMacros(calories, goal, weight) {
            // B√çLKOVINY - podle tv√Ωch koeficient≈Ø
            let proteinPerKg;
            switch (goal) {
                case 'loss': proteinPerKg = 2.0; break;
                case 'maintain': proteinPerKg = 2.2; break;
                case 'gain': proteinPerKg = 2.5; break;
                default: proteinPerKg = 1.73;
            }
            const protein = Math.round(weight * proteinPerKg);
            const proteinCalories = protein * 4;

            // SACHARIDY - fixn√≠ pomƒõr (mus√≠me naj√≠t spr√°vn√Ω)
            // Zkus√≠me 40% z kalori√≠:
            const carbCalories = calories * 0.40;
            const carbs = Math.round(carbCalories / 4);

            // TUKY - zbytek kalori√≠
            const fatCalories = calories - proteinCalories - carbCalories;
            const fat = Math.round(fatCalories / 9);

            // VL√ÅKNINA
            const fiber = calculateFiber(age, gender);

            return {
                protein: protein,
                carbs: carbs,
                fat: fat,
                fiber: fiber
            };
        }

        //Zobrazen√≠ v√Ωsledk≈Ø
        function displayResults(results) {
            console.log("üîÑ Zobrazuji v√Ωsledky:", results);

            // Z√°kladn√≠ v√Ωsledky s jednotkami na stejn√©m ≈ô√°dku
            document.getElementById('bmrResult').textContent = `${results.bmr} kcal`;
            document.getElementById('tdeeResult').textContent = `${results.tdee} kcal`;
            document.getElementById('targetCaloriesResult').textContent = `${results.targetCalories} kcal`;

            // Rozd√≠l hmotnosti
            const weightDiffElement = document.getElementById('weightDiffResult');
            if (results.weightDiff > 0) {
                weightDiffElement.textContent = `+${results.weightDiff} kg`;
                weightDiffElement.style.color = '#28a745';
            } else if (results.weightDiff < 0) {
                weightDiffElement.textContent = `${results.weightDiff} kg`;
                weightDiffElement.style.color = '#dc3545';
            } else {
                weightDiffElement.textContent = `${results.weightDiff} kg`;
                weightDiffElement.style.color = '#6c757d';
            }

            // Makro≈æiviny s jednotkami
            document.getElementById('proteinResult').textContent = `${results.macros.protein} g`;
            document.getElementById('carbsResult').textContent = `${results.macros.carbs} g`;
            document.getElementById('fatsResult').textContent = `${results.macros.fat} g`;
            document.getElementById('fiberResult').textContent = `${results.macros.fiber} g`;
        }

        // Ukl√°d√°n√≠ a naƒç√≠t√°n√≠ dat
        async function savePersonalCardData() {
            if (!personalCardData) {
                window.showCustomNotification("Nejd≈ô√≠ve spoƒç√≠tejte data pomoc√≠ tlaƒç√≠tka 'Spoƒç√≠tat'", 'error');
                return;
            }

            try {
                // Ulo≈æen√≠ do Supabase vƒçetnƒõ vypoƒç√≠tan√Ωch hodnot
                await saveToSupabase(personalCardData);

                // ‚úÖ AKTUALIZUJEME C√çLE V DENN√çM P≈ò√çJMU
                console.log("üîÑ Aktualizuji c√≠le po ulo≈æen√≠ osobn√≠ karty");
                await loadDailyIntakeGoals();

            } catch (error) {
                console.error("Chyba p≈ôi ukl√°d√°n√≠:", error);
            }
        }

        async function saveToSupabase(data) {
            try {
                const { error } = await window.supabaseClient
                    .from('personal_cards')
                    .upsert({
                        user_id: window.currentUser.id,
                        profile_id: window.currentProfileId,
                        form_data: data.formData,       // P≈Øvodn√≠ data z formul√°≈ôe
                        calculations: data.calculations, // Vypoƒç√≠tan√© hodnoty
                        timestamp: data.timestamp,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,profile_id'
                    });

                if (error) throw error;

                window.showCustomNotification('Osobn√≠ data byla √∫spƒõ≈°nƒõ ulo≈æena!', 'success');
                console.log("üíæ Ulo≈æena kompletn√≠ data:", data);
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ osobn√≠ch dat:', error);
                window.showCustomNotification('Chyba p≈ôi ukl√°d√°n√≠ dat: ' + error.message, 'error');
            }
        }

        async function loadPersonalCardData() {
            if (!window.currentProfileId) {
                console.log("‚ùå Nelze naƒç√≠st data - nen√≠ vybr√°n profil");
                return;
            }

            const saveButton = document.getElementById('savePersonalCard');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Naƒç√≠t√°m...';
            saveButton.disabled = true;

            try {
                const loadedData = await loadFromSupabase();

                if (loadedData && loadedData.formData) {
                    console.log("‚úÖ Data naƒçtena z DB");

                    // Ulo≈æ√≠me p≈Øvodn√≠ data pro sledov√°n√≠ zmƒõn
                    personalCardOriginalData = { ...loadedData.formData };
                    personalCardHasChanges = false;

                    fillFormWithData(loadedData);
                    saveButton.textContent = 'Ulo≈æit data';

                    // Aktualizujeme stav tlaƒç√≠tka
                    updateSaveButtonState();
                } else {
                    console.log("‚ÑπÔ∏è ≈Ω√°dn√° data k naƒçten√≠");
                    personalCardOriginalData = null;
                    personalCardHasChanges = false;
                    saveButton.textContent = 'Ulo≈æit data';
                    saveButton.disabled = true;
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat:", error);
                saveButton.textContent = 'Ulo≈æit data';
                saveButton.disabled = true;
                personalCardOriginalData = null;
                personalCardHasChanges = false;
            }
        }

        // Funkce pro p≈ôid√°n√≠ event listener≈Ø pro sledov√°n√≠ zmƒõn
        function addPersonalCardChangeListeners() {
            const formElements = [
                'gender', 'age', 'height', 'weight', 'bodyFat',
                'targetWeight', 'activityLevel', 'goal'
            ];

            formElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener('change', function () {
                        checkPersonalCardChanges();
                    });
                    element.addEventListener('input', function () {
                        checkPersonalCardChanges();
                    });
                }
            });
        }

        async function loadFromSupabase() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('personal_cards')
                    .select('*')
                    .eq('profile_id', window.currentProfileId)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                if (data) {
                    console.log("üì• Naƒçtena kompletn√≠ data:", data);
                    // Vr√°t√≠me strukturovan√° data
                    return {
                        formData: data.form_data,
                        calculations: data.calculations,
                        timestamp: data.timestamp
                    };
                }
                return null;
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ osobn√≠ch dat:', error);
                return null;
            }
        }

        /**
         * P≈ôev√°d√≠ procentu√°ln√≠ hodnotu (0-100) na barvu ve spektru ƒåerven√°-Oran≈æov√°-≈Ωlut√°-Zelen√°.
         * Pou≈æ√≠v√° metodu mapov√°n√≠ HSV/HUE barvy na procenta.
         * @param {number} percentage - Procentu√°ln√≠ hodnota (0 a≈æ 100).
         * @returns {string} Barva ve form√°tu 'rgb(r, g, b)'.
         */
        function percentageToColor(percentage) {
            // Zajist√≠me, ≈æe procenta jsou v rozmez√≠ 0 a≈æ 100
            const p = Math.max(0, Math.min(100, percentage));

            // Mapov√°n√≠ na odst√≠n HUE (0 = ƒçerven√°, 120 = zelen√°)
            // Otoƒç√≠me to: 0% = 0 (ƒçerven√°), 100% = 120 (zelen√°)
            const hue = (p * 1.2);

            // Pou≈æijeme HSL: H = plynul√Ω p≈ôechod, S = 100%, L = 50%
            return `hsl(${hue}, 100%, 40%)`; // Pou≈æ√≠v√°me 40% svƒõtlosti pro lep≈°√≠ sytost
        }

        function fillFormWithData(loadedData) {
            if (!loadedData) return;

            const { formData, calculations } = loadedData;

            console.log("üîÑ Pln√≠m formul√°≈ô daty:", formData);

            // Napln√≠me formul√°≈ô
            if (formData.gender) document.getElementById('gender').value = formData.gender;
            if (formData.age) document.getElementById('age').value = formData.age;
            if (formData.height) document.getElementById('height').value = formData.height;
            if (formData.weight) document.getElementById('weight').value = formData.weight;
            if (formData.bodyFat) document.getElementById('bodyFat').value = formData.bodyFat;
            if (formData.targetWeight) document.getElementById('targetWeight').value = formData.targetWeight;
            if (formData.activityLevel) document.getElementById('activityLevel').value = formData.activityLevel;
            if (formData.goal) {
                document.getElementById('goal').value = formData.goal;
            }

            // P≈ôid√°me event listenery pro zmƒõny
            addPersonalCardChangeListeners();

            // Pokud m√°me vypoƒç√≠tan√© hodnoty, zobraz√≠me je
            if (calculations) {
                console.log("üìä Zobrazuji vypoƒç√≠tan√© hodnoty:", calculations);
                displayResults(calculations);

                personalCardData = loadedData;
                // Tlaƒç√≠tko bude povoleno pouze p≈ôi zmƒõn√°ch
                checkPersonalCardChanges();
            }

            console.log("‚úÖ Formul√°≈ô naplnƒõn daty");
        }

        function debugLog(message) {
            console.log(message);
        }

        function parseValueAndUnit(valueString) {
            if (valueString === null || valueString === undefined) {
                return { number: NaN, unit: '' };
            }
            if (typeof valueString !== 'string' && typeof valueString !== 'number') {
                return { number: NaN, unit: '' };
            }
            if (typeof valueString === 'number') {
                return { number: valueString, unit: '' };
            }

            const cleanedString = String(valueString).replace(/[\s\u00A0]/g, '').replace(',', '.');
            const match = cleanedString.match(/(\d+\.?\d*)\s*(.*)/);

            if (match) {
                const number = parseFloat(match[1]);
                const unit = match[2] || '';
                return { number, unit };
            }
            return { number: NaN, unit: '' };
        }

        function formatNumberForDisplay(number, unit = '', isEnergyValue = false) {
            if (typeof number !== 'number' || isNaN(number) || number === null || number === undefined) {
                return '-';
            }

            let formattedNumber;
            if (isEnergyValue) {
                formattedNumber = parseFloat(number.toFixed(1));
            } else {
                formattedNumber = parseFloat(number.toFixed(2));
            }

            return `${formattedNumber.toLocaleString('cs-CZ')}${unit ? ` ${unit}` : ''}`;
        }

        // INTELIGENTN√ç FORM√ÅTOV√ÅN√ç - zobraz√≠ des. m√≠sto pouze pokud nen√≠ 0
        function smartRound(number) {
            if (typeof number !== 'number' || isNaN(number) || number === null || number === undefined) {
                return '0';
            }
            const rounded = Math.round(number * 10) / 10; // Zaokrouhl√≠ na 1 des. m√≠sto
            if (rounded === Math.floor(rounded)) {
                return Math.floor(rounded).toString(); // Cel√© ƒç√≠slo bez .0
            }
            return rounded.toFixed(1).replace('.', ','); // S ƒç√°rkou pro ƒçeskou lokalizaci
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // =============================================
        // INICIALIZACE APLIKACE
        // =============================================
        window.initializeSupabase = async function () {
            console.log("üîÑ Inicializuji Supabase...");
            try {
                const bodyElement = document.body;
                const supabaseUrl = bodyElement.dataset.supabaseUrl;
                const supabaseKey = bodyElement.dataset.supabaseKey;

                console.log("üîë Supabase konfigurace:", {
                    hasUrl: !!supabaseUrl,
                    hasKey: !!supabaseKey,
                    url: supabaseUrl ? `${supabaseUrl.substring(0, 20)}...` : 'none',
                    key: supabaseKey ? `${supabaseKey.substring(0, 10)}...` : 'none'
                });

                if (!supabaseUrl || !supabaseKey) {
                    console.error("‚ùå Chyb√≠ Supabase konfigurace");
                    return false;
                }

                if (typeof supabase === 'undefined') {
                    console.error("‚ùå Supabase SDK nen√≠ naƒçteno");
                    return false;
                }

                const { createClient } = supabase;
                window.supabaseClient = createClient(supabaseUrl, supabaseKey, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                    }
                });

                console.log("‚úÖ Supabase klient vytvo≈ôen");
                return true;
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi inicializaci Supabase:", error);
                return false;
            }
        };

        async function initializeApplication() {
            console.log("üéØ initializeApplication vol√°na");

            try {
                const supabaseInitialized = await window.initializeSupabase();
                if (!supabaseInitialized) {
                    console.log("‚ö†Ô∏è Supabase inicializace selhala - pokraƒçuji v lok√°ln√≠m re≈æimu");
                }

                // D≈ÆLE≈ΩIT√â: Inicializujeme userSettings hned na zaƒç√°tku
                window.userSettings = getDefaultSettings();
                console.log("üéØ Inicializov√°no userSettings na zaƒç√°tku aplikace:", window.userSettings);

                const { data: { session } } = await window.supabaseClient.auth.getSession();

                if (session && session.user) {
                    console.log("‚úÖ Session nalezena, user:", session.user.id);
                    if (session.user.email) {
                        window.currentUser = session.user;
                        await continueWithUser(session.user);
                    } else {
                        window.currentUser = session.user;
                        showLoginModal();
                    }
                } else {
                    showLoginModal();
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi inicializaci:", error);
                showLoginModal();
            }
        }

        // =============================================
        // AUTENTIZACE A SPR√ÅVA U≈ΩIVATEL≈Æ
        // =============================================
        function showLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                // Nejprve skryjeme v≈°echna ostatn√≠ mod√°ln√≠ okna
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.style.display = 'none';
                });

                // Pak zobraz√≠me p≈ôihla≈°ovac√≠ okno
                loginModal.style.display = 'flex';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('loginSuccess').style.display = 'none';

                // ‚úÖ P≈òID√ÅNO: Aktualizace zobrazen√≠ k≈ô√≠≈æku
                updateLoginModalCloseAbility();
            }
        }

        function hideLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        }

        async function loginUser(email, password) {
            try {
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                if (data.user) {
                    window.currentUser = data.user;
                    hideLoginModal();

                    // POZOR: Pou≈æijte setTimeout aby se notifikace nezobrazovala bƒõhem p≈ôechodu
                    setTimeout(() => {
                        try {
                            window.showCustomNotification(`V√≠tejte zpƒõt, ${email}!`, 'success');
                        } catch (notificationError) {
                            console.log("‚úÖ P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©, notifikace selhala:", notificationError);
                        }
                    }, 1000);

                    await continueWithUser(data.user);
                    return data.user;
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi p≈ôihl√°≈°en√≠:", error);
                const errorDiv = document.getElementById('loginError');
                if (errorDiv) {
                    errorDiv.textContent = `Chyba p≈ôi p≈ôihl√°≈°en√≠: ${error.message}`;
                    errorDiv.style.display = 'block';
                }
                throw error;
            }
        }

        async function registerUser(email, password) {
            try {
                const emailTrimmed = email.trim().toLowerCase();

                if (!isValidEmail(emailTrimmed)) {
                    throw new Error("Neplatn√Ω form√°t emailov√© adresy");
                }

                if (password.length < 6) {
                    throw new Error("Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø");
                }

                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: emailTrimmed,
                    password,
                    options: {
                        emailRedirectTo: window.location.origin + '/auth/callback'
                    }
                });

                if (error) {
                    // Specifick√° chyba pro neplatn√©/testovac√≠ emaily
                    if (error.message.includes('invalid') || error.message.includes('Invalid')) {
                        throw new Error("Emailov√° adresa nebyla p≈ôijata. Pou≈æijte pros√≠m platn√Ω existuj√≠c√≠ email (nap≈ô. v√°≈° skuteƒçn√Ω email).");
                    } else if (error.message.includes('already') || error.message.includes('exists')) {
                        throw new Error("√öƒçet s t√≠mto emailem ji≈æ existuje. P≈ôihlaste se nebo pou≈æijte jin√Ω email.");
                    } else {
                        throw error;
                    }
                }

                if (data.user) {
                    let message = "Registrace √∫spƒõ≈°n√°! ";
                    if (data.user.identities && data.user.identities.length === 0) {
                        message += "√öƒçet ji≈æ existuje. P≈ôihlaste se.";
                    } else if (!data.user.email_confirmed_at) {
                        message += "Pros√≠m zkontrolujte email a potvrƒète registraci (zkontrolujte i spam slo≈æku).";
                    } else {
                        message += "Nyn√≠ si vytvo≈ôte prvn√≠ profil.";
                        window.currentUser = data.user;
                        hideLoginModal();
                        window.showCustomNotification("V√≠tejte! Vytvo≈ôte si prvn√≠ profil.", 'success');
                        await continueWithUser(data.user);
                    }

                    document.getElementById('loginSuccess').textContent = message;
                    document.getElementById('loginSuccess').style.display = 'block';
                    return data.user;
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi registraci:", error);
                throw error;
            }
        }

        // P≈òID√ÅNO: Pomocn√° funkce pro validaci emailu
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        async function logoutUser() {
            try {
                const { error } = await window.supabaseClient.auth.signOut();
                if (error) {
                    console.error("‚ùå Chyba p≈ôi odhla≈°ov√°n√≠:", error);
                } else {
                    window.currentUser = null;
                    window.userProfiles = [];
                    window.currentProfileId = null;
                    // ‚úÖ RESETUJEME DENN√ç P≈ò√çJEM
                    resetDailyIntakeData();
                    localStorage.clear();
                    location.reload();
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi odhla≈°ov√°n√≠:", error);
            }
        }

        // P≈ôidejte funkci pro reset denn√≠ho p≈ô√≠jmu
        function resetDailyIntakeData() {
            console.log("üîÑ Resetuji data denn√≠ho p≈ô√≠jmu");
            currentDailyIntakeDate = new Date();
            dailyIntakeGoals = null;
            currentDailyIntakeData = null;
            window.currentMealContext = null;
        }

        // P≈ôid√°me inicializaci denn√≠ho p≈ô√≠jmu do hlavn√≠ inicializace aplikace
        async function continueWithUser(user) {
            window.currentUser = user;
            updateLoginButton();

            window.userSettings = getDefaultSettings();
            console.log("üéØ Inicializov√°no userSettings p≈ôi spu≈°tƒõn√≠:", window.userSettings);

            await window.loadUserProfiles();

            resetDailyIntakeData();

            if (window.userProfiles.length === 0) {
                window.showCreateProfileModal();
            } else if (window.userProfiles.length === 1) {
                const singleProfile = window.userProfiles[0];
                await window.selectProfile(singleProfile.id);

                // ZOBRAZ√çME DENN√ç P≈ò√çJEM JAKO HLAVN√ç OBSAH
                showDailyIntakeAsMainContent();
            } else {
                setTimeout(() => {
                    window.showProfileModal();
                }, 500);
            }

            // ‚úÖ P≈òID√ÅNO: Aktualizace mo≈ænosti zav≈ô√≠t p≈ôihla≈°ovac√≠ okno
            updateLoginModalCloseAbility();

            window.isAppInitialized = true;
            const recipesButton = document.getElementById('recipesButton');
            if (recipesButton) {
                recipesButton.disabled = false;
            }

            setTimeout(() => {
                fixRecipesWithNullIngredients();
            }, 2000);
        }

        window.selectProfile = async function (profileId) {
            try {
                const oldProfileId = window.currentProfileId;
                window.currentProfileId = profileId;

                await loadUserSettings();
                await window.loadAndDisplayCurrentProfile();

                updateProfileHeaderDisplay();

                // ‚úÖ RESETUJEME DENN√ç P≈ò√çJEM P≈òI ZMƒöNƒö PROFILU
                resetDailyIntakeData();

                // INICIALIZUJEME DENN√ç P≈ò√çJEM S NOV√ùMI DATY
                initializeDailyIntake();

                // ‚úÖ P≈òID√ÅNO: Aktualizace mo≈ænosti zav≈ô√≠t p≈ôihla≈°ovac√≠ okno
                updateLoginModalCloseAbility();

                if (oldProfileId && oldProfileId !== profileId) {
                    const newProfile = window.userProfiles.find(p => p.id === profileId);
                    if (newProfile) {
                        window.showCustomNotification(
                            `Profil byl zmƒõnƒõn na "<strong>${newProfile.name}</strong>"`,
                            'profileSwitch'
                        );
                    }
                }

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi v√Ωbƒõru profilu:", error);
            }
        };

        function updateLoginButton() {
            const loginBtn = document.getElementById('loginMenuBtn');

            if (!loginBtn) {
                console.log("‚ÑπÔ∏è loginMenuBtn neexistuje - pravdƒõpodobnƒõ byl odstranƒõn z HTML");
                return;
            }

            if (window.currentUser && window.currentUser.email) {
                loginBtn.style.display = 'none';
                loginBtn.textContent = `P≈ôihl√°≈°en: ${window.currentUser.email}`;
            } else {
                loginBtn.style.display = 'block';
                loginBtn.textContent = 'P≈ôihl√°sit se';
            }
        }

        // =============================================
        // SPR√ÅVA PROFIL≈Æ
        // =============================================
        window.loadUserProfiles = async function () {
            if (window.isLoadingProfiles) return;
            window.isLoadingProfiles = true;

            try {
                if (!window.currentUser) {
                    window.userProfiles = [];
                    return;
                }

                // ODEB√çR√ÅME podm√≠nku !window.currentUser.is_local - byla v≈ædy true
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('user_id', window.currentUser.id)
                        .order('created_at', { ascending: true });

                    if (error) throw error;
                    window.userProfiles = data || [];
                } else {
                    window.userProfiles = [];
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profil≈Ø:", error);
                window.userProfiles = [];
            } finally {
                window.isLoadingProfiles = false;
            }
        };

        window.showProfileModal = async function () {
            if (window.isProfileModalShowing) {
                console.log("‚ÑπÔ∏è Profil modal ji≈æ je otev≈ôen - refreshuji data");
                // Refreshneme data i kdy≈æ je modal ji≈æ otev≈ôen√Ω
                await refreshProfileModalContent();
                return;
            }

            const profileModal = document.getElementById('profileModal');
            if (!profileModal) return;

            window.isProfileModalShowing = true;
            profileModal.style.display = 'flex';
            profileModal.style.zIndex = '1000';
            console.log("‚úÖ Profil modal otev≈ôen");

            await refreshProfileModalContent();
        };

        // D≈ÆLE≈ΩIT√â: P≈ôidejte pomocnou funkci pro refresh obsahu modalu
        async function refreshProfileModalContent() {
            try {
                await window.loadUserProfiles();
                const profileList = document.getElementById('profileList');
                if (profileList) {
                    profileList.innerHTML = '';

                    if (!window.userProfiles || window.userProfiles.length === 0) {
                        profileList.innerHTML = `
                    <div class="no-profiles">
                        <div class="no-profiles-icon">üë§</div>
                        <div class="no-profiles-title">≈Ω√°dn√© profily</div>
                        <div class="no-profiles-text">Vytvo≈ôte si prvn√≠ profil pro ukl√°d√°n√≠ recept≈Ø a nastaven√≠</div>
                        <button id="createFirstProfileBtn" class="create-first-profile-btn">
                            Vytvo≈ôit prvn√≠ profil
                        </button>
                    </div>
                `;

                        document.getElementById('createFirstProfileBtn').addEventListener('click', function () {
                            closeProfileModal();
                            window.showCreateProfileModal();
                        });
                    } else {
                        const userInfo = document.createElement('div');
                        userInfo.className = 'user-info-header';
                        userInfo.innerHTML = `
                    <div class="user-email">${window.currentUser?.email || 'Anonymn√≠ u≈æivatel'}</div>
                    <div class="profile-count">Dostupn√© profily: ${window.userProfiles.length}</div>
                    <div class="profile-instruction">Kliknƒõte na profil pro v√Ωbƒõr</div>
                `;
                        profileList.appendChild(userInfo);

                        window.userProfiles.forEach(profile => {
                            const profileItem = document.createElement('div');
                            profileItem.classList.add('profile-item');
                            if (profile.id === window.currentProfileId) {
                                profileItem.classList.add('active');
                            }

                            profileItem.innerHTML = `
                        <div class="profile-name-container">
                            <span class="profile-name">${profile.name}</span>
                            ${profile.id === window.currentProfileId ? '<span class="current-profile-badge">Aktivn√≠</span>' : ''}
                        </div>
                        <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat" class="profile-delete" data-profile-id="${profile.id}">
                    `;

                            profileItem.addEventListener('click', (e) => {
                                if (!e.target.classList.contains('profile-delete')) {
                                    console.log("üë§ Vybr√°n profil:", profile.name);
                                    closeProfileModal();
                                    window.selectProfile(profile.id);
                                }
                            });

                            const deleteBtn = profileItem.querySelector('.profile-delete');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    const profileId = e.target.dataset.profileId;
                                    const profile = window.userProfiles.find(p => p.id === profileId);
                                    if (profileId && profile) {
                                        await window.deleteProfile(profileId);
                                    }
                                });
                            }

                            profileList.appendChild(profileItem);
                        });
                    }
                }
            } catch (error) {
                console.error("‚ùå Error refreshing profile modal:", error);
            }
        }

        function closeProfileModal() {
            const profileModal = document.getElementById('profileModal');
            if (profileModal) {
                profileModal.style.display = 'none';
            }
            window.isProfileModalShowing = false;
            console.log("üî¥ Profil modal zav≈ôen");
        }

        window.showCreateProfileModal = function () {
            const createProfileModal = document.getElementById('createProfileModal');
            const newProfileNameInput = document.getElementById('newProfileName');

            if (createProfileModal) {
                window.isProfileModalShowing = true;

                createProfileModal.style.display = 'flex';
                if (newProfileNameInput) {
                    newProfileNameInput.value = '';
                    setTimeout(() => newProfileNameInput.focus(), 100);
                }
            }
        };

        async function createNewProfile(profileName) {
            if (window.isCreatingProfile) return null;
            window.isCreatingProfile = true;

            try {
                // EMERGENCY FIX: Zajist√≠me, ≈æe userSettings existuje
                if (!window.userSettings) {
                    window.userSettings = getDefaultSettings();
                    console.log("üö® EMERGENCY - userSettings bylo null, inicializov√°no:", window.userSettings);
                }

                const trimmedName = profileName.trim();
                if (!trimmedName) {
                    window.showCustomNotification("Pros√≠m, zadejte n√°zev profilu.", 'error');
                    return null;
                }

                let newProfileId = null;

                if (window.supabaseClient && window.currentUser) {
                    const profileData = {
                        name: trimmedName,
                        user_id: window.currentUser.id,
                        created_at: new Date().toISOString(),
                        settings: getDefaultSettings() // D≈ÆLE≈ΩIT√â: P≈ôid√°me nastaven√≠ p≈ô√≠mo p≈ôi vytvo≈ôen√≠
                    };

                    console.log("üìù Vytv√°≈ô√≠m profil s nastaven√≠m:", profileData.settings);

                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .insert(profileData)
                        .select()
                        .single();

                    if (error) throw error;

                    newProfileId = data.id;

                    // Naƒçteme znovu profily z datab√°ze
                    await window.loadUserProfiles();

                    // P≈ôid√°me nov√Ω profil do lok√°ln√≠ho seznamu
                    if (!window.userProfiles) window.userProfiles = [];
                    window.userProfiles = window.userProfiles.filter(p => p.id !== data.id);
                    window.userProfiles.push(data);

                    console.log("‚úÖ Profil vytvo≈ôen, nastaven√≠:", data.settings);
                } else {
                    throw new Error("Pro vytvo≈ôen√≠ profilu se mus√≠te p≈ôihl√°sit");
                }

                // Zav≈ôeme createProfile modal
                document.getElementById('createProfileModal').style.display = 'none';

                // Vybereme nov√Ω profil
                await window.selectProfile(newProfileId);

                // Zav≈ôeme i profil modal pokud je otev≈ôen√Ω
                closeProfileModal();

                // Zobraz√≠me notifikaci (pokud je povolen√°)
                window.showCustomNotification(`Profil "<strong>${trimmedName}</strong>" byl √∫spƒõ≈°nƒõ vytvo≈ôen!`, 'profileCreation');
                return newProfileId;

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi vytv√°≈ôen√≠ profilu:", error);
                window.showCustomNotification("Chyba p≈ôi vytv√°≈ôen√≠ profilu: " + error.message, 'error');
                return null;
            } finally {
                window.isCreatingProfile = false;
            }
        }

        window.selectProfile = async function (profileId) {
            try {
                const profileExists = window.userProfiles && window.userProfiles.some(p => p.id === profileId);
                if (!profileExists) {
                    await window.loadUserProfiles();
                }

                const oldProfileId = window.currentProfileId;
                window.currentProfileId = profileId;

                await loadUserSettings();
                await window.loadAndDisplayCurrentProfile();

                // OZN√ÅMEN√ç P≈òI RUƒåN√ç ZMƒöNƒö PROFILU (voliteln√©)
                if (oldProfileId && oldProfileId !== profileId) {
                    const newProfile = window.userProfiles.find(p => p.id === profileId);
                    if (newProfile) {
                        window.showCustomNotification(
                            `Profil byl zmƒõnƒõn na "<strong>${newProfile.name}</strong>"`,
                            'profileSwitch'
                        );
                    }
                }

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi v√Ωbƒõru profilu:", error);
            }
        };

        // P≈òIDEJTE POMOCNOU FUNKCI PRO REFRESH MODALU
        async function refreshProfileModal() {
            const profileModal = document.getElementById('profileModal');
            if (profileModal && profileModal.style.display === 'flex') {
                // Zav≈ôeme a znovu otev≈ôeme modal pro refresh dat
                profileModal.style.display = 'none';
                window.isProfileModalShowing = false;

                // Po kr√°tk√© chv√≠li znovu otev≈ôeme s aktu√°ln√≠mi daty
                setTimeout(async () => {
                    await window.showProfileModal();
                }, 100);
            } else {
                // Pokud modal nen√≠ otev≈ôen√Ω, otev≈ôeme ho
                await window.showProfileModal();
            }
        }

        async function refreshProfileDisplayAfterDelete(deletedProfileId) {
            await window.loadUserProfiles();

            let result = {};

            if (window.currentProfileId === deletedProfileId) {
                if (window.userProfiles.length > 0) {
                    const newProfile = window.userProfiles[0];
                    window.currentProfileId = newProfile.id;
                    await loadUserSettings();
                    await window.loadAndDisplayCurrentProfile();
                    result.newProfile = newProfile;
                } else {
                    window.currentProfileId = null;
                    window.hideCurrentProfileDisplay();
                    result.noProfiles = true;
                }
            }

            return result;
        }

        // =============================================
        // ZOBRAZEN√ç PROFILU A NASTAVEN√ç
        // =============================================
        window.loadAndDisplayCurrentProfile = async function () {
            if (!window.currentProfileId) {
                window.hideCurrentProfileDisplay();
                return;
            }

            try {
                // D≈ÆLE≈ΩIT√â: Naƒçteme aktu√°ln√≠ seznam profil≈Ø
                await window.loadUserProfiles();

                const profile = window.userProfiles.find(p => p.id === window.currentProfileId);
                if (profile) {
                    window.updateCurrentProfileDisplay(profile.name);
                    await loadUserSettings();
                } else {
                    console.error("‚ùå Aktu√°ln√≠ profil nenalezen v seznamu:", window.currentProfileId);
                    window.hideCurrentProfileDisplay();
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profilu:", error);
                window.hideCurrentProfileDisplay();
            }
        };

        window.updateCurrentProfileDisplay = function (profileName) {
            // Star√© zobrazen√≠ (m≈Ø≈æe z≈Østat skryt√©)
            const oldProfileDisplay = document.getElementById('currentProfileDisplay');
            const oldProfileNameSpan = document.getElementById('currentProfileName');

            if (oldProfileDisplay && oldProfileNameSpan) {
                oldProfileNameSpan.textContent = profileName;
                oldProfileDisplay.style.display = 'none';
            }

            // Nov√© zobrazen√≠ v hlaviƒçce
            const profileNameHeader = document.getElementById('currentProfileNameHeader');
            if (profileNameHeader) {
                profileNameHeader.textContent = profileName;
            }

        };

        window.hideCurrentProfileDisplay = function () {
            const profileDisplay = document.getElementById('currentProfileDisplay');
            if (profileDisplay) {
                profileDisplay.style.display = 'none';
            }
        };

        // =============================================
        // NASTAVEN√ç U≈ΩIVATELE
        // =============================================
        async function loadUserSettings() {
            if (!window.currentUser || !window.currentProfileId) return;

            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .select('settings')
                        .eq('id', window.currentProfileId)
                        .single();

                    if (!error && data && data.settings) {
                        console.log("‚öôÔ∏è Naƒçtena nastaven√≠ z DB:", data.settings);
                        userSettings = data.settings;
                    } else {
                        console.log("‚öôÔ∏è Pou≈æ√≠v√°m defaultn√≠ nastaven√≠");
                        userSettings = getDefaultSettings();
                    }
                } else {
                    console.log("‚öôÔ∏è Pou≈æ√≠v√°m defaultn√≠ nastaven√≠ (bez Supabase)");
                    userSettings = getDefaultSettings();
                }
                updateSettingsUI();
            } catch (error) {
                console.error("Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠:", error);
                userSettings = getDefaultSettings();
                updateSettingsUI();
            }
        }

        function getDefaultSettings() {
            return {
                confirmRecipeCreation: true,
                confirmProfileCreation: true,


                confirmFoodAddition: true,
                confirmDeleteRecipe: true,

                confirmDeleteRecipeItem: true,
                confirmSaveChanges: true,
                confirmRecipeSaveSuccess: true,
                confirmRecipeDeletionSuccess: true,
                confirmRecipeDeletionError: true
            };
        }

        async function saveUserSettings() {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId || window.currentUser.is_local) {
                return;
            }

            try {
                const { error } = await window.supabaseClient
                    .from('profiles')
                    .update({
                        settings: userSettings,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', window.currentProfileId);

                if (error) {
                    console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠:", error);
                }
            } catch (error) {
                console.error("Error saving user settings:", error);
            }
        }

        function updateSettingsUI() {
            const toggleIds = [
                'confirmRecipeCreationToggle',



                'confirmFoodAdditionToggle',
                'confirmDeleteRecipeToggle',

                'confirmDeleteRecipeItemToggle',
                'confirmSaveChangesToggle',
                'confirmRecipeSaveSuccessToggle',
                'confirmRecipeDeletionSuccessToggle',
                'confirmRecipeDeletionErrorToggle'
            ];

            toggleIds.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    const settingKey = toggleId.replace('Toggle', '');
                    toggle.checked = userSettings[settingKey];
                }
            });
        }

        async function initializeSettingsForNewProfile(profileId) {
            const defaultSettings = getDefaultSettings();

            if (window.supabaseClient && window.currentUser) {
                try {
                    const { error } = await window.supabaseClient
                        .from('profiles')
                        .update({
                            settings: defaultSettings, // ULO≈Ω√çME DEFAULTN√ç NASTAVEN√ç
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', profileId);

                    if (error) {
                        console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠ pro nov√Ω profil:", error);
                    } else {
                        console.log("‚úÖ Nastaven√≠ pro nov√Ω profil ulo≈æeno:", defaultSettings);
                    }
                } catch (error) {
                    console.error("‚ùå Chyba p≈ôi inicializaci nastaven√≠:", error);
                }
            }

            // D≈ÆLE≈ΩIT√â: Nastav√≠me lok√°ln√≠ kopii nastaven√≠
            userSettings = defaultSettings;
            return true;
        }

        // Pomocn√° funkce pro bezpeƒçn√© nastaven√≠ HTML
        function setSafeHTML(element, html) {
            if (!element) return;

            // Jednoduch√° sanitizace - povol√≠me pouze bezpeƒçn√© tagy
            const safeHTML = html
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Odstranit scripty
                .replace(/on\w+="[^"]*"/g, '') // Odstranit event handlery
                .replace(/javascript:/gi, '') // Odstranit javascript: URL
                .replace(/<strong>(.*?)<\/strong>/g, '<strong>$1</strong>') // Povolit strong
                .replace(/<em>(.*?)<\/em>/g, '<em>$1</em>') // Povolit em
                .replace(/<b>(.*?)<\/b>/g, '<b>$1</b>') // Povolit b
                .replace(/<i>(.*?)<\/i>/g, '<i>$1</i>'); // Povolit i

            element.innerHTML = safeHTML;
        }

        // =============================================
        // NOTIFIKACE
        // =============================================
        window.showCustomNotification = function (message, notificationType, confirmCallback = null, showConfirmButtons = false) {
            try {
                const customNotificationModal = document.getElementById('customNotificationModal');
                const customNotificationMessage = document.getElementById('customNotificationMessage');

                if (!customNotificationModal || !customNotificationMessage) {
                    console.error("‚ùå Notification modal elements not found");
                    if (confirmCallback) confirmCallback();
                    return;
                }

                const settingMap = {
                    'recipeCreation': 'confirmRecipeCreation',
                    'foodAddition': 'confirmFoodAddition',


                    'confirmDeleteRecipe': 'confirmDeleteRecipe',

                    'confirmDeleteRecipeItem': 'confirmDeleteRecipeItem',
                    'confirmSaveChanges': 'confirmSaveChanges',
                    'recipeSaveSuccess': 'confirmRecipeSaveSuccess',
                    'recipeDeletionSuccess': 'confirmRecipeDeletionSuccess',
                    'recipeDeletionError': 'confirmRecipeDeletionError',
                    'profileCreation': 'confirmProfileCreation' // NOV√Å POLO≈ΩKA
                };

                const currentSettingKey = settingMap[notificationType];
                const showToggleInNotification = !!currentSettingKey;

                // D≈ÆLE≈ΩIT√Å OPRAVA: Pro v≈°echny typy notifikac√≠ - pokud je nastaven√≠ vypnuto a nejde o confirm tlaƒç√≠tka
                if (currentSettingKey && !userSettings[currentSettingKey] && !showConfirmButtons) {
                    console.log("üîï Notifikace vypnuta v nastaven√≠, p≈ôeskoƒçeno:", notificationType);
                    if (confirmCallback) confirmCallback();
                    return;
                }

                // D≈ÆLE≈ΩIT√Å OPRAVA: Pro confirm dialogy s tlaƒç√≠tky - pokud je nastaven√≠ vypnuto, rovnou potvrd√≠me
                if (currentSettingKey && !userSettings[currentSettingKey] && showConfirmButtons) {
                    console.log("üîï Confirm dialog vypnut v nastaven√≠, automatick√© potvrzen√≠:", notificationType);
                    if (confirmCallback) confirmCallback();
                    return;
                }

                const dynamicNotificationToggleContainer = document.getElementById('dynamicNotificationToggleContainer');
                const notificationControls = customNotificationModal.querySelector('.notification-controls');

                // Nastaven√≠ zpr√°vy
                if (customNotificationMessage) {
                    customNotificationMessage.innerHTML = message;
                }

                customNotificationModal.style.display = 'flex';

                // Vyƒçi≈°tƒõn√≠ container≈Ø
                if (dynamicNotificationToggleContainer) {
                    dynamicNotificationToggleContainer.innerHTML = '';
                }

                if (notificationControls) {
                    notificationControls.innerHTML = '';

                    // Vytvo≈ôen√≠ kontainer≈Ø pro layout
                    const toggleContainer = document.createElement('div');
                    toggleContainer.className = 'notification-toggle-container';

                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'notification-buttons-container';

                    // P≈ôep√≠naƒç "Zobrazovat tento dialog" - VLEVO
                    if (showToggleInNotification && currentSettingKey) {
                        const toggleLabelWrapper = document.createElement('label');
                        toggleLabelWrapper.classList.add('toggle-switch', 'notification-toggle-switch');

                        const toggleInput = document.createElement('input');
                        toggleInput.type = 'checkbox';
                        toggleInput.checked = userSettings[currentSettingKey]; // Zapnuto podle nastaven√≠
                        toggleInput.id = `dynamicToggle-${notificationType}`;

                        const sliderSpan = document.createElement('span');
                        sliderSpan.classList.add('slider');

                        toggleLabelWrapper.appendChild(toggleInput);
                        toggleLabelWrapper.appendChild(sliderSpan);

                        const labelElement = document.createElement('span');
                        labelElement.classList.add('toggle-label');
                        labelElement.textContent = 'Zobrazovat tento dialog';

                        toggleContainer.appendChild(toggleLabelWrapper);
                        toggleContainer.appendChild(labelElement);

                        toggleInput.addEventListener('change', () => {
                            userSettings[currentSettingKey] = toggleInput.checked;
                            saveUserSettings();
                            const settingsToggle = document.getElementById(`${currentSettingKey}Toggle`);
                            if (settingsToggle) {
                                settingsToggle.checked = toggleInput.checked;
                            }
                        });
                    }

                    // Tlaƒç√≠tka - VPRAVO
                    if (showConfirmButtons) {
                        const noButton = document.createElement('button');
                        noButton.textContent = 'Ne';
                        noButton.classList.add('notification-button', 'no-button');
                        noButton.onclick = () => {
                            customNotificationModal.style.display = 'none';
                        };

                        const yesButton = document.createElement('button');
                        yesButton.textContent = 'Ano';
                        yesButton.classList.add('notification-button', 'yes-button');
                        yesButton.onclick = () => {
                            customNotificationModal.style.display = 'none';
                            if (confirmCallback) confirmCallback();
                        };

                        buttonsContainer.appendChild(noButton);
                        buttonsContainer.appendChild(yesButton);
                    } else {
                        const okButton = document.createElement('button');
                        okButton.textContent = 'OK';
                        okButton.classList.add('notification-button', 'ok-button');
                        okButton.onclick = () => {
                            customNotificationModal.style.display = 'none';
                        };
                        buttonsContainer.appendChild(okButton);
                    }

                    // P≈ôid√°n√≠ container≈Ø do controls
                    notificationControls.appendChild(toggleContainer);
                    notificationControls.appendChild(buttonsContainer);
                }

            } catch (error) {
                console.error("‚ùå Chyba v showCustomNotification:", error);
                if (confirmCallback) confirmCallback();
            }
        };

        // =============================================
        // VYHLED√ÅV√ÅN√ç A ZOBRAZEN√ç V√ùSLEDK≈Æ
        // =============================================
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', async function (event) {
                event.preventDefault();

                // Skryjeme denn√≠ p≈ô√≠jem pokud je zobrazen
                const dailySection = document.getElementById('dailyIntakeSection');
                if (dailySection) {
                    dailySection.style.display = 'none';
                }

                // Zobraz√≠me v√Ωsledky
                const resultsDiv = document.getElementById('results');
                if (resultsDiv) {
                    resultsDiv.style.display = 'block';
                }

                // Skryjeme denn√≠ p≈ô√≠jem pokud je zobrazen
                document.getElementById('dailyIntakeSection').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                const query = document.getElementById('query').value;
                // const resultsDiv = document.getElementById('results');
                const loadingDiv = document.getElementById('loading');
                const errorDiv = document.getElementById('error-message');

                resultsDiv.innerHTML = '';
                errorDiv.innerHTML = '';
                loadingDiv.style.display = 'block';
                isSearchInterrupted = false;

                if (currentSearchController) {
                    currentSearchController.abort();
                }

                currentSearchController = new AbortController();

                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `query=${encodeURIComponent(query)}`,
                        signal: currentSearchController.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';

                    while (true) {
                        if (isSearchInterrupted) {
                            reader.cancel();
                            break;
                        }

                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            try {
                                const item = JSON.parse(line);
                                if (item.error) {
                                    errorDiv.textContent = `Chyba ze serveru: ${item.error}`;
                                    loadingDiv.style.display = 'none';
                                    return;
                                }
                                appendFoodItem(item);
                            } catch (e) {
                                console.error('Chyba p≈ôi parsov√°n√≠ JSON ≈ô√°dku:', e, '≈ò√°dek:', line);
                            }
                        }
                    }

                    if (buffer.trim() !== '' && !isSearchInterrupted) {
                        try {
                            const item = JSON.parse(buffer);
                            if (!item.error) {
                                appendFoodItem(item);
                            }
                        } catch (e) {
                            console.error('Chyba p≈ôi parsov√°n√≠ zbytku JSON bufferu:', e, 'Buffer:', buffer);
                        }
                    }

                    loadingDiv.style.display = 'none';
                    if (resultsDiv.innerHTML === '' && !isSearchInterrupted) {
                        resultsDiv.innerHTML = '<p>Nic nenalezeno.</p>';
                    }

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Do≈°lo k chybƒõ:', error);
                        loadingDiv.style.display = 'none';
                        if (!isSearchInterrupted) {
                            errorDiv.textContent = 'Do≈°lo k chybƒõ p≈ôi komunikaci se serverem.';
                        }
                    }
                }
            });
        }

        function appendFoodItem(item) {
            if (item.food_type !== 'potravina') return;

            const resultsDiv = document.getElementById('results');
            const foodItemDiv = document.createElement('div');
            foodItemDiv.classList.add('food-item', 'food-item-potravina');

            let displayImageUrl = item.image_url || placeholderImage;
            let imageHtml = '';

            if (item.image_url) {
                imageHtml = `<img src="${item.image_url}" alt="${item.name}" onerror="this.onerror=null;this.src='${placeholderImage}'" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" />`;
            } else {
                imageHtml = `<img src="${placeholderImage}" alt="Bez obr√°zku" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" />`;
            }

            const { number: caloriesNum, unit: caloriesUnit } = parseValueAndUnit(item.calories);
            const formattedCalories = formatNumberForDisplay(caloriesNum, caloriesUnit, true);

            foodItemDiv.innerHTML = `
                <div class="image-wrapper">${imageHtml}</div>
                <div class="food-details">
                    <h3>${item.name}</h3>
                    <div class="calories-and-type-row">
                        <p class="calories-display">Kalorie: ${formattedCalories}</p>
                    </div>
                </div>
            `;

            if (item.slug) {
                const newFoodItemDiv = foodItemDiv.cloneNode(true);
                newFoodItemDiv.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    isSearchInterrupted = true;
                    if (currentSearchController) {
                        currentSearchController.abort();
                    }
                    document.getElementById('loading').style.display = 'none';
                    showDetailsModal(item.slug, item.name, item.image_url, item.calories, item.food_type);
                });
                resultsDiv.appendChild(newFoodItemDiv);
            } else {
                resultsDiv.appendChild(foodItemDiv);
            }
        }

        // =============================================
        // ZOBRAZEN√ç DETAIL≈Æ POTRAVIN
        // =============================================
        const modalDetailsContent = document.getElementById('modalDetailsContent');
        const detailsModal = document.getElementById('detailsModal');

        async function showDetailsModal(slug, name, imageUrl, initialCaloriesString, foodType, isEditingRecipeIngredient = false, initialAmount = 100, initialUnit = 'g', originalNutritionalDetails = null) {
            console.log("üîç Otev√≠r√°m detail modal - editace:", isEditingRecipeIngredient, "foodType:", foodType);
            if (window.isOpeningDetailsModal && !isEditingRecipeIngredient) {
                await new Promise(resolve => setTimeout(resolve, 300));
                if (window.isOpeningDetailsModal) return;
            }

            if (!isEditingRecipeIngredient) {
                window.isOpeningDetailsModal = true;
            }

            try {
                let displayImageUrl = imageUrl || placeholderImage;
                modalDetailsContent.classList.remove('modal-recipe-container');
                document.getElementById('modalDetailsContent').classList.remove('modal-recipe-container');
                document.getElementById('detailsModal').classList.remove('modal-recipe-open');
                detailsModal.style.display = 'flex';
                modalDetailsContent.innerHTML = `<p class="loading-details">Naƒç√≠t√°m detaily pro ${name}...</p>`;

                let details;
                if (isEditingRecipeIngredient && originalNutritionalDetails) {
                    details = originalNutritionalDetails;
                } else {
                    const response = await fetch('/get_details', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slug: slug, food_type: foodType })
                    });

                    if (!response.ok) {
                        let errorMessage = `Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø (Status: ${response.status}).`;
                        let rawResponseText = await response.text();
                        try {
                            const errorData = JSON.parse(rawResponseText);
                            if (errorData && errorData.error) {
                                errorMessage = `Chyba ze serveru: ${errorData.error}`;
                            }
                        } catch (jsonParseError) {
                            errorMessage = `Chyba p≈ôi komunikaci se serverem: ${response.statusText || 'Nezn√°m√° chyba'}. Odpovƒõƒè: ${rawResponseText.substring(0, 100)}...`;
                        }
                        modalDetailsContent.innerHTML = `<p class="error-details">${errorMessage}</p>`;
                        return;
                    }

                    details = await response.json();
                }

                if (details.error) {
                    modalDetailsContent.innerHTML = `<p class="error-details">Chyba ze serveru: ${details.error}</p>`;
                } else {
                    const { unit: initialUnitForTypeDetection } = parseValueAndUnit(initialCaloriesString);
                    const isLiquidFood = initialUnitForTypeDetection.toLowerCase().includes('ml');

                    let actionButtonsHtml = '';
                    if (isEditingRecipeIngredient) {
                        setTimeout(() => {
                            detailsModal.addEventListener('click', function handleEditClickOutside(event) {
                                if (event.target === detailsModal) {
                                    detailsModal.removeEventListener('click', handleEditClickOutside);
                                    closeDetailsModalAndRestoreRecipe();
                                }
                            });
                        }, 100);

                        actionButtonsHtml = `
                            <div class="modal-action-buttons">
                                <button id="discardChangesButton" style="background-color: #dc3545; min-width: 120px;">Zahodit zmƒõny</button>
                                <button id="saveChangesButton" style="background-color: #28a745;">Ulo≈æit zmƒõny</button>
                            </div>
                        `;
                    } else {
                        // D≈ÆLE≈ΩIT√â: Tato ƒç√°st mus√≠ z≈Østat pro norm√°ln√≠ zobrazen√≠ potraviny!
                        actionButtonsHtml = `
                            <div class="modal-action-buttons">
                                <button id="addToRecipeButton">P≈ôidat do receptu</button>
                                <button id="addAsMealButton" style="background-color: #6f42c1; color: white;">P≈ôidat jako j√≠dlo</button>
                                <button id="createAndAddRecipeButton" class="btn-primary">Vytvo≈ôit recept a p≈ôidat</button>
                            </div>
                        `;
                    }

                    modalDetailsContent.innerHTML = `
                        <div class="modal-header-content">
                            <img id="modalHeaderImage" src="${displayImageUrl}" alt="${name}" class="modal-header-image" onerror="this.onerror=null;this.src='${placeholderImage}'" />
                            <div id="modalHeaderName" class="modal-header-name">${name}</div>
                        </div>
                        ${actionButtonsHtml}
                        <div class="interactive-section">
                            <div class="amount-controls">
                                <input type="number" id="amountInput" value="${initialAmount}" min="0" step="1" class="amount-input">
                                <select id="unitSelect" class="unit-select"></select>
                            </div>
                            <div class="energy-display-group">
                                <div id="totalKcalDisplay" class="energy-header"></div>
                                <div id="totalKjDisplay" class="energy-sub-header"></div>
                            </div>
                        </div>
                        <div id="nutrientDetailsSection"></div>
                        ${details.source_url ? `<p style="text-align: center; margin-top: 20px;"><a href="${details.source_url}" target="_blank">Zobrazit na Kalorick√©Tabulky.cz</a></p>` : ''}
                    `;

                    const amountInput = document.getElementById('amountInput');
                    const unitSelect = document.getElementById('unitSelect');
                    const addToRecipeButton = document.getElementById('addToRecipeButton');
                    const createAndAddRecipeButton = document.getElementById('createAndAddRecipeButton');
                    const saveChangesButton = document.getElementById('saveChangesButton');
                    const discardChangesButton = document.getElementById('discardChangesButton');

                    unitSelect.innerHTML = '';
                    if (isLiquidFood) {
                        unitSelect.add(new Option('ml', 'ml'));
                        unitSelect.add(new Option('l', 'l'));
                        unitSelect.value = initialUnit;
                    } else {
                        unitSelect.add(new Option('g', 'g'));
                        unitSelect.add(new Option('kg', 'kg'));
                        unitSelect.value = initialUnit;
                    }

                    const updateDisplay = () => {
                        const currentAmount = parseFloat(amountInput.value) || 0;
                        const selectedUnit = unitSelect.value;
                        let baseAmount = currentAmount;

                        if (selectedUnit === 'kg' || selectedUnit === 'l') {
                            baseAmount = currentAmount * 1000;
                        }

                        let factor = baseAmount / 100;
                        renderAllNutrientDetails(details, factor);

                        currentFoodItemData = {
                            foodName: name,
                            slug: slug,
                            imageUrl: displayImageUrl,
                            foodType: foodType,
                            amount: currentAmount,
                            unit: selectedUnit,
                            kcal: document.getElementById('totalKcalDisplay').textContent,
                            nutritionalDetails: details
                        };

                        // D≈ÆLE≈ΩIT√â: Nastav√≠me glob√°ln√≠ promƒõnnou
                        window.currentFoodItemForRecipe = currentFoodItemData;
                        console.log("üîÑ Nastaven currentFoodItemForRecipe:", window.currentFoodItemForRecipe); // Debug log
                    };

                    amountInput.addEventListener('input', updateDisplay);
                    unitSelect.addEventListener('change', updateDisplay);
                    updateDisplay();

                    if (addToRecipeButton) {
                        addToRecipeButton.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            console.log("‚ûï Kliknuto na P≈ôidat do receptu - z vyhled√°v√°n√≠");

                            // P≈òID√ÅNO: OKAM≈ΩIT√Å KONTROLA
                            if (!window.supabaseClient) {
                                console.error("‚ùå Supabase nen√≠ inicializov√°n, pokus o opravu...");
                                await window.initializeSupabase();
                            }

                            if (!checkInitialization()) return;

                            window.currentMealContext = null;
                            window.currentFoodItemForRecipe = currentFoodItemData;
                            await loadUserRecipesForAdding();
                            detailsModal.style.display = 'none';
                            document.getElementById('selectRecipeModal').style.display = 'flex';
                        });
                    }

                    if (createAndAddRecipeButton) {
                        createAndAddRecipeButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log("üÜï Kliknuto na Vytvo≈ôit recept a p≈ôidat");
                            if (!checkInitialization()) return;
                            detailsModal.style.display = 'none';
                            document.getElementById('createRecipeModal').style.display = 'flex';
                            document.getElementById('newRecipeNameInput').value = '';
                            document.getElementById('newRecipeNameInput').focus();
                        });
                    }

                    const addAsMealButton = document.getElementById('addAsMealButton');
                    if (addAsMealButton) {
                        addAsMealButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log("üçΩÔ∏è Kliknuto na P≈ôidat jako j√≠dlo");

                            if (!checkInitialization()) return;

                            // ‚úÖ POU≈ΩIJ P≈ò√çMO GLOB√ÅLN√ç PROMƒöNNOU
                            if (!window.currentFoodItemForRecipe) {
                                window.showCustomNotification("Nejd≈ô√≠ve vyberte potravinu", 'info');
                                return;
                            }

                            openSelectMealModal();
                        });
                    }

                    if (saveChangesButton) {
                        saveChangesButton.addEventListener('click', async () => {
                            if (currentEditingRecipeId && currentEditingIngredientIndex !== null) {
                                console.log("üíæ Kliknuto na Ulo≈æit zmƒõny");

                                // OKAM≈ΩITƒö odstran√≠me event listener pro kliknut√≠ mimo
                                const existingHandler = detailsModal._editClickOutsideHandler;
                                if (existingHandler) {
                                    detailsModal.removeEventListener('click', existingHandler);
                                    detailsModal._editClickOutsideHandler = null;
                                }

                                // OKAM≈ΩITƒö zav≈ôeme modal
                                detailsModal.style.display = 'none';

                                // A zavol√°me update funkci
                                await updateFoodItemInRecipe(currentEditingRecipeId, currentEditingIngredientIndex, currentFoodItemData);
                            } else {
                                window.showCustomNotification("Chyba: Nelze ulo≈æit zmƒõny. Chyb√≠ kontext √∫pravy.", 'info');
                            }
                        });
                    }

                    if (discardChangesButton) {
                        discardChangesButton.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            console.log("üóëÔ∏è Kliknuto na Zahodit zmƒõny");

                            // OKAM≈ΩITƒö odstran√≠me event listener
                            const existingHandler = detailsModal._editClickOutsideHandler;
                            if (existingHandler) {
                                detailsModal.removeEventListener('click', existingHandler);
                                detailsModal._editClickOutsideHandler = null;
                            }

                            // Pou≈æijeme na≈°i hlavn√≠ funkci pro zav≈ôen√≠ a obnoven√≠
                            await closeDetailsModalAndRestoreRecipe();
                        });
                    }
                }
            } catch (error) {
                console.error("Chyba v showDetailsModal:", error);
                window.isOpeningDetailsModal = false;
            } finally {
                if (!isEditingRecipeIngredient) {
                    setTimeout(() => {
                        window.isOpeningDetailsModal = false;
                    }, 1000);
                }
            }
        }

        // =============================================
        // NUTRIENTY A ZOBRAZEN√ç
        // =============================================
        function createNutrientRow(label, originalValueString, rdiString = null, dotColor = null, type = 'other', currentFactor = 1, addSeparator = false, fontWeight = 'bold', fontSize = null) {
            const { number: originalNumericValue, unit: displayUnit } = parseValueAndUnit(originalValueString);
            let calculatedValueDisplay = isNaN(originalNumericValue) ? '-' : formatNumberForDisplay(originalNumericValue * currentFactor, displayUnit, false);
            let dot = dotColor ? `<span class="dot ${dotColor}"></span>` : '';
            let labelClass = 'nutrient-label';
            let valueClass = 'nutrient-value';

            let labelStyle = `font-weight: ${fontWeight};`;
            let valueStyle = `font-weight: ${fontWeight};`;
            let separatorHtml = '';

            if (fontSize) {
                labelStyle += `font-size: ${fontSize};`;
                valueStyle += `font-size: ${fontSize};`;
            }

            if (dotColor) {
                let colorHex = '';
                switch (dotColor) {
                    case 'red': colorHex = '#f44336'; break;
                    case 'blue': colorHex = '#2196f3'; break;
                    case 'orange': colorHex = '#ff9800'; break;
                    case 'green': colorHex = '#4caf50'; break;
                    default: colorHex = '';
                }
                if (colorHex) {
                    labelStyle += `color: ${colorHex};`;
                    valueStyle += `color: ${colorHex};`;
                }
            }

            if (type === 'main') {
                labelClass += ' main';
                valueClass += ' main-value';
            } else if (type === 'nested') {
                labelClass = 'nutrient-sub-label';
                valueClass = 'nutrient-sub-value';
            }

            if (addSeparator && label !== 'B√≠lkoviny') {
                separatorHtml = `<div class="nutrient-line-separator"></div>`;
            }

            return `
                ${separatorHtml}
                <div class="nutrient-row">
                    <div class="${labelClass}" style="${labelStyle}">${dot}${label}</div>
                    <div class="${valueClass}" style="${valueStyle}">${calculatedValueDisplay}</div>
                </div>
            `;
        }

        function renderAllNutrientDetails(details, factor = 1) {
            if (!details || typeof details !== 'object') {
                console.error("Neplatn√° nutriƒçn√≠ data");
                return;
            }

            const nutrientDetailsSection = document.getElementById('nutrientDetailsSection');
            if (!nutrientDetailsSection) return;

            nutrientDetailsSection.innerHTML = '';

            const totalKcalDisplay = document.getElementById('totalKcalDisplay');
            const totalKjDisplay = document.getElementById('totalKjDisplay');

            if (totalKcalDisplay) {
                const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(details.total_kcal);
                totalKcalDisplay.textContent = formatNumberForDisplay(kcalNum * factor, kcalUnit, true);
            }
            if (totalKjDisplay) {
                const { number: kjNum, unit: kjUnit } = parseValueAndUnit(details.total_kj);
                totalKjDisplay.textContent = formatNumberForDisplay(kjNum * factor, kjUnit, true);
            }

            let nutrientsHtmlContent = '';

            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('B√≠lkoviny', details.protein, null, 'red', 'main', factor, false);
            nutrientsHtmlContent += createNutrientRow('Sacharidy', details.carbs, null, 'blue', 'main', factor, true);
            nutrientsHtmlContent += createNutrientRow('Cukry', details.sugar, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Tuky', details.fat, null, 'orange', 'main', factor, true);
            nutrientsHtmlContent += createNutrientRow('Nasycen√© mastn√© kyseliny', details.saturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Trans mastn√© kyseliny', details.trans_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Mononenasycen√©', details.monounsaturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Polynenasycen√©', details.polyunsaturated_fat, null, null, 'nested', factor, false);
            nutrientsHtmlContent += createNutrientRow('Cholesterol', details.cholesterol, null, null, 'nested', factor, false);
            nutrientsHtmlContent += `</div>`;
            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('Vl√°knina', details.fiber, null, 'green', 'main', factor, true);
            nutrientsHtmlContent += `</div>`;
            nutrientsHtmlContent += `<div class="nutrient-section">`;
            nutrientsHtmlContent += createNutrientRow('S≈Øl', details.salt, null, null, 'main', factor, true, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('V√°pn√≠k', details.calcium, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('Sod√≠k', details.sodium, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('Voda', details.water, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += createNutrientRow('PHE', details.phe, null, null, 'main', factor, false, 'normal', '1.05em');
            nutrientsHtmlContent += `</div>`;

            nutrientDetailsSection.innerHTML = nutrientsHtmlContent;
        }

        // =============================================
        // RECEPTY - SPR√ÅVA A ZOBRAZEN√ç
        // =============================================
        async function createNewRecipe(recipeName, foodItem) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                window.showCustomNotification("Chyba: Aplikace nen√≠ spr√°vnƒõ inicializov√°na.", 'error');
                return null;
            }

            try {
                const completeFoodItem = foodItem ? {
                    ...foodItem,
                    imageUrl: foodItem.imageUrl || placeholderImage,
                    // D≈ÆLE≈ΩIT√â: Zajist√≠me, ≈æe v≈°echny pot≈ôebn√© pole jsou nastaveny
                    foodName: foodItem.foodName || 'Nezn√°m√° potravina',
                    slug: foodItem.slug || '',
                    foodType: foodItem.foodType || 'potravina',
                    amount: foodItem.amount || 100,
                    unit: foodItem.unit || 'g',
                    kcal: foodItem.kcal || '0 kcal',
                    nutritionalDetails: foodItem.nutritionalDetails || null
                } : null;

                const recipeData = {
                    name: recipeName,
                    user_id: window.currentUser.id,
                    profile_id: window.currentProfileId,
                    ingredients: completeFoodItem ? [completeFoodItem] : [], // D≈ÆLE≈ΩIT√â: P≈ôid√°me potravinu do ingredients
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                console.log("üìù Vytv√°≈ô√≠m recept s daty:", recipeData); // Debug log

                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .insert(recipeData)
                    .select()
                    .single();

                if (error) throw error;

                console.log("‚úÖ Recept vytvo≈ôen:", data); // Debug log

                // Resetujeme stav
                window.isOpeningDetailsModal = false;
                window.currentFoodItemForRecipe = null;

                document.getElementById('createRecipeModal').style.display = 'none';
                if (detailsModal.style.display === 'flex') {
                    detailsModal.style.display = 'none';
                }

                return data.id;
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi vytv√°≈ôen√≠ receptu:", error);
                window.showCustomNotification("Chyba p≈ôi vytv√°≈ôen√≠ receptu: " + error.message, 'error');
                window.isOpeningDetailsModal = false;
                return null;
            }
        }

        async function loadUserRecipes(showNotification = false) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            try {
                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('profile_id', window.currentProfileId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                displayRecipesInModal(data || []);
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø:", error);
            }
        }

        async function loadUserRecipesForAdding() {
            console.log("üîç Naƒç√≠t√°m recepty pro p≈ôid√°n√≠ potraviny, kontext:",
                window.currentMealContext ? 'denn√≠ p≈ô√≠jem' : 'recept z vyhled√°v√°n√≠');

            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            try {
                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('profile_id', window.currentProfileId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                console.log(`‚úÖ Naƒçteno ${data?.length || 0} recept≈Ø pro p≈ôid√°n√≠`);
                displayRecipesInModal(data || [], true); // true = re≈æim p≈ôid√°v√°n√≠
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø:", error);
            }
        }

        // Mod√°ln√≠ okno pro zobrazen√≠ seznamu receptu po kliknut√≠ na RECEPTY
        function displayRecipesInModal(recipes, isAddToRecipeMode = false) {
            const existingRecipesList = document.getElementById('existingRecipesList');
            const recipeCountDisplay = document.getElementById('recipeCountDisplay');

            if (!existingRecipesList) return;
            existingRecipesList.innerHTML = '';

            if (recipeCountDisplay) {
                recipeCountDisplay.textContent = `Poƒçet recept≈Ø: ${recipes.length}`;
                recipeCountDisplay.style.display = 'block';
            }

            if (recipes.length === 0) {
                existingRecipesList.innerHTML = '<li style="text-align: center; color: #888; padding: 20px;">≈Ω√°dn√© recepty</li>';
                return;
            }

            recipes.forEach((recipe, index) => {
                const recipeItem = document.createElement('li');

                if (isAddToRecipeMode) {
                    recipeItem.className = 'recipe-list-item'; // BEZ akc√≠
                } else {
                    recipeItem.className = 'recipe-list-item with-actions'; // S akcemi
                }

                // ZOBRAZEN√ç P≈òI KLIKNUT√ç NA RECEPTY
                const totalCalories = calculateRecipeTotalCalories(recipe);
                const portions = recipe.portions || 1;
                const hasMultiplePortions = recipe.has_multiple_portions || false;

                // ROZHODNUT√ç: Kter√© kalorie zobrazit
                let displayCalories = totalCalories;

                if (hasMultiplePortions && recipe.recipe_one_portion) {
                    // Zobraz√≠me kalorie na jednu porci
                    displayCalories = Math.round(recipe.recipe_one_portion.total_kcal);
                }

                const formattedCalories = displayCalories > 0 ? `${Math.round(displayCalories)} kcal` : '-';
                const portionText = portions > 1 ? ` (${portions} porc√≠)` : '';

                if (isAddToRecipeMode) {
                    // RE≈ΩIM V√ùBƒöRU - bez ikonky smaz√°n√≠
                    recipeItem.innerHTML = `
                <div class="recipe-number">${index + 1}.</div>
                <div class="recipe-name">${recipe.name}${portionText}</div>
                <div class="recipe-calories">${formattedCalories}</div>
            `;
                } else {
                    // RE≈ΩIM PROHL√ç≈ΩEN√ç - s ikonkou smaz√°n√≠
                    recipeItem.innerHTML = `
                <div class="recipe-number">${index + 1}.</div>
                <div class="recipe-name">${recipe.name}${portionText}</div>
                <div class="recipe-calories">${formattedCalories}</div>
                <div class="recipe-actions">
                    <img src="{{ url_for('static', filename='icon/kos.png') }}" 
                         alt="Smazat" 
                         class="recipe-delete-icon" 
                         data-recipe-id="${recipe.id}" 
                         data-recipe-name="${recipe.name}">
                </div>
            `;
                }

                // Event listenery pouze pro re≈æim s akcemi
                if (!isAddToRecipeMode) {
                    const deleteIcon = recipeItem.querySelector('.recipe-delete-icon');
                    if (deleteIcon) {
                        deleteIcon.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const recipeId = e.target.dataset.recipeId;
                            const recipeName = e.target.dataset.recipeName;
                            await deleteRecipe(recipeId, recipeName);
                        });
                    }
                }

                // Kliknut√≠ na celou polo≈æku
                recipeItem.addEventListener('click', (e) => {
                    if (isAddToRecipeMode) {
                        const context = window.currentMealContext ? 'denn√≠ p≈ô√≠jem' : 'recept';
                        console.log(`üéØ Kliknuto na recept v kontextu: ${context}`);

                        if (window.currentMealContext) {
                            // KONTEXT: P≈ôid√°v√°me recept do denn√≠ho p≈ô√≠jmu
                            console.log("ü•ò P≈ôid√°v√°m RECEPT do denn√≠ho p≈ô√≠jmu:", recipe.name);
                            addRecipeToMeal(recipe);
                            // ZAV≈ò√çME MODAL OKAM≈ΩITƒö PO KLIKNUT√ç
                            document.getElementById('selectRecipeModal').style.display = 'none';
                        } else {
                            // KONTEXT: P≈ôid√°v√°me potravinu do receptu
                            console.log("ü•ò P≈ôid√°v√°m POTRAVINU do receptu:", recipe.name);
                            addFoodItemToExistingRecipe(recipe.id, window.currentFoodItemForRecipe);
                            // ZAV≈ò√çME MODAL OKAM≈ΩITƒö PO KLIKNUT√ç
                            document.getElementById('selectRecipeModal').style.display = 'none';
                        }
                    } else {
                        // Logika pro zobrazen√≠ detailu receptu
                        if (!e.target.classList.contains('recipe-delete-icon')) {
                            document.getElementById('selectRecipeModal').style.display = 'none';
                            openRecipeDetail(recipe.id, recipe.name);
                        }
                    }
                });

                existingRecipesList.appendChild(recipeItem);
            });
        }

        function calculateRecipeTotalCalories(recipe) {
            if (!recipe || !recipe.ingredients || !Array.isArray(recipe.ingredients)) return 0;

            let totalCalories = 0;
            recipe.ingredients.forEach((ingredient) => {
                if (!ingredient || !ingredient.foodName || !ingredient.kcal) return;
                const { number: kcalNum } = parseValueAndUnit(ingredient.kcal);
                if (!isNaN(kcalNum)) totalCalories += kcalNum;
            });

            // D≈ÆLE≈ΩIT√â: NEprov√°d√≠me p≈ôepoƒçet na porci - vrac√≠me CELKOV√â kalorie
            return Math.round(totalCalories);
        }

        async function fixRecipesWithNullIngredients() {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            try {
                const { data: recipes, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('profile_id', window.currentProfileId);

                if (error) return;

                let fixedCount = 0;
                for (const recipe of recipes) {
                    if (recipe.ingredients && Array.isArray(recipe.ingredients)) {
                        const originalLength = recipe.ingredients.length;
                        const cleanedIngredients = recipe.ingredients.filter(ing => ing !== null);

                        if (cleanedIngredients.length !== originalLength) {
                            const { error: updateError } = await window.supabaseClient
                                .from('recipes')
                                .update({
                                    ingredients: cleanedIngredients,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', recipe.id);

                            if (!updateError) fixedCount++;
                        }
                    }
                }

                if (fixedCount > 0) {
                    window.showCustomNotification(`Opraveno ${fixedCount} recept≈Ø s chybƒõj√≠c√≠mi ingrediencemi`, 'info');
                }
            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi opravƒõ recept≈Ø:", error);
            }
        }

        async function addFoodItemToSelectedRecipe(recipeId, recipeName) {
            window.isAddingToRecipe = true;

            try {
                console.log(`‚ûï P≈ôid√°v√°m recept "${recipeName}" do denn√≠ho p≈ô√≠jmu`);

                // Naƒçteme kompletn√≠ data receptu z datab√°ze
                const { data: recipeData, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('id', recipeId)
                    .single();

                if (error) throw error;

                const portions = recipeData.portions || 1;
                const hasMultiplePortions = recipeData.has_multiple_portions || false;
                const recipeOnePortion = recipeData.recipe_one_portion;

                console.log("üìä Recept:", {
                    name: recipeName,
                    portions: portions,
                    hasMultiplePortions: hasMultiplePortions,
                    recipeOnePortion: recipeOnePortion
                });

                // V≈ΩDY POU≈ΩIJEME DATA PRO JEDNU PORCI - pokud jsou dostupn√°
                let nutritionalData = {};
                let displayCalories = 0;
                let usedOnePortionData = false;

                if (hasMultiplePortions && recipeOnePortion) {
                    // RECEPT S V√çCE PORCEMI: pou≈æijeme data pro jednu porci
                    console.log("üî¢ Pou≈æ√≠v√°m data pro jednu porci z recipe_one_portion");
                    nutritionalData = recipeOnePortion;
                    displayCalories = recipeOnePortion.total_kcal;
                    usedOnePortionData = true;
                } else {
                    // RECEPT S JEDNOU PORC√ç: pou≈æijeme p≈Øvodn√≠ data
                    console.log("üî¢ Pou≈æ√≠v√°m p≈Øvodn√≠ data");
                    const firstIngredient = recipeData.ingredients?.[0];
                    nutritionalData = firstIngredient?.nutritionalDetails || {};
                    displayCalories = parseFloat(firstIngredient?.kcal || 0);
                }

                // Vytvo≈ô√≠me foodItem s P≈òEPOƒåTEN√ùMI DATY
                const recipeFoodItem = {
                    foodName: recipeName,
                    slug: '',
                    imageUrl: recipeData.imageUrl || "{{ url_for('static', filename='icon/recepty.png') }}",
                    foodType: 'recept',
                    amount: 100, // z√°kladn√≠ mno≈æstv√≠ pro jednu porci
                    unit: 'g',
                    kcal: displayCalories + ' kcal',
                    nutritionalDetails: nutritionalData, // D≈ÆLE≈ΩIT√â: pou≈æijeme p≈ôepoƒçten√° data
                    isRecipe: true,
                    recipeId: recipeId,
                    portions: 1, // V≈ΩDY p≈ôid√°me jednu porci do denn√≠ho p≈ô√≠jmu
                    ingredients: recipeData.ingredients || [],
                    usedOnePortionData: usedOnePortionData,
                    // D≈ÆLE≈ΩIT√â: P≈ôep√≠≈°eme nutriƒçn√≠ data ingredienc√≠ p≈ôepoƒçten√Ωmi daty
                    overriddenNutrition: nutritionalData
                };

                console.log("üì¶ P≈ôipraven foodItem s p≈ôepoƒçten√Ωmi daty:", {
                    foodName: recipeFoodItem.foodName,
                    calories: recipeFoodItem.kcal,
                    usedOnePortionData: recipeFoodItem.usedOnePortionData,
                    nutritionalData: recipeFoodItem.nutritionalDetails
                });

                // Zav≈ôeme modaly a p≈ôid√°me do denn√≠ho p≈ô√≠jmu
                document.getElementById('selectRecipeModal').style.display = 'none';

                const currentDate = new Date();
                const mealType = window.currentMealContext?.mealType || 'breakfast';

                await addFoodItemToDailyMeal(recipeFoodItem, mealType, currentDate);

                window.showCustomNotification(
                    `Recept "<strong>${recipeName}</strong>" byl p≈ôid√°n do ${mealTypeLabels[mealType]}!`,
                    'success'
                );

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ receptu:", error);
                window.showCustomNotification("Chyba: " + error.message, 'error');
            } finally {
                window.isAddingToRecipe = false;
                window.currentFoodItemForRecipe = null;
            }
        }

        async function openRecipeDetail(recipeId, recipeName) {
            document.getElementById('selectRecipeModal').style.display = 'none';
            await showRecipeDetailsModal(recipeId, recipeName);
        }

        async function addFoodItemToExistingRecipe(recipeId, foodItem) {
            if (!window.supabaseClient) {
                console.error("‚ùå Supabase nen√≠ inicializov√°n! Pokus√≠m se opravit...");

                console.log("ü•ò addFoodItemToExistingRecipe vol√°na s:", {
                    recipeId,
                    foodName: foodItem?.foodName,
                    context: "p≈ôid√°n√≠ potraviny do receptu"
                });

                // Zkus√≠me znovu inicializovat
                try {
                    await window.initializeSupabase();
                    if (!window.supabaseClient) {
                        window.showCustomNotification("Chyba datab√°ze. Obnovte str√°nku.", 'error');
                        return;
                    }
                    // D≈ÆLE≈ΩIT√â: PO √öSPƒö≈†N√âM P≈òID√ÅN√ç ZAV≈òEME MODAL
                    document.getElementById('selectRecipeModal').style.display = 'none';

                    console.log("‚úÖ Potravina √∫spƒõ≈°nƒõ p≈ôid√°na do receptu");

                    // Zobraz√≠me potvrzen√≠
                    window.showCustomNotification(
                        `"<strong>${completeFoodItem.foodName}</strong>" byl p≈ôid√°n do receptu "<strong>${recipeData.name}</strong>"`,
                        'success'
                    );

                    // Resetujeme stav
                    window.currentFoodItemForRecipe = null;

                } catch (error) {
                    console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi p≈ôid√°v√°n√≠ do receptu:", error);
                    // I p≈ôi chybƒõ zav≈ôeme modal
                    document.getElementById('selectRecipeModal').style.display = 'none';
                }
            }

            if (!window.currentUser || !window.currentProfileId) {
                window.showCustomNotification("Pro tuto akci se mus√≠te p≈ôihl√°sit.", 'info');
                return;
            }

            console.log("ü•ò addFoodItemToExistingRecipe vol√°na s:", {
                recipeId,
                foodName: foodItem?.foodName,
                context: window.currentMealContext ? 'denn√≠ p≈ô√≠jem' : 'recept z vyhled√°v√°n√≠'
            });

            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                console.error("‚ùå Chyb√≠ inicializace:", {
                    supabase: !!window.supabaseClient,
                    user: !!window.currentUser,
                    profile: !!window.currentProfileId
                });
                return;
            }

            try {
                const { data: recipeData, error: fetchError } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('id', recipeId)
                    .single();

                if (fetchError) {
                    console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ receptu:", fetchError);
                    throw fetchError;
                }

                console.log("üìã Naƒçten recept:", recipeData.name, "ingredience:", recipeData.ingredients?.length || 0);

                const completeFoodItem = {
                    ...foodItem,
                    imageUrl: foodItem.imageUrl || placeholderImage,
                    // D≈ÆLE≈ΩIT√â: Zajist√≠me, ≈æe v≈°echny pot≈ôebn√© pole jsou nastaveny
                    foodName: foodItem.foodName || 'Nezn√°m√° potravina',
                    slug: foodItem.slug || '',
                    foodType: foodItem.foodType || 'potravina',
                    amount: foodItem.amount || 100,
                    unit: foodItem.unit || 'g',
                    kcal: foodItem.kcal || '0 kcal',
                    nutritionalDetails: foodItem.nutritionalDetails || null
                };

                const currentIngredients = recipeData.ingredients || [];
                const updatedIngredients = [...currentIngredients, completeFoodItem];

                console.log("üìù Ukl√°d√°m aktualizovan√© ingredience:", updatedIngredients.length);

                const { error: updateError } = await window.supabaseClient
                    .from('recipes')
                    .update({
                        ingredients: updatedIngredients,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', recipeId);

                if (updateError) {
                    console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ receptu:", updateError);
                    throw updateError;
                }

                console.log("‚úÖ Potravina √∫spƒõ≈°nƒõ p≈ôid√°na do receptu");

            } catch (error) {
                console.error("‚ùå Neoƒçek√°van√° chyba p≈ôi p≈ôid√°v√°n√≠ do receptu:", error);

                // Zobraz√≠me chybu i kdy≈æ je notifikace vypnut√°
                const errorMessage = `Chyba p≈ôi p≈ôid√°v√°n√≠ do receptu: ${error.message}`;
                const customNotificationModal = document.getElementById('customNotificationModal');
                const customNotificationMessage = document.getElementById('customNotificationMessage');

                if (customNotificationModal && customNotificationMessage) {
                    customNotificationMessage.innerHTML = errorMessage;
                    customNotificationModal.style.display = 'flex';
                } else {
                    alert(errorMessage);
                }
            }
        }

        async function updateFoodItemInRecipe(recipeId, ingredientIndex, updatedFoodItem) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            const executeUpdate = async () => {
                try {
                    const { data: recipeData, error: fetchError } = await window.supabaseClient
                        .from('recipes')
                        .select('*')
                        .eq('id', recipeId)
                        .single();

                    if (fetchError) throw fetchError;

                    const currentIngredients = recipeData.ingredients || [];
                    if (ingredientIndex >= 0 && ingredientIndex < currentIngredients.length) {
                        currentIngredients[ingredientIndex] = updatedFoodItem;

                        const { error: updateError } = await window.supabaseClient
                            .from('recipes')
                            .update({
                                ingredients: currentIngredients,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', recipeId);

                        if (updateError) throw updateError;

                        // D≈ÆLE≈ΩIT√â: Pou≈æijeme spoleƒçnou funkci pro zav≈ôen√≠ a obnoven√≠
                        await closeDetailsModalAndRestoreRecipe();

                        // Zobraz√≠me notifikaci
                        window.showCustomNotification(`Polo≈æka "<strong>${updatedFoodItem.foodName}</strong>" v receptu byla √∫spƒõ≈°nƒõ aktualizov√°na.`, 'recipeSaveSuccess');
                    }
                } catch (error) {
                    console.error("Error updating food item in recipe:", error);
                    window.showCustomNotification("Chyba p≈ôi aktualizaci polo≈æky v receptu: " + error.message, 'recipeDeletionError');
                }
            };

            window.showCustomNotification(`Opravdu chcete ulo≈æit zmƒõny pro polo≈æku "<strong>${updatedFoodItem.foodName}</strong>" ? `, 'confirmSaveChanges', executeUpdate, true);
        }

        async function deleteRecipe(recipeId, recipeName) {
    if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

    window.showCustomNotification(`Opravdu chcete odstranit recept "<strong>${recipeName}</strong>" ze seznamu recept≈Ø?`, 'confirmDeleteRecipe', async () => {
        try {
            console.log(`üóëÔ∏è Ma≈æu recept ${recipeName} (${recipeId}) - pouze ze seznamu...`);

            // 1. POUZE sma≈æte recept ze seznamu
            const { error: deleteRecipeError } = await window.supabaseClient
                .from('recipes')
                .delete()
                .eq('id', recipeId)
                .eq('profile_id', window.currentProfileId);

            if (deleteRecipeError) {
                console.error("‚ùå Chyba p≈ôi maz√°n√≠ receptu:", deleteRecipeError);
                throw deleteRecipeError;
            }

            console.log(`‚úÖ Recept ${recipeName} √∫spƒõ≈°nƒõ smaz√°n ze seznamu`);
            window.showCustomNotification(`Recept "<strong>${recipeName}</strong>" byl odstranƒõn ze seznamu. J√≠dla v denn√≠m p≈ô√≠jmu z≈Østala zachov√°na.`, 'recipeDeletionSuccess');
            loadUserRecipes();
            
        } catch (error) {
            console.error("‚ùå Error deleting recipe:", error);
            window.showCustomNotification(`Chyba p≈ôi odstra≈àov√°n√≠ receptu: ${error.message}`, 'recipeDeletionError');
        }
    }, true);
}

        async function deleteFoodItemFromRecipe(recipeId, ingredientIndex, ingredientName, recipeName) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) return;

            window.showCustomNotification(`Opravdu chcete odstranit polo≈æku "<strong>${ingredientName}</strong>" z receptu "<strong>${recipeName}</strong>" ? `, 'confirmDeleteRecipeItem', async () => {
                try {
                    const { data: recipeData, error: fetchError } = await window.supabaseClient
                        .from('recipes')
                        .select('*')
                        .eq('id', recipeId)
                        .single();

                    if (fetchError) throw fetchError;

                    const currentIngredients = recipeData.ingredients || [];
                    if (ingredientIndex >= 0 && ingredientIndex < currentIngredients.length) {
                        currentIngredients.splice(ingredientIndex, 1);

                        const { error: updateError } = await window.supabaseClient
                            .from('recipes')
                            .update({
                                ingredients: currentIngredients,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', recipeId);

                        if (updateError) throw updateError;

                        window.showCustomNotification(`Polo≈æka "<strong>${ingredientName}</strong>" byla √∫spƒõ≈°nƒõ smaz√°na z receptu "<strong>${recipeName}</strong>".`, 'recipeDeletionSuccess');
                        await showRecipeDetailsModal(recipeId, recipeName);
                    }
                } catch (error) {
                    console.error("Error deleting food item from recipe:", error);
                    window.showCustomNotification(`Chyba p≈ôi odstra≈àov√°n√≠ polo≈æky "<strong>${ingredientName}</strong>": ${error.message} `, 'recipeDeletionError');
                }
            }, true);
        }

        async function showRecipeDetailsModal(recipeId, recipeName) {
            console.log("üîç showRecipeDetailsModal vol√°na pro:", recipeName, "ID:", recipeId);
            if (window.isAddingToRecipe) return;

            window.isOpeningDetailsModal = false;
            modalDetailsContent.classList.add('modal-recipe-container');
            document.getElementById('modalDetailsContent').classList.add('modal-recipe-container');
            document.getElementById('detailsModal').classList.add('modal-recipe-open');
            detailsModal.style.display = 'flex';
            modalDetailsContent.innerHTML = `< p class="loading-details" > Naƒç√≠t√°m detaily receptu "${recipeName}"...</p > `;

            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                modalDetailsContent.innerHTML = `< p class= "error-details" > Chyba: Aplikace se nenaƒçetla spr√°vnƒõ.Nelze naƒç√≠st recept.</p > `;
                return;
            }

            try {
                const { data: recipeData, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('id', recipeId)
                    .single();

                if (error) throw error;

                if (!recipeData) {
                    modalDetailsContent.innerHTML = `< p class= "error-details" > Recept "${recipeName}" nebyl nalezen.</p > `;
                    return;
                }

                const portions = recipeData.portions || 1;
                const imageUrl = recipeData.imageUrl || "{{ url_for('static', filename='icon/recepty.png') }}";
                const ingredients = recipeData.ingredients || [];

                // Funkce pro v√Ωpoƒçet nutriƒçn√≠ch hodnot na z√°kladƒõ poƒçtu porc√≠
                const calculateNutritionForPortions = (targetPortions = portions) => {
                    const aggregatedNutrients = {
                        total_kcal: 0, total_kj: 0, protein: 0, carbs: 0, sugar: 0, fat: 0,
                        saturated_fat: 0, trans_fat: 0, monounsaturated_fat: 0, polyunsaturated_fat: 0,
                        cholesterol: 0, fiber: 0, salt: 0, calcium: 0, sodium: 0, water: 0, phe: 0
                    };

                    if (ingredients.length === 1 && ingredients[0].isCustomRecipe) {
                        // Vlastn√≠ recept - pou≈æijeme KOMPLETN√ç data z ingredience
                        const customRecipe = ingredients[0];
                        const nutritionalDetails = customRecipe.nutritionalDetails || {};
                        const originalPortions = customRecipe.portions || 1;

                        // P≈ôepoƒçet na targetPortions
                        const portionFactor = targetPortions / originalPortions;

                        console.log("üîç Naƒçten√° nutriƒçn√≠ data vlastn√≠ho receptu:", nutritionalDetails);

                        // P≈òENESEME V≈†ECHNY HODNOTY
                        aggregatedNutrients.total_kcal = (nutritionalDetails.total_kcal || 0) * portionFactor;
                        aggregatedNutrients.total_kj = (nutritionalDetails.total_kj || 0) * portionFactor;
                        aggregatedNutrients.protein = (nutritionalDetails.protein || 0) * portionFactor;
                        aggregatedNutrients.carbs = (nutritionalDetails.carbs || 0) * portionFactor;
                        aggregatedNutrients.sugar = (nutritionalDetails.sugar || 0) * portionFactor;
                        aggregatedNutrients.fat = (nutritionalDetails.fat || 0) * portionFactor;
                        aggregatedNutrients.saturated_fat = (nutritionalDetails.saturated_fat || 0) * portionFactor;
                        aggregatedNutrients.trans_fat = (nutritionalDetails.trans_fat || 0) * portionFactor;
                        aggregatedNutrients.monounsaturated_fat = (nutritionalDetails.monounsaturated_fat || 0) * portionFactor;
                        aggregatedNutrients.polyunsaturated_fat = (nutritionalDetails.polyunsaturated_fat || 0) * portionFactor;
                        aggregatedNutrients.cholesterol = (nutritionalDetails.cholesterol || 0) * portionFactor;
                        aggregatedNutrients.fiber = (nutritionalDetails.fiber || 0) * portionFactor;
                        aggregatedNutrients.salt = (nutritionalDetails.salt || 0) * portionFactor;
                        aggregatedNutrients.calcium = (nutritionalDetails.calcium || 0) * portionFactor;
                        aggregatedNutrients.sodium = (nutritionalDetails.sodium || 0) * portionFactor;
                        aggregatedNutrients.water = (nutritionalDetails.water || 0) * portionFactor;
                        aggregatedNutrients.phe = (nutritionalDetails.phe || 0) * portionFactor;

                        console.log("üìä P≈ôepoƒçten√° data na", targetPortions, "porc√≠:", aggregatedNutrients);
                    } else {
                        // Norm√°ln√≠ recept s v√≠ce ingrediencemi (p≈Øvodn√≠ k√≥d)
                        ingredients.forEach(ingredient => {
                            if (ingredient.nutritionalDetails && typeof ingredient.nutritionalDetails === 'object') {
                                const amount = parseFloat(ingredient.amount) || 0;
                                let baseAmount = amount;
                                if (ingredient.unit === 'kg' || ingredient.unit === 'l') baseAmount *= 1000;
                                const factor = baseAmount / 100;

                                for (const key in aggregatedNutrients) {
                                    if (ingredient.nutritionalDetails[key] && ingredient.nutritionalDetails[key] !== "N/A") {
                                        const { number: valNum } = parseValueAndUnit(ingredient.nutritionalDetails[key]);
                                        if (!isNaN(valNum)) aggregatedNutrients[key] += valNum * factor;
                                    }
                                }
                            }
                        });

                        // P≈ôepoƒçet na targetPortions
                        const portionFactor = targetPortions / portions;
                        for (const key in aggregatedNutrients) {
                            aggregatedNutrients[key] *= portionFactor;
                        }
                    }

                    const totalKj = aggregatedNutrients.total_kj || (aggregatedNutrients.total_kcal * 4.184);
                    const formattedAggregatedNutrients = {};
                    for (const key in aggregatedNutrients) {
                        let unit = '';
                        if (key.includes('kcal')) unit = 'kcal';
                        else if (key.includes('kj')) unit = 'kJ';
                        else if (['protein', 'carbs', 'sugar', 'fat', 'saturated_fat', 'trans_fat',
                            'monounsaturated_fat', 'polyunsaturated_fat', 'fiber', 'salt', 'water', 'phe'].includes(key)) unit = 'g';
                        else if (['cholesterol', 'calcium', 'sodium'].includes(key)) unit = 'mg';

                        formattedAggregatedNutrients[key] = formatNumberForDisplay(aggregatedNutrients[key], unit, key.includes('kcal') || key.includes('kj'));
                    }

                    return {
                        nutrients: formattedAggregatedNutrients,
                        rawNutrients: aggregatedNutrients, // P≈òID√ÅNO - ƒç√≠seln√© hodnoty
                        totalKj: totalKj,
                        totalWeight: 100 * targetPortions // P≈ôibli≈æn√° hmotnost na porci
                    };
                };

                // Poƒç√°teƒçn√≠ v√Ωpoƒçet pro aktu√°ln√≠ poƒçet porc√≠
                let currentPortions = portions;
                let currentNutrition = calculateNutritionForPortions(currentPortions);

                // Vytvo≈ôen√≠ HTML s v√Ωbƒõrem porc√≠
                modalDetailsContent.innerHTML = `
            <!-- HLAVIƒåKA S OBR√ÅZKEM A N√ÅZVEM -->
            <div class="modal-recipe-fixed-header">
                
                ${ingredients.length === 1 && ingredients[0].isCustomRecipe ? `
                    <!-- VLASTN√ç RECEPT - POƒåET PORC√ç NAD N√ÅZVEM -->
                    <div class="portions-display-text">Poƒçet porc√≠: ${currentPortions}</div>
                ` : ''}
                
                <!-- HORN√ç ≈ò√ÅDEK: OBR√ÅZEK VLEVO + N√ÅZEV -->
                <div class="recipe-header-top">
                    <img id="modalHeaderImage" src="${imageUrl}" alt="${recipeName}" 
                         class="modal-header-image" 
                         onerror="this.onerror=null;this.src='{{ url_for('static', filename='icon/recepty.png') }}'">
                    <div id="modalHeaderName" class="modal-header-name">${recipeName}</div>
                </div>
                
                ${ingredients.length === 1 && ingredients[0].isCustomRecipe ? `
                    <!-- VLASTN√ç RECEPT - TLAƒå√çTKA VLEVO, ENERGIE VPRAVO -->
                    <div class="custom-recipe-controls">
                        <div class="custom-recipe-buttons">
                            <button id="editCustomRecipeButton" class="btn-edit-custom" title="Upravit recept">
                                <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Upravit">
                                Upravit recept
                            </button>
                            <button id="addRecipeAsMealButton" class="btn-add-meal-small">
                                üçΩÔ∏è P≈ôidat jako j√≠dlo
                            </button>
                        </div>
                        
                        <div class="energy-display-custom">
                            <div id="totalKcalDisplay" class="energy-kcal-custom">${currentNutrition.nutrients.total_kcal}</div>
                            <div id="totalKjDisplay" class="energy-kj-custom">${formatNumberForDisplay(currentNutrition.totalKj, 'kJ', true)}</div>
                        </div>
                    </div>
                ` : `
                    <!-- Bƒö≈ΩN√ù RECEPT Z VYHLEDAN√ùCH POTRAVIN -->
                    <div class="normal-recipe-controls">
                        <button id="addRecipeAsMealButton" class="btn-add-meal-small">
                            üçΩÔ∏è P≈ôidat jako j√≠dlo
                        </button>
                        
                        <div class="energy-display-normal">
                            <div id="totalKcalDisplay" class="energy-kcal-normal">${currentNutrition.nutrients.total_kcal}</div>
                            <div id="totalKjDisplay" class="energy-kj-normal">${formatNumberForDisplay(currentNutrition.totalKj, 'kJ', true)}</div>
                        </div>
                    </div>
                `}
                
                <!-- K≈ò√ç≈ΩEK -->
                <span class="close-button" id="closeRecipeDetailModal">&times;</span>
            </div>

            <!-- SCROLLOVATELN√ù OBSAH -->
            <div class="modal-scrollable-container-with-header">
                <div id="nutrientDetailsSection"></div>
                <h3 class="ingredients-title">Slo≈æen√≠ receptu:</h3>
                <div id="recipeIngredientsList"></div>
            </div>
`;

                // Funkce pro aktualizaci zobrazen√≠
                const updateDisplay = () => {
                    currentNutrition = calculateNutritionForPortions(currentPortions);

                    // Aktualizace kalori√≠
                    document.getElementById('totalKcalDisplay').textContent = currentNutrition.nutrients.total_kcal;
                    document.getElementById('totalKjDisplay').textContent = formatNumberForDisplay(currentNutrition.totalKj, 'kJ', true);

                    // Aktualizace nutriƒçn√≠ch hodnot
                    renderAllNutrientDetails(currentNutrition.nutrients);
                };

                // OPRAVA: Event listener pro zmƒõnu poƒçtu porc√≠ - POUZE pokud element existuje
                // POZN: Poƒçet porc√≠ je nyn√≠ jen zobrazen√Ω text, ne select
                // const portionsSelect = document.getElementById('recipePortionsSelect');
                // if (portionsSelect) {
                //     portionsSelect.addEventListener('change', function () {
                //         currentPortions = parseInt(this.value);
                //         updateDisplay();
                //     });
                //     console.log("‚úÖ Event listener pro recipePortionsSelect p≈ôid√°n");
                // } else {
                //     console.log("‚ÑπÔ∏è recipePortionsSelect neexistuje - norm√°ln√≠ recept bez v√Ωbƒõru porc√≠");
                // }

                // Inicializace zobrazen√≠
                updateDisplay();

                // Zobrazen√≠ ingredienc√≠
                const ingredientsListEl = document.getElementById('recipeIngredientsList');

                // OPRAVA: P≈ôidejte kontrolu existence elementsListEl
                if (ingredientsListEl) {
                    if (ingredients.length === 0) {
                        ingredientsListEl.innerHTML = '<p style="text-align: center; color: #888;">Tento recept neobsahuje ≈æ√°dn√© potraviny.</p>';
                    } else {
                        ingredients.forEach((ingredient, index) => {
                            const ingredientItemDiv = document.createElement('div');
                            ingredientItemDiv.classList.add('recipe-ingredient-item');
                            
                            // P≈òID√ÅME T≈ò√çDU PRO VLASTN√ç RECEPT
                            const isCustomRecipe = ingredients.length === 1 && ingredient.isCustomRecipe;
                            if (isCustomRecipe) {
                                ingredientItemDiv.classList.add('custom-recipe-ingredient');
                            }

                            const ingPlaceholderImage = "{{ url_for('static', filename='icon/potraviny.png') }}";
                            let displayImageUrl = ingredient.imageUrl || ingPlaceholderImage;

                            const { number: kcalNum, unit: kcalUnit } = parseValueAndUnit(ingredient.kcal);
                            const formattedIngredientKcal = formatNumberForDisplay(kcalNum, kcalUnit, true);

                            // NAHRADTE star√© HTML ingredienc√≠ t√≠mto:
                            ingredientItemDiv.innerHTML = `
    <div class="ingredient-main-content">
        <div class="ingredient-image-wrapper">
            <img src="${displayImageUrl}" alt="${ingredient.foodName}" 
                onerror="this.onerror=null;this.src='${ingPlaceholderImage}'"
                class="ingredient-image">
        </div>
        <div class="ingredient-basic-info">
            <div class="ingredient-name" title="${ingredient.foodName}">${ingredient.foodName}</div>
            <div class="ingredient-nutrition-row">
                <span class="calorie-badge">${Math.round(ingredient.calories || kcalNum)} kcal</span>
                <span class="amount-badge">${ingredient.amount} ${ingredient.unit}</span>
            </div>
        </div>
        <div class="ingredient-actions-vertical">
            <button class="edit-ingredient-btn" data-recipe-id="${recipeId}"
                data-ingredient-index="${index}" title="Upravit ingredienci">
                <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Upravit">
            </button>
            <button class="delete-ingredient-btn" data-recipe-id="${recipeId}"
                data-ingredient-index="${index}" title="Smazat ingredienci">
                <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat">
            </button>
        </div>
    </div>
`;

                            ingredientsListEl.appendChild(ingredientItemDiv);

                            // OPRAVA: Bezpeƒçn√© p≈ôi≈ôazen√≠ event listener≈Ø pro tlaƒç√≠tka ingredienc√≠
                            const editBtn = ingredientItemDiv.querySelector('.edit-ingredient-btn');
                            if (editBtn) {
                                editBtn.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    
                                    // KONTROLA: Je to vlastn√≠ recept?
                                    const isCustomRecipe = ingredients.length === 1 && ingredients[0].isCustomRecipe;
                                    
                                    if (isCustomRecipe && recipeId) {
                                        console.log("üîß Vlastn√≠ recept - otev√≠r√°m editaci:", recipeId);
                                        // Zav≈ôeme detail receptu
                                        detailsModal.style.display = 'none';
                                        // Otev≈ôeme modal pro editaci vlastn√≠ho receptu
                                        await openCustomRecipeModalForEdit(recipeId);
                                    } else {
                                        // Bƒõ≈æn√° editace ingredience v receptu
                                        currentEditingRecipeId = e.target.closest('.edit-ingredient-btn').dataset.recipeId;
                                        currentEditingIngredientIndex = parseInt(e.target.closest('.edit-ingredient-btn').dataset.ingredientIndex);
                                        isEditingRecipeItem = true;
                                        editingRecipeContext = { recipeId: currentEditingRecipeId, recipeName: recipeName };

                                        const ingredientToEdit = ingredients[currentEditingIngredientIndex];
                                        if (ingredientToEdit) {
                                            await showDetailsModal(
                                                ingredientToEdit.slug,
                                                ingredientToEdit.foodName,
                                                ingredientToEdit.imageUrl,
                                                ingredientToEdit.kcal,
                                                ingredientToEdit.foodType,
                                                true,
                                                ingredientToEdit.amount,
                                                ingredientToEdit.unit,
                                                ingredientToEdit.nutritionalDetails
                                            );
                                        }
                                    }
                                });
                            }

                            const deleteBtn = ingredientItemDiv.querySelector('.delete-ingredient-btn');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const currentRecipeId = e.target.closest('.delete-ingredient-btn').dataset.recipeId;
                                    const ingredientIndex = parseInt(e.target.closest('.delete-ingredient-btn').dataset.ingredientIndex);
                                    const ingredientName = ingredient.foodName;
                                    deleteFoodItemFromRecipe(currentRecipeId, ingredientIndex, ingredientName, recipeName);
                                });
                            }

                            // OPRAVA: V≈°echny event listenery s kontrolou existence element≈Ø

                            // 1. K≈ô√≠≈æek pro zav≈ôen√≠
                            const closeRecipeDetailModal = document.getElementById('closeRecipeDetailModal');
                            if (closeRecipeDetailModal) {
                                closeRecipeDetailModal.addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    console.log("‚ùå Kliknuto na k≈ô√≠≈æek detailu receptu");
                                    detailsModal.style.display = 'none';
                                    window.isOpeningDetailsModal = false;
                                });
                            } else {
                                console.log("‚ùå closeRecipeDetailModal nenalezen");
                            }

                            // 2. Tlaƒç√≠tko "P≈ôidat jako j√≠dlo"
                            const addRecipeAsMealButton = document.getElementById('addRecipeAsMealButton');
                            if (addRecipeAsMealButton) {
                                addRecipeAsMealButton.addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    console.log("üçΩÔ∏è Kliknuto na P≈ôidat recept jako j√≠dlo:", recipeName);

                                    if (!checkInitialization()) return;

                                    // Ujist√≠me se, ≈æe v≈°echny nutriƒçn√≠ hodnoty maj√≠ v√Ωchoz√≠ hodnotu 0
                                    // POU≈Ω√çV√ÅME rawNutrients (ƒç√≠seln√©) m√≠sto nutrients (form√°tovan√© stringy)
                                    const raw = currentNutrition.rawNutrients || {};
                                    const safeNutrients = {
                                        total_kcal: raw.total_kcal || 0,
                                        total_kj: raw.total_kj || 0,
                                        protein: raw.protein || 0,
                                        carbs: raw.carbs || 0,
                                        sugar: raw.sugar || 0,
                                        fat: raw.fat || 0,
                                        saturated_fat: raw.saturated_fat || 0,
                                        trans_fat: raw.trans_fat || 0,
                                        monounsaturated_fat: raw.monounsaturated_fat || 0,
                                        polyunsaturated_fat: raw.polyunsaturated_fat || 0,
                                        cholesterol: raw.cholesterol || 0,
                                        fiber: raw.fiber || 0, // KL√çƒå - ƒç√≠seln√° hodnota
                                        salt: raw.salt || 0,
                                        calcium: raw.calcium || 0,
                                        sodium: raw.sodium || 0,
                                        water: raw.water || 0,
                                        phe: raw.phe || 0
                                    };
                                    
                                    const recipeFoodItem = {
                                        foodName: recipeName,
                                        slug: '',
                                        imageUrl: imageUrl,
                                        foodType: 'recept',
                                        amount: currentNutrition.totalWeight,
                                        unit: 'g',
                                        kcal: currentNutrition.nutrients.total_kcal,
                                        nutritionalDetails: safeNutrients, // POU≈ΩIJEME BEZPEƒåN√â HODNOTY
                                        isRecipe: true,
                                        recipeId: recipeId,
                                        portions: currentPortions,
                                        ingredients: ingredients
                                    };

                                    window.currentFoodItemForRecipe = recipeFoodItem;
                                    detailsModal.style.display = 'none';
                                    openSelectMealModal();
                                });
                            } else {
                                console.log("‚ùå addRecipeAsMealButton nenalezen");
                            }
                            
                            // 2b. Tlaƒç√≠tko "Upravit recept" (pouze u vlastn√≠ch recept≈Ø)
                            const editCustomRecipeButton = document.getElementById('editCustomRecipeButton');
                            if (editCustomRecipeButton) {
                                editCustomRecipeButton.addEventListener('click', async function (e) {
                                    e.stopPropagation();
                                    console.log("‚úèÔ∏è Kliknuto na Upravit vlastn√≠ recept:", recipeId);
                                    // Zav≈ôeme detail receptu
                                    detailsModal.style.display = 'none';
                                    // Otev≈ôeme modal pro editaci
                                    await openCustomRecipeModalForEdit(recipeId);
                                });
                            }

                            // 3. V√Ωbƒõr porc√≠ - POUZE pokud element existuje
                            const portionsSelect = document.getElementById('recipePortionsSelect');
                            if (portionsSelect) {
                                portionsSelect.addEventListener('change', function () {
                                    currentPortions = parseInt(this.value);
                                    updateDisplay();
                                });
                                console.log("‚úÖ Event listener pro recipePortionsSelect p≈ôid√°n");
                            } else {
                                console.log("‚ÑπÔ∏è recipePortionsSelect neexistuje - norm√°ln√≠ recept bez v√Ωbƒõru porc√≠");
                            }

                            // Inicializace zobrazen√≠
                            updateDisplay();
                        });
                    }
                } else {
                    console.log("‚ùå ingredientsListEl nenalezen - nelze zobrazit ingredience");
                }
            } catch (error) {
                console.error("Error loading recipe details:", error);
                modalDetailsContent.innerHTML = `< p class= "error-details" > Do≈°lo k chybƒõ p≈ôi naƒç√≠t√°n√≠ detail≈Ø receptu: ${error.message}</p > `;
            }
        }

        // =============================================
        // SPR√ÅVA MODAL≈Æ
        // =============================================
        function initializeDetailsModalListeners() {
            const closeButton = detailsModal.querySelector('.close-button');
            if (closeButton) {
                const newCloseButton = closeButton.cloneNode(true);
                closeButton.parentNode.replaceChild(newCloseButton, closeButton);

                newCloseButton.addEventListener('click', function (e) {
                    e.stopPropagation();
                    console.log("‚ùå Kliknuto na zav√≠rac√≠ k≈ô√≠≈æek");
                    // V≈ΩDY pou≈æijeme closeDetailsModalAndRestoreRecipe - ta se postar√° o obnoven√≠ receptu pokud je to editace
                    closeDetailsModalAndRestoreRecipe();
                });
            }

            detailsModal.addEventListener('click', function (event) {
                if (event.target.classList.contains('close-button') || event.target.closest('.close-button')) return;

                if (event.target === detailsModal) {
                    console.log("‚ùå Kliknuto mimo modal");
                    if (isEditingRecipeItem) {
                        console.log("üìù Editace - speci√°ln√≠ zav√≠r√°n√≠");
                        // Pro editaci pou≈æijeme na≈°i speci√°ln√≠ funkci
                        closeDetailsModalAndRestoreRecipe();
                    } else {
                        // Pro norm√°ln√≠ zobrazen√≠ jednodu≈°e zav≈ôeme
                        detailsModal.style.display = 'none';
                        window.isOpeningDetailsModal = false;
                    }
                }
            });
        }

        async function closeDetailsModalAndRestoreRecipe() {
            if (window.closeDetailsModalCalled) return;
            window.closeDetailsModalCalled = true;

            console.log("üî¥ Zav√≠r√°m detailn√≠ modal - editace:", isEditingRecipeItem);

            // Ulo≈æ√≠me si kontext p≈ôed resetem
            const wasEditing = isEditingRecipeItem;
            const recipeIdToRestore = currentEditingRecipeId;
            const recipeNameToRestore = editingRecipeContext?.recipeName || "Recept";

            // OKAM≈ΩITƒö zav≈ôeme modal
            detailsModal.style.display = 'none';

            // OKAM≈ΩITƒö resetujeme stav
            isEditingRecipeItem = false;
            editingRecipeContext = null;
            currentEditingRecipeId = null;
            currentEditingIngredientIndex = null;

            // Odstran√≠me event listener
            const existingHandler = detailsModal._editClickOutsideHandler;
            if (existingHandler) {
                detailsModal.removeEventListener('click', existingHandler);
                detailsModal._editClickOutsideHandler = null;
            }

            // D≈ÆLE≈ΩIT√â: Pokud jsme byli v editaci, v≈ædy obnov√≠me recept
            if (wasEditing && recipeIdToRestore) {
                console.log("üîÑ Obnovuji recept po editaci:", recipeIdToRestore);
                try {
                    // Kr√°tk√© zpo≈ædƒõn√≠ pro zaji≈°tƒõn√≠ ƒçist√©ho p≈ôechodu
                    setTimeout(async () => {
                        await showRecipeDetailsModal(recipeIdToRestore, recipeNameToRestore);
                    }, 100);
                } catch (error) {
                    console.error("‚ùå Chyba p≈ôi zobrazov√°n√≠ detailu receptu:", error);
                }
            }

            setTimeout(() => {
                window.closeDetailsModalCalled = false;
            }, 300);
        }

        function initializeRecipeListListeners() {
            const recipeItems = document.querySelectorAll('.recipe-list-item');
            recipeItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    if (e.target.classList.contains('recipe-delete-icon') || e.target.closest('.recipe-actions')) return;
                    const recipeId = this.querySelector('.recipe-delete-icon')?.dataset.recipeId;
                    const recipeName = this.querySelector('.recipe-name').textContent;
                    document.getElementById('selectRecipeModal').style.display = 'none';
                    openRecipeDetail(recipeId, recipeName);
                });
            });
        }

        function initializeSettingsSections() {
            const sectionHeaders = document.querySelectorAll('.setting-section-header');
            sectionHeaders.forEach((header, index) => {
                header.replaceWith(header.cloneNode(true));
                const newHeader = document.querySelectorAll('.setting-section-header')[index];

                newHeader.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const content = this.nextElementSibling;
                    const arrow = this.querySelector('.setting-section-arrow');

                    if (content && content.classList.contains('setting-section-content')) {
                        const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';

                        if (isOpen) {
                            content.style.maxHeight = "0";
                            content.style.opacity = "0";
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            content.style.opacity = "1";
                            if (arrow) arrow.style.transform = 'rotate(180deg)';
                        }
                    }
                });

                const content = newHeader.nextElementSibling;
                const arrow = newHeader.querySelector('.setting-section-arrow');

                if (content && content.classList.contains('setting-section-content')) {
                    content.style.maxHeight = "0";
                    content.style.opacity = "0";
                    content.style.transition = 'max-height 0.3s ease, opacity 0.3s ease';
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                }
            });
        }

        function collapseAllSettingsSections() {
            const sectionHeaders = document.querySelectorAll('.setting-section-header');
            let foundOpen = false;

            sectionHeaders.forEach(header => {
                const content = header.nextElementSibling;
                const arrow = header.querySelector('.setting-section-arrow');

                if (content && content.classList.contains('setting-section-content')) {
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
                    if (isOpen) {
                        content.style.maxHeight = "0";
                        content.style.opacity = "0";
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                        header.classList.remove('active');
                        foundOpen = true;
                    }
                }
            });

            return foundOpen;
        }

        function setupModalCloseHandlers() {
            document.getElementById('closeSettingsModal').addEventListener('click', function () {
                collapseAllSettingsSections();
                setTimeout(() => {
                    document.getElementById('settingsModal').style.display = 'none';
                }, 100);
            });

            document.getElementById('settingsModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    const hadOpenSections = collapseAllSettingsSections();
                    const delay = hadOpenSections ? 150 : 0;
                    setTimeout(() => {
                        this.style.display = 'none';
                    }, delay);
                }
            });

            const modals = [
                'profileModal', 'createProfileModal', 'selectRecipeModal', 'createRecipeModal'
            ];

            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function (event) {
                        if (event.target === this) {
                            this.style.display = 'none';
                            if (modalId === 'profileModal') {
                                window.isProfileModalShowing = false;
                            }
                        }
                    });
                }
            });
        }

        // =============================================
        // VALIDACE A KONTROLY
        // =============================================
        function checkInitialization() {
            if (!window.isAppInitialized) {
                window.showCustomNotification("Pros√≠m, poƒçkejte, ne≈æ se aplikace plnƒõ inicializuje.", 'info');
                return false;
            }

            if (!window.currentUser) {
                window.showCustomNotification("Pro tuto akci se mus√≠te p≈ôihl√°sit.", 'info');
                return false;
            }

            if (!window.currentProfileId) {
                window.showCustomNotification("Pro tuto akci si mus√≠te vybrat profil.", 'info');
                return false;
            }

            if (!window.userProfiles || window.userProfiles.length === 0) {
                window.showCustomNotification("Pro tuto akci pot≈ôebujete m√≠t vytvo≈ôen√Ω profil.", 'info');
                return false;
            }

            if (!window.supabaseClient) {
                window.showCustomNotification("Chyba datab√°ze. Zkuste obnovit str√°nku.", 'error');
                return false;
            }

            return true;
        }

        // =============================================
        // SKENOV√ÅN√ç ƒå√ÅROV√ùCH K√ìD≈Æ
        // =============================================

        // ZLEP≈†EN√Å FUNKCE PRO SPU≈†TƒöN√ç SKEN√âRU
        async function startModernBarcodeScanner() {
            if (!window.barcodeDetector) {
                const supported = await initModernBarcodeScanner();
                if (!supported) return;
            }

            try {
                // Z√≠sk√°n√≠ p≈ô√≠stupu ke kame≈ôe
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                const video = document.getElementById('barcodeVideo');
                video.srcObject = stream;
                video.style.display = 'block';

                // ƒåek√°n√≠ na naƒçten√≠ videa
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(resolve).catch(resolve);
                    };
                });

                barcodeScannerActive = true;
                startBarcodeDetection();

            } catch (error) {
                console.error('Chyba p≈ôi p≈ô√≠stupu ke kame≈ôe:', error);
                showBarcodeError('Nelze z√≠skat p≈ô√≠stup ke kame≈ôe: ' + error.message);
            }
        }

        // ZAƒå√ÅTEK DETEKCE (zat√≠m placeholder)
        function startBarcodeDetection() {
            const status = document.getElementById('barcodeStatus');
            const video = document.getElementById('barcodeVideo');

            status.textContent = 'üîç Skenuji... Nami≈ôte na ƒç√°rov√Ω k√≥d';

            // Kontrola podpory Barcode Detection API
            if (!('BarcodeDetector' in window)) {
                status.textContent = 'üì± V√°≈° prohl√≠≈æeƒç nepodporuje automatick√© skenov√°n√≠. Pou≈æijte ruƒçn√≠ zad√°n√≠.';
                return;
            }

            try {
                // Vytvo≈ôen√≠ detektoru
                const barcodeDetector = new BarcodeDetector({
                    formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39']
                });

                startBarcodeDetectionLoop(barcodeDetector, video, status);

            } catch (error) {
                console.error('Chyba p≈ôi vytv√°≈ôen√≠ BarcodeDetector:', error);
                status.textContent = '‚ùå Chyba skenov√°n√≠. Pou≈æijte ruƒçn√≠ zad√°n√≠.';
            }
        }

        // SKUTEƒåN√Å DETEKCE V RE√ÅLN√âM ƒåASE
        function startBarcodeDetectionLoop(barcodeDetector, video, status) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let lastDetectedCode = '';
            let detectionCount = 0;

            const detectFrame = async () => {
                if (!barcodeScanningActive || video.readyState !== video.HAVE_ENOUGH_DATA) {
                    return;
                }

                try {
                    // Nastaven√≠ canvasu podle videa
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // Detekce ƒç√°rov√Ωch k√≥d≈Ø
                    const barcodes = await barcodeDetector.detect(canvas);

                    if (barcodes.length > 0) {
                        const barcode = barcodes[0];

                        // Kontrola, zda je to nov√Ω k√≥d (aby se neopakovalo)
                        if (barcode.rawValue !== lastDetectedCode) {
                            lastDetectedCode = barcode.rawValue;
                            detectionCount++;

                            // Vizualn√≠ potvrzen√≠
                            status.textContent = `‚úÖ Nalezen k√≥d: ${barcode.rawValue} `;
                            status.style.color = '#28a745';

                            // Zvukov√Ω feedback (voliteln√©)
                            playDetectionSound();

                            // Po 2 sekund√°ch zpracujeme k√≥d
                            setTimeout(() => {
                                processDetectedBarcode(barcode.rawValue);
                            }, 2000);

                            return; // P≈ôestaneme skenovat po nalezen√≠ k√≥du
                        }
                    }

                    // Pokraƒçujeme v detekci
                    if (barcodeScanningActive) {
                        requestAnimationFrame(detectFrame);
                    }

                } catch (error) {
                    console.error('Chyba p≈ôi detekci:', error);
                    if (barcodeScanningActive) {
                        requestAnimationFrame(detectFrame);
                    }
                }
            };

            // Spu≈°tƒõn√≠ detekce
            detectFrame();
        }

        // ZPRACOV√ÅN√ç NALEZEN√âHO K√ìDU
        function processDetectedBarcode(barcode) {
            console.log('üéØ Zpracov√°v√°m nalezen√Ω k√≥d:', barcode);

            // Zastav√≠me skenov√°n√≠
            barcodeScanningActive = false;

            // Zav≈ôeme modal a vyhled√°me
            closeBarcodeScanner();
            searchByBarcode(barcode);
        }

        // ZVUKOV√ù FEEDBACK (voliteln√©)
        function playDetectionSound() {
            try {
                // Jednoduch√Ω beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

            } catch (error) {
                console.log('Zvuk nelze p≈ôehr√°t');
            }
        }

        // ZPRACOV√ÅN√ç NALEZEN√âHO K√ìDU
        function handleDetectedBarcode(barcode, status) {
            console.log('üéØ Nalezen k√≥d:', barcode);

            status.innerHTML = `
                ‚úÖ <strong>K√≥d nalezen: ${barcode}</strong><br>
                <small>Zpracov√°v√°m...</small>
            `;
            status.style.color = '#28a745';

            // Vizualn√≠ potvrzen√≠
            flashOverlay();

            // Zpracov√°n√≠ po kr√°tk√© dobƒõ
            setTimeout(() => {
                barcodeScanningActive = false;
                closeBarcodeScanner();
                searchByBarcode(barcode);
            }, 1500);
        }

        // VIZU√ÅLN√ç EFEKTY PRO LEP≈†√ç UX
        function addScanningEffects() {
            const overlay = document.querySelector('.barcode-overlay');
            if (overlay) {
                // P≈ôid√°me animovanou ƒç√°ru
                const scanLine = document.createElement('div');
                scanLine.className = 'scan-line';
                overlay.appendChild(scanLine);

                // Pulzuj√≠c√≠ efekt
                overlay.style.animation = 'pulse 2s infinite';
            }
        }

        function flashOverlay() {
            const overlay = document.querySelector('.barcode-overlay');
            if (overlay) {
                overlay.style.background = '#4CAF50';
                overlay.style.transition = 'background 0.3s';

                setTimeout(() => {
                    overlay.style.background = 'rgba(0, 0, 0, 0.3)';
                }, 300);
            }
        }

        // ZASTAVEN√ç SKEN√âRU
        function stopBarcodeScanner() {
            barcodeScannerActive = false;

            if (barcodeDetectionInterval) {
                clearInterval(barcodeDetectionInterval);
                barcodeDetectionInterval = null;
            }

            const video = document.getElementById('barcodeVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // FALLBACK PRO RUƒåN√ç ZAD√ÅN√ç
        function showBarcodeFallback() {
            const container = document.getElementById('barcodeScannerContainer');
            container.innerHTML = `
                <div class="barcode-placeholder">
                    <p>üîí Skenov√°n√≠ nen√≠ dostupn√©</p>
                    <p>Pou≈æijte pros√≠m ruƒçn√≠ zad√°n√≠ k√≥du n√≠≈æe</p>
                </div>
            `;
        }

        // ZPRACOV√ÅN√ç CHYB KAMERY
        function getCameraErrorMessage(error) {
            switch (error.name) {
                case 'NotAllowedError':
                    return 'P≈ô√≠stup ke kame≈ôe byl odep≈ôen. Povolte kameru v nastaven√≠ prohl√≠≈æeƒçe.';
                case 'NotFoundError':
                    return 'Nebyla nalezena ≈æ√°dn√° kamera.';
                case 'NotSupportedError':
                    return 'V√°≈° prohl√≠≈æeƒç nepodporuje p≈ô√≠stup ke kame≈ôe.';
                case 'NotReadableError':
                    return 'Kamera je ji≈æ pou≈æ√≠van√° jinou aplikac√≠.';
                default:
                    return 'Nelze spustit kameru: ' + error.message;
            }
        }

        // TLAƒå√çTKO PRO AKCI (pro iPhone)
        function addBarcodeActionButton() {
            const controls = document.querySelector('.barcode-controls');
            if (!document.getElementById('startScanButton')) {
                const scanButton = document.createElement('button');
                scanButton.id = 'startScanButton';
                scanButton.className = 'btn-primary';

                // Detekce za≈ô√≠zen√≠
                const isIPhone = /iPhone|iPad|iPod/.test(navigator.userAgent);

                if (isIPhone) {
                    scanButton.textContent = 'üì± Skenovat (iPhone)';
                    scanButton.onclick = startIPhoneBarcodeDetection;
                } else {
                    scanButton.textContent = 'üéØ Skenovat';
                    scanButton.onclick = startUniversalBarcodeDetection;
                }

                controls.appendChild(scanButton);
            }
        }

        // FUNKCE PRO KONTROLU PODPORY PROHL√ç≈ΩEƒåE
        function checkBarcodeSupport() {
            const status = document.getElementById('barcodeStatus');

            if (!('BarcodeDetector' in window)) {
                status.innerHTML = `
            üì± <strong>Automatick√© skenov√°n√≠ nen√≠ podporov√°no</strong><br>
            <small>Pou≈æijte ruƒçn√≠ zad√°n√≠ k√≥du n√≠≈æe</small>
        `;
                return false;
            }

            status.textContent = '‚úÖ Automatick√© skenov√°n√≠ je p≈ôipraveno';
            return true;
        }

        // INICIALIZACE EVENT LISTENER≈Æ
        function initBarcodeScanner() {
            console.log("üîÑ Inicializuji nov√Ω sken√©r ƒç√°rov√Ωch k√≥d≈Ø");

            // Tlaƒç√≠tko pro otev≈ôen√≠ sken√©ru
            document.getElementById('barcodeButtonInModal').addEventListener('click', openBarcodeScanner);

            // Zav√≠rac√≠ tlaƒç√≠tko
            document.getElementById('closeBarcodeModal').addEventListener('click', closeBarcodeScanner);

            // P≈ôep√≠n√°n√≠ kamery
            document.getElementById('toggleCameraButton').addEventListener('click', toggleCamera);

            // Ruƒçn√≠ zad√°n√≠
            document.getElementById('submitManualBarcode').addEventListener('click', submitManualBarcode);

            // Enter v ruƒçn√≠m zad√°n√≠
            document.getElementById('manualBarcodeInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    submitManualBarcode();
                }
            });

            // Kliknut√≠ mimo modal
            document.getElementById('barcodeModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    closeBarcodeScanner();
                }
            });
        }

        /*function initQuagga() {
            if (typeof Quagga !== 'undefined') {
                try {
                        Quagga.init({
                            inputStream: {
                                name: "Live",
                                type: "LiveStream",
                                target: document.getElementById('barcodeVideo'),
                                constraints: {
                                    width: 1280,
                                    height: 720,
                                    facingMode: barcodeFacingMode,
                                    aspectRatio: { min: 1, max: 2 }
                                },
                            },
                            decoder: {
                                readers: ["ean_reader", "ean_8_reader"],
                                multiple: false,
                                resolution: 800,
                                patchSize: "x-large",
                            },
                            locator: {
                                patchSize: "large",
                                halfSample: true,
                                debug: {
                                    showCanvas: false,
                                    showPatches: false,
                                    showFoundPatches: false,
                                    showSkeleton: false
                                }
                            },
                            preprocessor: {
                                contrast: { min: 32, max: 220 },
                                sharpen: { flat: 1.0, jagged: 2.0 }
                            },
                            frequency: 5,
                            numOfWorkers: 2,
                            debug: false
                        }, function (err) {
                            if (err) {
                                console.error("Chyba p≈ôi inicializaci Quagga:", err);
                                document.getElementById('barcodeStatus').textContent = 'Nepoda≈ôilo se inicializovat skener';
                                document.getElementById('barcodeStatus').style.color = 'red';
                                return;
                            }

                            quaggaInitialized = true;
                            Quagga.onDetected(function (result) {
                                if (result && result.codeResult && result.codeResult.code) {
                                    if (result.codeResult.confidence !== undefined && result.codeResult.confidence < 0.3) return;
                                    handleBarcodeDetected(result.codeResult.code, result);
                                }
                            });
                        });
                } catch (error) {
                        console.error('V√Ωjimka p≈ôi inicializaci Quaggy:', error);
                }
            }
        }*/

        // UNIVERZ√ÅLN√ç DETEKCE ƒå√ÅROV√ùCH K√ìD≈Æ PRO V≈†ECHNA ZA≈ò√çZEN√ç
        function startUniversalBarcodeDetection() {
            const status = document.getElementById('barcodeStatus');
            const video = document.getElementById('barcodeVideo');

            status.textContent = 'üîç Skenuji... Nami≈ôte na ƒç√°rov√Ω k√≥d';

            // 1. NEJPRVE ZKUS√çME MODERN√ç API (pro Android/nov√Ω Safari)
            if ('BarcodeDetector' in window) {
                try {
                    const barcodeDetector = new BarcodeDetector({
                        formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39']
                    });
                    startModernDetection(barcodeDetector, video, status);
                    return;
                } catch (error) {
                    console.log('Modern√≠ API selhalo, pou≈æ√≠v√°me fallback');
                }
            }

            // 2. POKUD MODERN√ç API NEFUNGUJE, POU≈ΩIJEME ZRCADLOV√ù N√ÅHLED
            status.innerHTML = `
                    üì± <strong>Automatick√© skenov√°n√≠</strong><br>
                        <small>Nam√≠≈ôejte k√≥d do zelen√©ho r√°meƒçku. K√≥d se zobraz√≠ v n√°hledu.</small>
                        `;
            startMirrorPreviewDetection(video, status);
        }

        // MODERN√ç DETEKCE PRO ANDROID/NOV√Å ZA≈ò√çZEN√ç
        function startModernDetection(barcodeDetector, video, status) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let lastDetectedCode = '';

            const detectFrame = async () => {
                if (!barcodeScanningActive || video.readyState !== video.HAVE_ENOUGH_DATA) return;

                try {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const barcodes = await barcodeDetector.detect(canvas);

                    if (barcodes.length > 0) {
                        const barcode = barcodes[0];
                        if (barcode.rawValue !== lastDetectedCode) {
                            lastDetectedCode = barcode.rawValue;
                            handleDetectedBarcode(barcode.rawValue, status);
                            return;
                        }
                    }

                    if (barcodeScanningActive) requestAnimationFrame(detectFrame);
                } catch (error) {
                    if (barcodeScanningActive) requestAnimationFrame(detectFrame);
                }
            };

            detectFrame();
        }

        // ZRCADLOV√ù N√ÅHLED PRO iPHONE/STAR≈†√ç ZA≈ò√çZEN√ç
        function startMirrorPreviewDetection(video, status) {
            // P≈ôid√°me instrukce p≈ô√≠mo do overlay
            const overlay = document.querySelector('.barcode-overlay');
            if (overlay) {
                overlay.innerHTML = `
            <div style="text-align: center; color: white;">
                <div style="font-size: 24px; margin-bottom: 10px;">üì∑</div>
                <div><strong>Nam√≠≈ôejte k√≥d sem</strong></div>
                <div style="font-size: 12px; margin-top: 5px;">K√≥d se zobraz√≠ v n√°hledu</div>
            </div>
        `;
            }

            // U≈æivatel uvid√≠ k√≥d p≈ô√≠mo v n√°hledu a m≈Ø≈æe ho opsat
            status.innerHTML = `
                        üëÅÔ∏è <strong>Zrcadlov√Ω n√°hled aktivn√≠</strong><br>
                            <small>P≈ôeƒçtƒõte ƒç√°rov√Ω k√≥d z obrazovky a zadejte jej ruƒçnƒõ</small>
                            `;

            // M≈Ø≈æeme p≈ôidat zv√Ωraznƒõn√≠ oblasti
            addScanningEffects();
        }

        // Z√ÅKLADN√ç FUNKCE PRO SKENOV√ÅN√ç
        async function openBarcodeScanner() {
            console.log("üîç Otev√≠r√°m sken√©r ƒç√°rov√Ωch k√≥d≈Ø");

            const modal = document.getElementById('barcodeModal');
            const container = document.getElementById('barcodeScannerContainer');
            const status = document.getElementById('barcodeStatus');

            modal.style.display = 'flex';

            // Detekce za≈ô√≠zen√≠
            const isIPhone = /iPhone|iPad|iPod/.test(navigator.userAgent);

            if (isIPhone) {
                status.innerHTML = 'üì± <strong>P≈ôipravuji skenov√°n√≠ pro iPhone</strong>';
            } else {
                status.textContent = 'Inicializuji kameru...';
            }

            try {
                const video = document.createElement('video');
                video.id = 'barcodeVideo';
                video.playsInline = true;
                video.muted = true;

                const overlay = document.createElement('div');
                overlay.className = 'barcode-overlay';

                if (isIPhone) {
                    /*   overlay.innerHTML = `
                           <div style="text-align: center; color: white;">
                               <div style="font-size: 24px; margin-bottom: 10px;">üì±</div>
                               <div><strong>iPhone Skenov√°n√≠</strong></div>
                               <div style="font-size: 12px; margin-top: 5px;">Optimalizov√°no pro iOS</div>
                           </div>
                       `;*/
                } else {
                    overlay.innerHTML = 'üì∑ P≈ôipravuji skenov√°n√≠...';
                }

                container.innerHTML = '';
                container.appendChild(video);
                container.appendChild(overlay);

                await startCamera(video);

                if (isIPhone) {
                    status.innerHTML = `
                        ‚úÖ <strong>iPhone kamera p≈ôipravena</strong><br>
                        <small>Kliknƒõte na "Skenovat (iPhone)"</small>
                    `;
                } else {
                    status.innerHTML = `
                        ‚úÖ <strong>Kamera p≈ôipravena</strong><br>
                        <small>Kliknƒõte na "Skenovat"</small>
                    `;
                }

                addBarcodeActionButton();

            } catch (error) {
                console.error("‚ùå Chyba:", error);
                status.textContent = '‚ùå ' + error.message;
                showBarcodeFallback();
            }
        }

        // SPECIALIZOVAN√â ≈òE≈†EN√ç PRO iPHONE
        function startIPhoneBarcodeDetection() {
            const status = document.getElementById('barcodeStatus');
            const video = document.getElementById('barcodeVideo');

            status.innerHTML = 'üì± <strong>iPhone skenov√°n√≠</strong><br><small>Vysok√° p≈ôesnost - poƒçkejte na potvrzen√≠</small>';

            // Resetujeme stav detekce
            window.barcodeDetectionState = {
                detectedCodes: new Map(),
                lastValidCode: null,
                confidenceThreshold: 0.7,
                minDetectionCount: 2
            };

            if ('BarcodeDetector' in window) {
                try {
                    const barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a'] });
                    startHighAccuracyDetection(barcodeDetector, video, status);
                    return;
                } catch (error) {
                    console.log('Native API selhalo:', error);
                }
            }

            loadQuaggaForIPhone(video, status);
        }

        // VYSOCE P≈òESN√Å DETEKCE
        function startHighAccuracyDetection(barcodeDetector, video, status) {
            let detectionCount = 0;
            let lastStableCode = null;
            let sameCodeCount = 0;

            const detectFrame = async () => {
                if (!barcodeScanningActive) return;

                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const barcodes = await barcodeDetector.detect(canvas);

                    if (barcodes.length > 0) {
                        const barcode = barcodes[0];

                        // FILTRACE 1: Pouze validn√≠ EAN/UPC k√≥dy
                        if (isValidBarcodeFormat(barcode.rawValue)) {

                            // FILTRACE 2: Stejn√Ω k√≥d mus√≠ b√Ωt detekov√°n v√≠cekr√°t
                            if (barcode.rawValue === lastStableCode) {
                                sameCodeCount++;

                                // VIZU√ÅLN√ç INDIK√ÅTOR SPOLEHLIVOSTI
                                updateConfidenceIndicator(status, sameCodeCount);

                                // FILTRACE 3: Alespo≈à 3x stejn√Ω k√≥d
                                if (sameCodeCount >= 3) {
                                    handleHighConfidenceBarcode(barcode.rawValue, status);
                                    return;
                                }
                            } else {
                                // Nov√Ω k√≥d - reset counteru
                                lastStableCode = barcode.rawValue;
                                sameCodeCount = 1;
                                status.innerHTML = `üîç <strong>Detekov√°n: ${barcode.rawValue}</strong><br><small>Udr≈æte k√≥d stabiln√≠...</small>`;
                            }
                        }
                    }

                    detectionCount++;

                    // Pravideln√© ƒçi≈°tƒõn√≠ pamƒõti
                    if (detectionCount % 50 === 0) {
                        lastStableCode = null;
                        sameCodeCount = 0;
                    }

                    if (barcodeScanningActive) {
                        setTimeout(() => detectFrame(), 200);
                    }

                } catch (error) {
                    if (barcodeScanningActive) {
                        setTimeout(() => detectFrame(), 300);
                    }
                }
            };

            detectFrame();
        }

        // VALIDACE FORM√ÅTU ƒå√ÅROV√âHO K√ìDU
        function isValidBarcodeFormat(code) {
            if (!code || typeof code !== 'string') return false;

            const cleanCode = code.replace(/\D/g, '');

            // EAN-13: 13 ƒç√≠slic
            if (/^\d{13}$/.test(cleanCode)) {
                return validateEAN13(cleanCode);
            }

            // EAN-8: 8 ƒç√≠slic
            if (/^\d{8}$/.test(cleanCode)) {
                return validateEAN8(cleanCode);
            }

            // UPC-A: 12 ƒç√≠slic
            if (/^\d{12}$/.test(cleanCode)) {
                return validateUPCA(cleanCode);
            }

            return false;
        }

        // VALIDACE EAN-13 KONTROLN√ç ƒå√çSLICE
        function validateEAN13(code) {
            if (code.length !== 13) return false;

            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
            }
            const checksum = (10 - (sum % 10)) % 10;

            return checksum === parseInt(code[12]);
        }

        // VALIDACE EAN-8
        function validateEAN8(code) {
            if (code.length !== 8) return false;

            let sum = 0;
            for (let i = 0; i < 7; i++) {
                sum += parseInt(code[i]) * (i % 2 === 0 ? 3 : 1);
            }
            const checksum = (10 - (sum % 10)) % 10;

            return checksum === parseInt(code[7]);
        }

        // VALIDACE UPC-A
        function validateUPCA(code) {
            if (code.length !== 12) return false;

            let sum = 0;
            for (let i = 0; i < 11; i++) {
                sum += parseInt(code[i]) * (i % 2 === 0 ? 3 : 1);
            }
            const checksum = (10 - (sum % 10)) % 10;

            return checksum === parseInt(code[11]);
        }

        // VIZU√ÅLN√ç INDIK√ÅTOR SPOLEHLIVOSTI
        function updateConfidenceIndicator(status, count) {
            const confidenceLevel = Math.min(count / 3, 1);
            const percentage = Math.round(confidenceLevel * 100);

            let color, emoji;
            if (confidenceLevel < 0.33) {
                color = '#dc3545';
                emoji = 'üî¥';
            } else if (confidenceLevel < 0.66) {
                color = '#ffc107';
                emoji = 'üü°';
            } else {
                color = '#28a745';
                emoji = 'üü¢';
            }

            status.innerHTML = `
                                    ${emoji} <strong style="color: ${color};">Spolehlivost: ${percentage}%</strong><br>
                                        <small>Udr≈æte k√≥d stabiln√≠ pro automatick√© zpracov√°n√≠</small>
                                        `;
        }

        // ZPRACOV√ÅN√ç VYSOCE SPOLEHLIV√âHO K√ìDU
        function handleHighConfidenceBarcode(barcode, status) {
            console.log('üéØ Vysok√° spolehlivost k√≥du:', barcode);

            status.innerHTML = `
                                        ‚úÖ <strong style="color: #28a745; font-size: 1.1em;">K√ìD POTVRZEN!</strong><br>
                                            <small>${barcode} - otev√≠r√°m vyhled√°v√°n√≠...</small>
                                            `;

            playIPhoneDetectionSound();
            barcodeScanningActive = false;

            // Vizu√°ln√≠ potvrzen√≠ p≈ôed p≈ôechodem
            flashOverlaySuccess();

            setTimeout(() => {
                closeBarcodeScanner();
                openSearchWithBarcode(barcode);
            }, 1000);
        }

        // NATIVN√ç DETEKCE PRO iPHONE
        function startIPhoneNativeDetection(barcodeDetector, video, status) {
            status.innerHTML = 'üîç <strong>Automatick√© skenov√°n√≠</strong><br><small>Nam√≠≈ôejte na ƒç√°rov√Ω k√≥d</small>';

            const detectFrame = async () => {
                if (!barcodeScanningActive) return;

                try {
                    // Vytvo≈ô√≠me canvas z videa
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // Detekce ƒç√°rov√Ωch k√≥d≈Ø
                    const barcodes = await barcodeDetector.detect(canvas);

                    if (barcodes.length > 0) {
                        const barcode = barcodes[0];
                        handleIPhoneDetectedBarcode(barcode.rawValue, status);
                        return;
                    }

                    // Pokraƒçujeme v detekci
                    if (barcodeScanningActive) {
                        setTimeout(() => detectFrame(), 300); // Pomalej≈°√≠ pro iPhone
                    }

                } catch (error) {
                    console.log('iPhone detekce chyba:', error);
                    if (barcodeScanningActive) {
                        setTimeout(() => detectFrame(), 500);
                    }
                }
            };

            detectFrame();
        }

        // JAVASCRIPT DETEKCE PRO STAR≈†√ç iPHONE
        function startIPhoneJavascriptDetection(video, status) {
            status.innerHTML = `
                üì± <strong>Optimalizovan√© pro iPhone</strong><br>
                <small>Pomalej≈°√≠, ale spolehliv√© skenov√°n√≠</small>
            `;

            // Pou≈æijeme Quagga.js, kter√° m√° lep≈°√≠ podporu pro iOS
            loadQuaggaForIPhone(video, status);
        }

        // NAƒåTEN√ç QUAGGA PRO iPHONE
        function loadQuaggaForIPhone(video, status) {
            // Kontrola, zda je Quagga ji≈æ naƒçtena
            if (typeof Quagga === 'undefined') {
                status.innerHTML = 'üì• <strong>Naƒç√≠t√°m skenovac√≠ engine...</strong>';

                // Dynamick√© naƒçten√≠ Quagga
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js';
                script.onload = () => {
                    initializeQuaggaForIPhone(video, status);
                };
                script.onerror = () => {
                    status.innerHTML = '‚ùå <strong>Nelze naƒç√≠st skenovac√≠ engine</strong><br><small>Pou≈æijte ruƒçn√≠ zad√°n√≠</small>';
                };
                document.head.appendChild(script);
            } else {
                initializeQuaggaForIPhone(video, status);
            }
        }

        // INICIALIZACE QUAGGA PRO iPHONE
        // VYLEP≈†EN√Å QUAGGA PRO VY≈†≈†√ç P≈òESNOST
        function initializeQuaggaForIPhone(video, status) {
            status.innerHTML = 'üîç <strong>Vysokop≈ôesn√© skenov√°n√≠</strong><br><small>Nam√≠≈ôte na ƒç√°rov√Ω k√≥d</small>';

            try {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            facingMode: "environment",
                            width: { min: 640, ideal: 1280, max: 1920 },
                            height: { min: 480, ideal: 720, max: 1080 },
                            aspectRatio: { min: 1, max: 2 }
                        },
                        area: {
                            top: "25%",
                            right: "10%",
                            left: "10%",
                            bottom: "25%"
                        }
                    },
                    decoder: {
                        readers: [
                            "ean_reader",
                            "ean_8_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ],
                        multiple: false
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    locate: true,
                    frequency: 5, // Pomalej≈°√≠ = p≈ôesnƒõj≈°√≠
                    numOfWorkers: 1, // M√©nƒõ worker≈Ø = stabilnƒõj≈°√≠
                    debug: {
                        drawBoundingBox: false,
                        showFrequency: false,
                        drawScanline: false,
                        showPattern: false
                    }
                }, function (err) {
                    if (err) {
                        console.error('Quagga chyba:', err);
                        status.innerHTML = '‚ùå <strong>Skenov√°n√≠ selhalo</strong>';
                        return;
                    }

                    console.log('Quagga √∫spƒõ≈°nƒõ inicializov√°na - vysok√° p≈ôesnost');
                    Quagga.start();

                    // VYLEP≈†EN√Å DETEKCE S FILTRAC√ç
                    let lastCode = '';
                    let codeCount = 0;

                    Quagga.onDetected(function (result) {
                        if (result && result.codeResult && result.codeResult.code) {
                            const currentCode = result.codeResult.code;

                            // FILTRACE: Stejn√Ω k√≥d mus√≠ b√Ωt detekov√°n 2x
                            if (currentCode === lastCode) {
                                codeCount++;

                                if (codeCount >= 2 && isValidBarcodeFormat(currentCode)) {
                                    Quagga.offDetected();
                                    handleHighConfidenceBarcode(currentCode, status);
                                }
                            } else {
                                lastCode = currentCode;
                                codeCount = 1;
                            }
                        }
                    });
                });

            } catch (error) {
                console.error('Chyba inicializace Quagga:', error);
                status.innerHTML = '‚ùå <strong>Skenov√°n√≠ nelze spustit</strong>';
            }
        }

        // VIZU√ÅLN√ç POTVRZEN√ç √öSPƒöCHU
        function flashOverlaySuccess() {
            const overlay = document.querySelector('.barcode-overlay');
            if (overlay) {
                overlay.style.background = '#28a745';
                overlay.style.transition = 'all 0.5s ease';
                overlay.innerHTML = `
                                            <div style="text-align: center; color: white;">
                                                <div style="font-size: 32px; margin-bottom: 10px;">‚úÖ</div>
                                                <div><strong>√öSPƒöCH!</strong></div>
                                                <div style="font-size: 12px; margin-top: 5px;">K√≥d potvrzen</div>
                                            </div>
                                            `;

                setTimeout(() => {
                    if (overlay) {
                        overlay.style.background = 'rgba(0, 0, 0, 0.3)';
                    }
                }, 800);
            }
        }

        // ZPRACOV√ÅN√ç NALEZEN√âHO K√ìDU NA iPHONE
        function handleIPhoneDetectedBarcode(barcode, status) {
            console.log('üì± iPhone nalezen k√≥d:', barcode);

            // Vizualn√≠ potvrzen√≠
            status.innerHTML = `
                                            ‚úÖ <strong style="color: #28a745;">K√≥d nalezen!</strong><br>
                                                <small>${barcode} - otev√≠r√°m vyhled√°v√°n√≠...</small>
                                                `;

            // Zvukov√Ω feedback
            playIPhoneDetectionSound();

            // Zastav√≠me skenov√°n√≠
            if (typeof Quagga !== 'undefined' && Quagga) {
                Quagga.stop();
            }
            barcodeScanningActive = false;

            // OKAM≈ΩIT√â ZAV≈òEN√ç SKEN√âRU A OTEVREN√ç VYHLED√ÅV√ÅN√ç
            setTimeout(() => {
                closeBarcodeScanner();
                openSearchWithBarcode(barcode); // ‚Üê NOV√Å FUNKCE
            }, 800); // Kr√°tk√° prodleva pro UX
        }

        // NOV√Å FUNKCE PRO OTEVREN√ç VYHLED√ÅV√ÅN√ç S K√ìDEM
        function openSearchWithBarcode(barcode) {
            console.log("üîç Otev√≠r√°m vyhled√°v√°n√≠ s k√≥dem:", barcode);

            // 1. Otev≈ôeme vyhled√°vac√≠ modal
            const searchModal = document.getElementById('searchModal');
            if (searchModal) {
                searchModal.style.display = 'flex';
            }

            // 2. Vypln√≠me k√≥d do vyhled√°vac√≠ho pole
            const searchInput = document.getElementById('searchModalQuery');
            if (searchInput) {
                searchInput.value = barcode;
                searchInput.focus(); // Kurzor do pole

                // 3. OKAM≈ΩITƒö SPUST√çME VYHLED√ÅV√ÅN√ç
                setTimeout(() => {
                    performBarcodeSearch(barcode);
                }, 300);
            }
        }

        // FUNKCE PRO SPU≈†TƒöN√ç VYHLED√ÅV√ÅN√ç
        function performBarcodeSearch(barcode) {
            console.log("üéØ Spou≈°t√≠m vyhled√°v√°n√≠ k√≥du:", barcode);

            const searchInput = document.getElementById('searchModalQuery');
            const resultsDiv = document.getElementById('searchModalResults');
            const loadingDiv = document.getElementById('searchModalLoading');

            if (!searchInput || !resultsDiv) return;

            // Reset v√Ωsledk≈Ø
            resultsDiv.innerHTML = '';

            // Zobraz√≠me loading
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }

            // Simulace vyhled√°v√°n√≠ (nahraƒète skuteƒçn√Ωm vol√°n√≠m)
            setTimeout(() => {
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }

                // Zde bude skuteƒçn√© vyhled√°v√°n√≠
                performSearch(barcode);

            }, 500);
        }

        // ZVUK PRO iPHONE
        function playIPhoneDetectionSound() {
            // Jednodu≈°≈°√≠ zvukov√° metoda pro iOS
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF5fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUgBjiO1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUgBjiO1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUgBjiO1/LMeSwFJHf');
                audio.play();
            } catch (e) {
                // Fallback - vibrace (pokud je podporov√°no)
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }
        }

        // SPU≈†TƒöN√ç KAMERY
        async function startCamera(videoElement) {
            try {
                // Zastav√≠me p≈ôedchoz√≠ stream
                if (barcodeStream) {
                    barcodeStream.getTracks().forEach(track => track.stop());
                }

                // Z√≠sk√°n√≠ p≈ô√≠stupu ke kame≈ôe
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                barcodeStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = barcodeStream;

                // ƒåek√°n√≠ na naƒçten√≠ videa
                await new Promise((resolve, reject) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play().then(resolve).catch(reject);
                    };
                    setTimeout(resolve, 1000); // Fallback timeout
                });

                barcodeScanningActive = true;
                console.log("‚úÖ Kamera √∫spƒõ≈°nƒõ spu≈°tƒõna");

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi spou≈°tƒõn√≠ kamery:", error);
                throw new Error(getCameraErrorMessage(error));
            }
        }

        function detectSimpleBarcodes(imageData) {
            return []; // Zjednodu≈°en√° implementace
        }

        function handleBarcodeDetected(barcode, quaggaResult) {
            if (lastDetectedBarcode === barcode) return;

            console.log('Nalezen ƒç√°rov√Ω k√≥d:', barcode);
            const isValid = isValidEAN(barcode);

            if (!isValid) {
                document.getElementById('barcodeStatus').textContent = `Neplatn√Ω k√≥d: ${barcode}`;
                document.getElementById('barcodeStatus').style.color = 'orange';
                return;
            }

            lastDetectedBarcode = barcode;
            document.getElementById('barcodeStatus').textContent = `Nalezen k√≥d: ${barcode}`;
            document.getElementById('barcodeStatus').style.color = '#4CAF50';

            document.getElementById('barcodeOverlay').classList.add('barcode-found');

            if (quaggaInitialized) {
                Quagga.stop();
            }

            setTimeout(() => {
                closeBarcodeScanner();
                searchByBarcode(barcode);
            }, 1000);

            setTimeout(() => {
                document.getElementById('barcodeOverlay').classList.remove('barcode-found');
            }, 1500);
        }

        function isValidEAN(barcode) {
            if (!/^\d{8}$|^\d{13}$/.test(barcode)) return false;
            return validateEANChecksum(barcode);
        }

        function validateEANChecksum(barcode) {
            if (barcode.length !== 8 && barcode.length !== 13) return false;
            return true; // Zjednodu≈°en√° validace
        }

        // VYHLED√ÅN√ç PODLE K√ìDU
        function searchByBarcode(barcode) {
            console.log("üîç Vyhled√°v√°m k√≥d:", barcode);

            // Zav≈ôeme skenovac√≠ modal
            closeBarcodeScanner();

            // Otev≈ôeme vyhled√°vac√≠ modal s k√≥dem
            openSearchWithBarcode(barcode);
        }

        // P≈òEP√çN√ÅN√ç KAMERY
        async function toggleCamera() {
            if (!barcodeScanningActive) return;

            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';

            const status = document.getElementById('barcodeStatus');
            status.textContent = 'üîÑ P≈ôep√≠n√°m kameru...';

            const video = document.getElementById('barcodeVideo');
            if (video) {
                await startCamera(video);
                status.textContent = '‚úÖ Kamera p≈ôipravena - nami≈ôte na ƒç√°rov√Ω k√≥d';
            }
        }

        async function toggleFlash() {
            if (!barcodeStream) return;
            const videoTrack = barcodeStream.getVideoTracks()[0];
            if (!videoTrack) return;

            try {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    await videoTrack.applyConstraints({
                        advanced: [{ torch: !barcodeFlashEnabled }]
                    });
                    barcodeFlashEnabled = !barcodeFlashEnabled;
                    document.getElementById('toggleFlashButton').textContent = barcodeFlashEnabled ? 'Vypnout blesk' : 'Blesk';
                }
            } catch (error) {
                console.error('Chyba p≈ôi ovl√°d√°n√≠ blesku:', error);
            }
        }

        // RUƒåN√ç ZAD√ÅN√ç K√ìDU
        function submitManualBarcode() {
            const input = document.getElementById('manualBarcodeInput');
            const barcode = input.value.trim();

            if (barcode) {
                closeBarcodeScanner();
                openSearchWithBarcode(barcode); // ‚Üê STEJN√â JAKO U SKENOV√ÅN√ç
                input.value = '';
            }
        }

        // ZAV≈òEN√ç SKEN√âRU
        function closeBarcodeScanner() {
            console.log("üî¥ Zav√≠r√°m sken√©r");
            barcodeScanningActive = false;

            // D≈Økladn√© zastaven√≠ Quaggy
            if (typeof Quagga !== 'undefined' && Quagga) {
                try {
                    Quagga.stop();
                    Quagga.offDetected();
                } catch (error) {
                    console.log('Chyba p≈ôi zastavov√°n√≠ Quaggy:', error);
                }
            }

            // Zastav√≠me kameru
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }

            const modal = document.getElementById('barcodeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        document.getElementById('confirmCreateRecipeButton').addEventListener('click', async function () {
            const recipeName = document.getElementById('newRecipeNameInput').value.trim();
            if (!recipeName) {
                window.showCustomNotification("Pros√≠m, zadejte n√°zev receptu.", 'info');
                return;
            }

            try {
                // D≈ÆLE≈ΩIT√â: P≈ôed√°me currentFoodItemForRecipe do createNewRecipe
                const recipeId = await createNewRecipe(recipeName, window.currentFoodItemForRecipe);
                if (recipeId) {
                    document.getElementById('createRecipeModal').style.display = 'none';
                    // Zobraz√≠me potvrzen√≠
                    window.showCustomNotification(`Recept "${recipeName}" byl vytvo≈ôen a potravina byla p≈ôid√°na!`, 'recipeCreation');
                }
            } catch (error) {
                console.error("Chyba p≈ôi vytv√°≈ôen√≠ receptu:", error);
                window.showCustomNotification("Chyba p≈ôi vytv√°≈ôen√≠ receptu: " + error.message, 'error');
            }
        });

        // ‚úÖ P≈òID√ÅNO: Funkce pro aktualizaci zav√≠r√°n√≠ p≈ôihla≈°ovac√≠ho okna
        function updateLoginModalCloseAbility() {
            const closeButton = document.getElementById('closeLoginModal');
            if (closeButton) {
                if (window.currentUser && window.currentProfileId) {
                    closeButton.style.display = 'block';
                    console.log("‚úÖ P≈ôihla≈°ovac√≠ okno lze zav≈ô√≠t - √∫ƒçet naƒçten");
                } else {
                    closeButton.style.display = 'none';
                    console.log("‚ùå P≈ôihla≈°ovac√≠ okno nelze zav≈ô√≠t - √∫ƒçet nen√≠ naƒçten");
                }
            }
        }

        // UPRAVEN√â CSS PRO LEP≈†√ç UX
        const improvedBarcodeCSS = `
                                                .barcode-scanner-container {
                                                    position: relative;
                                                width: 100%;
                                                max-width: 400px;
                                                margin: 0 auto;
        }

                                                #barcodeVideo {
                                                    width: 100%;
                                                height: 300px;
                                                border-radius: 12px;
                                                object-fit: cover;
        }

                                                .barcode-overlay {
                                                    position: absolute;
                                                top: 50%;
                                                left: 50%;
                                                transform: translate(-50%, -50%);
                                                width: 80%;
                                                height: 40%;
                                                border: 3px solid #4CAF50;
                                                border-radius: 12px;
                                                pointer-events: none;
                                                animation: pulse 2s infinite;
        }

                                                .barcode-fallback {
                                                    text - align: center;
                                                padding: 20px;
        }

                                                .manual-input {
                                                    display: flex;
                                                gap: 10px;
                                                margin-top: 15px;
        }

                                                .manual-input input {
                                                    flex: 1;
                                                padding: 10px;
                                                border: 1px solid #ddd;
                                                border-radius: 8px;
        }

                                                @keyframes pulse {
                                                    0 % { border- color: #4CAF50; }
                                                50% {border - color: #FFEB3B; }
                                                100% {border - color: #4CAF50; }
        }
                                                `;

        // Funkce pro zav≈ôen√≠ modalu vlastn√≠ho receptu
        function closeCustomRecipeModal() {
            document.getElementById('customRecipeModal').style.display = 'none';
            // RESET editace
            window.editingCustomRecipeId = null;
        }

        // =============================================
        // INICIALIZACE APLIKACE
        // =============================================
        document.addEventListener('DOMContentLoaded', async function () {
            console.log("üè† DOM naƒçten, hled√°m elementy...");

            // P≈ôid√°n√≠ CSS
            const style = document.createElement('style');
            style.textContent = improvedBarcodeCSS;
            document.head.appendChild(style);

            // Event listenery
            document.getElementById('barcodeButtonInModal').addEventListener('click', function () {
                openBarcodeScanner();
            });

            const portionsSelect = document.getElementById('customRecipePortions');
            if (portionsSelect) {
                // Nastav√≠me v√Ωchoz√≠ hodnotu
                portionsSelect.value = '1';

                // P≈ôid√°me event listener pro zmƒõnu
                portionsSelect.addEventListener('change', function () {
                    console.log('Poƒçet porc√≠ zmƒõnƒõn na:', this.value);
                });
            }

            // Debug - kter√© elementy existuj√≠
            console.log("addAsMealButton:", document.getElementById('addAsMealButton'));
            console.log("selectMealModal:", document.getElementById('selectMealModal'));
            console.log("meal-type-btn count:", document.querySelectorAll('.meal-type-btn').length);

            // POƒåK√ÅME CHVILKU NE≈Ω SE V≈†ECHNY ELEMENTY NAƒåTOU
            setTimeout(() => {
                initializeMealModalListeners();
            }, 100);
            if (window.appInitialized) return;
            window.appInitialized = true;

            // Event listener pro k≈ô√≠≈æek nastaven√≠
            document.getElementById('closeSettingsModal').addEventListener('click', function () {
                console.log("‚ùå Kliknuto na zav√≠rac√≠ k≈ô√≠≈æek nastaven√≠");
                closeSettingsModal();
            });

            // Event listener pro kliknut√≠ mimo modal nastaven√≠ 
            document.getElementById('settingsModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    console.log("‚ùå Kliknuto mimo modal nastaven√≠");
                    closeSettingsModal();
                }
            });

            // Event listener pro kliknut√≠ mimo modal formular pro vlastni recept
            document.getElementById('customRecipeModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    closeCustomRecipeModal();
                }
            });

            // Event listener pro kliknut√≠ mimo modal VLASTN√ç RECEPT
            document.getElementById('customRecipeModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    closeCustomRecipeModal();
                }
            });

            // ‚úÖ P≈òID√ÅNO: Podm√≠nƒõn√© zav√≠r√°n√≠ p≈ôihla≈°ovac√≠ho okna
            document.getElementById('loginModal').addEventListener('click', function (event) {
                // Pouze pokud je naƒçten√Ω √∫ƒçet s profilem
                if (event.target === this && window.currentUser && window.currentProfileId) {
                    console.log("‚ùå Kliknuto mimo p≈ôihla≈°ovac√≠ modal (√∫ƒçet naƒçten)");
                    hideLoginModal();
                }
            });

            // ‚úÖ P≈òID√ÅNO: K≈ô√≠≈æek pro p≈ôihla≈°ovac√≠ okno (pouze pokud je √∫ƒçet naƒçten√Ω)
            const loginCloseButton = document.createElement('span');
            loginCloseButton.className = 'close-button';
            loginCloseButton.innerHTML = '&times;';
            loginCloseButton.id = 'closeLoginModal';
            loginCloseButton.style.display = 'none'; // Skryt√© dokud nen√≠ √∫ƒçet naƒçten

            loginCloseButton.addEventListener('click', function () {
                if (window.currentUser && window.currentProfileId) {
                    console.log("‚ùå Kliknuto na k≈ô√≠≈æek p≈ôihla≈°ovac√≠ho modalu");
                    hideLoginModal();
                }
            });

            // P≈ôid√°me k≈ô√≠≈æek do p≈ôihla≈°ovac√≠ho modalu
            document.getElementById('loginModal').querySelector('.modal-content').appendChild(loginCloseButton);

            document.getElementById('personalCardButton').addEventListener('click', showPersonalCardModal);
            // ‚úÖ P≈òID√ÅNO: Event listener pro tlaƒç√≠tko "Otev≈ô√≠t osobn√≠ kartu" v modalu profilu
            document.getElementById('personalCardButton').addEventListener('click', function () {
                console.log("üéØ Kliknuto na Otev≈ô√≠t osobn√≠ kartu z profilu");

                // Zav≈ôeme modal profilu
                document.getElementById('profileNameModal').style.display = 'none';

                // Otev≈ôeme osobn√≠ kartu
                showPersonalCardModal();
            });

            //document.getElementById('closePersonalCard').addEventListener('click', closePersonalCardModal);
            document.getElementById('calculatePersonalCard').addEventListener('click', calculatePersonalCard);
            document.getElementById('savePersonalCard').addEventListener('click', savePersonalCardData);

            // Event listener pro zmƒõnu c√≠le (zobraz√≠/skryje intenzitu)
            /*document.getElementById('goal').addEventListener('change', function () {
                const intensityGroup = document.getElementById('intensityGroup');
                                                if (this.value === 'maintain') {
                                                    intensityGroup.style.display = 'none';
                } else {
                                                    intensityGroup.style.display = 'block';
                }
            });*/

            // Event listener pro zmƒõnu c√≠le
            const goalSelect = document.getElementById('goal');
            if (goalSelect) {
                goalSelect.addEventListener('change', function () {
                    const intensityGroup = document.getElementById('intensityGroup');
                    const intensitySelect = document.getElementById('intensity');

                    if (intensityGroup && intensitySelect) {
                        if (this.value === 'maintain') {
                            // P≈ôi udr≈æen√≠: intenzita disabled a pr√°zdn√°
                            intensitySelect.disabled = true;
                            intensitySelect.value = "";
                            intensitySelect.style.backgroundColor = '#f8f9fa';
                            intensitySelect.style.color = '#6c757d';
                        } else if (this.value === 'loss' || this.value === 'gain') {
                            // P≈ôi redukci/nab√≠r√°n√≠: intenzita enabled a pr√°zdn√°
                            intensitySelect.disabled = false;
                            intensitySelect.value = ""; // PR√ÅZDN√â - ≈æ√°dn√° p≈ôedvolba
                            intensitySelect.style.backgroundColor = '';
                            intensitySelect.style.color = '';
                        } else {
                            // ≈Ω√°dn√Ω c√≠l vybr√°n: intenzita disabled a pr√°zdn√°
                            intensitySelect.disabled = true;
                            intensitySelect.value = "";
                            intensitySelect.style.backgroundColor = '#f8f9fa';
                            intensitySelect.style.color = '#6c757d';
                        }
                    }
                });

                // Inicializace - ≈æ√°dn√° p≈ôedvolba
                goalSelect.dispatchEvent(new Event('change'));
            }

            document.getElementById('closeSelectRecipeModal').addEventListener('click', function () {
                document.getElementById('selectRecipeModal').style.display = 'none';
            });

            document.getElementById('closeCreateProfileModal').addEventListener('click', function () {
                document.getElementById('createProfileModal').style.display = 'none';
            });

            document.getElementById('cancelCreateProfile').addEventListener('click', function () {
                document.getElementById('createProfileModal').style.display = 'none';
                window.isProfileModalShowing = false;
            });

            initializeDetailsModalListeners();

            // ‚úÖ OPRAVA: Event listenery pro v≈°echny modaly recept≈Ø a j√≠del
            document.getElementById('selectRecipeModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    console.log("‚ùå Kliknuto mimo modal recept≈Ø");
                    this.style.display = 'none';
                }
            });

            document.getElementById('createRecipeModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    console.log("‚ùå Kliknuto mimo modal vytvo≈ôen√≠ receptu");
                    this.style.display = 'none';
                }
            });

            console.log("üè† inicializuji nov√Ω sken√©r");

            // POƒåK√ÅME, A≈§ SE NAƒåTOU V≈†ECHNY ELEMENTY
            setTimeout(() => {
                // Inicializujeme NOV√ù sken√©r
                initBarcodeScanner();
                console.log("‚úÖ Nov√Ω sken√©r ƒç√°rov√Ωch k√≥d≈Ø inicializov√°n");
            }, 1000);

            await initializeApplication();

            // Event listenery pro p≈ôihl√°≈°en√≠
            document.getElementById('loginBtn').addEventListener('click', async function () {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                if (!email || !password) {
                    errorDiv.textContent = "Vypl≈àte email a heslo";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    await loginUser(email, password);
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            document.getElementById('registerBtn').addEventListener('click', async function () {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                if (!email || !password) {
                    errorDiv.textContent = "Vypl≈àte email a heslo";
                    errorDiv.style.display = 'block';
                    return;
                }

                if (password.length < 6) {
                    errorDiv.textContent = "Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    await registerUser(email, password);
                    errorDiv.style.display = 'none';
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });

            // Event listenery pro profily
            document.getElementById('confirmCreateProfile').addEventListener('click', async function (event) {
                event.preventDefault();
                event.stopPropagation();

                if (this.disabled) return;

                const profileNameInput = document.getElementById('newProfileName');
                if (profileNameInput) {
                    const profileName = profileNameInput.value.trim();
                    if (!profileName) {
                        window.showCustomNotification("Pros√≠m, zadejte n√°zev profilu.", 'info');
                        return;
                    }

                    this.disabled = true;
                    const originalText = this.textContent;
                    this.textContent = "Vytv√°≈ôen√≠...";

                    try {
                        const newProfileId = await createNewProfile(profileName);
                        if (newProfileId) {
                            document.getElementById('createProfileModal').style.display = 'none';
                        }
                    } catch (error) {
                        console.error("‚ùå Chyba p≈ôi vytv√°≈ôen√≠ profilu:", error);
                    } finally {
                        if (this && this.parentNode) {
                            this.disabled = false;
                            this.textContent = originalText;
                        }
                    }
                }
            });

            // Event listenery pro recepty
            document.getElementById('recipesButton').addEventListener('click', async () => {
                if (!checkInitialization()) return;
                try {
                    await loadUserRecipes();
                    document.getElementById('selectRecipeModal').style.display = 'flex';
                } catch (error) {
                    window.showCustomNotification("Chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø: " + error.message, 'error');
                }
            });

            // Event listenery pro nastaven√≠
            const settingsIcon = document.getElementById('settingsIcon');
            if (settingsIcon) {
                settingsIcon.addEventListener('click', () => {
                    const settingsModal = document.getElementById('settingsModal');
                    if (settingsModal) {
                        settingsModal.style.display = 'flex';
                        setTimeout(initializeSettingsSections, 100);
                    }
                });
            } else {
                console.log("‚ÑπÔ∏è settingsIcon neexistuje - pravdƒõpodobnƒõ byl odstranƒõn z HTML");
            }

            document.getElementById('switchAccountBtn').addEventListener('click', async function () {
                // Nejprve sbal√≠me v≈°echny otev≈ôen√© sekce v nastaven√≠
                const hadOpenSections = collapseAllSettingsSections();

                // Poƒçk√°me chv√≠li na animaci sbalen√≠ (pokud jsou nƒõjak√© sekce otev≈ôen√©)
                const delay = hadOpenSections ? 150 : 0;

                setTimeout(() => {
                    // Zav≈ôeme modal nastaven√≠
                    document.getElementById('settingsModal').style.display = 'none';

                    // Po dal≈°√≠ kr√°tk√© chv√≠li zobraz√≠me p≈ôihla≈°ovac√≠ okno
                    setTimeout(() => {
                        showLoginModal();
                    }, 50);
                }, delay);
            });

            // Event listenery pro p≈ôep√≠naƒçe nastaven√≠
            const toggleIds = [
                'confirmRecipeCreationToggle',
                'confirmFoodAdditionToggle',
                'confirmDeleteRecipeToggle',
                'confirmDeleteRecipeItemToggle',
                'confirmSaveChangesToggle',
                'confirmRecipeSaveSuccessToggle',
                'confirmRecipeDeletionSuccessToggle',
                'confirmRecipeDeletionErrorToggle'
            ];

            toggleIds.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', function () {
                        const settingKey = toggleId.replace('Toggle', '');
                        userSettings[settingKey] = this.checked;
                        saveUserSettings();
                    });
                }
            });

            // Event listener pro kliknut√≠ na profil
            const profileDisplay = document.getElementById('currentProfileDisplay');
            if (profileDisplay) {
                profileDisplay.addEventListener('click', function (e) {
                    e.stopPropagation();
                    window.showProfileModal();
                });
            }

            console.log("‚úÖ Aplikace inicializov√°na");

            // P≈òID√ÅNO: Event listener pro k≈ô√≠≈æek osobn√≠ karty
            const closePersonalCardBtn = document.getElementById('closePersonalCardModal');
            if (closePersonalCardBtn) {
                closePersonalCardBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    closePersonalCardModal();
                });
            }

            // Event listener pro pridani vlastn√≠ho receptu
            document.getElementById('addCustomRecipeBtn').addEventListener('click', openCustomRecipeModal);
            document.getElementById('closeCustomRecipeModal').addEventListener('click', closeCustomRecipeModal);
            document.getElementById('saveCustomRecipeBtn').addEventListener('click', saveCustomRecipe);

            // Event listener pro kliknut√≠ mimo modal
            document.getElementById('customRecipeModal').addEventListener('click', function (event) {
                if (event.target === this) {
                    closeCustomRecipeModal();
                }
            });
        });

        function showDailyIntakeSection() {
            if (!checkInitialization()) {
                window.showCustomNotification("Pro zobrazen√≠ denn√≠ho p≈ô√≠jmu se mus√≠te p≈ôihl√°sit a vybrat profil", 'info');
                return;
            }

            console.log("üìä Zobrazuji denn√≠ p≈ô√≠jem pro profil:", window.currentProfileId);

            // Skryjeme v√Ωsledky vyhled√°v√°n√≠
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
            }

            // Zobraz√≠me sekci denn√≠ho p≈ô√≠jmu
            const dailySection = document.getElementById('dailyIntakeSection');
            if (dailySection) {
                dailySection.style.display = 'block';
                console.log("‚úÖ Sekce denn√≠ho p≈ô√≠jmu zobrazena");
            } else {
                console.error("‚ùå Sekce denn√≠ho p≈ô√≠jmu nenalezena");
                return;
            }

            // ‚úÖ P≈òID√ÅME KONTROLU - pokud nem√°me data nebo jsou ze ≈°patn√©ho profilu, naƒçteme znova
            if (!currentDailyIntakeData || !dailyIntakeGoals) {
                console.log("üîÑ Inicializuji denn√≠ p≈ô√≠jem - data chyb√≠");
                initializeDailyIntake();
            } else {
                console.log("üîÑ Aktualizuji zobrazen√≠ denn√≠ho p≈ô√≠jmu");
                updateDailyIntakeDisplay();
            }
        }

        // P≈òID√ÅN√ç VLASTN√çHO RECEPTU

        // Funkce pro otev≈ôen√≠ modalu vlastn√≠ho receptu
        function openCustomRecipeModal() {
            document.getElementById('selectRecipeModal').style.display = 'none';
            document.getElementById('customRecipeModal').style.display = 'flex';

            // Vyƒçist√≠me v≈°echny pole formul√°≈ôe
            const fields = [
                'customRecipeName', 'customRecipeCalories', 'customRecipeProtein',
                'customRecipeCarbs', 'customRecipeSugar', 'customRecipeFat',
                'customRecipeSaturatedFat', 'customRecipeTransFat', 'customRecipeMonoFat',
                'customRecipePolyFat', 'customRecipeCholesterol', 'customRecipeFiber',
                'customRecipeSalt', 'customRecipeCalcium', 'customRecipeSodium',
                'customRecipeWater', 'customRecipePhe'
            ];

            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) element.value = '';
            });

            // Zamƒõ≈ô√≠me se na prvn√≠ pole
            document.getElementById('customRecipeName').focus();
        }

        // NOV√Å FUNKCE: Otev≈ôen√≠ modalu pro editaci vlastn√≠ho receptu
        async function openCustomRecipeModalForEdit(recipeId) {
            console.log("‚úèÔ∏è Otev√≠r√°m modal pro editaci vlastn√≠ho receptu:", recipeId);
            
            // ZAV≈ò√çT V≈†ECHNY OSTATN√ç MODALY
            const detailsModal = document.getElementById('detailsModal');
            if (detailsModal) {
                detailsModal.style.display = 'none';
            }
            
            try {
                // Naƒçteme data receptu z datab√°ze
                const { data: recipeData, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('id', recipeId)
                    .single();
                
                if (error) throw error;
                
                if (!recipeData || !recipeData.ingredients || recipeData.ingredients.length === 0) {
                    window.showCustomNotification('Nepoda≈ôilo se naƒç√≠st data receptu', 'error');
                    return;
                }
                
                // Z√≠sk√°me nutriƒçn√≠ data z prvn√≠ ingredience (vlastn√≠ recept m√° jen 1 polo≈æku)
                const ingredient = recipeData.ingredients[0];
                const nutritionalDetails = ingredient.nutritionalDetails || {};
                
                console.log("üìä Naƒçten√° data receptu:", {
                    name: recipeData.name,
                    calories: ingredient.calories,
                    nutritionalDetails: nutritionalDetails
                });
                
                // Otev≈ôeme modal
                const customModal = document.getElementById('customRecipeModal');
                if (customModal) {
                    customModal.style.display = 'flex';
                    console.log("‚úÖ Custom recipe modal otev≈ôen");
                } else {
                    console.error("‚ùå customRecipeModal element neexistuje!");
                    return;
                }
                
                // Vypln√≠me formul√°≈ô hodnotami
                document.getElementById('customRecipeName').value = recipeData.name || '';
                document.getElementById('customRecipeCalories').value = ingredient.calories || nutritionalDetails.total_kcal || '';
                document.getElementById('customRecipeProtein').value = nutritionalDetails.protein || '';
                document.getElementById('customRecipeCarbs').value = nutritionalDetails.carbs || '';
                document.getElementById('customRecipeSugar').value = nutritionalDetails.sugar || '';
                document.getElementById('customRecipeFat').value = nutritionalDetails.fat || '';
                document.getElementById('customRecipeSaturatedFat').value = nutritionalDetails.saturated_fat || '';
                document.getElementById('customRecipeTransFat').value = nutritionalDetails.trans_fat || '';
                document.getElementById('customRecipeMonoFat').value = nutritionalDetails.monounsaturated_fat || '';
                document.getElementById('customRecipePolyFat').value = nutritionalDetails.polyunsaturated_fat || '';
                document.getElementById('customRecipeCholesterol').value = nutritionalDetails.cholesterol || '';
                document.getElementById('customRecipeFiber').value = nutritionalDetails.fiber || '';
                document.getElementById('customRecipeSalt').value = nutritionalDetails.salt || '';
                document.getElementById('customRecipeCalcium').value = nutritionalDetails.calcium || '';
                document.getElementById('customRecipeSodium').value = nutritionalDetails.sodium || '';
                document.getElementById('customRecipeWater').value = nutritionalDetails.water || '';
                document.getElementById('customRecipePhe').value = nutritionalDetails.phe || '';
                document.getElementById('customRecipePortions').value = recipeData.portions || 1;
                
                // Ulo≈æ√≠me ID receptu pro pozdƒõj≈°√≠ update
                window.editingCustomRecipeId = recipeId;
                
                console.log("‚úÖ Formul√°≈ô vyplnƒõn daty receptu");
                
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ receptu:", error);
                window.showCustomNotification('Chyba p≈ôi naƒç√≠t√°n√≠ receptu: ' + error.message, 'error');
            }
        }

        // Funkce pro ulo≈æen√≠ vlastn√≠ho receptu
        async function saveCustomRecipe() {
            const recipeData = getCustomRecipeData();
            if (!recipeData) return;

            console.log("üìù Data z formul√°≈ôe vlastn√≠ho receptu:", recipeData);

            try {
                // P≈ôid√°me poƒçet porc√≠ do dat
                const portions = parseInt(document.getElementById('customRecipePortions').value) || 1;
                recipeData.portions = portions;

                // KONTROLA: Jsme v re≈æimu editace?
                if (window.editingCustomRecipeId) {
                    // UPDATE existuj√≠c√≠ho receptu
                    await updateCustomRecipe(window.editingCustomRecipeId, recipeData);
                    window.editingCustomRecipeId = null; // Reset
                    closeCustomRecipeModal();
                    window.showCustomNotification('Recept byl √∫spƒõ≈°nƒõ aktualizov√°n!', 'success');
                    await loadUserRecipes();
                    await loadDailyIntakeData(currentDailyIntakeDate); // Reload denn√≠ho p≈ô√≠jmu
                } else {
                    // CREATE nov√©ho receptu
                    const recipeId = await createCustomRecipe(recipeData);
                    if (recipeId) {
                        closeCustomRecipeModal();
                        window.showCustomNotification('Recept byl √∫spƒõ≈°nƒõ ulo≈æen!', 'success');
                        await loadUserRecipes();
                    }
                }
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ receptu:', error);
                window.showCustomNotification('Chyba p≈ôi ukl√°d√°n√≠: ' + error.message, 'error');
            }
        }

        // Funkce pro z√≠sk√°n√≠ dat z formul√°≈ôe
        function getCustomRecipeData() {
            const name = document.getElementById('customRecipeName').value.trim();
            const calories = parseFloat(document.getElementById('customRecipeCalories').value) || 0;

            if (!name) {
                window.showCustomNotification('Zadejte n√°zev receptu', 'info');
                return null;
            }

            if (calories === 0) {
                window.showCustomNotification('Zadejte kalorickou hodnotu', 'info');
                return null;
            }

            // Z√çSK√ÅME V≈†ECHNY HODNOTY Z FORMUL√Å≈òE
            return {
                name: name,
                calories: calories,
                protein: parseFloat(document.getElementById('customRecipeProtein').value) || 0,
                carbs: parseFloat(document.getElementById('customRecipeCarbs').value) || 0,
                sugar: parseFloat(document.getElementById('customRecipeSugar').value) || 0,
                fat: parseFloat(document.getElementById('customRecipeFat').value) || 0,
                saturated_fat: parseFloat(document.getElementById('customRecipeSaturatedFat').value) || 0,
                trans_fat: parseFloat(document.getElementById('customRecipeTransFat').value) || 0,
                monounsaturated_fat: parseFloat(document.getElementById('customRecipeMonoFat').value) || 0,
                polyunsaturated_fat: parseFloat(document.getElementById('customRecipePolyFat').value) || 0,
                cholesterol: parseFloat(document.getElementById('customRecipeCholesterol').value) || 0,
                fiber: parseFloat(document.getElementById('customRecipeFiber').value) || 0,
                salt: parseFloat(document.getElementById('customRecipeSalt').value) || 0,
                calcium: parseFloat(document.getElementById('customRecipeCalcium').value) || 0,
                sodium: parseFloat(document.getElementById('customRecipeSodium').value) || 0,
                water: parseFloat(document.getElementById('customRecipeWater').value) || 0,
                phe: parseFloat(document.getElementById('customRecipePhe').value) || 0
            };
        }

        // Funkce pro vytvo≈ôen√≠ receptu v datab√°zi
        async function createCustomRecipe(recipeData) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                throw new Error('Aplikace nen√≠ spr√°vnƒõ inicializov√°na');
            }

            // Poƒçet porc√≠ z formul√°≈ôe
            const portions = parseInt(document.getElementById('customRecipePortions').value) || 1;

            // KOMPLETN√ç nutriƒçn√≠ data
            const completeNutritionalDetails = {
                total_kcal: recipeData.calories,
                total_kj: recipeData.calories * 4.184,
                protein: recipeData.protein || 0,
                carbs: recipeData.carbs || 0,
                sugar: recipeData.sugar || 0,
                fat: recipeData.fat || 0,
                saturated_fat: recipeData.saturated_fat || 0,
                trans_fat: recipeData.trans_fat || 0,
                monounsaturated_fat: recipeData.monounsaturated_fat || 0,
                polyunsaturated_fat: recipeData.polyunsaturated_fat || 0,
                cholesterol: recipeData.cholesterol || 0,
                fiber: recipeData.fiber || 0,
                salt: recipeData.salt || 0,
                calcium: recipeData.calcium || 0,
                sodium: recipeData.sodium || 0,
                water: recipeData.water || 0,
                phe: recipeData.phe || 0
            };

            // Vytvo≈ô√≠me data pro jednu porci (pokud je v√≠ce porc√≠)
            let recipeOnePortion = null;
            let hasMultiplePortions = false;

            if (portions > 1) {
                hasMultiplePortions = true;
                recipeOnePortion = {
                    total_kcal: recipeData.calories / portions,
                    total_kj: (recipeData.calories * 4.184) / portions,
                    protein: (recipeData.protein || 0) / portions,
                    carbs: (recipeData.carbs || 0) / portions,
                    sugar: (recipeData.sugar || 0) / portions,
                    fat: (recipeData.fat || 0) / portions,
                    saturated_fat: (recipeData.saturated_fat || 0) / portions,
                    trans_fat: (recipeData.trans_fat || 0) / portions,
                    monounsaturated_fat: (recipeData.monounsaturated_fat || 0) / portions,
                    polyunsaturated_fat: (recipeData.polyunsaturated_fat || 0) / portions,
                    cholesterol: (recipeData.cholesterol || 0) / portions,
                    fiber: (recipeData.fiber || 0) / portions,
                    salt: (recipeData.salt || 0) / portions,
                    calcium: (recipeData.calcium || 0) / portions,
                    sodium: (recipeData.sodium || 0) / portions,
                    water: (recipeData.water || 0) / portions,
                    phe: (recipeData.phe || 0) / portions
                };
            }

            // Vytvo≈ô√≠me ingredienci s nutriƒçn√≠mi daty
            const recipeIngredient = {
                foodName: recipeData.name,
                slug: 'custom-recipe',
                imageUrl: "{{ url_for('static', filename='icon/recepty.png') }}",
                foodType: 'recept',
                amount: 100,
                unit: 'g',
                kcal: recipeData.calories + ' kcal',
                nutritionalDetails: completeNutritionalDetails,
                isCustomRecipe: true,
                portions: portions
            };

            const recipeToSave = {
                name: recipeData.name,
                user_id: window.currentUser.id,
                profile_id: window.currentProfileId,
                ingredients: [recipeIngredient],
                portions: portions,
                has_multiple_portions: hasMultiplePortions,
                recipe_one_portion: recipeOnePortion,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            console.log("üíæ Ukl√°d√°m vlastn√≠ recept:", {
                name: recipeData.name,
                portions: portions,
                hasMultiplePortions: hasMultiplePortions,
                recipeOnePortion: recipeOnePortion
            });

            const { data, error } = await window.supabaseClient
                .from('recipes')
                .insert(recipeToSave)
                .select()
                .single();

            if (error) throw error;
            return data.id;
        }

        // NOV√Å FUNKCE: Aktualizace vlastn√≠ho receptu
        async function updateCustomRecipe(recipeId, recipeData) {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                throw new Error('Aplikace nen√≠ spr√°vnƒõ inicializov√°na');
            }

            // Poƒçet porc√≠ z formul√°≈ôe
            const portions = parseInt(document.getElementById('customRecipePortions').value) || 1;

            // KOMPLETN√ç nutriƒçn√≠ data
            const completeNutritionalDetails = {
                total_kcal: recipeData.calories,
                total_kj: recipeData.calories * 4.184,
                protein: recipeData.protein || 0,
                carbs: recipeData.carbs || 0,
                sugar: recipeData.sugar || 0,
                fat: recipeData.fat || 0,
                saturated_fat: recipeData.saturated_fat || 0,
                trans_fat: recipeData.trans_fat || 0,
                monounsaturated_fat: recipeData.monounsaturated_fat || 0,
                polyunsaturated_fat: recipeData.polyunsaturated_fat || 0,
                cholesterol: recipeData.cholesterol || 0,
                fiber: recipeData.fiber || 0,
                salt: recipeData.salt || 0,
                calcium: recipeData.calcium || 0,
                sodium: recipeData.sodium || 0,
                water: recipeData.water || 0,
                phe: recipeData.phe || 0
            };

            // Vytvo≈ô√≠me data pro jednu porci (pokud je v√≠ce porc√≠)
            let recipeOnePortion = null;
            let hasMultiplePortions = false;

            if (portions > 1) {
                hasMultiplePortions = true;
                recipeOnePortion = {
                    total_kcal: recipeData.calories / portions,
                    total_kj: (recipeData.calories * 4.184) / portions,
                    protein: (recipeData.protein || 0) / portions,
                    carbs: (recipeData.carbs || 0) / portions,
                    sugar: (recipeData.sugar || 0) / portions,
                    fat: (recipeData.fat || 0) / portions,
                    saturated_fat: (recipeData.saturated_fat || 0) / portions,
                    trans_fat: (recipeData.trans_fat || 0) / portions,
                    monounsaturated_fat: (recipeData.monounsaturated_fat || 0) / portions,
                    polyunsaturated_fat: (recipeData.polyunsaturated_fat || 0) / portions,
                    cholesterol: (recipeData.cholesterol || 0) / portions,
                    fiber: (recipeData.fiber || 0) / portions,
                    salt: (recipeData.salt || 0) / portions,
                    calcium: (recipeData.calcium || 0) / portions,
                    sodium: (recipeData.sodium || 0) / portions,
                    water: (recipeData.water || 0) / portions,
                    phe: (recipeData.phe || 0) / portions
                };
            }

            // Aktualizujeme ingredienci s nutriƒçn√≠mi daty
            const recipeIngredient = {
                foodName: recipeData.name,
                slug: 'custom-recipe',
                imageUrl: "{{ url_for('static', filename='icon/recepty.png') }}",
                foodType: 'recept',
                amount: 100,
                unit: 'g',
                kcal: recipeData.calories + ' kcal',
                nutritionalDetails: completeNutritionalDetails,
                isCustomRecipe: true,
                portions: portions
            };

            const updateData = {
                name: recipeData.name,
                ingredients: [recipeIngredient],
                portions: portions,
                has_multiple_portions: hasMultiplePortions,
                recipe_one_portion: recipeOnePortion,
                updated_at: new Date().toISOString()
            };

            console.log("üíæ Aktualizuji vlastn√≠ recept:", {
                id: recipeId,
                name: recipeData.name,
                portions: portions
            });

            const { error } = await window.supabaseClient
                .from('recipes')
                .update(updateData)
                .eq('id', recipeId);

            if (error) throw error;
            
            console.log("‚úÖ Recept √∫spƒõ≈°nƒõ aktualizov√°n");
        }

        // DENN√ç P≈ò√çJEM - HLAVN√ç FUNKCE

        // Inicializace denn√≠ho p≈ô√≠jmu
        function initializeDailyIntake() {
            console.log("üîÑ Inicializace denn√≠ho p≈ô√≠jmu pro profil:", window.currentProfileId);

            // Naƒçteme c√≠le a pak data
            loadDailyIntakeGoals()
                .finally(() => {
                    // ‚úÖ VOL√ÅME V≈ΩDY - po √∫spƒõchu i po chybƒõ
                    checkAndDisplayGoalsWarning();
                    loadDailyIntakeData(currentDailyIntakeDate);
                });

            setupDailyIntakeEventListeners();
        }

        // funkce pro kontrolu c√≠l≈Ø
        function checkAndDisplayGoalsWarning() {
            const mainContent = document.getElementById('mainContent');
            if (!mainContent) return;

            // Odstran√≠me existuj√≠c√≠ varov√°n√≠
            const existingWarning = document.querySelector('.goals-warning');
            if (existingWarning) {
                existingWarning.remove();
            }

            // Zkontrolujeme jestli m√°me c√≠le
            if (!dailyIntakeGoals) {
                console.log("‚ö†Ô∏è C√≠le nejsou naƒçteny, zobrazuji varov√°n√≠");
                showGoalsWarning();
            } else {
                console.log("‚úÖ C√≠le jsou naƒçteny, odstra≈àuji varov√°n√≠");
                // Ujist√≠me se, ≈æe ≈æ√°dn√© varov√°n√≠ nez≈Østalo
                const warning = document.querySelector('.goals-warning');
                if (warning) {
                    warning.remove();
                }
            }
        }

        // Naƒçten√≠ c√≠l≈Ø z osobn√≠ karty
        async function loadDailyIntakeGoals() {
            return new Promise(async (resolve, reject) => {
                try {
                    if (!window.currentProfileId) {
                        console.log("‚ùå Nelze naƒç√≠st c√≠le - nen√≠ vybr√°n profil");
                        dailyIntakeGoals = null;
                        resolve();
                        return;
                    }

                    console.log("üéØ Naƒç√≠t√°m c√≠le pro profil:", window.currentProfileId);

                    const { data, error } = await window.supabaseClient
                        .from('personal_cards')
                        .select('form_data, calculations')
                        .eq('profile_id', window.currentProfileId);

                    if (error) {
                        console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ osobn√≠ karty:", error);
                        dailyIntakeGoals = null;
                        resolve(); // I p≈ôi chybƒõ pokraƒçujeme
                        return;
                    }

                    if (data && data.length > 0 && data[0].calculations) {
                        const calculations = data[0].calculations;
                        console.log("üì¶ Data osobn√≠ karty - calculations:", calculations);

                        if (calculations.macros) {
                            dailyIntakeGoals = {
                                calories: calculations.targetCalories || 2000,
                                protein: calculations.macros.protein || 150,
                                carbs: calculations.macros.carbs || 250,
                                fat: calculations.macros.fat || 67,
                                fiber: calculations.macros.fiber || 30
                            };
                            console.log("‚úÖ Naƒçteny c√≠le z osobn√≠ karty:", dailyIntakeGoals);
                        } else {
                            console.log("‚ÑπÔ∏è Osobn√≠ karta existuje, ale neobsahuje makro≈æiviny");
                            dailyIntakeGoals = null;
                        }
                    } else {
                        console.log("‚ÑπÔ∏è Osobn√≠ karta neexistuje nebo nem√° calculations");
                        dailyIntakeGoals = null;
                    }

                    resolve();
                } catch (error) {
                    console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ c√≠l≈Ø:", error);
                    dailyIntakeGoals = null;
                    resolve(); // I p≈ôi chybƒõ pokraƒçujeme
                }
            });
        }

        async function checkPersonalCardStructure() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('personal_cards')
                    .select('data')
                    .eq('profile_id', window.currentProfileId);

                if (error) throw error;

                if (data && data.length > 0) {
                    const cardData = data[0].data;
                    console.log("üîç Struktura osobn√≠ karty:", {
                        hasData: !!cardData,
                        dataKeys: cardData ? Object.keys(cardData) : '≈æ√°dn√° data',
                        hasCalculations: cardData?.calculations ? 'ano' : 'ne',
                        calculationsKeys: cardData?.calculations ? Object.keys(cardData.calculations) : '≈æ√°dn√© v√Ωpoƒçty',
                        hasMacros: cardData?.calculations?.macros ? 'ano' : 'ne',
                        macrosKeys: cardData?.calculations?.macros ? Object.keys(cardData.calculations.macros) : '≈æ√°dn√© makro≈æiviny'
                    });
                } else {
                    console.log("‚ÑπÔ∏è Osobn√≠ karta neexistuje");
                }
            } catch (error) {
                console.error("‚ùå Chyba p≈ôi kontrole struktury osobn√≠ karty:", error);
            }
        }

        // Naƒçten√≠ denn√≠ch dat
        async function loadDailyIntakeData(date) {
            try {
                if (!window.currentUser || !window.currentProfileId) {
                    console.log("‚ùå Nelze naƒç√≠st data - nen√≠ p≈ôihl√°≈°en√≠ nebo profil");
                    return;
                }

                const dateString = formatDateForAPI(date);
                console.log("üìÖ Naƒç√≠t√°m data pro:", dateString, "profil:", window.currentProfileId);

                const { data: dailyData, error: dailyError } = await window.supabaseClient
                    .from('daily_intakes')
                    .select('id, intake_date')
                    .eq('user_id', window.currentUser.id)
                    .eq('profile_id', window.currentProfileId)
                    .eq('intake_date', dateString);

                if (dailyError) throw dailyError;

                let dailyIntakeId = null;
                let meals = [];

                if (dailyData && dailyData.length > 0) {
                    dailyIntakeId = dailyData[0].id;

                    // Naƒçteme meals pro tento daily_intake
                    const { data: mealsData, error: mealsError } = await window.supabaseClient
                        .from('daily_meals')
                        .select('id, meal_type, meal_order')
                        .eq('daily_intake_id', dailyIntakeId)
                        .order('meal_order', { ascending: true });

                    if (mealsError) throw mealsError;

                    // Pro ka≈æd√© j√≠dlo naƒçteme polo≈æky
                    for (const meal of mealsData) {
                        const { data: itemsData, error: itemsError } = await window.supabaseClient
                            .from('meal_items')
                            .select('*')
                            .eq('daily_meal_id', meal.id)
                            .order('created_at', { ascending: true });

                        // P≈òIDEJTE DEBUG:
                        console.log("üì• NAƒåTEN√â MEAL_ITEMS Z DATAB√ÅZE:", itemsData?.map(item => ({
                            id: item.id,
                            food_name: item.food_name,
                            recipe_id: item.recipe_id,
                            recipe_name: item.recipe_name, // ‚Üê OVƒö≈òTE ≈ΩE TADY JE HODNOTA
                            has_recipe_name: !!item.recipe_name
                        })));

                        if (itemsError) throw itemsError;

                        // D≈ÆLE≈ΩIT√â: Pro polo≈æky s recipe_id naƒçteme aktu√°ln√≠ data receptu
                        // V ƒç√°sti kde naƒç√≠t√°me data receptu pro meal_item p≈ôidejte:
                        const itemsWithRecipeData = await Promise.all(
                            (itemsData || []).map(async (item) => {
                                if (item.recipe_id) {
                                    try {
                                        const { data: recipeData, error: recipeError } = await window.supabaseClient
                                            .from('recipes')
                                            .select('has_multiple_portions, recipe_one_portion, portions')
                                            .eq('id', item.recipe_id)
                                            .single();

                                        // D≈ÆLE≈ΩIT√â: Pokud recept neexistuje, pou≈æijeme data z meal_items
                                        if (recipeError || !recipeData) {
                                            console.log("‚ÑπÔ∏è Recept ji≈æ neexistuje, pou≈æ√≠v√°m data z meal_items:", {
                                                foodName: item.food_name,
                                                portions: item.portions,
                                                usedOnePortionData: item.used_one_portion_data,
                                                hasOriginalData: !!item.original_portion_data
                                            });

                                            // Pokud m√°me ulo≈æen√° data pro jednu porci, pou≈æijeme je
                                            if (item.used_one_portion_data && item.original_portion_data) {
                                                console.log("üî¢ Pou≈æ√≠v√°m ulo≈æen√° data pro jednu porci");
                                                return {
                                                    ...item,
                                                    calories: item.original_portion_data.total_kcal || item.calories,
                                                    protein: item.original_portion_data.protein || item.protein,
                                                    carbs: item.original_portion_data.carbs || item.carbs,
                                                    fat: item.original_portion_data.fat || item.fat,
                                                    fiber: item.original_portion_data.fiber || item.fiber,
                                                    nutritional_data: item.original_portion_data
                                                };
                                            }

                                            // Jinak vr√°t√≠me p≈Øvodn√≠ item
                                            return item;
                                        }

                                        console.log("üîç Naƒç√≠t√°m data receptu pro meal_item:", {
                                            foodName: item.food_name,
                                            recipeId: item.recipe_id,
                                            hasMultiplePortions: recipeData.has_multiple_portions,
                                            usedOnePortionData: item.used_one_portion_data
                                        });

                                        // POKUD byl recept p≈ôid√°n s p≈ôepoƒçtem na jednu porci, pou≈æijeme data z meal_items
                                        if (item.used_one_portion_data && recipeData.has_multiple_portions) {
                                            console.log("üî¢ Pou≈æ√≠v√°m p≈ôepoƒçten√° data z meal_items pro:", item.food_name);
                                            // Data jsou ji≈æ v item - nic nemƒõn√≠me
                                        } else if (recipeData.has_multiple_portions && recipeData.recipe_one_portion) {
                                            // RECEPT M√Å V√çCE PORC√ç: pou≈æijeme data pro jednu porci
                                            console.log("üî¢ Aktualizuji na data pro jednu porci pro:", item.food_name);
                                            return {
                                                ...item,
                                                calories: recipeData.recipe_one_portion.total_kcal || item.calories,
                                                protein: recipeData.recipe_one_portion.protein || item.protein,
                                                carbs: recipeData.recipe_one_portion.carbs || item.carbs,
                                                fat: recipeData.recipe_one_portion.fat || item.fat,
                                                fiber: recipeData.recipe_one_portion.fiber || item.fiber,
                                                nutritional_data: recipeData.recipe_one_portion
                                            };
                                        }
                                    } catch (error) {
                                        console.log("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ receptu:", error);
                                        // POKUD DOJDE K CHYBƒö, VR√ÅT√çME P≈ÆVODN√ç ITEM
                                        return item;
                                    }
                                }
                                return item;
                            })
                        );

                        meals.push({
                            ...meal,
                            meal_items: itemsWithRecipeData
                        });
                    }
                }

                currentDailyIntakeData = {
                    id: dailyIntakeId,
                    intake_date: dateString,
                    daily_meals: meals
                };

                console.log("üìä Naƒçtena denn√≠ data:", currentDailyIntakeData?.daily_meals?.length || 0, "j√≠del");
                setTimeout(() => {
                    updateDailyIntakeDisplay();
                }, 100);

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ denn√≠ch dat:", error);
                window.showCustomNotification("Chyba p≈ôi naƒç√≠t√°n√≠ denn√≠ch dat: " + error.message, 'error');
            }
        }

        // Aktualizace zobrazen√≠
        function updateDailyIntakeDisplay() {
            console.log("üîÑ Aktualizuji zobrazen√≠ denn√≠ho p≈ô√≠jmu");

            // Debug: zkontrolujte data kter√° se zobrazuj√≠
            if (currentDailyIntakeData?.daily_meals) {
                currentDailyIntakeData.daily_meals.forEach(meal => {
                    meal.meal_items?.forEach(item => {
                        if (item.recipe_id) {
                            console.log("üìã Zobrazuji recept:", {
                                name: item.food_name,
                                calories: item.calories,
                                usedOnePortionData: item.used_one_portion_data
                            });
                        }
                    });
                });
            }

            updateDateDisplay();
            calculateAndDisplayTotals();
            renderMealItems();
        }

        // Funkce pro zobrazen√≠ varov√°n√≠ kdy≈æ nejsou c√≠le
        function showGoalsWarning() {
            const mainContent = document.getElementById('mainContent');
            if (!mainContent) return;

            const warningHtml = `
                                                <div class="goals-warning">
                                                    <div class="warning-icon">‚ö†Ô∏è</div>
                                                    <div class="warning-content">
                                                        <h3>Chyb√≠ c√≠le pro denn√≠ p≈ô√≠jem</h3>
                                                        <p>Pro spr√°vn√© zobrazen√≠ denn√≠ho p≈ô√≠jmu je pot≈ôeba vyplnit osobn√≠ kartu.</p>
                                                        <button id="openPersonalCardBtn" class="btn-primary">Otev≈ô√≠t osobn√≠ kartu</button>
                                                    </div>
                                                </div>
                                                `;

            // Najdeme nebo vytvo≈ô√≠me warning element
            let warningElement = document.querySelector('.goals-warning');
            if (!warningElement) {
                warningElement = document.createElement('div');
                warningElement.className = 'goals-warning';
                warningElement.innerHTML = warningHtml;
                mainContent.insertBefore(warningElement, mainContent.firstChild);
            }

            // Event listener pro tlaƒç√≠tko
            document.getElementById('openPersonalCardBtn')?.addEventListener('click', () => {
                showPersonalCardModal();
            });
        }

        // Aktualizace zobrazen√≠ data
        function updateDateDisplay() {
            const dateDisplay = document.getElementById('currentDateDisplay');
            if (dateDisplay) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateDisplay.textContent = currentDailyIntakeDate.toLocaleDateString('cs-CZ', options);
            }
        }

        // V√Ωpoƒçet a zobrazen√≠ souƒçt≈Ø
        function calculateAndDisplayTotals() {
            // ‚úÖ Pou≈æijte demo c√≠le pokud nejsou naƒçteny skuteƒçn√© c√≠le
            const goalsToUse = dailyIntakeGoals || {
                calories: 2000,
                protein: 150,
                carbs: 250,
                fat: 67,
                fiber: 30
            };

            console.log("üßÆ Pou≈æ√≠v√°m c√≠le:", goalsToUse);

            const totals = calculateDailyTotals();
            console.log("üßÆ Vypoƒç√≠tan√© souƒçty:", totals);

            updateCircularCharts(totals, goalsToUse);
            updateChartDetails(totals, goalsToUse);
        }

        // V√Ωpoƒçet denn√≠ch souƒçt≈Ø
        function calculateDailyTotals() {
            const totals = {
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                fiber: 0
            };

            if (!currentDailyIntakeData || !currentDailyIntakeData.daily_meals) {
                return totals;
            }

            currentDailyIntakeData.daily_meals.forEach(meal => {
                if (meal.meal_items) {
                    meal.meal_items.forEach(item => {
                        totals.calories += parseFloat(item.calories) || 0;
                        totals.protein += parseFloat(item.protein) || 0;
                        totals.carbs += parseFloat(item.carbs) || 0;
                        totals.fat += parseFloat(item.fat) || 0;
                        totals.fiber += parseFloat(item.fiber) || 0;
                    });
                }
            });

            return totals;
        }

        // Aktualizace kruhov√Ωch graf≈Ø
        function updateCircularCharts(totals, goals) {
            updateCircularChart('caloriesChart', totals.calories, goals.calories, '');
            updateCircularChart('proteinChart', totals.protein, goals.protein, 'protein');
            updateCircularChart('carbsChart', totals.carbs, goals.carbs, 'carbs');
            updateCircularChart('fatsChart', totals.fat, goals.fat, 'fats');
            updateCircularChart('fiberChart', totals.fiber, goals.fiber, 'fiber');
        }

        // Aktualizace jednoho kruhov√©ho grafu (UPRAVENO PRO DYNAMICKOU BARVU PROCENT)
        function updateCircularChart(chartId, current, goal, type = '') {
            const chartElement = document.getElementById(chartId);
            if (!chartElement) return;

            // Zaji≈°tƒõn√≠, ≈æe procenta nep≈ôekroƒç√≠ 100 (pro barvu a dasharray)
            const percentage = goal > 0 ? Math.min((current / goal) * 100, 100) : 0;
            const circle = chartElement.querySelector('.circle');
            const percentageText = chartElement.querySelector('.percentage');

            // P≈Øvodn√≠ barvy pro Makro≈æiviny
            const originalColors = {
                protein: '#f44336', // P≈ô√≠klad barvy
                carbs: '#2196f3',
                fats: '#ffc107',
                fiber: '#28a745'
            };
            const defaultMacroColor = originalColors[type] || '#007bff';

            if (circle && percentageText) {
                circle.style.strokeDasharray = `${percentage}, 100`;
                percentageText.textContent = `${Math.round(percentage)}%`;

                // --- DYNAMICK√Å ZMƒöNA BARVY TEXTU PROCENT (Plat√≠ pro V≈†ECHNY grafy) ---
                const color = percentageToColor(percentage);
                percentageText.style.fill = color; // Barva textu procent se mƒõn√≠ v≈ædy dynamicky

                // --- LOGIKA PRO BARVU KRUHU (STROKE) ---
                const isCaloriesChart = chartId === 'caloriesChart';

                if (isCaloriesChart) {
                    // Kalorie: Barva kruhu se mƒõn√≠ dynamicky (stejnƒõ jako text procent)
                    circle.style.stroke = color;
                } else {
                    // Makro≈æiviny: Barva kruhu je V≈ΩDY p≈Øvodn√≠, bez dynamick√© zmƒõny (p≈ôi p≈ôekroƒçen√≠ c√≠le z≈Østane p≈Øvodn√≠)
                    circle.style.stroke = defaultMacroColor;
                }
            }
        }

        // Aktualizace detail≈Ø pod grafy
        function updateChartDetails(totals, goals) {
            updateChartDetail('calories', totals.calories, goals.calories, 'kcal');
            updateChartDetail('protein', totals.protein, goals.protein, 'g');
            updateChartDetail('carbs', totals.carbs, goals.carbs, 'g');
            updateChartDetail('fats', totals.fat, goals.fat, 'g');
            updateChartDetail('fiber', totals.fiber, goals.fiber, 'g');
        }

        // Aktualizace jednoho detailu
        function updateChartDetail(type, current, goal, unit) {
            const remaining = goal - current; // BEZ Math.max - chceme vidƒõt z√°porn√© hodnoty
            const exceeded = current > goal; // JE P≈òEKROƒåENO?

            const valueElement = document.getElementById(`${type}Value`);
            const labelElement = document.getElementById(`${type}Label`);

            if (valueElement) {
                valueElement.textContent = `${Math.round(current)} / ${Math.round(goal)} ${unit}`;
            }

            if (labelElement) {
                if (exceeded) {
                    // P≈òEKROƒåENO - zobraz v kladn√Ωch ƒç√≠slech ƒçervenƒõ
                    const overAmount = Math.abs(remaining); // Absolutn√≠ hodnota
                    labelElement.textContent = `P≈ôekroƒçeno o ${Math.round(overAmount)} ${unit}`;
                    labelElement.classList.add('exceeded'); // P≈òID√ÅME T≈ò√çDU PRO ƒåERVENOU
                } else {
                    // NORM√ÅLN√ç - zb√Ωv√°
                    labelElement.textContent = `Zb√Ωv√° ${Math.round(remaining)} ${unit}`;
                    labelElement.classList.remove('exceeded'); // ODSTRAN√çME T≈ò√çDU
                }
            }
        }

        // Vykreslen√≠ polo≈æek j√≠del - S SESKUPEN√çM RECEPT≈Æ
        async function renderMealItems() {
            const mealTypes = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner', 'dinner2'];

            for (const mealType of mealTypes) {
                const container = document.getElementById(`${mealType}Items`);
                if (!container) continue;

                container.innerHTML = '';

                const meals = currentDailyIntakeData.daily_meals?.filter(meal => meal.meal_type === mealType) || [];

                if (meals.length === 0) {
                    container.innerHTML = '<div class="empty-meal-message">≈Ω√°dn√° j√≠dla</div>';
                    continue;
                }

                console.log(`üéØ Renderuji ${mealType}: ${meals.length} meals`);

                // P≈òEDEJ ASYNC FUNKCI A POƒåKEJ NA V√ùSLEDEK
                const groupedItems = await groupMealItemsByRecipe(meals);

                console.log(`üìä ${mealType}: ${groupedItems.length} skupin (recepty: ${groupedItems.filter(g => g.isRecipe).length})`);

                // Zbytek funkce z≈Øst√°v√° stejn√Ω...
                groupedItems.forEach(group => {
                    if (group.isRecipe) {
                        const recipeElement = createRecipeGroupElement(group, mealType);
                        container.appendChild(recipeElement);
                        console.log(`‚úÖ P≈ôid√°na skupina receptu: ${group.recipeName}`);
                    } else {
                        group.items.forEach(item => {
                            const foodItemElement = createFoodItemElement(item, group.mealId);
                            container.appendChild(foodItemElement);
                            console.log(`‚úÖ P≈ôid√°na samostatn√° potravina: ${item.food_name}`);
                        });
                    }
                });

                // Pokud se nic nevykreslilo, zobrazte p≈Øvodn√≠ zobrazen√≠
                if (container.children.length === 0) {
                    console.log(`üîÑ Pou≈æ√≠v√°m fallback zobrazen√≠ pro ${mealType}`);
                    renderMealItemsFallbackForMeal(mealType, meals);
                }
            }
        }

        // Pomocn√° funkce pro fallback
        function renderMealItemsFallbackForMeal(mealType, meals) {
            const container = document.getElementById(`${mealType}Items`);
            if (!container) return;

            container.innerHTML = '';

            meals.forEach(meal => {
                if (meal.meal_items && meal.meal_items.length > 0) {
                    meal.meal_items.forEach(item => {
                        const mealItemElement = createFoodItemElement(item, meal.id);
                        container.appendChild(mealItemElement);
                        console.log(`üîÑ Fallback: P≈ôid√°na polo≈æka ${item.food_name}`);
                    });
                }
            });
        }

        // Fallback funkce pro p≈Øvodn√≠ zobrazen√≠
        function renderMealItemsFallback() {
            const mealTypes = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner', 'dinner2'];

            mealTypes.forEach(mealType => {
                const container = document.getElementById(`${mealType}Items`);
                if (!container) return;

                container.innerHTML = '';

                const meals = currentDailyIntakeData.daily_meals?.filter(meal => meal.meal_type === mealType) || [];

                if (meals.length === 0) {
                    container.innerHTML = '<div class="empty-meal-message">≈Ω√°dn√° j√≠dla</div>';
                    return;
                }

                meals.forEach(meal => {
                    if (meal.meal_items && meal.meal_items.length > 0) {
                        meal.meal_items.forEach(item => {
                            const mealItemElement = createFoodItemElement(item, meal.id);
                            container.appendChild(mealItemElement);
                        });
                    }
                });
            });
        }

        // Pomocn√° funkce pro bezpeƒçnou pr√°ci s UUID
        function safeUUID(value) {
            if (!value || value === 'null' || value === 'undefined') {
                return null;
            }
            return value;
        }

        // Upraven√° funkce getRecipeName pro bezpeƒçn√© zach√°zen√≠ s NULL
        async function getRecipeName(recipeId) {
            if (!recipeId || recipeId === 'null' || recipeId === 'undefined') {
                return 'Recept (smaz√°no)';
            }

            try {
                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .select('name')
                    .eq('id', recipeId)
                    .single();

                if (!error && data) {
                    console.log("‚úÖ N√°zev receptu naƒçten z datab√°ze:", data.name);
                    return data.name;
                }

                console.log("‚ÑπÔ∏è Recept neexistuje, pou≈æ√≠v√°m fallback");
                return 'Recept (smaz√°no)';

            } catch (error) {
                console.log("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ n√°zvu receptu:", error);
                return `Recept ${recipeId}`;
            }
        }

        // Seskupte polo≈æky podle recept≈Ø - OPRAVEN√Å VERZE
        async function groupMealItemsByRecipe(meals) {
            const groups = [];

            for (const meal of meals) {
                if (!meal.meal_items || meal.meal_items.length === 0) continue;

                console.log(`üîç Zpracov√°v√°m j√≠dlo ${meal.meal_type}:`, meal.meal_items.length, 'polo≈æek');

                const recipeGroups = {};

                for (const item of meal.meal_items) {
                    // OPRAVA: Normalizujte recipe_id
                    let recipeId = item.recipe_id;
                    if (recipeId === 'null' || recipeId === 'undefined' || recipeId === null) {
                        recipeId = null;
                    }

                    const recipeName = item.recipe_name;

                    console.log(`ü•ò Polo≈æka: "${item.food_name}", recipe_id:`, recipeId, 'recipe_name:', recipeName);

                    // D≈ÆLE≈ΩIT√â: Skupujeme podle recipe_name, i kdy≈æ recipe_id je null
                    const hasValidRecipeName = recipeName &&
                        recipeName !== 'null' &&
                        recipeName !== 'undefined' &&
                        recipeName !== '';

                    if (hasValidRecipeName) {
                        const groupKey = `${recipeName}_${recipeId || 'null'}`; // Unik√°tn√≠ kl√≠ƒç

                        if (!recipeGroups[groupKey]) {
                            console.log(`üìã Skupina receptu: ${recipeName} (recipe_id: ${recipeId})`);

                            recipeGroups[groupKey] = {
                                isRecipe: true,
                                recipeId: recipeId,
                                recipeName: recipeName,
                                recipeExists: !!recipeId && recipeId !== 'null', // recipe_id existuje = recept existuje
                                items: [],
                                mealId: meal.id,
                                mealType: meal.meal_type,
                                totalCalories: 0,
                                totalProtein: 0,
                                totalCarbs: 0,
                                totalFat: 0
                            };
                        }

                        // P≈ôidej polo≈æku do skupiny
                        recipeGroups[groupKey].items.push(item);
                        recipeGroups[groupKey].totalCalories += parseFloat(item.calories) || 0;
                        recipeGroups[groupKey].totalProtein += parseFloat(item.protein) || 0;
                        recipeGroups[groupKey].totalCarbs += parseFloat(item.carbs) || 0;
                        recipeGroups[groupKey].totalFat += parseFloat(item.fat) || 0;
                    } else if (recipeId && recipeId !== 'null' && recipeId !== 'undefined') {
                        // Polo≈æka m√° recipe_id ale nem√° recipe_name
                        const groupKey = `recipe_${recipeId}`;

                        if (!recipeGroups[groupKey]) {
                            // Zkus√≠me naƒç√≠st n√°zev receptu
                            const recipeNameFromDb = await getRecipeName(recipeId);

                            recipeGroups[groupKey] = {
                                isRecipe: true,
                                recipeId: recipeId,
                                recipeName: recipeNameFromDb,
                                recipeExists: true,
                                items: [],
                                mealId: meal.id,
                                mealType: meal.meal_type,
                                totalCalories: 0,
                                totalProtein: 0,
                                totalCarbs: 0,
                                totalFat: 0
                            };
                        }

                        recipeGroups[groupKey].items.push(item);
                        recipeGroups[groupKey].totalCalories += parseFloat(item.calories) || 0;
                        recipeGroups[groupKey].totalProtein += parseFloat(item.protein) || 0;
                        recipeGroups[groupKey].totalCarbs += parseFloat(item.carbs) || 0;
                        recipeGroups[groupKey].totalFat += parseFloat(item.fat) || 0;
                    } else {
                        // Samostatn√° potravina (bez receptu)
                        groups.push({
                            isRecipe: false,
                            items: [item],
                            mealId: meal.id,
                            mealType: meal.meal_type
                        });
                    }
                }

                // P≈ôidej skupiny recept≈Ø do v√Ωsledku
                Object.values(recipeGroups).forEach(group => {
                    groups.push(group);
                });
            }

            console.log(`üéØ Celkem skupin: ${groups.length} (recepty: ${groups.filter(g => g.isRecipe).length})`);
            return groups;
        }

        // Pomocn√° funkce pro z√≠sk√°n√≠ n√°zvu receptu z polo≈æek
        function getRecipeNameFromItems(items, recipeId) {
            // Najdeme prvn√≠ polo≈æku s t√≠mto recipe_id, kter√° m√° food_name
            const recipeItem = items.find(item => item.recipe_id === recipeId && item.food_name);
            return recipeItem ? recipeItem.food_name : 'Recept';
        }

        // Vytvo≈ôen√≠ elementu skupiny recept≈Ø S MNO≈ΩSTV√çM
        function createRecipeGroupElement(group, mealType) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'recipe-group';
            groupDiv.dataset.recipeId = group.recipeId;
            groupDiv.dataset.mealId = group.mealId;

            // P≈ôidej t≈ô√≠du pro smazan√© recepty
            if (!group.recipeExists) {
                groupDiv.classList.add('deleted-recipe');
            }
            
            // DETEKCE VLASTN√çHO RECEPTU: m√° pouze 1 polo≈æku s n√°zvem shodn√Ωm s n√°zvem receptu
            // NEBO m√° dataset.isCustomRecipe nastaven√Ω na true p≈ôi vytv√°≈ôen√≠
            const isCustomRecipe = (group.items.length === 1 && 
                                   (group.items[0].food_name === group.recipeName ||
                                    group.items[0].food_name?.trim().toLowerCase() === group.recipeName?.trim().toLowerCase())) ||
                                   group.isCustomRecipe === true;
            
            if (isCustomRecipe) {
                groupDiv.classList.add('custom-recipe');
                groupDiv.dataset.isCustomRecipe = 'true'; // ULO≈Ω√çME DO DATASETU
                console.log("‚úÖ Vlastn√≠ recept detekov√°n:", group.recipeName);
            }

            const totalAmount = group.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            const mainUnit = group.items[0]?.unit || 'g';
            const isExpanded = false;

            groupDiv.innerHTML = `
        <div class="recipe-header ${isExpanded ? 'expanded' : ''}">
            <div class="recipe-main-info">
                <div class="recipe-icon">${group.recipeExists ? 'üìã' : 'üóëÔ∏è'}</div>
                <div class="recipe-details">
  <div class="recipe-name">
                        ${group.recipeName}
                        ${!group.recipeExists ? '<span class="deleted-badge">(smaz√°no)</span>' : ''}
                    </div>
                    <!-- OBA TYPY - DVOU≈ò√ÅDKOV√ù LAYOUT -->
                    <div class="recipe-totals-row main-highlight-row">
                        <span class="calorie-highlight">${smartRound(group.totalCalories)} kcal</span>
                        <span class="total-amount-display">${smartRound(totalAmount)} ${mainUnit}</span>
                    </div>
                    <div class="recipe-totals-row macro-stats-row">
                        <span>B: ${smartRound(group.totalProtein)}g</span>
                        <span>S: ${smartRound(group.totalCarbs)}g</span>
                        <span>T: ${smartRound(group.totalFat)}g</span>
                    </div>
                </div>
            </div>
            <div class="recipe-actions">
                <button class="toggle-recipe-btn" title="Rozbalit ingredience">
                    <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Rozbalit" class="toggle-icon ${isExpanded ? 'expanded' : ''}">
                </button>
                <button class="delete-recipe-group-btn" title="Smazat recept">
                    <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat recept">
                </button>
            </div>
        </div>
        <div class="recipe-ingredients ${isExpanded ? 'expanded' : ''}">
            ${group.items.map(item => {
                const cals = parseFloat(item.calories) || 0;
                const prot = parseFloat(item.protein) || 0;
                const carb = parseFloat(item.carbs) || 0;
                const fat = parseFloat(item.fat) || 0;
                const amt = parseFloat(item.amount) || 0;
                
                return `
                <div class="recipe-ingredient-item ${isCustomRecipe ? 'custom-recipe-ingredient' : ''}">
                    <div class="ingredient-info">
                        <div class="ingredient-name">${item.food_name}</div>
                        ${isCustomRecipe ? `
                            <!-- VLASTN√ç RECEPT - DVOU≈ò√ÅDKOV√ù, K LEV√âMU OKRAJI -->
                            <div class="ingredient-details-tworow custom-left">
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">kcal</div>
                                    <div class="nutrient-value-bottom nutrient-bold">${smartRound(cals)}</div>
                                </div>
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">B:</div>
                                    <div class="nutrient-value-bottom">${smartRound(prot)}g</div>
                                </div>
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">S:</div>
                                    <div class="nutrient-value-bottom">${smartRound(carb)}g</div>
                                </div>
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">T:</div>
                                    <div class="nutrient-value-bottom">${smartRound(fat)}g</div>
                                </div>
                            </div>
                        ` : `
                            <!-- Bƒö≈ΩN√ù RECEPT - DVOU≈ò√ÅDKOV√ù S HMOTNOST√ç JEDNO≈ò√ÅDKOVOU -->
                            <div class="ingredient-details-tworow">
                                <div class="amount-single">${smartRound(amt)}${item.unit}</div>
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">kcal</div>
                                    <div class="nutrient-value-bottom nutrient-bold">${smartRound(cals)}</div>
                                </div>
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">B:</div>
                                    <div class="nutrient-value-bottom">${smartRound(prot)}g</div>
                                </div>
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">S:</div>
                                    <div class="nutrient-value-bottom">${smartRound(carb)}g</div>
                                </div>
                                <div class="nutrient-column">
                                    <div class="nutrient-label-top">T:</div>
                                    <div class="nutrient-value-bottom">${smartRound(fat)}g</div>
                                </div>
                            </div>
                        `}
                    </div>
                    <div class="ingredient-actions">
                        <button class="edit-ingredient-btn" data-item-id="${item.id}" title="Upravit ingredienci">
                            <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Upravit">
                        </button>
                        <button class="delete-ingredient-btn" data-item-id="${item.id}" title="Smazat ingredienci">
                            <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat">
                        </button>
                    </div>
                </div>
            `}).join('')}
        </div>
    `;

            // Event listenery z≈Øst√°vaj√≠ stejn√©...
            const toggleBtn = groupDiv.querySelector('.toggle-recipe-btn');
            const ingredientsContainer = groupDiv.querySelector('.recipe-ingredients');
            const recipeHeader = groupDiv.querySelector('.recipe-header');
            const toggleIcon = groupDiv.querySelector('.toggle-icon');

            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isNowExpanded = !ingredientsContainer.classList.contains('expanded');
                ingredientsContainer.classList.toggle('expanded', isNowExpanded);
                recipeHeader.classList.toggle('expanded', isNowExpanded);
                toggleIcon.classList.toggle('expanded', isNowExpanded);
            });

            recipeHeader.addEventListener('click', (e) => {
                if (!e.target.closest('.recipe-actions')) {
                    const isNowExpanded = !ingredientsContainer.classList.contains('expanded');
                    ingredientsContainer.classList.toggle('expanded', isNowExpanded);
                    recipeHeader.classList.toggle('expanded', isNowExpanded);
                    toggleIcon.classList.toggle('expanded', isNowExpanded);
                }
            });

            const deleteBtn = groupDiv.querySelector('.delete-recipe-group-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteRecipeGroup(group.recipeId, group.mealId, group.recipeName);
            });

            groupDiv.querySelectorAll('.edit-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const itemId = e.target.closest('.edit-ingredient-btn').dataset.itemId;
                    
                    // KONTROLA: Je to vlastn√≠ recept? ƒåteme z datasetu groupDiv
                    const isCustom = groupDiv.dataset.isCustomRecipe === 'true';
                    
                    console.log("üîç DEBUG - isCustom:", isCustom, "recipeId:", group.recipeId);
                    console.log("üîç DEBUG - dataset.isCustomRecipe:", groupDiv.dataset.isCustomRecipe);
                    
                    if (isCustom && group.recipeId) {
                        console.log("üîß Otev√≠r√°m editaci vlastn√≠ho receptu:", group.recipeId);
                        // Zav≈ôeme denn√≠ p≈ô√≠jem modal pokud je otev≈ôen√Ω
                        const dailyModal = document.getElementById('dailyIntakeSection');
                        if (dailyModal) {
                            dailyModal.style.display = 'none';
                        }
                        // Otev≈ôi modal pro editaci vlastn√≠ho receptu
                        await openCustomRecipeModalForEdit(group.recipeId);
                    } else {
                        console.log("üîß Bƒõ≈æn√° editace ingredience:", itemId);
                        // Bƒõ≈æn√° editace ingredience
                        editMealItem(itemId);
                    }
                });
            });

            groupDiv.querySelectorAll('.delete-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const itemId = e.target.closest('.delete-ingredient-btn').dataset.itemId;
                    const mealId = group.mealId;
                    deleteMealItem(itemId, mealId);
                });
            });

            return groupDiv;
        }

        // Vytvo≈ôen√≠ elementu samostatn√© potraviny S MNO≈ΩSTV√çM
        function createFoodItemElement(item, mealId) {
            const div = document.createElement('div');
            div.className = 'food-item';
            div.innerHTML = `
                                                <div class="food-item-info">
                                                    <div class="food-item-name">${item.food_name}</div>
                                                    <div class="food-item-details">
                                                        <span class="amount-badge">${item.amount} ${item.unit}</span>
                                                        <span>${smartRound(parseFloat(item.calories) || 0)} kcal</span>
                                                        ${item.protein ? `<span>B: ${Math.round(parseFloat(item.protein) || 0)}g</span>` : ''}
                                                        ${item.carbs ? `<span>S: ${Math.round(parseFloat(item.carbs) || 0)}g</span>` : ''}
                                                        ${item.fat ? `<span>T: ${Math.round(parseFloat(item.fat) || 0)}g</span>` : ''}
                                                    </div>
                                                </div>
                                                <div class="food-item-actions">
                                                    <button class="edit-food-item" data-item-id="${item.id}" title="Upravit potravinu">
                                                        <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Upravit">
                                                    </button>
                                                    <button class="delete-food-item" data-item-id="${item.id}" data-meal-id="${mealId}" title="Smazat potravinu">
                                                        <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat">
                                                    </button>
                                                </div>
                                                `;

            // Event listenery z≈Øst√°vaj√≠ stejn√©...
            div.querySelector('.edit-food-item').addEventListener('click', (e) => {
                e.stopPropagation();
                const itemId = e.target.closest('.edit-food-item').dataset.itemId;
                editMealItem(itemId);
            });

            div.querySelector('.delete-food-item').addEventListener('click', (e) => {
                e.stopPropagation();
                const itemId = e.target.closest('.delete-food-item').dataset.itemId;
                const mealId = e.target.closest('.delete-food-item').dataset.mealId;
                deleteMealItem(itemId, mealId);
            });

            return div;
        }

        // Funkce pro smaz√°n√≠ cel√© skupiny recept≈Ø
        async function deleteRecipeGroup(recipeId, mealId, recipeName) {
            window.showCustomNotification(
                `Opravdu chcete smazat cel√Ω recept "<strong>${recipeName}</strong>" vƒçetnƒõ v≈°ech ingredienc√≠?`,
                'confirmDeleteRecipe',
                async () => {
                    try {
                        // D≈ÆLE≈ΩIT√â: Spr√°vn√Ω SQL dotaz pro NULL hodnoty
                        let query = window.supabaseClient
                            .from('meal_items')
                            .select('id');

                        // Pokud recipeId je null/undefined, hled√°me polo≈æky s NULL recipe_id
                        if (!recipeId || recipeId === 'null' || recipeId === 'undefined') {
                            query = query.is('recipe_id', null); // Spr√°vn√Ω zp≈Øsob pro NULL
                        } else {
                            query = query.eq('recipe_id', recipeId); // Pro norm√°ln√≠ UUID
                        }

                        // P≈ôid√°me filtr na daily_meal_id
                        query = query.eq('daily_meal_id', mealId);

                        const { data: items, error: findError } = await query;

                        if (findError) {
                            console.error("‚ùå Chyba p≈ôi hled√°n√≠ polo≈æek:", findError);
                            throw findError;
                        }

                        // Smazeme v≈°echny polo≈æky
                        if (items && items.length > 0) {
                            const { error: deleteError } = await window.supabaseClient
                                .from('meal_items')
                                .delete()
                                .in('id', items.map(item => item.id));

                            if (deleteError) {
                                console.error("‚ùå Chyba p≈ôi maz√°n√≠ polo≈æek:", deleteError);
                                throw deleteError;
                            }
                        }

                        window.showCustomNotification(`Recept "${recipeName}" byl smaz√°n`, 'success');
                        await loadDailyIntakeData(currentDailyIntakeDate);

                    } catch (error) {
                        console.error("‚ùå Chyba p≈ôi maz√°n√≠ receptu:", error);
                        window.showCustomNotification("Chyba p≈ôi maz√°n√≠ receptu: " + error.message, 'error');
                    }
                },
                true
            );
        }

        // Vytvo≈ôen√≠ elementu polo≈æky j√≠dla
        function createMealItemElement(item, mealId) {
            const div = document.createElement('div');
            div.className = 'meal-item';
            div.innerHTML = `
                                                <div class="meal-item-info">
                                                    <div class="meal-item-name">${item.food_name}</div>
                                                    <div class="meal-item-details">
                                                        ${item.amount} ${item.unit} ‚Ä¢ ${Math.round(item.calories)} kcal
                                                        ${item.protein ? ` ‚Ä¢ B: ${Math.round(item.protein)}g` : ''}
                                                        ${item.carbs ? ` ‚Ä¢ S: ${Math.round(item.carbs)}g` : ''}
                                                        ${item.fat ? ` ‚Ä¢ T: ${Math.round(item.fat)}g` : ''}
                                                    </div>
                                                </div>
                                                <div class="meal-item-actions">
                                                    <button class="meal-item-action edit-meal-item" data-item-id="${item.id}">
                                                        <img src="{{ url_for('static', filename='icon/editace.png') }}" alt="Upravit">
                                                    </button>
                                                    <button class="meal-item-action delete-meal-item" data-item-id="${item.id}" data-meal-id="${mealId}">
                                                        <img src="{{ url_for('static', filename='icon/kos.png') }}" alt="Smazat">
                                                    </button>
                                                </div>
                                                `;

            return div;
        }

        // Nastaven√≠ event listener≈Ø
        function setupDailyIntakeEventListeners() {
            // Navigace mezi dny
            document.getElementById('prevDayBtn')?.addEventListener('click', () => navigateDay(-1));
            document.getElementById('nextDayBtn')?.addEventListener('click', () => navigateDay(1));
            document.getElementById('todayBtn')?.addEventListener('click', () => {
                // RELOAD STR√ÅNKY
                window.location.reload();
            });

            // Tlaƒç√≠tka pro p≈ôid√°n√≠ j√≠dla
            document.querySelectorAll('.add-meal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mealType = e.target.dataset.mealType;
                    openRecipeSelectionForMeal(mealType);
                });
            });

            // Delegace event≈Ø pro akce s j√≠dly
            document.addEventListener('click', (e) => {
                if (e.target.closest('.edit-meal-item')) {
                    const itemId = e.target.closest('.edit-meal-item').dataset.itemId;
                    editMealItem(itemId);
                }

                if (e.target.closest('.delete-meal-item')) {
                    const itemId = e.target.closest('.delete-meal-item').dataset.itemId;
                    const mealId = e.target.closest('.delete-meal-item').dataset.mealId;
                    deleteMealItem(itemId, mealId);
                }
            });
        }

        // Navigace mezi dny
        function navigateDay(direction) {
            currentDailyIntakeDate.setDate(currentDailyIntakeDate.getDate() + direction);
            loadDailyIntakeData(currentDailyIntakeDate);
        }

        // Otev≈ôen√≠ v√Ωbƒõru receptu pro j√≠dlo
        function openRecipeSelectionForMeal(mealType) {
            if (!checkInitialization()) return;

            console.log("‚ûï P≈ôid√°v√°m j√≠dlo pro:", mealType, "profil:", window.currentProfileId);

            // Ulo≈æ√≠me kontext pro pozdƒõj≈°√≠ p≈ôid√°n√≠
            window.currentMealContext = {
                mealType: mealType,
                date: currentDailyIntakeDate,
                profileId: window.currentProfileId // ‚úÖ Ulo≈æ√≠me i profil pro kontrolu
            };

            // Naƒçteme a zobraz√≠me recepty PRO SPR√ÅVN√ù PROFIL
            loadUserRecipesForMealSelection();
            document.getElementById('selectRecipeModal').style.display = 'flex';
        }

        // Naƒçten√≠ recept≈Ø pro v√Ωbƒõr do j√≠dla
        async function loadUserRecipesForMealSelection() {
            if (!window.supabaseClient || !window.currentUser || !window.currentProfileId) {
                console.log("‚ùå Nelze naƒç√≠st recepty - chyb√≠ u≈æivatel nebo profil");
                return;
            }

            try {
                console.log("üìã Naƒç√≠t√°m recepty pro profil:", window.currentProfileId);

                const { data, error } = await window.supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('profile_id', window.currentProfileId) // ‚úÖ D≈ÆLE≈ΩIT√â - filtr na profil
                    .order('created_at', { ascending: false });

                if (error) throw error;

                console.log("‚úÖ Naƒçteno recept≈Ø:", data?.length || 0);
                displayRecipesForMealSelection(data || []);

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø:", error);
                window.showCustomNotification("Chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø: " + error.message, 'error');
            }
        }

        // Zobrazen√≠ recept≈Ø pro v√Ωbƒõr pro p≈ôid√°n√≠ do j√≠dla
        function displayRecipesForMealSelection(recipes) {
            const existingRecipesList = document.getElementById('existingRecipesList');
            const recipeCountDisplay = document.getElementById('recipeCountDisplay');

            if (!existingRecipesList) return;
            existingRecipesList.innerHTML = '';

            if (recipeCountDisplay) {
                recipeCountDisplay.textContent = `Vyberte recept (${recipes.length})`;
                recipeCountDisplay.style.display = 'block';
            }

            if (recipes.length === 0) {
                existingRecipesList.innerHTML = '<li style="text-align: center; color: #888; padding: 20px;">≈Ω√°dn√© recepty</li>';
                return;
            }

            recipes.forEach((recipe, index) => {
                const recipeItem = document.createElement('li');
                recipeItem.className = 'recipe-list-item'; // BEZ with-actions

                // ZOBRAZEN√ç P≈òI P≈òIDAT J√çDLO Z HLAVN√ç OBRAZOVKY
                const totalCalories = calculateRecipeTotalCalories(recipe);
                const portions = recipe.portions || 1;
                const hasMultiplePortions = recipe.has_multiple_portions || false;

                // ROZHODNUT√ç: Kter√© kalorie zobrazit
                let displayCalories = totalCalories;

                if (hasMultiplePortions && recipe.recipe_one_portion) {
                    // Zobraz√≠me kalorie na jednu porci
                    displayCalories = Math.round(recipe.recipe_one_portion.total_kcal);
                }

                const formattedCalories = displayCalories > 0 ? `${Math.round(displayCalories)} kcal` : '-';
                const portionText = portions > 1 ? ` (${portions} porc√≠)` : '';

                // POUZE z√°kladn√≠ rozlo≈æen√≠ - bez ikonky
                recipeItem.innerHTML = `
                                                <div class="recipe-number">${index + 1}.</div>
                                                <div class="recipe-name">${recipe.name}</div>
                                                <div class="recipe-calories">${formattedCalories}</div>
                                                `;

                recipeItem.addEventListener('click', () => {
                    addRecipeToMeal(recipe);
                });

                existingRecipesList.appendChild(recipeItem);
            });
        }

        // P≈ôid√°n√≠ receptu do j√≠dla
        async function addRecipeToMeal(recipe) {
            // P≈òID√ÅNO: Kontrola jestli p≈ôid√°v√°me do receptu nebo do denn√≠ho p≈ô√≠jmu
            if (!window.currentMealContext) {
                // P≈òID√ÅV√ÅME DO RECEPTU Z VYHLED√ÅV√ÅN√ç
                console.log("üìù P≈ôid√°v√°m potravinu do receptu z vyhled√°v√°n√≠:", recipe.name);
                await addFoodItemToExistingRecipe(recipe.id, window.currentFoodItemForRecipe);
                document.getElementById('selectRecipeModal').style.display = 'none';

                // Zav≈ôeme i detailn√≠ modal pokud je otev≈ôen√Ω
                if (detailsModal.style.display === 'flex') {
                    detailsModal.style.display = 'none';
                }

                window.isOpeningDetailsModal = false;
                window.currentFoodItemForRecipe = null;
                return;
            }

            // P≈ÆVODN√ç K√ìD PRO P≈òID√ÅV√ÅN√ç DO DENN√çHO P≈ò√çJMU
            try {
                const { mealType, date } = window.currentMealContext;

                // Zav≈ôeme modal
                document.getElementById('selectRecipeModal').style.display = 'none';

                // P≈ôid√°me recept do denn√≠ho p≈ô√≠jmu
                await addRecipeToDailyIntake(recipe, mealType, date);

                window.showCustomNotification(`Recept "${recipe.name}" byl p≈ôid√°n do ${mealTypeLabels[mealType]}!`, 'success');

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ receptu:", error);
                window.showCustomNotification("Chyba p≈ôi p≈ôid√°v√°n√≠ receptu: " + error.message, 'error');
            }
        }

        // P≈ôid√°n√≠ receptu do denn√≠ho p≈ô√≠jmu
        async function addRecipeToDailyIntake(recipe, mealType, date) {
            try {
                // ‚úÖ KONTROLA - recept mus√≠ pat≈ôit k aktu√°ln√≠mu profilu
                if (recipe.profile_id !== window.currentProfileId) {
                    console.error("‚ùå Recept nepat≈ô√≠ k aktu√°ln√≠mu profilu:", recipe.profile_id, "vs", window.currentProfileId);
                    window.showCustomNotification("Chyba: Recept nepat≈ô√≠ k vybran√©mu profilu", 'error');
                    return;
                }

                const dateString = formatDateForAPI(date);

                // 1. Zkontrolujeme/z√≠sk√°me denn√≠ z√°znam S KONTROLOU PROFILU
                let dailyIntakeId = await getOrCreateDailyIntake(dateString);

                // 2. Z√≠sk√°me/create meal pro dan√Ω typ
                let mealId = await getOrCreateMeal(dailyIntakeId, mealType);

                // 3. P≈ôid√°me v≈°echny ingredience receptu jako polo≈æky j√≠dla S RECIPE_ID
                if (recipe.ingredients && recipe.ingredients.length > 0) {
                    for (const ingredient of recipe.ingredients) {
                        // DEBUG: Zobrazit hodnoty p≈ôed ulo≈æen√≠m
                        console.log("üîç INGREDIENCE P≈òED ULO≈ΩEN√çM:", {
                            foodName: ingredient.foodName,
                            amount: ingredient.amount,
                            unit: ingredient.unit,
                            kcal: ingredient.kcal,
                            protein: ingredient.nutritionalDetails?.protein,
                            carbs: ingredient.nutritionalDetails?.carbs,
                            fat: ingredient.nutritionalDetails?.fat
                        });
                        
                        // ‚úÖ D≈ÆLE≈ΩIT√â: P≈ôid√°me recipe_id k ingredienci
                        const ingredientWithRecipeId = {
                            ...ingredient,
                            recipe_id: recipe.id // P≈òID√ÅME RECIPE_ID
                        };

                        await addMealItem(mealId, ingredientWithRecipeId, recipe.name);
                    }
                }

                // 4. Znovu naƒçteme data
                await loadDailyIntakeData(date);

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ do denn√≠ho p≈ô√≠jmu:", error);
                throw error;
            }
        }

        // Pomocn√© funkce
        function formatDateForAPI(date) {
            return date.toISOString().split('T')[0];
        }

        async function getOrCreateDailyIntake(dateString) {
            // Nejprve zkus√≠me naj√≠t existuj√≠c√≠ z√°znam S KONTROLOU PROFILU
            const { data: existing, error: findError } = await window.supabaseClient
                .from('daily_intakes')
                .select('id')
                .eq('user_id', window.currentUser.id)
                .eq('profile_id', window.currentProfileId) // ‚úÖ D≈ÆLE≈ΩIT√â
                .eq('intake_date', dateString)
                .single();

            if (findError && findError.code !== 'PGRST116') throw findError;

            if (existing) {
                return existing.id;
            }

            // Vytvo≈ô√≠me nov√Ω z√°znam S SPR√ÅVN√ùM PROFIL_ID
            const { data: newIntake, error: createError } = await window.supabaseClient
                .from('daily_intakes')
                .insert({
                    user_id: window.currentUser.id,
                    profile_id: window.currentProfileId, // ‚úÖ D≈ÆLE≈ΩIT√â
                    intake_date: dateString
                })
                .select()
                .single();

            if (createError) throw createError;
            return newIntake.id;
        }

        async function getOrCreateMeal(dailyIntakeId, mealType) {
            // Najdeme posledn√≠ po≈ôad√≠ pro tento typ j√≠dla
            const { data: existingMeals, error: findError } = await window.supabaseClient
                .from('daily_meals')
                .select('id, meal_order')
                .eq('daily_intake_id', dailyIntakeId)
                .eq('meal_type', mealType)
                .order('meal_order', { ascending: false });

            if (findError) throw findError;

            const nextOrder = existingMeals && existingMeals.length > 0 ? existingMeals[0].meal_order + 1 : 0;

            // Vytvo≈ô√≠me nov√© j√≠dlo
            const { data: newMeal, error: createError } = await window.supabaseClient
                .from('daily_meals')
                .insert({
                    daily_intake_id: dailyIntakeId,
                    meal_type: mealType,
                    meal_order: nextOrder
                })
                .select()
                .single();

            if (createError) {
                // SPECI√ÅLN√ç CHYBA PRO DINNER2
                if (createError.code === '23514' && mealType === 'dinner2') {
                    window.showCustomNotification(
                        'Druh√° veƒçe≈ôe vy≈æaduje aktualizaci datab√°ze. Kontaktujte administr√°tora nebo spus≈•te SQL p≈ô√≠kaz pro p≈ôid√°n√≠ dinner2 do check constraintu.',
                        'error'
                    );
                }
                throw createError;
            }
            return newMeal.id;
        }

        async function addMealItem(mealId, ingredient, recipeName) {
            console.log("‚ûï P≈ôid√°v√°m polo≈æku s recipe_id:", {
                mealId: mealId,
                foodName: ingredient.foodName,
                recipeId: ingredient.recipe_id,
                recipeName: recipeName
            });

            // D≈ÆLE≈ΩIT√â: Zajistƒõte, aby recipe_name bylo v≈ædy nastaveno
            const finalRecipeName = recipeName || ingredient.recipe_name || await getRecipeName(ingredient.recipe_id) || 'Recept';

            // PARSOV√ÅN√ç KALORI√ç - zachov√° desetinn√° m√≠sta
            const { number: caloriesNum } = parseValueAndUnit(ingredient.kcal);
            const { number: proteinNum } = parseValueAndUnit(ingredient.nutritionalDetails?.protein);
            const { number: carbsNum } = parseValueAndUnit(ingredient.nutritionalDetails?.carbs);
            const { number: fatNum } = parseValueAndUnit(ingredient.nutritionalDetails?.fat);
            const { number: fiberNum } = parseValueAndUnit(ingredient.nutritionalDetails?.fiber);

            const { error } = await window.supabaseClient
                .from('meal_items')
                .insert({
                    daily_meal_id: mealId,
                    recipe_id: ingredient.recipe_id || null,
                    recipe_name: finalRecipeName, // D≈ÆLE≈ΩIT√â: v≈ædy nastavit
                    food_name: ingredient.foodName || 'Nezn√°m√° potravina',
                    amount: ingredient.amount || 100,
                    unit: ingredient.unit || 'g',
                    calories: caloriesNum || 0,
                    protein: proteinNum || 0,
                    carbs: carbsNum || 0,
                    fat: fatNum || 0,
                    fiber: fiberNum || 0,
                    nutritional_data: ingredient.nutritionalDetails || null
                });

            if (error) {
                console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ polo≈æky:", error);
                throw error;
            }

            console.log("‚úÖ Polo≈æka √∫spƒõ≈°nƒõ ulo≈æena s recipe_name:", finalRecipeName);
        }

        // Funkce pro √∫pravu a maz√°n√≠ (zat√≠m z√°kladn√≠)
        function editMealItem(itemId) {
            console.log("‚úèÔ∏è √öprava polo≈æky:", itemId);
            window.showCustomNotification("Funkce √∫pravy bude brzy dostupn√°", 'info');
        }

        async function deleteMealItem(itemId, mealId) {
            window.showCustomNotification(
                `Opravdu chcete smazat tuto polo≈æku?`,
                'confirmDeleteRecipeItem',
                async () => {
                    try {
                        const { error } = await window.supabaseClient
                            .from('meal_items')
                            .delete()
                            .eq('id', itemId);

                        if (error) throw error;

                        window.showCustomNotification("Polo≈æka byla smaz√°na", 'success');
                        await loadDailyIntakeData(currentDailyIntakeDate);

                    } catch (error) {
                        console.error("‚ùå Chyba p≈ôi maz√°n√≠ polo≈æky:", error);
                        window.showCustomNotification("Chyba p≈ôi maz√°n√≠ polo≈æky: " + error.message, 'error');
                    }
                },
                true
            );
        }

        function closeSettingsModal() {
            console.log("üî¥ Zav√≠r√°m modal nastaven√≠");

            // Nejprve sbal√≠me v≈°echny otev≈ôen√© sekce
            const hadOpenSections = collapseAllSettingsSections();

            // Poƒçk√°me chv√≠li na animaci sbalen√≠ (pokud jsou nƒõjak√© sekce otev≈ôen√©)
            const delay = hadOpenSections ? 150 : 0;

            setTimeout(() => {
                document.getElementById('settingsModal').style.display = 'none';
                console.log("‚úÖ Modal nastaven√≠ zav≈ôen");
            }, delay);
        }

        // Event listener pro skenov√°n√≠ v modalu
        document.getElementById('barcodeButtonInModal')?.addEventListener('click', function () {
            closeSearchModal();
            openBarcodeScanner();
        });

        // Funkce pro kontrolu a opravu zobrazen√≠ recept≈Ø
        function fixRecipeDisplay() {
            console.log("üîß Opravuji zobrazen√≠ recept≈Ø...");
            const mealTypes = ['breakfast', 'snack1', 'lunch', 'snack2', 'dinner', 'dinner2'];

            mealTypes.forEach(mealType => {
                const container = document.getElementById(`${mealType}Items`);
                if (!container) return;

                // Zkontrolujte zda jsou nƒõjak√© polo≈æky s recipe_id
                const mealItems = container.querySelectorAll('.meal-item');
                console.log(`üìä ${mealType}: ${mealItems.length} polo≈æek`);
            });
        }

        // P≈ôidejte tuto funkci pro testov√°n√≠
        async function testRecipeGrouping() {
            console.log("üß™ TEST: Kontrola seskupov√°n√≠ recept≈Ø");

            const meals = currentDailyIntakeData.daily_meals || [];
            let totalItems = 0;
            let totalGroups = 0;

            meals.forEach(meal => {
                totalItems += meal.meal_items?.length || 0;
            });

            for (const meal of meals) {
                if (!meal.meal_items) continue;

                const grouped = await groupMealItemsByRecipe([meal]);
                totalGroups += grouped.length;

                console.log(`üß™ ${meal.meal_type}: ${meal.meal_items.length} polo≈æek ‚Üí ${grouped.length} skupin`);

                grouped.forEach(group => {
                    console.log(`   üì¶ ${group.isRecipe ? 'RECEPT' : 'POTRAVINA'}: ${group.recipeName || 'bez receptu'} (${group.items.length} polo≈æek)`);
                });
            }

            console.log(`üß™ CELKEM: ${totalItems} polo≈æek ‚Üí ${totalGroups} skupin`);
        }

        // Testovac√≠ funkce pro kontrolu maz√°n√≠
        async function testDeleteRecipeGroup() {
            console.log("üß™ TEST: Kontrola maz√°n√≠ receptu s NULL recipe_id");

            // Najdƒõte nƒõjakou skupinu s NULL recipe_id
            const testMeal = currentDailyIntakeData.daily_meals?.find(meal =>
                meal.meal_items?.some(item => !item.recipe_id && item.recipe_name)
            );

            if (testMeal) {
                const testItem = testMeal.meal_items.find(item => !item.recipe_id && item.recipe_name);
                console.log(`üß™ Testovac√≠ polo≈æka:`, {
                    food_name: testItem.food_name,
                    recipe_id: testItem.recipe_id,
                    recipe_name: testItem.recipe_name,
                    meal_id: testMeal.id
                });

                // Otestujte maz√°n√≠
                await deleteRecipeGroup(null, testMeal.id, testItem.recipe_name);
            } else {
                console.log("üß™ ≈Ω√°dn√° testovac√≠ polo≈æka s NULL recipe_id nenalezena");
            }
        }

        // Funkce pro kontrolu v≈°ech meal_items s probl√©mov√Ωmi recipe_id
        async function debugMealItems() {
            console.log("üêõ DEBUG: Kontrola meal_items");

            try {
                // Polo≈æky s NULL recipe_id
                const { data: nullItems, error: nullError } = await window.supabaseClient
                    .from('meal_items')
                    .select('id, food_name, recipe_id, recipe_name, created_at')
                    .is('recipe_id', null)
                    .limit(10);

                if (!nullError && nullItems && nullItems.length > 0) {
                    console.log("üìã Polo≈æky s NULL recipe_id:", nullItems.length);
                    nullItems.forEach(item => {
                        console.log(`   ü•ò ${item.food_name}: recipe_name="${item.recipe_name}"`);
                    });
                }

                // Polo≈æky s platn√Ωm recipe_id
                const { data: validItems, error: validError } = await window.supabaseClient
                    .from('meal_items')
                    .select('id, food_name, recipe_id, recipe_name, created_at')
                    .not('recipe_id', 'is', null)
                    .limit(10);

                if (!validError && validItems && validItems.length > 0) {
                    console.log("üìã Polo≈æky s platn√Ωm recipe_id:", validItems.length);
                    validItems.forEach(item => {
                        console.log(`   ‚úÖ ${item.food_name}: recipe_id=${item.recipe_id}, recipe_name="${item.recipe_name}"`);
                    });
                }

            } catch (error) {
                console.error("‚ùå Chyba p≈ôi debugov√°n√≠:", error);
            }
        }

        // Spus≈•te debug
        setTimeout(debugMealItems, 2000);

        // Spustit po naƒçten√≠ denn√≠ho p≈ô√≠jmu
        setTimeout(fixRecipeDisplay, 2000);

    </script>
</body>

</html>